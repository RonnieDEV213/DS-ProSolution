---
phase: 29-app-wide-persistent-cache
plan: 03
type: execute
wave: 2
depends_on: [29-01]
files_modified:
  - apps/web/src/hooks/sync/use-sync-accounts.ts
  - apps/web/src/app/va/accounts/page.tsx
  - apps/web/src/components/admin/accounts-table.tsx
autonomous: true

must_haves:
  truths:
    - "useSyncAccounts hook reads from db.accounts via useLiveQuery for instant reactive data"
    - "useSyncAccounts calls syncAccounts() on mount for background sync"
    - "useSyncAccounts supports search filtering in memory"
    - "/va/accounts page uses useSyncAccounts instead of direct API fetch"
    - "accounts-table.tsx uses useSyncAccounts for VA mode and useCachedQuery for admin mode"
    - "Account data loads instantly from IndexedDB, syncs in background"
  artifacts:
    - path: "apps/web/src/hooks/sync/use-sync-accounts.ts"
      provides: "Cache-first hook for accounts using full V3 sync"
      contains: "useSyncAccounts"
    - path: "apps/web/src/app/va/accounts/page.tsx"
      provides: "VA accounts page using IndexedDB-first data loading"
      contains: "useSyncAccounts"
  key_links:
    - from: "apps/web/src/hooks/sync/use-sync-accounts.ts"
      to: "apps/web/src/lib/db/sync.ts"
      via: "syncAccounts() import for background sync"
      pattern: "syncAccounts"
    - from: "apps/web/src/hooks/sync/use-sync-accounts.ts"
      to: "apps/web/src/lib/db/index.ts"
      via: "db.accounts for IndexedDB reads"
      pattern: "db\\.accounts"
---

<objective>
Complete the Accounts V3 wiring by creating a useSyncAccounts hook that reads from db.accounts via useLiveQuery and syncs in background, then wire /va/accounts and admin accounts-table to use it.

Purpose: The accounts IndexedDB table and syncAccounts() function already exist (Phase 18) but the UI was bypassing them with direct API fetch. This plan completes the "last 10%" to make accounts load instantly from IndexedDB.

Output: useSyncAccounts hook, /va/accounts and accounts-table wired to IndexedDB-first loading.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/29-app-wide-persistent-cache/29-RESEARCH.md
@apps/web/src/lib/db/index.ts
@apps/web/src/lib/db/sync.ts
@apps/web/src/hooks/sync/use-sync-accounts.ts
@apps/web/src/app/va/accounts/page.tsx
@apps/web/src/components/admin/accounts-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSyncAccounts hook</name>
  <files>apps/web/src/hooks/sync/use-sync-accounts.ts</files>
  <action>
Create `apps/web/src/hooks/sync/use-sync-accounts.ts`:

1. Use `useLiveQuery` from dexie-react-hooks to read `db.accounts` reactively
2. Apply in-memory search filter if `search` option provided
3. Sort by `account_code` ascending
4. Use `useLiveQuery` separately for `totalCount` via `db.accounts.count()`
5. Call `syncAccounts()` on mount for background sync
6. Track isSyncing state with ref guard to prevent concurrent syncs
7. Return: `{ accounts, isLoading, isSyncing, error, totalCount, refetch }`
  </action>
  <verify>
1. File exists at apps/web/src/hooks/sync/use-sync-accounts.ts
2. Uses useLiveQuery from dexie-react-hooks
3. Calls syncAccounts() from lib/db/sync
4. Returns accounts, isLoading, isSyncing, error, totalCount, refetch
  </verify>
  <done>
- useSyncAccounts hook created with reactive IndexedDB reads
- Background sync on mount with concurrent sync guard
- In-memory search filtering and sorting
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire /va/accounts to useSyncAccounts</name>
  <files>apps/web/src/app/va/accounts/page.tsx</files>
  <action>
Replace direct API fetch with useSyncAccounts:
- Import and use useSyncAccounts({ search })
- Data loads instantly from IndexedDB
- Background sync updates reactive queries automatically
  </action>
  <verify>
1. Grep for `useSyncAccounts` in va/accounts/page.tsx
2. No direct fetch/useQuery calls for accounts data
  </verify>
  <done>
- /va/accounts reads from db.accounts via useSyncAccounts
- Instant load from IndexedDB, background sync for freshness
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire accounts-table dual mode (admin: useCachedQuery, VA: useSyncAccounts)</name>
  <files>apps/web/src/components/admin/accounts-table.tsx</files>
  <action>
Update accounts-table to use dual data loading:
- Admin mode: useCachedQuery with `admin:accounts:${search}:${page}` cache key
- VA mode: useSyncAccounts for full IndexedDB-first loading
- Both modes show instant data on revisit
  </action>
  <verify>
1. Grep for both `useCachedQuery` and `useSyncAccounts` in accounts-table.tsx
2. Conditional usage based on user role/mode
  </verify>
  <done>
- accounts-table supports both admin (cached query) and VA (full sync) modes
- Both modes load instantly from persistent storage
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **useSyncAccounts:** Reads from db.accounts reactively, syncs in background
2. **/va/accounts:** Uses useSyncAccounts for instant IndexedDB loading
3. **accounts-table:** Dual mode â€” useCachedQuery (admin) and useSyncAccounts (VA)
4. **Build:** `npm run build` succeeds
</verification>

<success_criteria>
- useSyncAccounts hook exists with reactive IndexedDB reads + background sync
- /va/accounts loads from IndexedDB instantly
- accounts-table supports dual admin/VA modes
- Build succeeds with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-app-wide-persistent-cache/29-03-SUMMARY.md`
</output>
