---
phase: 29-app-wide-persistent-cache
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/hooks/use-cached-query.ts
  - apps/web/src/lib/db/index.ts
  - apps/web/src/lib/db/schema.ts
  - apps/web/src/lib/query-keys.ts
autonomous: true

must_haves:
  truths:
    - "A useCachedQuery() hook exists that wraps TanStack Query with IndexedDB persistence"
    - "The hook reads from db._query_cache[cacheKey] on mount and passes as initialData"
    - "The hook writes fresh network data back to db._query_cache when TanStack Query resolves"
    - "initialDataUpdatedAt is set so TanStack Query knows cached data age for staleness checks"
    - "Query is disabled until IndexedDB cache check completes (enabled: cacheChecked)"
    - "IndexedDB failures are caught gracefully — fall through to normal network fetch"
    - "Database schema version 4 includes _query_cache table with 'key' primary index"
    - "QueryCacheEntry type is exported from db/schema.ts with key, data, cached_at fields"
    - "Admin query keys exist in queryKeys factory: users, departmentRoles, invites, dashboardCounts"
  artifacts:
    - path: "apps/web/src/hooks/use-cached-query.ts"
      provides: "useCachedQuery hook — TanStack Query + IndexedDB persistent cache"
      contains: "useCachedQuery"
    - path: "apps/web/src/lib/db/index.ts"
      provides: "_query_cache table in Dexie schema"
      contains: "_query_cache"
    - path: "apps/web/src/lib/query-keys.ts"
      provides: "Type-safe admin query key factory"
      contains: "admin.*users.*departmentRoles.*invites.*dashboardCounts"
  key_links:
    - from: "apps/web/src/hooks/use-cached-query.ts"
      to: "apps/web/src/lib/db/index.ts"
      via: "db._query_cache.get() and db._query_cache.put() for IndexedDB persistence"
      pattern: "db\\._query_cache"
---

<objective>
Create the useCachedQuery() hook that wraps TanStack Query with IndexedDB persistence, extend the Dexie database schema to include a _query_cache table, and add admin query keys to the type-safe query key factory.

Purpose: This is the foundation that all subsequent cache wiring (Plans 02-03) depends on. The hook provides a drop-in replacement for useQuery that adds persistent caching with zero backend changes.

Output: useCachedQuery hook, _query_cache DB table, admin query keys.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-app-wide-persistent-cache/29-RESEARCH.md
@apps/web/src/lib/db/index.ts
@apps/web/src/lib/db/schema.ts
@apps/web/src/lib/query-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QueryCacheEntry type and _query_cache table to Dexie schema</name>
  <files>apps/web/src/lib/db/schema.ts, apps/web/src/lib/db/index.ts</files>
  <action>
1. Add `QueryCacheEntry` interface to `db/schema.ts`:
```typescript
export interface QueryCacheEntry {
  key: string;
  data: unknown;
  cached_at: string;
}
```

2. In `db/index.ts`:
- Import `QueryCacheEntry` from schema
- Bump SCHEMA_VERSION to 4
- Add `_query_cache: EntityTable<QueryCacheEntry, 'key'>` to the Dexie type
- Add `_query_cache: 'key'` to the stores definition
- Re-export `QueryCacheEntry`
  </action>
  <verify>
1. Grep for `QueryCacheEntry` in schema.ts — should exist with key, data, cached_at fields
2. Grep for `_query_cache` in index.ts — should appear in both type definition and stores
3. SCHEMA_VERSION should be 4
  </verify>
  <done>
- QueryCacheEntry type defined in db/schema.ts
- _query_cache table added to Dexie schema at version 4
- Type exported for use by useCachedQuery hook
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useCachedQuery hook</name>
  <files>apps/web/src/hooks/use-cached-query.ts</files>
  <action>
Create `apps/web/src/hooks/use-cached-query.ts` with:

1. `UseCachedQueryOptions<TData>` interface extending TanStack Query's `UseQueryOptions` with a `cacheKey: string` property
2. `useCachedQuery<TData>()` function that:
   - Phase 1: On mount, reads `db._query_cache.get(cacheKey)` → sets cached state
   - Phase 2: Passes cached data as `initialData` with `initialDataUpdatedAt` to `useQuery`
   - Phase 3: On fresh data from network, writes back to `db._query_cache.put()`
   - Query is `enabled: cacheChecked && (options.enabled !== false)` — waits for IndexedDB check
   - All IndexedDB errors caught with `.catch()` — non-critical, falls through to network
  </action>
  <verify>
1. File exists at apps/web/src/hooks/use-cached-query.ts
2. Exports `useCachedQuery` function
3. Contains `db._query_cache.get` (read) and `db._query_cache.put` (write)
4. Contains `initialData` and `initialDataUpdatedAt` for TanStack Query integration
5. Contains `cacheChecked` guard for query enabling
  </verify>
  <done>
- useCachedQuery hook created with 3-phase cache lifecycle
- IndexedDB read → initialData → background refresh → IndexedDB write
- Graceful degradation on IndexedDB failures
  </done>
</task>

<task type="auto">
  <name>Task 3: Add admin query keys to query key factory</name>
  <files>apps/web/src/lib/query-keys.ts</files>
  <action>
Add `admin` section to queryKeys factory:

```typescript
admin: {
  users: (search?: string, page?: number) =>
    ["admin", "users", search ?? "", page ?? 1] as const,
  departmentRoles: (orgId: string) =>
    ["admin", "department-roles", orgId] as const,
  invites: (page?: number) =>
    ["admin", "invites", page ?? 1] as const,
  dashboardCounts: () =>
    ["admin", "dashboard-counts"] as const,
},
```

These keys serve dual purpose: TanStack Query cache keys AND IndexedDB cache key derivation.
  </action>
  <verify>
1. Grep for `admin:` section in query-keys.ts
2. Contains users, departmentRoles, invites, dashboardCounts functions
3. TypeScript compiles without errors
  </verify>
  <done>
- Admin query keys added to type-safe factory
- Keys support pagination (users, invites) and org-scoping (departmentRoles)
- Dashboard counts use singleton key pattern
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema:** _query_cache table exists in Dexie schema v4
2. **Hook:** useCachedQuery reads from IndexedDB on mount, passes as initialData, writes back on fresh data
3. **Keys:** Admin query keys exist in queryKeys factory
4. **Build:** `npm run build` succeeds with zero TypeScript errors

Note: No pages are wired to useCachedQuery yet — Plans 02 and 03 handle that.
</verification>

<success_criteria>
- useCachedQuery hook exists with full IndexedDB persistence lifecycle
- _query_cache table in Dexie schema at version 4
- Admin query keys in queryKeys factory
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-app-wide-persistent-cache/29-01-SUMMARY.md`
</output>
