---
phase: 14-history-snapshot-simplification
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - apps/web/src/components/admin/collection/log-detail-modal.tsx
autonomous: true

must_haves:
  truths:
    - "Changes panel shows Added section with green styling for added sellers"
    - "Changes panel shows Removed section with red styling for removed sellers"
    - "Empty sections are hidden (no 'Added (0)' or 'Removed (0)')"
    - "Clicking history entry updates Changes panel with that entry's diff"
    - "Compare mode removed from modal"
  artifacts:
    - path: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      provides: "History Entry modal with Changes panel"
      contains: "Added.*Removed"
  key_links:
    - from: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      to: "/api/sellers/audit-log/{log_id}/sellers"
      via: "fetch in fetchChangesForEntry"
      pattern: "audit-log.*sellers"
---

<objective>
Refactor LogDetailModal to "History Entry" modal with inline diff display

Purpose: Show added/removed sellers with visual +/- indicators instead of full seller list snapshot
Output: Unified modal showing Changes panel with green added / red removed styling
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-history-snapshot-simplification/14-CONTEXT.md
@.planning/phases/14-history-snapshot-simplification/14-RESEARCH.md
@apps/web/src/components/admin/collection/log-detail-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace seller snapshot with Changes panel</name>
  <files>apps/web/src/components/admin/collection/log-detail-modal.tsx</files>
  <action>
Refactor the left panel of LogDetailModal from "Sellers at this point" to "Changes" panel.

1. **Update state:**
   - Remove `sellers` state, add `changes` state: `{ added: string[], removed: string[] }`
   - Remove `sellersLoading`, add `changesLoading`
   - Remove compare mode state entirely: `compareMode`, `compareSelection`

2. **Update fetch function:**
   - Rename `fetchSellersForLog` to `fetchChangesForEntry`
   - Parse new API response shape: `{ sellers, count, added, removed }`
   - Set changes state: `setChanges({ added: data.added || [], removed: data.removed || [] })`

3. **Update the collection run fetch:**
   - For collection runs, the diff is the sellers_new from the run
   - Fetch sellers from export endpoint as before, but set them as `added` (collection runs only add, never remove)

4. **Replace left panel content:**
   - Change header from "Sellers at this point" to "Changes"
   - Remove export dropdown (not needed for diff view)
   - Render Added section with count header: "Added (X)"
   - Render Removed section with count header: "Removed (X)"
   - Hide sections with 0 items (conditional render based on array length)

5. **Styling for Added rows (from CONTEXT.md):**
```tsx
<div className={cn(
  "flex items-center gap-2 px-3 py-1.5 rounded",
  "border-l-2 border-green-500",
  i % 2 === 0 ? "bg-green-500/10" : "bg-green-500/5"
)}>
  <Plus className="h-3.5 w-3.5 text-green-400" />
  <span className="text-sm text-green-300">{name}</span>
</div>
```

6. **Styling for Removed rows:**
```tsx
<div className={cn(
  "flex items-center gap-2 px-3 py-1.5 rounded",
  "border-l-2 border-red-500",
  i % 2 === 0 ? "bg-red-500/10" : "bg-red-500/5"
)}>
  <Minus className="h-3.5 w-3.5 text-red-400" />
  <span className="text-sm text-red-300">{name}</span>
</div>
```

7. **Empty state (when no changes):**
```tsx
<div className="flex flex-col items-center justify-center h-full text-gray-500">
  <FileQuestion className="h-12 w-12 mb-2 text-gray-600" />
  <span className="text-sm">No changes in this entry</span>
</div>
```

Import FileQuestion from lucide-react for empty state icon.
  </action>
  <verify>
Check component structure:
- `grep -n "Changes" apps/web/src/components/admin/collection/log-detail-modal.tsx`
- `grep -n "Added.*Removed" apps/web/src/components/admin/collection/log-detail-modal.tsx`
- `grep -n "compareMode" apps/web/src/components/admin/collection/log-detail-modal.tsx` should return nothing
  </verify>
  <done>Left panel shows Changes with Added/Removed sections, green/red styling, empty sections hidden</done>
</task>

<task type="auto">
  <name>Task 2: Remove compare mode and update modal header</name>
  <files>apps/web/src/components/admin/collection/log-detail-modal.tsx</files>
  <action>
Remove all compare mode functionality and simplify the modal.

1. **Remove from header:**
   - Delete the Compare button
   - Delete the "Select 2 logs to compare" text
   - Remove the compareSelection counter display
   - Keep only the title: "History Entry"

2. **Remove compare-related functions:**
   - Delete `enterCompareMode` function
   - Delete `startCompare` function
   - Delete `toggleLogSelection` function
   - Delete `isSelected` function

3. **Remove props:**
   - Remove `onCompare` prop from interface
   - Remove `onCollectionRunDetail` prop from interface (no longer needed - unified modal)

4. **Simplify entry click handler:**
   - Remove compare mode branching in `handleEntryClick`
   - Both manual edits and collection runs use same flow: update viewingEntry, fetch changes

5. **Remove from Full History list:**
   - Remove checkbox styling for selected items
   - Remove the "More detail" tab button on collection run entries
   - Keep the viewing highlight (bg-gray-700 for current entry)

6. **Update DialogTitle:**
   - Change from "Log Details" to "History Entry"
  </action>
  <verify>
Check removal:
- `grep -n "onCompare" apps/web/src/components/admin/collection/log-detail-modal.tsx` should return nothing (except maybe in imports if unused)
- `grep -n "compareMode" apps/web/src/components/admin/collection/log-detail-modal.tsx` should return nothing
- `grep -n "History Entry" apps/web/src/components/admin/collection/log-detail-modal.tsx` should find the title
  </verify>
  <done>Compare mode removed, modal titled "History Entry", unified behavior for all entry types</done>
</task>

<task type="auto">
  <name>Task 3: Update click behavior and entry highlight</name>
  <files>apps/web/src/components/admin/collection/log-detail-modal.tsx</files>
  <action>
Ensure unified click behavior and proper highlighting.

1. **Unified handleEntryClick:**
```tsx
const handleEntryClick = (entry: HistoryEntry) => {
  if (entry.type === "manual_edit") {
    setViewingEntry({ type: "log", id: entry.id });
    fetchChangesForEntry(entry.id);
  } else if (entry.type === "collection_run") {
    setViewingEntry({ type: "run", id: entry.id });
    fetchChangesForRun(entry.id);
  }
};
```

2. **Collection run changes:**
   - For collection runs, fetch from `/sellers/export?run_id={id}&format=json`
   - Set changes as: `{ added: data.sellers.map(s => s.display_name), removed: [] }`
   - Collection runs only add sellers, never remove

3. **Entry highlight in Full History:**
   - When viewingEntry matches, apply highlight: `bg-blue-500/20 ring-1 ring-blue-500/50`
   - Remove the old bg-gray-700 highlight, use the blue highlight for consistency

4. **Initial load:**
   - When modal opens with selectedLogId or selectedRunId, fetch changes immediately
   - Set viewingEntry to match the initial selection

5. **Clean up unused imports:**
   - Remove GitCompare, Check icons (no longer used)
   - Keep Plus, Minus, Edit3 for entry badges
   - Add FileQuestion for empty state
  </action>
  <verify>
Check behavior:
- `grep -n "handleEntryClick" apps/web/src/components/admin/collection/log-detail-modal.tsx`
- `grep -n "viewingEntry" apps/web/src/components/admin/collection/log-detail-modal.tsx`
- `grep -n "FileQuestion" apps/web/src/components/admin/collection/log-detail-modal.tsx`
  </verify>
  <done>Click on any entry updates Changes panel, selected entry highlighted with blue ring, unified behavior</done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd apps/web && npm run build 2>&1 | head -50`
2. No compare mode: `grep "compareMode" apps/web/src/components/admin/collection/log-detail-modal.tsx` returns nothing
3. Changes panel exists: `grep "Changes" apps/web/src/components/admin/collection/log-detail-modal.tsx`
4. Added/Removed styling: `grep -E "green-500|red-500" apps/web/src/components/admin/collection/log-detail-modal.tsx`
</verification>

<success_criteria>
- [ ] "Sellers at this point" replaced with "Changes" panel
- [ ] Added section shows green rows with Plus icon
- [ ] Removed section shows red rows with Minus icon
- [ ] Empty sections hidden (no "Added (0)" or "Removed (0)")
- [ ] Compare mode completely removed
- [ ] Modal title is "History Entry"
- [ ] Both manual edits and collection runs work uniformly
- [ ] Selected entry highlighted in Full History list
- [ ] Empty state shows icon and message when no changes
</success_criteria>

<output>
After completion, create `.planning/phases/14-history-snapshot-simplification/14-02-SUMMARY.md`
</output>
