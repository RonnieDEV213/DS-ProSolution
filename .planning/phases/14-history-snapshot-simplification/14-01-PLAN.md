---
phase: 14-history-snapshot-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/app/routers/sellers.py
  - apps/api/src/app/services/collection.py
autonomous: true

must_haves:
  truths:
    - "Audit log entry endpoint returns added and removed arrays"
    - "Diff computed from old_value/new_value JSON fields"
    - "Handles all entry types: single add, bulk add, single remove, bulk remove, edit"
  artifacts:
    - path: "apps/api/src/app/services/collection.py"
      provides: "compute_entry_diff method"
      contains: "def compute_entry_diff"
    - path: "apps/api/src/app/routers/sellers.py"
      provides: "Extended audit-log/{log_id}/sellers endpoint"
      contains: "added.*removed"
  key_links:
    - from: "apps/api/src/app/routers/sellers.py"
      to: "apps/api/src/app/services/collection.py"
      via: "compute_entry_diff method call"
      pattern: "compute_entry_diff"
---

<objective>
Extend the existing audit log sellers endpoint to return added/removed arrays

Purpose: Frontend needs per-entry diff data to show inline +/- indicators without computing diffs client-side
Output: Extended GET /sellers/audit-log/{log_id}/sellers returns { sellers, count, added, removed }
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-history-snapshot-simplification/14-CONTEXT.md
@.planning/phases/14-history-snapshot-simplification/14-RESEARCH.md
@apps/api/src/app/services/collection.py
@apps/api/src/app/routers/sellers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compute_entry_diff method to CollectionService</name>
  <files>apps/api/src/app/services/collection.py</files>
  <action>
Add a new method `compute_entry_diff` to CollectionService that computes added/removed lists from a single audit log entry.

The method should:
1. Accept entry dict with keys: action, seller_name, old_value, new_value
2. Return tuple[list[str], list[str]] as (added, removed)
3. Handle all action types:
   - "add" (single): added = [seller_name] or [new_value.display_name]
   - "add" (bulk): added = new_value.names array
   - "remove" (single): removed = [seller_name] or [old_value.display_name]
   - "remove" (bulk): removed = old_value.names array
   - "edit": removed = [old_value.display_name], added = [seller_name]
4. Sort both lists alphabetically before returning
5. Handle JSON parse errors gracefully with fallback to seller_name

Add this method near the existing `get_sellers_at_log` method (around line 954).

Reference the pattern from 14-RESEARCH.md Code Examples section.
  </action>
  <verify>
Method exists: `grep -n "def compute_entry_diff" apps/api/src/app/services/collection.py`
Method handles all actions: `grep -A 30 "def compute_entry_diff" apps/api/src/app/services/collection.py | grep -E "add|remove|edit"`
  </verify>
  <done>CollectionService has compute_entry_diff method that handles all entry types and returns sorted (added, removed) tuple</done>
</task>

<task type="auto">
  <name>Task 2: Extend audit-log/{log_id}/sellers endpoint</name>
  <files>apps/api/src/app/routers/sellers.py, apps/api/src/app/services/collection.py</files>
  <action>
Extend the GET /sellers/audit-log/{log_id}/sellers endpoint to return added and removed arrays.

1. In CollectionService, add a new method `get_entry_diff` that:
   - Fetches the single audit log entry by log_id
   - Calls compute_entry_diff on it
   - Returns (added, removed) tuple

2. In sellers.py router, modify `get_sellers_at_log` endpoint:
   - After getting sellers list, also get the diff for this entry
   - Call service.get_entry_diff(org_id, log_id)
   - Return extended response: { sellers, count, added, removed }

New response shape:
```json
{
  "sellers": ["A", "B", "C"],
  "count": 3,
  "added": ["A"],
  "removed": []
}
```

Handle the case where entry is not found (return empty added/removed arrays).
  </action>
  <verify>
Test endpoint manually or check response shape:
- Start API: `cd apps/api && python -m uvicorn app.main:app --reload --app-dir src`
- Check endpoint returns new fields (requires auth token)
Code check: `grep -A 5 "return.*sellers.*count" apps/api/src/app/routers/sellers.py | grep -E "added|removed"`
  </verify>
  <done>Endpoint returns { sellers, count, added, removed } with diff computed from entry's old_value/new_value</done>
</task>

</tasks>

<verification>
1. API starts without errors: `cd apps/api && python -c "from app.main import app; print('OK')"`
2. New method exists: `grep "def compute_entry_diff" apps/api/src/app/services/collection.py`
3. New method exists: `grep "def get_entry_diff" apps/api/src/app/services/collection.py`
4. Endpoint returns added/removed: `grep -B 2 -A 5 '"sellers".*"count"' apps/api/src/app/routers/sellers.py`
</verification>

<success_criteria>
- [ ] compute_entry_diff method handles: add (single), add (bulk), remove (single), remove (bulk), edit
- [ ] get_entry_diff method fetches entry and calls compute_entry_diff
- [ ] Endpoint response includes added and removed arrays
- [ ] Both arrays are sorted alphabetically
- [ ] API imports and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-history-snapshot-simplification/14-01-SUMMARY.md`
</output>
