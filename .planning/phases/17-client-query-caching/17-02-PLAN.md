---
phase: 17-client-query-caching
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - apps/web/src/hooks/mutations/use-create-record.ts
  - apps/web/src/hooks/mutations/use-update-record.ts
  - apps/web/src/hooks/mutations/use-delete-record.ts
  - apps/web/src/components/bookkeeping/bookkeeping-content.tsx
  - apps/web/src/components/bookkeeping/records-table.tsx
  - apps/web/src/components/bookkeeping/add-record-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Create mutation invalidates records list cache"
    - "Update mutation invalidates records list cache"
    - "Delete mutation invalidates records list cache"
    - "Bookkeeping view uses TanStack Query for data fetching"
    - "Cache persists across navigation (no refetch when returning to page)"
  artifacts:
    - path: "apps/web/src/hooks/mutations/use-create-record.ts"
      provides: "Create record mutation with cache invalidation"
      exports: ["useCreateRecord"]
    - path: "apps/web/src/hooks/mutations/use-update-record.ts"
      provides: "Update record mutation with cache invalidation"
      exports: ["useUpdateRecord"]
    - path: "apps/web/src/hooks/mutations/use-delete-record.ts"
      provides: "Delete record mutation with cache invalidation"
      exports: ["useDeleteRecord"]
  key_links:
    - from: "apps/web/src/hooks/mutations/use-create-record.ts"
      to: "queryClient.invalidateQueries"
      via: "onSuccess callback"
      pattern: "invalidateQueries.*queryKeys\\.records"
    - from: "apps/web/src/components/bookkeeping/bookkeeping-content.tsx"
      to: "apps/web/src/hooks/queries/use-accounts.ts"
      via: "useAccounts hook call"
      pattern: "useAccounts"
    - from: "apps/web/src/components/bookkeeping/bookkeeping-content.tsx"
      to: "apps/web/src/hooks/queries/use-records-infinite.ts"
      via: "useRecordsInfinite hook call"
      pattern: "useRecordsInfinite"
---

<objective>
Create mutation hooks with cache invalidation and migrate bookkeeping view to TanStack Query

Purpose: Completes the query caching infrastructure by ensuring all data modifications automatically invalidate stale cache entries, providing instant perceived updates and consistent data.

Output: Mutation hooks for CRUD operations, bookkeeping-content.tsx migrated from useEffect/useState to TanStack Query hooks
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-client-query-caching/17-CONTEXT.md
@.planning/phases/17-client-query-caching/17-RESEARCH.md

# Query infrastructure from 17-01
@apps/web/src/lib/query-keys.ts
@apps/web/src/lib/query-client.ts
@apps/web/src/hooks/queries/use-accounts.ts
@apps/web/src/hooks/queries/use-records-infinite.ts

# Components to migrate
@apps/web/src/components/bookkeeping/bookkeeping-content.tsx
@apps/web/src/components/bookkeeping/records-table.tsx
@apps/web/src/components/bookkeeping/add-record-dialog.tsx

# API functions called by mutations
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mutation hooks with cache invalidation</name>
  <files>
    apps/web/src/hooks/mutations/use-create-record.ts
    apps/web/src/hooks/mutations/use-update-record.ts
    apps/web/src/hooks/mutations/use-delete-record.ts
  </files>
  <action>
    1. Create `apps/web/src/hooks/mutations/` directory

    2. Create `apps/web/src/hooks/mutations/use-create-record.ts`:
       - Import useMutation, useQueryClient from @tanstack/react-query
       - Import queryKeys from @/lib/query-keys
       - Import api, RecordCreate from @/lib/api
       - Export useCreateRecord(orgId: string, accountId: string) hook:
         - mutationFn: (data: RecordCreate) => api.createRecord(data)
         - onSuccess: invalidate queryKeys.records.infinite(orgId, accountId)
           - Use exact: false to match any filter variations
         - Return mutation object

    3. Create `apps/web/src/hooks/mutations/use-update-record.ts`:
       - Import useMutation, useQueryClient from @tanstack/react-query
       - Import queryKeys from @/lib/query-keys
       - Import api, RecordUpdate from @/lib/api
       - Export useUpdateRecord(orgId: string, accountId: string) hook:
         - mutationFn: ({ id, data }: { id: string; data: RecordUpdate }) => api.updateRecord(id, data)
         - onSuccess: invalidate queryKeys.records.infinite(orgId, accountId)
         - Return mutation object

    4. Create `apps/web/src/hooks/mutations/use-delete-record.ts`:
       - Import useMutation, useQueryClient from @tanstack/react-query
       - Import queryKeys from @/lib/query-keys
       - Import api from @/lib/api
       - Export useDeleteRecord(orgId: string, accountId: string) hook:
         - mutationFn: (recordId: string) => api.deleteRecord(recordId)
         - onMutate: (optional optimistic update - remove from cache immediately)
           - Cancel in-flight queries
           - Snapshot previous data
           - Remove record from cache optimistically
           - Return context with previousData
         - onError: rollback using context.previousData
         - onSettled: invalidate to ensure consistency
         - Return mutation object
  </action>
  <verify>
    - TypeScript compiles: `cd apps/web && npx tsc --noEmit`
    - All three hooks export properly
  </verify>
  <done>
    Mutation hooks created for create/update/delete with automatic cache invalidation on success
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate bookkeeping-content to TanStack Query</name>
  <files>
    apps/web/src/components/bookkeeping/bookkeeping-content.tsx
    apps/web/src/components/bookkeeping/records-table.tsx
    apps/web/src/components/bookkeeping/add-record-dialog.tsx
  </files>
  <action>
    1. Update `apps/web/src/components/bookkeeping/bookkeeping-content.tsx`:
       - Remove useState for accounts, records, loading, error
       - Remove useEffect for loading accounts
       - Remove loadRecords callback
       - Import useAccounts from @/hooks/queries/use-accounts
       - Import useRecordsInfinite from @/hooks/queries/use-records-infinite
       - Note: orgId is needed for queries - for now, use a placeholder 'default' or extract from user context
         - Add TODO: "Get orgId from user context when multi-org support added"
       - Use useAccounts() for accounts list:
         - const { data: accounts = [], isPending: accountsLoading } = useAccounts(orgId)
       - Use useRecordsInfinite() for records:
         - const { data, isPending, isFetching, error } = useRecordsInfinite(orgId, selectedAccountId, filters)
         - Extract records: data?.pages?.flatMap(page => page.items) ?? []
       - Update loading states:
         - Initial load: show skeleton when isPending
         - Background refetch: subtle spinner when isFetching && !isPending
       - Remove handleRecordUpdated, handleRecordDeleted callbacks (mutations handle invalidation)
       - Keep handleRecordAdded for dialog close behavior only (no manual cache update)
       - Remove local state updates after mutations (TanStack Query invalidation handles it)

    2. Update `apps/web/src/components/bookkeeping/records-table.tsx`:
       - Import useUpdateRecord, useDeleteRecord from mutations hooks
       - Get orgId and accountId from props or parent context
       - Replace direct api.updateRecord calls with updateMutation.mutate()
       - Replace direct api.deleteRecord calls with deleteMutation.mutate()
       - Remove onRecordUpdated, onRecordDeleted prop callbacks
       - Add loading states: disable row actions while mutation.isPending

    3. Update `apps/web/src/components/bookkeeping/add-record-dialog.tsx`:
       - Import useCreateRecord from mutations hooks
       - Get orgId from props or parent context
       - Replace direct api.createRecord call with createMutation.mutateAsync()
       - Remove onRecordAdded callback usage for cache updates (keep for dialog close)
       - Add loading state: disable form while mutation.isPending
       - Handle success: close dialog, show toast
       - Handle error: show error toast, don't close dialog
  </action>
  <verify>
    - `cd apps/web && npm run build` succeeds
    - Start dev server and test bookkeeping page:
      1. Select account - records load
      2. Navigate away and back - records load from cache (instant, no loading spinner on warm cache)
      3. Add record - list updates automatically after mutation
      4. Edit record - list updates automatically after mutation
      5. Delete record - record disappears from list
    - Open React Query Devtools - confirm cache entries exist for accounts and records
  </verify>
  <done>
    Bookkeeping view migrated to TanStack Query, mutations invalidate cache automatically, cache persists across navigation
  </done>
</task>

</tasks>

<verification>
1. Build check: `cd apps/web && npm run build` completes without errors
2. TypeScript check: `cd apps/web && npx tsc --noEmit` passes
3. Functional test:
   - Load bookkeeping page - accounts and records load
   - Navigate to another page, return - data loads instantly from cache
   - Create record - list refreshes showing new record
   - Update record - list refreshes showing changes
   - Delete record - record removed from list
4. Devtools check: Open React Query Devtools, verify cache entries for accounts and records queries
</verification>

<success_criteria>
- CACH-01 MET: TanStack Query provides query caching with stale-while-revalidate (instant loads from cache, background refetch)
- CACH-02 MET: Create/update/delete mutations automatically invalidate related list queries
- CACH-03 MET: Cache persists in memory for session duration (no re-fetch on navigation to same page)
- Deduplication WORKS: Multiple components requesting same data share single cache entry
- Loading states: Skeleton for cold start, subtle indicator for background refetch
- Error handling: Inline error display, 3 retries with exponential backoff
</success_criteria>

<output>
After completion, create `.planning/phases/17-client-query-caching/17-02-SUMMARY.md`
</output>
