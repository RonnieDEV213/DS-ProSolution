---
phase: 17-client-query-caching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/src/lib/query-client.ts
  - apps/web/src/lib/query-keys.ts
  - apps/web/src/components/providers/query-provider.tsx
  - apps/web/src/hooks/queries/use-accounts.ts
  - apps/web/src/hooks/queries/use-records-infinite.ts
  - apps/web/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "TanStack Query is installed and configured"
    - "QueryProvider wraps the application"
    - "Query hooks exist for accounts and records"
    - "Query keys are type-safe and centralized"
  artifacts:
    - path: "apps/web/src/lib/query-client.ts"
      provides: "QueryClient configuration with stale times and retry logic"
      exports: ["createQueryClient"]
    - path: "apps/web/src/lib/query-keys.ts"
      provides: "Type-safe query key factory"
      exports: ["queryKeys"]
    - path: "apps/web/src/components/providers/query-provider.tsx"
      provides: "Client component QueryProvider with devtools"
      exports: ["QueryProvider"]
    - path: "apps/web/src/hooks/queries/use-accounts.ts"
      provides: "useAccounts query hook"
      exports: ["useAccounts"]
    - path: "apps/web/src/hooks/queries/use-records-infinite.ts"
      provides: "useRecordsInfinite hook for cursor pagination"
      exports: ["useRecordsInfinite"]
  key_links:
    - from: "apps/web/src/app/layout.tsx"
      to: "apps/web/src/components/providers/query-provider.tsx"
      via: "QueryProvider wraps children"
      pattern: "<QueryProvider>"
    - from: "apps/web/src/hooks/queries/use-accounts.ts"
      to: "apps/web/src/lib/query-keys.ts"
      via: "queryKey from factory"
      pattern: "queryKeys\\.accounts"
    - from: "apps/web/src/hooks/queries/use-records-infinite.ts"
      to: "apps/web/src/lib/api.ts"
      via: "fetchAPI call"
      pattern: "api\\."
---

<objective>
Set up TanStack Query infrastructure and create query hooks for accounts and records

Purpose: Provides stale-while-revalidate caching, request deduplication, and loading state management for all list views. Forms foundation for mutation invalidation in 17-02.

Output: QueryProvider wrapping app, query key factory, query hooks for accounts and records with infinite scroll support
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-client-query-caching/17-CONTEXT.md
@.planning/phases/17-client-query-caching/17-RESEARCH.md

# Existing API functions to wrap with TanStack Query
@apps/web/src/lib/api.ts

# Root layout to add QueryProvider
@apps/web/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TanStack Query and create query infrastructure</name>
  <files>
    apps/web/package.json
    apps/web/src/lib/query-client.ts
    apps/web/src/lib/query-keys.ts
    apps/web/src/components/providers/query-provider.tsx
  </files>
  <action>
    1. Install dependencies:
       ```bash
       cd apps/web && npm install @tanstack/react-query @tanstack/react-query-devtools
       ```

    2. Create `apps/web/src/lib/query-client.ts`:
       - Export `createQueryClient()` function (not singleton - for SSR safety)
       - Configure default options:
         - staleTime: 30 * 1000 (30 seconds default)
         - gcTime: 5 * 60 * 1000 (5 minutes)
         - retry: 3 with exponential backoff (1s, 2s, 4s, max 30s)
         - refetchOnWindowFocus: true
         - refetchOnMount: true

    3. Create `apps/web/src/lib/query-keys.ts`:
       - Export `queryKeys` object with factory functions
       - Pattern: `['entity', orgId, ...scope]` for org-scoped queries
       - Include:
         - accounts.all(orgId) => ['accounts', orgId]
         - accounts.list(orgId) => ['accounts', orgId, 'list']
         - records.all(orgId) => ['records', orgId]
         - records.list(orgId, accountId, filters?) => ['records', orgId, accountId, 'list', filters]
         - records.infinite(orgId, accountId, filters?) => ['records', orgId, accountId, 'infinite', filters]
       - Use `as const` for type safety
       - Export filter types (RecordFilters)

    4. Create `apps/web/src/components/providers/` directory

    5. Create `apps/web/src/components/providers/query-provider.tsx`:
       - 'use client' directive (must be client component)
       - Use useState(() => createQueryClient()) pattern for SSR safety
       - Wrap children with QueryClientProvider
       - Include ReactQueryDevtools (initialIsOpen: false)
  </action>
  <verify>
    - npm list @tanstack/react-query shows version 5.x installed
    - Files exist at expected paths
    - TypeScript compiles: `cd apps/web && npx tsc --noEmit`
  </verify>
  <done>
    TanStack Query installed, query client configured with stale times and retry logic, query key factory provides type-safe keys, QueryProvider ready to wrap app
  </done>
</task>

<task type="auto">
  <name>Task 2: Create query hooks and integrate QueryProvider</name>
  <files>
    apps/web/src/hooks/queries/use-accounts.ts
    apps/web/src/hooks/queries/use-records-infinite.ts
    apps/web/src/app/layout.tsx
  </files>
  <action>
    1. Create `apps/web/src/hooks/queries/` directory

    2. Create `apps/web/src/hooks/queries/use-accounts.ts`:
       - Import useQuery from @tanstack/react-query
       - Import queryKeys from @/lib/query-keys
       - Import api from @/lib/api
       - Export useAccounts(orgId: string) hook:
         - queryKey: queryKeys.accounts.list(orgId)
         - queryFn: () => api.getAccounts()
         - staleTime: 5 * 60 * 1000 (accounts rarely change - 5 min)
       - Return query result with typed Account[]

    3. Create `apps/web/src/hooks/queries/use-records-infinite.ts`:
       - Import useInfiniteQuery from @tanstack/react-query
       - Import queryKeys from @/lib/query-keys
       - Note: This hook is a PLACEHOLDER for Phase 18 sync endpoint integration
       - For now, use existing api.getRecords (not cursor-paginated yet)
       - Export useRecordsInfinite(orgId, accountId, filters?) hook:
         - queryKey: queryKeys.records.infinite(orgId, accountId, filters)
         - queryFn: For now, wrap api.getRecords to return format compatible with infinite query
           - Return { items: records, nextCursor: null, hasMore: false }
         - initialPageParam: null
         - getNextPageParam: (lastPage) => lastPage.hasMore ? lastPage.nextCursor : undefined
         - staleTime: 30 * 1000 (records change frequently)
       - Add TODO comment: "Replace with sync endpoint when Phase 18 wires IndexedDB"

    4. Update `apps/web/src/app/layout.tsx`:
       - Import QueryProvider from @/components/providers/query-provider
       - Wrap children with QueryProvider (inside TooltipProvider, outside Toaster)
       - Keep existing structure intact
  </action>
  <verify>
    - `cd apps/web && npm run build` succeeds
    - `cd apps/web && npm run dev` starts without errors
    - Open http://localhost:3000 in browser, open React Query Devtools (floating button)
  </verify>
  <done>
    useAccounts and useRecordsInfinite hooks created, QueryProvider wraps app in layout, devtools accessible in development
  </done>
</task>

</tasks>

<verification>
1. Dependency check: `cd apps/web && npm list @tanstack/react-query` shows 5.x
2. Build check: `cd apps/web && npm run build` completes without errors
3. TypeScript check: `cd apps/web && npx tsc --noEmit` passes
4. Runtime check: Start dev server, confirm no console errors, devtools button visible
</verification>

<success_criteria>
- TanStack Query v5 installed in apps/web
- QueryProvider wraps entire application
- Query key factory provides type-safe keys scoped by orgId
- useAccounts hook queries accounts with 5-minute stale time
- useRecordsInfinite hook ready for cursor pagination (placeholder for Phase 18)
- React Query Devtools accessible in development mode
- Existing functionality unaffected (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/17-client-query-caching/17-01-SUMMARY.md`
</output>
