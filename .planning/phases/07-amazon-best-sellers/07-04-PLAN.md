---
phase: 07-amazon-best-sellers
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - apps/web/src/components/admin/collection/amazon-category-selector.tsx
  - apps/web/src/components/admin/collection/category-preset-dropdown.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view Amazon departments with collapsible category sublists"
    - "Admin can toggle individual categories or entire departments"
    - "Admin can search/filter categories by name"
    - "Admin can see selection count badge"
    - "Admin can select presets from dropdown"
    - "Admin can save current selection as custom preset"
    - "Admin can delete custom presets"
  artifacts:
    - path: "apps/web/src/components/admin/collection/amazon-category-selector.tsx"
      provides: "Category selection UI with search and department headers"
      exports: ["AmazonCategorySelector"]
    - path: "apps/web/src/components/admin/collection/category-preset-dropdown.tsx"
      provides: "Preset dropdown with save/delete functionality"
      exports: ["CategoryPresetDropdown"]
  key_links:
    - from: "amazon-category-selector.tsx"
      to: "/amazon/categories"
      via: "fetch on mount"
      pattern: "fetch.*amazon/categories"
    - from: "category-preset-dropdown.tsx"
      to: "/amazon/presets"
      via: "fetch and POST/DELETE"
      pattern: "amazon/presets"
---

<objective>
Build the Amazon category selection UI with department hierarchy, search filtering, and preset management dropdown.

Purpose: Provide the visual interface for admin to select which Amazon categories to include in collection runs. Implements all CONTEXT.md requirements: collapsible departments, search, presets, selection count.

Output: Two React components - category selector and preset dropdown
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-amazon-best-sellers/07-CONTEXT.md
@apps/web/src/components/admin/department-role-dialog.tsx
@apps/web/src/components/admin/collection/run-config-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CategoryPresetDropdown component</name>
  <files>apps/web/src/components/admin/collection/category-preset-dropdown.tsx</files>
  <action>
Create the preset dropdown component for selecting and managing category presets.

Features:
- Dropdown showing available presets (built-in "Select All" + custom)
- "Save as preset" option that opens inline name input
- Delete icon on custom presets (not on built-in)
- Auto-refresh after save/delete

```tsx
"use client";

import { useState } from "react";
import { createClient } from "@/lib/supabase/client";
import { toast } from "sonner";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { ChevronDown, Save, Trash2, X } from "lucide-react";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface Preset {
  id: string;
  name: string;
  category_ids: string[];
  is_builtin: boolean;
}

interface CategoryPresetDropdownProps {
  presets: Preset[];
  selectedCategoryIds: string[];
  allCategoryIds: string[];
  onPresetSelect: (categoryIds: string[]) => void;
  onPresetsChange: () => void;
}

export function CategoryPresetDropdown({
  presets,
  selectedCategoryIds,
  allCategoryIds,
  onPresetSelect,
  onPresetsChange,
}: CategoryPresetDropdownProps) {
  const [showSaveInput, setShowSaveInput] = useState(false);
  const [newPresetName, setNewPresetName] = useState("");
  const [saving, setSaving] = useState(false);
  const [deletingId, setDeletingId] = useState<string | null>(null);

  const supabase = createClient();

  const handleSelectAll = () => {
    onPresetSelect(allCategoryIds);
  };

  const handlePresetClick = (preset: Preset) => {
    if (preset.name === "Select All") {
      handleSelectAll();
    } else {
      onPresetSelect(preset.category_ids);
    }
  };

  const handleSavePreset = async () => {
    if (!newPresetName.trim()) {
      toast.error("Please enter a preset name");
      return;
    }

    if (selectedCategoryIds.length === 0) {
      toast.error("Select at least one category first");
      return;
    }

    setSaving(true);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast.error("Not authenticated");
        return;
      }

      const response = await fetch(`${API_BASE}/amazon/presets`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({
          name: newPresetName.trim(),
          category_ids: selectedCategoryIds,
        }),
      });

      if (response.status === 409) {
        toast.error("A preset with this name already exists");
        return;
      }

      if (!response.ok) {
        throw new Error("Failed to save preset");
      }

      toast.success(`Preset "${newPresetName}" saved`);
      setNewPresetName("");
      setShowSaveInput(false);
      onPresetsChange();
    } catch (err) {
      toast.error(err instanceof Error ? err.message : "Failed to save preset");
    } finally {
      setSaving(false);
    }
  };

  const handleDeletePreset = async (preset: Preset, e: React.MouseEvent) => {
    e.stopPropagation();

    if (preset.is_builtin) return;

    setDeletingId(preset.id);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const response = await fetch(`${API_BASE}/amazon/presets/${preset.id}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      if (!response.ok) {
        throw new Error("Failed to delete preset");
      }

      toast.success(`Preset "${preset.name}" deleted`);
      onPresetsChange();
    } catch (err) {
      toast.error(err instanceof Error ? err.message : "Failed to delete preset");
    } finally {
      setDeletingId(null);
    }
  };

  // Find current selection in presets
  const currentPreset = presets.find(
    (p) =>
      p.category_ids.length === selectedCategoryIds.length &&
      p.category_ids.every((id) => selectedCategoryIds.includes(id))
  );

  return (
    <div className="flex items-center gap-2">
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline" className="border-gray-700 bg-gray-800">
            {currentPreset?.name || "Select preset..."}
            <ChevronDown className="ml-2 h-4 w-4" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent className="w-56 bg-gray-800 border-gray-700">
          {/* Select All (always first) */}
          <DropdownMenuItem
            onClick={handleSelectAll}
            className="cursor-pointer"
          >
            Select All
          </DropdownMenuItem>

          {/* Custom presets */}
          {presets.filter((p) => !p.is_builtin && p.name !== "Select All").length > 0 && (
            <>
              <DropdownMenuSeparator className="bg-gray-700" />
              {presets
                .filter((p) => !p.is_builtin && p.name !== "Select All")
                .map((preset) => (
                  <DropdownMenuItem
                    key={preset.id}
                    onClick={() => handlePresetClick(preset)}
                    className="cursor-pointer flex justify-between"
                  >
                    <span>{preset.name}</span>
                    <button
                      onClick={(e) => handleDeletePreset(preset, e)}
                      className="text-gray-500 hover:text-red-400 ml-2"
                      disabled={deletingId === preset.id}
                    >
                      <Trash2 className="h-4 w-4" />
                    </button>
                  </DropdownMenuItem>
                ))}
            </>
          )}
        </DropdownMenuContent>
      </DropdownMenu>

      {/* Save as preset */}
      {showSaveInput ? (
        <div className="flex items-center gap-2">
          <Input
            value={newPresetName}
            onChange={(e) => setNewPresetName(e.target.value)}
            placeholder="Preset name..."
            className="w-40 h-9 bg-gray-800 border-gray-700"
            onKeyDown={(e) => {
              if (e.key === "Enter") handleSavePreset();
              if (e.key === "Escape") {
                setShowSaveInput(false);
                setNewPresetName("");
              }
            }}
          />
          <Button
            size="sm"
            onClick={handleSavePreset}
            disabled={saving}
          >
            <Save className="h-4 w-4" />
          </Button>
          <Button
            size="sm"
            variant="ghost"
            onClick={() => {
              setShowSaveInput(false);
              setNewPresetName("");
            }}
          >
            <X className="h-4 w-4" />
          </Button>
        </div>
      ) : (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => setShowSaveInput(true)}
          className="text-gray-400"
        >
          <Save className="h-4 w-4 mr-1" />
          Save preset
        </Button>
      )}
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit src/components/admin/collection/category-preset-dropdown.tsx 2>&1 | head -20`</verify>
  <done>CategoryPresetDropdown component handles preset selection, save, and delete</done>
</task>

<task type="auto">
  <name>Task 2: Create AmazonCategorySelector component</name>
  <files>apps/web/src/components/admin/collection/amazon-category-selector.tsx</files>
  <action>
Create the main category selector component with department hierarchy, search, and collapsible sections.

Features per CONTEXT.md:
- Department headers with collapsible category sublists
- Clicking department toggles all children
- Search box at top to filter categories
- Checkboxes + selection count badge
- Integrates with CategoryPresetDropdown

```tsx
"use client";

import { useState, useEffect, useMemo, useCallback } from "react";
import { createClient } from "@/lib/supabase/client";
import { cn } from "@/lib/utils";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import { Badge } from "@/components/ui/badge";
import { ChevronDown, ChevronRight, Search } from "lucide-react";
import { CategoryPresetDropdown } from "./category-preset-dropdown";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface Category {
  id: string;
  name: string;
  node_id: string;
}

interface Department {
  id: string;
  name: string;
  node_id: string;
  categories: Category[];
}

interface Preset {
  id: string;
  name: string;
  category_ids: string[];
  is_builtin: boolean;
}

interface AmazonCategorySelectorProps {
  selectedCategoryIds: string[];
  onSelectionChange: (categoryIds: string[]) => void;
}

export function AmazonCategorySelector({
  selectedCategoryIds,
  onSelectionChange,
}: AmazonCategorySelectorProps) {
  const [departments, setDepartments] = useState<Department[]>([]);
  const [presets, setPresets] = useState<Preset[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [expandedDepts, setExpandedDepts] = useState<Set<string>>(new Set());

  const supabase = createClient();

  // Fetch departments and presets
  const fetchData = useCallback(async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const headers = { Authorization: `Bearer ${session.access_token}` };

      // Fetch in parallel
      const [categoriesRes, presetsRes] = await Promise.all([
        fetch(`${API_BASE}/amazon/categories`, { headers }),
        fetch(`${API_BASE}/amazon/presets`, { headers }),
      ]);

      if (categoriesRes.ok) {
        const data = await categoriesRes.json();
        setDepartments(data.departments || []);
      }

      if (presetsRes.ok) {
        const data = await presetsRes.json();
        setPresets(data.presets || []);
      }
    } catch (err) {
      console.error("Failed to fetch categories:", err);
    } finally {
      setLoading(false);
    }
  }, [supabase.auth]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // Get all category IDs for "Select All"
  const allCategoryIds = useMemo(() => {
    return departments.flatMap((dept) =>
      dept.categories.map((cat) => cat.id)
    );
  }, [departments]);

  // Filter departments based on search
  const filteredDepartments = useMemo(() => {
    if (!searchQuery.trim()) return departments;

    const query = searchQuery.toLowerCase();
    return departments
      .map((dept) => {
        const deptMatches = dept.name.toLowerCase().includes(query);
        const matchingCats = dept.categories.filter((cat) =>
          cat.name.toLowerCase().includes(query)
        );

        // Include department if it matches or has matching categories
        if (deptMatches || matchingCats.length > 0) {
          return {
            ...dept,
            // If department matches, show all categories; otherwise show only matching
            categories: deptMatches ? dept.categories : matchingCats,
          };
        }
        return null;
      })
      .filter((dept): dept is Department => dept !== null);
  }, [departments, searchQuery]);

  // Toggle department expansion
  const toggleExpanded = (deptId: string) => {
    setExpandedDepts((prev) => {
      const next = new Set(prev);
      if (next.has(deptId)) {
        next.delete(deptId);
      } else {
        next.add(deptId);
      }
      return next;
    });
  };

  // Toggle all categories in a department
  const toggleDepartment = (dept: Department) => {
    const deptCategoryIds = dept.categories.map((c) => c.id);
    const allSelected = deptCategoryIds.every((id) =>
      selectedCategoryIds.includes(id)
    );

    if (allSelected) {
      // Deselect all in department
      onSelectionChange(
        selectedCategoryIds.filter((id) => !deptCategoryIds.includes(id))
      );
    } else {
      // Select all in department
      const newSelection = new Set([...selectedCategoryIds, ...deptCategoryIds]);
      onSelectionChange(Array.from(newSelection));
    }
  };

  // Toggle single category
  const toggleCategory = (categoryId: string) => {
    if (selectedCategoryIds.includes(categoryId)) {
      onSelectionChange(selectedCategoryIds.filter((id) => id !== categoryId));
    } else {
      onSelectionChange([...selectedCategoryIds, categoryId]);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center p-8 text-gray-400">
        Loading categories...
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Header with preset dropdown and selection count */}
      <div className="flex items-center justify-between">
        <CategoryPresetDropdown
          presets={presets}
          selectedCategoryIds={selectedCategoryIds}
          allCategoryIds={allCategoryIds}
          onPresetSelect={onSelectionChange}
          onPresetsChange={fetchData}
        />
        <Badge variant="secondary" className="bg-gray-700 text-gray-200">
          {selectedCategoryIds.length} selected
        </Badge>
      </div>

      {/* Search box */}
      <div className="relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" />
        <Input
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          placeholder="Search categories..."
          className="pl-9 bg-gray-800 border-gray-700"
        />
      </div>

      {/* Department list */}
      <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2">
        {filteredDepartments.map((dept) => {
          const deptCategoryIds = dept.categories.map((c) => c.id);
          const selectedInDept = deptCategoryIds.filter((id) =>
            selectedCategoryIds.includes(id)
          ).length;
          const allSelected = selectedInDept === deptCategoryIds.length;
          const someSelected = selectedInDept > 0 && !allSelected;
          const isExpanded = expandedDepts.has(dept.id);

          return (
            <div
              key={dept.id}
              className="bg-gray-800 rounded-lg overflow-hidden"
            >
              {/* Department header */}
              <div
                className="flex items-center gap-2 p-3 cursor-pointer hover:bg-gray-750"
                onClick={() => toggleExpanded(dept.id)}
              >
                {/* Expand/collapse icon */}
                {isExpanded ? (
                  <ChevronDown className="h-4 w-4 text-gray-400" />
                ) : (
                  <ChevronRight className="h-4 w-4 text-gray-400" />
                )}

                {/* Department checkbox */}
                <div
                  onClick={(e) => {
                    e.stopPropagation();
                    toggleDepartment(dept);
                  }}
                >
                  <Checkbox
                    checked={allSelected}
                    className={cn(
                      someSelected && "opacity-50 data-[state=checked]:opacity-100"
                    )}
                  />
                </div>

                {/* Department name and count */}
                <span className="flex-1 font-medium text-white">
                  {dept.name}
                </span>
                <span className="text-sm text-gray-500">
                  {selectedInDept}/{deptCategoryIds.length}
                </span>
              </div>

              {/* Category list (collapsible) */}
              {isExpanded && (
                <div className="px-3 pb-3 space-y-1 ml-6">
                  {dept.categories.map((cat) => {
                    const isSelected = selectedCategoryIds.includes(cat.id);
                    return (
                      <div
                        key={cat.id}
                        className={cn(
                          "flex items-center gap-2 p-2 rounded cursor-pointer",
                          "hover:bg-gray-700",
                          isSelected && "bg-gray-700/50"
                        )}
                        onClick={() => toggleCategory(cat.id)}
                      >
                        <Checkbox checked={isSelected} />
                        <span className="text-sm text-gray-300">{cat.name}</span>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}

        {filteredDepartments.length === 0 && (
          <div className="text-center py-8 text-gray-500">
            No categories match your search.
          </div>
        )}
      </div>
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/web && npx tsc --noEmit src/components/admin/collection/amazon-category-selector.tsx 2>&1 | head -20`</verify>
  <done>AmazonCategorySelector component displays department hierarchy with search, expand/collapse, and preset integration</done>
</task>

</tasks>

<verification>
1. Both components compile without TypeScript errors
2. CategoryPresetDropdown handles preset CRUD
3. AmazonCategorySelector fetches from /amazon/categories and /amazon/presets
4. Search filtering works on category names
5. Department toggle selects/deselects all child categories
6. Selection count badge updates correctly
7. All files committed to git
</verification>

<success_criteria>
- [ ] CategoryPresetDropdown shows presets in dropdown
- [ ] CategoryPresetDropdown allows saving new presets
- [ ] CategoryPresetDropdown allows deleting custom presets
- [ ] AmazonCategorySelector displays departments with collapsible categories
- [ ] AmazonCategorySelector search filters categories by name
- [ ] AmazonCategorySelector department click toggles all children
- [ ] AmazonCategorySelector shows selection count badge
</success_criteria>

<output>
After completion, create `.planning/phases/07-amazon-best-sellers/07-04-SUMMARY.md`
</output>
