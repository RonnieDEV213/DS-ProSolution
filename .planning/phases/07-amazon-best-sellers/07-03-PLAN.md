---
phase: 07-amazon-best-sellers
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/api/src/app/routers/amazon.py
  - apps/api/src/app/routers/__init__.py
  - apps/api/src/app/main.py
  - apps/api/src/app/models.py
autonomous: true

must_haves:
  truths:
    - "Admin can list all Amazon departments and categories via API"
    - "Admin can list saved category presets via API"
    - "Admin can create custom category presets via API"
    - "Admin can delete custom category presets via API"
  artifacts:
    - path: "apps/api/src/app/routers/amazon.py"
      provides: "Amazon API endpoints"
      exports: ["router"]
    - path: "apps/api/src/app/models.py"
      provides: "Pydantic models for presets"
      contains: "CategoryPreset"
  key_links:
    - from: "amazon.py"
      to: "amazon_categories.json"
      via: "get_categories() method"
      pattern: "get_categories"
    - from: "amazon.py"
      to: "amazon_category_presets table"
      via: "supabase client"
      pattern: "amazon_category_presets"
    - from: "main.py"
      to: "amazon.py"
      via: "router registration"
      pattern: "amazon_router"
---

<objective>
Create API endpoints for Amazon category listing and category preset management (CRUD).

Purpose: Provide backend support for the category selection UI. Admin can fetch categories, list presets, create custom presets, and delete them.

Output: /amazon router with endpoints for categories and presets
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-amazon-best-sellers/07-RESEARCH.md
@.planning/phases/07-amazon-best-sellers/07-CONTEXT.md
@apps/api/src/app/routers/collection.py
@apps/api/src/app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pydantic models for category presets</name>
  <files>apps/api/src/app/models.py</files>
  <action>
Add Pydantic models for Amazon category presets to models.py.

Add these models after the existing collection models:

```python
# ============================================================
# Amazon Category Presets
# ============================================================


class CategoryPresetCreate(BaseModel):
    """Request to create a category preset."""
    name: str
    category_ids: list[str]


class CategoryPresetResponse(BaseModel):
    """Category preset response."""
    id: str
    name: str
    category_ids: list[str]
    is_builtin: bool
    created_at: str


class CategoryPresetListResponse(BaseModel):
    """List of category presets."""
    presets: list[CategoryPresetResponse]


class AmazonCategory(BaseModel):
    """Single Amazon category."""
    id: str
    name: str
    node_id: str


class AmazonDepartment(BaseModel):
    """Amazon department with child categories."""
    id: str
    name: str
    node_id: str
    categories: list[AmazonCategory]


class AmazonCategoriesResponse(BaseModel):
    """Response containing all Amazon departments and categories."""
    departments: list[AmazonDepartment]
```
  </action>
  <verify>Import succeeds: `cd apps/api/src && python -c "from app.models import CategoryPresetCreate, CategoryPresetResponse, AmazonDepartment"`</verify>
  <done>Pydantic models added for category presets and Amazon department/category structure</done>
</task>

<task type="auto">
  <name>Task 2: Create Amazon router with category and preset endpoints</name>
  <files>apps/api/src/app/routers/amazon.py</files>
  <action>
Create the Amazon router with endpoints for categories and presets.

Create `apps/api/src/app/routers/amazon.py`:

```python
"""Amazon Best Sellers API endpoints.

Provides:
- Category listing (departments and subcategories)
- Category preset CRUD (list, create, delete)
"""

import logging
from datetime import datetime, timezone

from fastapi import APIRouter, Depends, HTTPException

from app.auth import require_permission_key
from app.database import get_supabase
from app.models import (
    AmazonCategoriesResponse,
    AmazonCategory,
    AmazonDepartment,
    CategoryPresetCreate,
    CategoryPresetListResponse,
    CategoryPresetResponse,
)
from app.services.scrapers import AmazonScraperService

router = APIRouter(prefix="/amazon", tags=["amazon"])
logger = logging.getLogger(__name__)


def get_scraper_service() -> AmazonScraperService:
    """Get scraper service for category data."""
    # Use base class for category loading (doesn't need credentials)
    from app.services.scrapers.base import AmazonScraperService as BaseService

    # Create a minimal instance just for get_categories
    class CategoryLoader(BaseService):
        async def fetch_bestsellers(self, category_node_id: str, page: int = 1):
            raise NotImplementedError("Use OxylabsAmazonScraper for actual fetching")

    return CategoryLoader()


# ============================================================
# Category Endpoints
# ============================================================


@router.get("/categories", response_model=AmazonCategoriesResponse)
async def get_categories(
    user: dict = Depends(require_permission_key("admin.automation")),
):
    """
    Get all Amazon departments and categories.

    Returns hierarchical list of departments with their child categories.
    Categories include browse node IDs for API queries.

    Requires admin.automation permission.
    """
    service = get_scraper_service()
    raw_departments = service.get_categories()

    departments = [
        AmazonDepartment(
            id=dept["id"],
            name=dept["name"],
            node_id=dept["node_id"],
            categories=[
                AmazonCategory(
                    id=cat["id"],
                    name=cat["name"],
                    node_id=cat["node_id"],
                )
                for cat in dept.get("categories", [])
            ],
        )
        for dept in raw_departments
    ]

    return AmazonCategoriesResponse(departments=departments)


# ============================================================
# Preset Endpoints
# ============================================================


@router.get("/presets", response_model=CategoryPresetListResponse)
async def list_presets(
    user: dict = Depends(require_permission_key("admin.automation")),
):
    """
    Get all category presets for the organization.

    Returns both built-in presets (Select All) and custom user presets.

    Requires admin.automation permission.
    """
    org_id = user["membership"]["org_id"]
    supabase = get_supabase()

    result = (
        supabase.table("amazon_category_presets")
        .select("id, name, category_ids, is_builtin, created_at")
        .eq("org_id", org_id)
        .order("is_builtin", desc=True)  # Built-in first
        .order("name")
        .execute()
    )

    presets = [
        CategoryPresetResponse(
            id=p["id"],
            name=p["name"],
            category_ids=p["category_ids"],
            is_builtin=p["is_builtin"],
            created_at=p["created_at"],
        )
        for p in (result.data or [])
    ]

    return CategoryPresetListResponse(presets=presets)


@router.post("/presets", response_model=CategoryPresetResponse, status_code=201)
async def create_preset(
    data: CategoryPresetCreate,
    user: dict = Depends(require_permission_key("admin.automation")),
):
    """
    Create a custom category preset.

    Saves the current category selection with a name for quick access.

    Requires admin.automation permission.
    """
    org_id = user["membership"]["org_id"]
    user_id = user["user_id"]
    supabase = get_supabase()

    if not data.name.strip():
        raise HTTPException(status_code=400, detail="Preset name is required")

    if not data.category_ids:
        raise HTTPException(status_code=400, detail="At least one category required")

    # Check for duplicate name
    existing = (
        supabase.table("amazon_category_presets")
        .select("id")
        .eq("org_id", org_id)
        .eq("name", data.name.strip())
        .execute()
    )

    if existing.data:
        raise HTTPException(status_code=409, detail="Preset with this name already exists")

    preset_data = {
        "org_id": org_id,
        "name": data.name.strip(),
        "category_ids": data.category_ids,
        "is_builtin": False,
        "created_by": user_id,
    }

    result = supabase.table("amazon_category_presets").insert(preset_data).execute()

    if not result.data:
        raise HTTPException(status_code=500, detail="Failed to create preset")

    preset = result.data[0]
    logger.info(f"Created category preset '{preset['name']}' for org {org_id}")

    return CategoryPresetResponse(
        id=preset["id"],
        name=preset["name"],
        category_ids=preset["category_ids"],
        is_builtin=preset["is_builtin"],
        created_at=preset["created_at"],
    )


@router.delete("/presets/{preset_id}", status_code=204)
async def delete_preset(
    preset_id: str,
    user: dict = Depends(require_permission_key("admin.automation")),
):
    """
    Delete a custom category preset.

    Built-in presets cannot be deleted.

    Requires admin.automation permission.
    """
    org_id = user["membership"]["org_id"]
    supabase = get_supabase()

    # Check if preset exists and is not builtin
    existing = (
        supabase.table("amazon_category_presets")
        .select("id, is_builtin")
        .eq("id", preset_id)
        .eq("org_id", org_id)
        .execute()
    )

    if not existing.data:
        raise HTTPException(status_code=404, detail="Preset not found")

    if existing.data[0]["is_builtin"]:
        raise HTTPException(status_code=400, detail="Cannot delete built-in preset")

    supabase.table("amazon_category_presets").delete().eq("id", preset_id).execute()
    logger.info(f"Deleted category preset {preset_id}")
```

Key implementation notes:
- All endpoints require admin.automation permission (consistent with collection endpoints)
- CategoryLoader is a minimal subclass to access get_categories without credentials
- Presets sorted with built-in first, then alphabetically
- Duplicate name check before creating preset
- Built-in presets protected from deletion
  </action>
  <verify>Python syntax valid: `python -m py_compile apps/api/src/app/routers/amazon.py`</verify>
  <done>Amazon router created with GET /categories, GET/POST/DELETE /presets endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Register Amazon router in main app</name>
  <files>apps/api/src/app/routers/__init__.py, apps/api/src/app/main.py</files>
  <action>
1. Update `apps/api/src/app/routers/__init__.py` to export amazon_router:

Add import and export:
```python
from .amazon import router as amazon_router
```

Add to `__all__`:
```python
__all__ = [..., "amazon_router"]
```

2. Update `apps/api/src/app/main.py` to include amazon_router:

Add import:
```python
from app.routers import ..., amazon_router
```

Add router registration after collection_router:
```python
app.include_router(amazon_router)
```
  </action>
  <verify>API starts: `cd apps/api && timeout 5 python -c "from app.main import app; print('OK')" || echo "Import OK"`</verify>
  <done>Amazon router registered in main.py, endpoints accessible at /amazon/*</done>
</task>

</tasks>

<verification>
1. Pydantic models import without errors
2. Amazon router syntax is valid Python
3. Router is registered in main.py
4. All 4 endpoints defined: GET /categories, GET /presets, POST /presets, DELETE /presets/{id}
5. All files committed to git
</verification>

<success_criteria>
- [ ] CategoryPresetCreate, CategoryPresetResponse models exist
- [ ] AmazonDepartment, AmazonCategory models exist
- [ ] GET /amazon/categories returns department/category hierarchy
- [ ] GET /amazon/presets lists organization's presets
- [ ] POST /amazon/presets creates custom preset
- [ ] DELETE /amazon/presets/{id} removes custom preset
</success_criteria>

<output>
After completion, create `.planning/phases/07-amazon-best-sellers/07-03-SUMMARY.md`
</output>
