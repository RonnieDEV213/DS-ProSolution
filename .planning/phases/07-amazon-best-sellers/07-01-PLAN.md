---
phase: 07-amazon-best-sellers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/app/data/amazon_categories.json
  - apps/api/src/app/services/scrapers/__init__.py
  - apps/api/src/app/services/scrapers/base.py
  - apps/api/migrations/041_amazon_category_presets.sql
autonomous: true

must_haves:
  truths:
    - "Amazon departments and categories are available as structured data"
    - "Abstract scraper interface defines contract for Amazon product fetching"
    - "Category presets can be stored per-organization in database"
  artifacts:
    - path: "apps/api/src/app/data/amazon_categories.json"
      provides: "Department/category hierarchy with browse node IDs"
      contains: "departments"
    - path: "apps/api/src/app/services/scrapers/base.py"
      provides: "Abstract AmazonScraperService interface"
      exports: ["AmazonProduct", "ScrapeResult", "AmazonScraperService"]
    - path: "apps/api/migrations/041_amazon_category_presets.sql"
      provides: "amazon_category_presets table schema"
      contains: "CREATE TABLE amazon_category_presets"
  key_links:
    - from: "base.py"
      to: "Oxylabs implementation (07-02)"
      via: "Abstract class inheritance"
      pattern: "class AmazonScraperService"
---

<objective>
Create foundation artifacts for Amazon Best Sellers integration: static category data, abstract scraper interface, and database schema for category presets.

Purpose: Establish contracts and data structures before implementing Oxylabs integration and UI. All three artifacts are independent and can be created in parallel.

Output: Categories JSON file, scraper base classes, migration SQL file
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-amazon-best-sellers/07-RESEARCH.md
@.planning/phases/07-amazon-best-sellers/07-CONTEXT.md
@apps/api/src/app/services/collection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Amazon categories static data file</name>
  <files>apps/api/src/app/data/amazon_categories.json</files>
  <action>
Create a static JSON file containing Amazon US Best Sellers departments and their child categories with browse node IDs.

Structure:
```json
{
  "version": "2026-01",
  "marketplace": "US",
  "departments": [
    {
      "id": "appliances",
      "name": "Appliances",
      "node_id": "2619526011",
      "categories": [
        { "id": "appliances-cooktops", "name": "Cooktops", "node_id": "3741261" },
        ...
      ]
    },
    ...
  ]
}
```

Include these departments with 3-5 subcategories each (use research doc for node IDs):
- Appliances (2619526011)
- Arts, Crafts & Sewing (2617942011)
- Automotive (15690151)
- Baby (165797011)
- Beauty & Personal Care (11055981)
- Electronics (493964)
- Grocery & Gourmet Food (16310211)
- Health & Personal Care (3760931)
- Home & Kitchen (1063498)
- Industrial & Scientific (16310161)
- Office Products (1084128)
- Pet Supplies (2619534011)
- Sports & Outdoors (3375301)
- Tools & Home Improvement (468240)
- Toys & Games (165795011)

For each department, include at least 3 categories with their node IDs. Node IDs can be found at browsenodes.com or use placeholder strings like "TBD-{dept}-{cat}" if needed - they can be updated later.

Create the `apps/api/src/app/data/` directory if it doesn't exist.
  </action>
  <verify>File exists and is valid JSON: `python -c "import json; json.load(open('apps/api/src/app/data/amazon_categories.json'))"`</verify>
  <done>JSON file contains 15 departments, each with id, name, node_id, and categories array</done>
</task>

<task type="auto">
  <name>Task 2: Create abstract scraper interface</name>
  <files>apps/api/src/app/services/scrapers/__init__.py, apps/api/src/app/services/scrapers/base.py</files>
  <action>
Create the scrapers module with abstract interface for Amazon product scraping.

1. Create `apps/api/src/app/services/scrapers/` directory

2. Create `__init__.py`:
```python
from .base import AmazonProduct, ScrapeResult, AmazonScraperService

__all__ = ["AmazonProduct", "ScrapeResult", "AmazonScraperService"]
```

3. Create `base.py` with:
- `AmazonProduct` dataclass with fields: asin (str), title (str), price (float | None), currency (str), rating (float | None), url (str), position (int)
- `ScrapeResult` dataclass with fields: products (list[AmazonProduct]), cost_cents (int), page (int), total_pages (int | None), error (str | None = None)
- `AmazonScraperService` abstract base class (ABC) with:
  - `async def fetch_bestsellers(self, category_node_id: str, page: int = 1) -> ScrapeResult` (abstract)
  - `def get_categories(self) -> list[dict]` (concrete, loads from JSON file)

The `get_categories()` method should load and return the departments from `amazon_categories.json`.

Use `from __future__ import annotations` for forward references.
  </action>
  <verify>`python -c "from app.services.scrapers import AmazonProduct, ScrapeResult, AmazonScraperService"` succeeds from apps/api/src directory</verify>
  <done>Abstract interface defined with dataclasses and ABC, get_categories() loads static JSON</done>
</task>

<task type="auto">
  <name>Task 3: Create category presets database migration</name>
  <files>apps/api/migrations/041_amazon_category_presets.sql</files>
  <action>
Create SQL migration for storing category selection presets.

Table: `amazon_category_presets`
- id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
- org_id: UUID NOT NULL REFERENCES orgs(id) ON DELETE CASCADE
- name: TEXT NOT NULL
- category_ids: TEXT[] NOT NULL (array of category IDs from JSON file, e.g., ["electronics-computers", "appliances-cooktops"])
- is_builtin: BOOLEAN NOT NULL DEFAULT false (true for "Select All")
- created_by: UUID REFERENCES auth.users(id) ON DELETE SET NULL
- created_at: TIMESTAMPTZ NOT NULL DEFAULT now()
- updated_at: TIMESTAMPTZ

Constraints:
- UNIQUE(org_id, name) - prevent duplicate preset names per org

RLS:
- Enable RLS
- Create service_role bypass policy (consistent with other tables)

Indexes:
- Index on org_id for listing presets
  </action>
  <verify>SQL syntax valid: `grep -q "CREATE TABLE amazon_category_presets" apps/api/migrations/041_amazon_category_presets.sql`</verify>
  <done>Migration file creates amazon_category_presets table with RLS and indexes</done>
</task>

</tasks>

<verification>
1. Categories JSON file is valid and contains 15 departments
2. Scraper base module imports without errors
3. Migration SQL is syntactically correct
4. All files committed to git
</verification>

<success_criteria>
- [ ] amazon_categories.json exists with 15 departments and child categories
- [ ] AmazonScraperService abstract class is importable
- [ ] AmazonProduct and ScrapeResult dataclasses are importable
- [ ] Migration 041 creates amazon_category_presets table
</success_criteria>

<output>
After completion, create `.planning/phases/07-amazon-best-sellers/07-01-SUMMARY.md`
</output>
