---
phase: 04-extension-rbac
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/extension/sidepanel.html
  - packages/extension/sidepanel.css
  - packages/extension/sidepanel.js
  - packages/extension/service-worker.js
autonomous: false

must_haves:
  truths:
    - "VA with assigned roles sees one tab per role, tabs named after role"
    - "VA with zero roles sees empty state message 'No features assigned. Contact your admin.'"
    - "Admin user sees all extension tabs with admin badge indicator"
    - "Clock-out button is accessible from profile section header"
    - "Clicking a tab shows that tab as active with clear visual distinction"
    - "If VA's roles change mid-session, user is forced to re-authenticate"
  artifacts:
    - path: "packages/extension/sidepanel.html"
      provides: "Profile section with user info, tab bar container, empty state"
      contains: "profile-section"
    - path: "packages/extension/sidepanel.css"
      provides: "Tab bar styling, active tab state, admin badge"
      contains: "tab-bar"
    - path: "packages/extension/sidepanel.js"
      provides: "Tab rendering logic, admin bypass, permission re-check"
      contains: "renderTabs"
    - path: "packages/extension/service-worker.js"
      provides: "Permission re-check alarm handler"
      contains: "permission_recheck"
  key_links:
    - from: "packages/extension/sidepanel.js"
      to: "chrome.storage.local"
      via: "currentState.roles"
      pattern: "currentState\\.roles"
    - from: "packages/extension/sidepanel.js"
      to: "service-worker clock-out"
      via: "send('CLOCK_OUT')"
      pattern: "send\\('CLOCK_OUT'\\)"
    - from: "packages/extension/service-worker.js"
      to: "clockOut function"
      via: "permission_recheck alarm triggers clockOut('roles_changed')"
      pattern: "clockOut\\('roles_changed'\\)"
---

<objective>
Implement RBAC-driven tab rendering in the Chrome extension side panel with profile/identity section, admin bypass, empty state for VAs with no roles, and periodic permission re-check.

Purpose: VAs see only the extension features their assigned roles permit; Admins bypass RBAC and see all tabs; users can log out from a visible profile section.

Output:
- Profile section showing user name, type badge, admin indicator, and Clock Out button
- Dynamic tab bar rendering tabs from user's roles array
- Admin bypass showing all extension tabs when user.is_admin is true
- Empty state message when VA has no assigned roles
- Periodic permission re-check that forces re-auth on role changes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-extension-rbac/04-CONTEXT.md
@.planning/phases/04-extension-rbac/04-RESEARCH.md
@.planning/phases/03-extension-auth-flow/03-01-SUMMARY.md
@.planning/phases/03-extension-auth-flow/03-02-SUMMARY.md

# Source files
@packages/extension/sidepanel.html
@packages/extension/sidepanel.css
@packages/extension/sidepanel.js
@packages/extension/service-worker.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile section and tab bar HTML structure</name>
  <files>packages/extension/sidepanel.html</files>
  <action>
Restructure the hub section in sidepanel.html to add RBAC-driven UI:

1. Add profile section at the TOP of hub-section (before agent-info-card):
```html
<!-- Profile/Identity Section -->
<section class="profile-section">
  <div class="profile-info">
    <span id="profile-name" class="profile-name">User</span>
    <span id="profile-type-badge" class="profile-type-badge">va</span>
    <span id="admin-badge" class="admin-badge hidden">Admin View</span>
  </div>
  <button id="btn-clock-out-header" class="btn btn-danger btn-small">Clock Out</button>
</section>
```

2. Add tab bar container after profile section:
```html
<!-- Tab Bar (dynamically rendered from roles) -->
<nav id="tab-bar" class="tab-bar">
  <!-- Tabs rendered dynamically by JS -->
</nav>

<!-- Tab Bar Skeleton (shown while loading) -->
<nav id="tab-bar-skeleton" class="tab-bar-skeleton hidden">
  <div class="skeleton-tab"></div>
  <div class="skeleton-tab"></div>
</nav>

<!-- Tab Content Container -->
<div id="tab-content" class="tab-content">
  <!-- Content for active tab (placeholder for now) -->
  <p class="tab-placeholder">Feature content will appear here</p>
</div>

<!-- Empty State (for VAs with no roles) -->
<section id="empty-state" class="empty-state-section hidden">
  <p class="empty-state-message">No features assigned. Contact your admin.</p>
</section>
```

3. REMOVE the existing Clock Out button from the Quick Actions section at the bottom (it's now in profile header).
   - Delete the div with class "session-actions" containing btn-clock-out

4. Keep existing agent-info-card, stats, current-task, attention, queue, and actions sections BELOW the tab content - these will eventually move into specific tabs but remain visible for now.
  </action>
  <verify>
Open sidepanel.html and verify:
- profile-section element exists with profile-name, profile-type-badge, admin-badge, btn-clock-out-header
- tab-bar nav element exists
- tab-bar-skeleton element exists with skeleton-tab divs
- tab-content div exists with placeholder
- empty-state section exists with correct message
- Old btn-clock-out in session-actions is removed
  </verify>
  <done>HTML structure ready for RBAC tab rendering with profile section at top of hub</done>
</task>

<task type="auto">
  <name>Task 2: Add CSS styles for profile section, tabs, and admin badge</name>
  <files>packages/extension/sidepanel.css</files>
  <action>
Add CSS styles for the new RBAC UI components. Place these styles appropriately in the CSS file:

1. Profile section styles:
```css
/* Profile Section */
.profile-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
}

.profile-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.profile-name {
  font-weight: 600;
  color: var(--text-primary);
}

.profile-type-badge {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  text-transform: uppercase;
}

.admin-badge {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  background: #3b82f6;
  color: white;
  font-weight: 500;
}

.admin-badge.hidden {
  display: none;
}
```

2. Tab bar styles:
```css
/* Tab Bar */
.tab-bar {
  display: flex;
  gap: 4px;
  padding: 8px 16px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
  overflow-x: auto;
}

.tab-bar:empty {
  display: none;
}

.tab {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--text-secondary);
  font-size: 13px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s ease;
}

.tab:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.tab.active {
  background: var(--primary);
  color: white;
  font-weight: 600;
}

.tab-icon {
  font-size: 14px;
}
```

3. Tab skeleton styles:
```css
/* Tab Bar Skeleton */
.tab-bar-skeleton {
  display: flex;
  gap: 4px;
  padding: 8px 16px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-color);
}

.skeleton-tab {
  width: 100px;
  height: 32px;
  border-radius: 6px;
  background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
  background-size: 200% 100%;
  animation: skeleton-pulse 1.5s ease-in-out infinite;
}

@keyframes skeleton-pulse {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
```

4. Tab content and empty state styles:
```css
/* Tab Content */
.tab-content {
  padding: 16px;
  min-height: 100px;
}

.tab-placeholder {
  color: var(--text-secondary);
  text-align: center;
  padding: 24px;
}

/* Empty State (no roles) */
.empty-state-section {
  padding: 32px 16px;
  text-align: center;
}

.empty-state-message {
  color: var(--text-secondary);
  font-size: 14px;
}
```

Ensure CSS variables (--bg-secondary, --bg-tertiary, --primary, etc.) are already defined in the file. If not, use appropriate fallback values.
  </action>
  <verify>
Check sidepanel.css contains:
- .profile-section with flex layout
- .admin-badge with blue background
- .tab-bar with flex and overflow-x
- .tab and .tab.active with distinct styles (active has primary color)
- .skeleton-tab with animation
- .empty-state-section styles
  </verify>
  <done>CSS styles complete for profile section, tab bar, and empty state</done>
</task>

<task type="auto">
  <name>Task 3: Implement tab rendering logic with admin bypass and permission re-check</name>
  <files>packages/extension/sidepanel.js, packages/extension/service-worker.js</files>
  <action>
Implement the JavaScript logic for RBAC-driven tab rendering:

**In sidepanel.js:**

1. Add new element references in the `elements` object:
```javascript
// Profile Section
profileName: document.getElementById('profile-name'),
profileTypeBadge: document.getElementById('profile-type-badge'),
adminBadge: document.getElementById('admin-badge'),
btnClockOutHeader: document.getElementById('btn-clock-out-header'),

// Tab Bar
tabBar: document.getElementById('tab-bar'),
tabBarSkeleton: document.getElementById('tab-bar-skeleton'),
tabContent: document.getElementById('tab-content'),
emptyState: document.getElementById('empty-state'),
```

2. Add ADMIN_TABS constant near the top of the file:
```javascript
// Admin sees all extension tabs (feature list)
const ADMIN_TABS = [
  { id: 'order_tracking', name: 'Order Tracking', icon: 'ðŸ“‹' },
  { id: 'accounts', name: 'Accounts', icon: 'ðŸª' },
];

// Map role names to icons (for VA tabs)
const ROLE_ICONS = {
  'Order Tracking': 'ðŸ“‹',
  'Accounts': 'ðŸª',
  'Bookkeeping': 'ðŸ“Š',
  'default': 'ðŸ“',
};
```

3. Add renderProfileSection() function:
```javascript
function renderProfileSection() {
  if (!currentState?.user_context) return;
  const { name, user_type, is_admin } = currentState.user_context;

  if (elements.profileName) {
    elements.profileName.textContent = name || 'User';
  }
  if (elements.profileTypeBadge) {
    elements.profileTypeBadge.textContent = user_type || 'va';
  }
  if (elements.adminBadge) {
    if (is_admin) {
      elements.adminBadge.classList.remove('hidden');
    } else {
      elements.adminBadge.classList.add('hidden');
    }
  }
}
```

4. Add renderTabs() function:
```javascript
function renderTabs() {
  if (!currentState) return;
  const { user_context, roles } = currentState;

  // Hide skeleton, show tab bar
  elements.tabBarSkeleton?.classList.add('hidden');
  elements.tabBar?.classList.remove('hidden');

  // Admin bypass - show all tabs
  if (user_context?.is_admin) {
    renderAdminTabs();
    elements.emptyState?.classList.add('hidden');
    elements.tabContent?.classList.remove('hidden');
    return;
  }

  // VA with no roles - show empty state
  if (!roles || roles.length === 0) {
    showEmptyState();
    return;
  }

  // VA with roles - render assigned tabs
  elements.emptyState?.classList.add('hidden');
  elements.tabContent?.classList.remove('hidden');

  // Sort by priority if available, otherwise use array order
  const sortedRoles = [...roles].sort((a, b) => (a.priority || 0) - (b.priority || 0));

  if (elements.tabBar) {
    elements.tabBar.innerHTML = sortedRoles.map((role, index) => `
      <button class="tab ${index === 0 ? 'active' : ''}"
              data-role-id="${escapeHtml(role.id)}"
              data-role-name="${escapeHtml(role.name)}">
        <span class="tab-icon">${getRoleIcon(role.name)}</span>
        <span>${escapeHtml(role.name)}</span>
      </button>
    `).join('');

    // Attach click handlers
    attachTabClickHandlers();
  }

  // Show first tab content
  if (sortedRoles.length > 0) {
    showTabContent(sortedRoles[0].id, sortedRoles[0].name);
  }
}

function renderAdminTabs() {
  if (elements.tabBar) {
    elements.tabBar.innerHTML = ADMIN_TABS.map((tab, index) => `
      <button class="tab ${index === 0 ? 'active' : ''}"
              data-tab-id="${tab.id}">
        <span class="tab-icon">${tab.icon}</span>
        <span>${tab.name}</span>
      </button>
    `).join('');

    attachTabClickHandlers();
  }

  // Show first tab content
  if (ADMIN_TABS.length > 0) {
    showTabContent(ADMIN_TABS[0].id, ADMIN_TABS[0].name);
  }
}

function showEmptyState() {
  elements.tabBar?.classList.add('hidden');
  elements.tabContent?.classList.add('hidden');
  elements.emptyState?.classList.remove('hidden');
}

function showTabContent(tabId, tabName) {
  if (elements.tabContent) {
    // For now, show placeholder with tab name
    // Future phases will populate actual content
    elements.tabContent.innerHTML = `
      <p class="tab-placeholder">${escapeHtml(tabName || tabId)} feature content will appear here</p>
    `;
  }
}

function getRoleIcon(roleName) {
  return ROLE_ICONS[roleName] || ROLE_ICONS.default;
}

function attachTabClickHandlers() {
  elements.tabBar?.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      // Update active state
      elements.tabBar.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      // Show content
      const tabId = tab.dataset.roleId || tab.dataset.tabId;
      const tabName = tab.dataset.roleName || tab.textContent.trim();
      showTabContent(tabId, tabName);
    });
  });
}
```

5. Modify renderHub() to call renderProfileSection() and renderTabs():
```javascript
function renderHub() {
  // NEW: Render profile section first
  renderProfileSection();

  // NEW: Render tabs
  renderTabs();

  // Keep existing hub rendering for agent info, stats, etc.
  // Agent info
  elements.agentLabel.textContent = currentState.label || 'Unknown';
  // ... rest of existing renderHub code
}
```

6. Add event listener for the new Clock Out header button (near other event listeners):
```javascript
elements.btnClockOutHeader?.addEventListener('click', () => {
  send('CLOCK_OUT');
});
```

7. Add message handler for ROLES_CHANGED (in handleMessage function's switch):
```javascript
case 'ROLES_CHANGED':
  // Force re-authentication when roles change
  elements.validatingOverlay?.classList.add('hidden');
  hideAllSections();
  showSection('clockIn');
  renderClockIn();
  break;
```

**In service-worker.js:**

8. Add permission re-check alarm constant and handler:
```javascript
// Near other constants at top
const PERMISSION_RECHECK_MINUTES = 5;
```

9. Modify startInactivityTimer() to ALSO start permission re-check:
```javascript
async function startInactivityTimer() {
  await chrome.alarms.clear('inactivity_warning');
  await chrome.alarms.clear('inactivity_timeout');
  await chrome.alarms.clear('permission_recheck');  // ADD THIS

  const now = Date.now();
  await chrome.storage.local.set({ last_activity_at: now });

  // Warning 5 minutes before timeout
  chrome.alarms.create('inactivity_warning', {
    when: now + INACTIVITY_TIMEOUT_MS - INACTIVITY_WARNING_MS
  });

  // Timeout after 1 hour
  chrome.alarms.create('inactivity_timeout', {
    when: now + INACTIVITY_TIMEOUT_MS
  });

  // ADD: Periodic permission re-check
  chrome.alarms.create('permission_recheck', {
    periodInMinutes: PERMISSION_RECHECK_MINUTES
  });
}
```

10. Add permission_recheck alarm handler in chrome.alarms.onAlarm.addListener:
```javascript
case 'permission_recheck':
  checkPermissionChanges();
  break;
```

11. Add checkPermissionChanges function:
```javascript
/**
 * Check if user's permissions have changed since clock-in.
 * If rbac_version changed, force re-authentication.
 */
async function checkPermissionChanges() {
  const state = await getState();
  if (state.auth_state !== 'clocked_in') return;
  if (!state.access_token || !state.user_context) return;

  try {
    // Use the access token to fetch current user info
    const response = await fetch(`${API_BASE}/auth/me`, {
      headers: {
        'Authorization': `Bearer ${state.access_token}`,
        'Content-Type': 'application/json',
      },
    });

    if (response.status === 401) {
      // Token invalid, force re-auth
      await clockOut('token_expired');
      return;
    }

    if (!response.ok) {
      console.warn('[SW] Permission check failed:', response.status);
      return; // Don't force logout on network errors, try again later
    }

    const data = await response.json();

    // Compare rbac_version
    if (data.rbac_version && data.rbac_version !== state.rbac_version) {
      console.log('[SW] RBAC version changed, forcing re-auth');
      await clockOut('roles_changed');

      // Notify side panels
      for (const port of sidePanelPorts) {
        try {
          port.postMessage({ type: 'ROLES_CHANGED' });
        } catch (e) {
          // Port may be disconnected
        }
      }
    }
  } catch (err) {
    console.warn('[SW] Permission check error:', err.message);
    // Don't force logout on network errors
  }
}
```

12. Extend clockOut() to clear permission_recheck alarm:
In the existing clockOut() function, add:
```javascript
await chrome.alarms.clear('permission_recheck');
```

13. Add 'roles_changed' and 'permission_fetch_failed' to clock-out messages in sidepanel.js renderClockedOut():
```javascript
const messages = {
  'manual': 'You have clocked out.',
  'inactivity': 'Clocked out due to inactivity.',
  'code_rotated': 'Your access code was changed. Please clock in again.',
  'token_expired': 'Your session has expired. Please clock in again.',
  'roles_changed': 'Your permissions have changed. Please clock in again.',
  'permission_fetch_failed': 'Could not verify permissions. Please clock in again.',
};
```
  </action>
  <verify>
Test in browser:
1. Load extension, pair, clock in as VA with roles -> should see tabs matching roles
2. Clock in as admin -> should see all tabs with admin badge
3. Clock in as VA with no roles -> should see empty state message
4. Click tabs -> active tab should highlight with blue background
5. Click Clock Out in header -> should log out and show clocked-out screen
6. Check chrome://extensions service worker logs for permission_recheck alarm
  </verify>
  <done>Tab rendering, admin bypass, empty state, and permission re-check all implemented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete RBAC-driven tab UI in the Chrome extension:
- Profile section with user name, type badge, admin indicator, and Clock Out button
- Dynamic tab bar that renders tabs from user's assigned roles
- Admin bypass showing all extension tabs
- Empty state for VAs with no assigned roles
- Periodic permission re-check (every 5 minutes) that forces re-auth if roles change
  </what-built>
  <how-to-verify>
1. Open Chrome extension side panel
2. If paired and clocked in as admin:
   - Verify profile section shows your name, "admin" badge, and "Admin View" badge
   - Verify tab bar shows "Order Tracking" and "Accounts" tabs
   - Click between tabs - active tab should be clearly highlighted (blue)
   - Click Clock Out button in header - should log out

3. If testing as VA with roles:
   - Verify profile section shows name and "va" badge (no Admin View)
   - Verify tabs match your assigned roles (role name = tab name)
   - Verify clicking tabs switches active state

4. If testing as VA with no roles:
   - Verify "No features assigned. Contact your admin." message appears
   - Verify no tab bar is shown

5. Check service worker logs (chrome://extensions) for "permission_recheck" alarm creation
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Profile section visible with user info, type badge, and Clock Out button
- Tab bar renders dynamically from roles (VA) or shows all tabs (Admin)
- Empty state displays when VA has no roles
- Clicking tabs updates active state with clear visual distinction
- Clock Out works from header button
- Permission re-check alarm runs every 5 minutes when clocked in
- Roles change forces re-authentication
</verification>

<success_criteria>
Requirements fulfilled:
- EXT-05: RBAC permissions loaded on auth (from Phase 3, used here for rendering)
- EXT-06: Tabs render based on assigned roles (one tab per role)
- EXT-07: Admin sees all extension tabs (bypass RBAC check)
- EXT-08: User can log out (Clock Out button in profile section)
- EXT-09: Auto-logout on inactivity (from Phase 3, still working)

Additional from CONTEXT.md:
- Profile/identity section with user type and name
- Clock-out button adjacent to profile info
- Empty state for VAs with no roles
- Admin badge indicator
- Tab ordering by role priority
- Periodic permission re-check with force re-auth on change
</success_criteria>

<output>
After completion, create `.planning/phases/04-extension-rbac/04-01-SUMMARY.md`
</output>
