---
phase: 28-collection-storage-rendering-infrastructure
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/migrations/052_sellers_authenticated_rls.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Authenticated users can SELECT sellers rows scoped to their org via the sync endpoint"
    - "The /sync/sellers endpoint returns the org's 4700 sellers instead of 0 rows"
    - "The service_role policy remains intact and unchanged"
  artifacts:
    - path: "apps/api/migrations/052_sellers_authenticated_rls.sql"
      provides: "Authenticated user RLS SELECT policy on sellers table"
      contains: "CREATE POLICY"
  key_links:
    - from: "apps/api/migrations/052_sellers_authenticated_rls.sql"
      to: "sellers table RLS"
      via: "Supabase RLS policy evaluation"
      pattern: "CREATE POLICY.*authenticated.*sellers"
---

<objective>
Add an authenticated user RLS SELECT policy on the `sellers` table so the `/sync/sellers` endpoint (which uses `get_supabase_for_user()`) can read seller rows.

Purpose: The sellers grid shows "no sellers" despite 4,700 sellers in the database. The sync endpoint uses a user-scoped Supabase client subject to RLS, but the sellers table only has a `service_role` policy (migration 037). Supabase silently returns 0 rows when no RLS policy matches the `authenticated` role. This single migration unblocks the entire SellersGrid.

Output: Migration `052_sellers_authenticated_rls.sql` adding an org-scoped SELECT policy for authenticated users.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-collection-storage-rendering-infrastructure/28-UAT.md

Reference migrations for RLS pattern:
@apps/api/migrations/037_collection_infrastructure.sql (lines 136-158: current sellers RLS â€” service_role only)
@apps/api/migrations/049_import_batch_tracking.sql (lines 36-46: authenticated user SELECT policy pattern to follow)
@apps/api/migrations/036_presence_system.sql (lines 53-62: alternative authenticated SELECT pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration adding authenticated user SELECT policy on sellers table</name>
  <files>apps/api/migrations/052_sellers_authenticated_rls.sql</files>
  <action>
Create migration file `apps/api/migrations/052_sellers_authenticated_rls.sql` that adds an authenticated user RLS SELECT policy on the `sellers` table, scoped to the user's org via the `memberships` table.

Use the EXACT pattern from migration 049 (import_batches). The SQL should:

1. Drop the policy if it already exists (idempotent):
   `DROP POLICY IF EXISTS "authenticated_select_sellers" ON sellers;`

2. Create the policy:
   ```sql
   CREATE POLICY "authenticated_select_sellers"
   ON sellers
   FOR SELECT
   TO authenticated
   USING (
       org_id IN (
           SELECT org_id FROM memberships
           WHERE user_id = auth.uid()
           AND status = 'active'
       )
   );
   ```

Include a clear header comment explaining:
- Migration number and purpose
- The root cause (sync endpoint uses user-scoped client, but sellers table had no authenticated SELECT policy)
- That the existing service_role policy is NOT touched

Do NOT modify or drop the existing `service_role_sellers` policy. Do NOT add UPDATE/INSERT/DELETE policies (mutations go through the API service role client, not the user client). Only SELECT is needed because the sync endpoint only reads.
  </action>
  <verify>
1. File exists: `ls apps/api/migrations/052_sellers_authenticated_rls.sql`
2. Contains CREATE POLICY with authenticated role: `grep -c "TO authenticated" apps/api/migrations/052_sellers_authenticated_rls.sql` returns 1
3. Contains org_id scoping via memberships: `grep -c "memberships" apps/api/migrations/052_sellers_authenticated_rls.sql` returns at least 1
4. Does NOT contain DROP on service_role policy: `grep -c "service_role_sellers" apps/api/migrations/052_sellers_authenticated_rls.sql` returns 0
5. SQL syntax check: no obvious syntax errors (semicolons present, balanced parentheses)
  </verify>
  <done>
Migration file exists with a single authenticated user SELECT policy on the sellers table, scoped to org_id via memberships, matching the established pattern from migrations 036/049. The service_role policy is untouched.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Run migration and verify sellers load in grid</name>
  <what-built>Migration 052 adds an RLS policy allowing authenticated users to SELECT from the sellers table when their org_id matches via the memberships table. This should unblock the /sync/sellers endpoint which was returning 0 rows.</what-built>
  <how-to-verify>
1. Run the migration against your Supabase database:
   - Open the Supabase Dashboard SQL Editor
   - Paste and execute the contents of `apps/api/migrations/052_sellers_authenticated_rls.sql`
   - Confirm it executes without errors

2. Verify the policy exists:
   - In Supabase Dashboard, navigate to Authentication > Policies > sellers table
   - Confirm you see BOTH policies: `service_role_sellers` (existing) and `authenticated_select_sellers` (new)

3. Test the sellers grid:
   - Navigate to the Collection/Sellers page in the app
   - The grid should now load and display the 4,700 sellers
   - Search should work (type a seller name, results filter)
   - Adding a new seller should work and appear in the grid

4. Confirm background sync indicator:
   - On page load, you should briefly see "(syncing...)" then sellers appear
   - On subsequent visits, sellers should appear instantly from IndexedDB cache
  </how-to-verify>
  <resume-signal>Type "approved" if sellers load correctly, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
- Migration file `052_sellers_authenticated_rls.sql` exists in `apps/api/migrations/`
- The SQL adds exactly one policy: `authenticated_select_sellers` on `sellers` for SELECT to authenticated role
- The policy scopes access via `org_id IN (SELECT org_id FROM memberships WHERE user_id = auth.uid() AND status = 'active')`
- The existing `service_role_sellers` policy is not modified
- After running the migration, `/sync/sellers` returns the org's sellers instead of 0 rows
</verification>

<success_criteria>
- The sellers grid displays all 4,700 sellers after the migration is applied
- All UAT tests blocked by Test 1 (tests 2-8, 12) can now proceed
- The sync endpoint continues to work with cursor pagination
- No regressions to service_role operations (collection runs, worker writes to sellers)
</success_criteria>

<output>
After completion, create `.planning/phases/28-collection-storage-rendering-infrastructure/28-07-SUMMARY.md`
</output>
