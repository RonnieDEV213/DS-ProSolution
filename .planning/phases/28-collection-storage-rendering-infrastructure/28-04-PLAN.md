---
phase: 28-collection-storage-rendering-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["28-03"]
files_modified:
  - apps/web/src/components/admin/collection/sellers-grid.tsx
autonomous: true

must_haves:
  truths:
    - "SellersGrid reads sellers from useSyncSellers (IndexedDB) not fetch+useState"
    - "SellersGrid shows sync status (loading from cache, syncing from server)"
    - "Seller search filters through useSyncSellers filters.search (debounced 300ms)"
    - "Seller data persists across page navigation and reload"
    - "All existing interactions preserved: click, shift-click, ctrl-click, drag select, right-click flag paint, hover detail, Ctrl+A, Ctrl+C, Ctrl+Z"
  artifacts:
    - path: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      provides: "SellersGrid with IndexedDB data source"
      contains: "useSyncSellers"
  key_links:
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "apps/web/src/hooks/sync/use-sync-sellers.ts"
      via: "useSyncSellers hook call"
      pattern: "useSyncSellers"
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "apps/web/src/lib/db/index.ts"
      via: "No more direct fetch - data flows through IndexedDB"
      pattern: "useSyncSellers|db\\.sellers"
---

<objective>
Replace SellersGrid's data source from direct fetch()+useState to useSyncSellers (IndexedDB-backed, reactive). This is the core migration task.

Purpose: The current SellersGrid fetches all sellers via `fetch(API_BASE/sellers?limit=100000)` and stores them in `useState`. This creates no persistence, no offline support, no background sync, and a single massive request. After this plan, sellers load instantly from IndexedDB cache with background sync, persisting across page navigation and browser reloads.

Output: sellers-grid.tsx refactored to use useSyncSellers as its data source. All existing interactions preserved. No visual changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/28-collection-storage-rendering-infrastructure/28-CONTEXT.md
@.planning/phases/28-collection-storage-rendering-infrastructure/28-RESEARCH.md
@apps/web/src/components/admin/collection/sellers-grid.tsx
@apps/web/src/hooks/sync/use-sync-sellers.ts
@apps/web/src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace data source with useSyncSellers</name>
  <files>
    apps/web/src/components/admin/collection/sellers-grid.tsx
  </files>
  <action>
This is a surgical refactoring of the SellersGrid data source. The goal is to replace the fetch+useState data loading with useSyncSellers while preserving ALL existing interaction patterns (drag select, flag paint, shift-click, hover, keyboard shortcuts, export).

**CRITICAL: Read the entire sellers-grid.tsx before making changes. It is 1,530 lines with complex interaction patterns. The migration must preserve every behavior.**

Step-by-step changes:

1. **Replace data loading state and fetch with useSyncSellers:**

   REMOVE these lines:
   - `const [sellers, setSellers] = useState<Seller[]>([]);`
   - `const [loading, setLoading] = useState(true);`
   - The entire `fetchSellers` useCallback
   - The `useEffect` that calls `fetchSellers` on `refreshTrigger`
   - `const supabase = createClient();` (import no longer needed after Plan 05 removes remaining supabase usages)
   - `import { createClient } from "@/lib/supabase/client";`
   - `const API_BASE = ...` line (will still be needed temporarily for mutations -- remove in Plan 05)

   ADD:
   ```typescript
   import { useSyncSellers } from '@/hooks/sync/use-sync-sellers';
   import { useDebouncedValue } from '@/hooks/use-debounced-value'; // Create if needed (see below)
   ```

   Replace the data loading with:
   ```typescript
   // Debounce search term for IndexedDB query (300ms per CONTEXT.md)
   const debouncedSearch = useDebouncedValue(
     newSellerName.includes('\n') ? '' : newSellerName.trim(),
     300
   );

   const {
     sellers,
     isLoading: loading,
     isSyncing,
     totalCount,
     flaggedCount,
     refetch,
   } = useSyncSellers({
     filters: {
       search: debouncedSearch || undefined,
     },
   });
   ```

   If `useDebouncedValue` doesn't exist, create a tiny utility hook:
   ```typescript
   // apps/web/src/hooks/use-debounced-value.ts
   import { useState, useEffect } from 'react';
   export function useDebouncedValue<T>(value: T, delay: number): T {
     const [debounced, setDebounced] = useState(value);
     useEffect(() => {
       const timer = setTimeout(() => setDebounced(value), delay);
       return () => clearTimeout(timer);
     }, [value, delay]);
     return debounced;
   }
   ```

2. **Replace the Seller interface with SellerRecord import:**

   The current `Seller` interface in sellers-grid.tsx:
   ```typescript
   interface Seller {
     id: string;
     display_name: string;
     normalized_name: string;
     platform: string;
     times_seen: number;
     feedback_percent?: number;
     feedback_count?: number;
     created_at?: string;
     flagged?: boolean;
   }
   ```

   Replace with import from schema:
   ```typescript
   import type { SellerRecord } from '@/lib/db/schema';
   ```

   Then replace `Seller` with `SellerRecord` throughout the file. Note the SellerRecord interface:
   ```typescript
   interface SellerRecord {
     id: string;
     display_name: string;
     normalized_name: string;
     platform: string;
     platform_id: string | null;
     times_seen: number;
     flagged: boolean;        // Note: NOT optional
     updated_at: string;
     deleted_at: string | null;
   }
   ```

   The SellerRecord does NOT have `feedback_percent`, `feedback_count`, or `created_at`. The SellerDetailPanel hover component uses these. Handle this:
   - `feedback_percent` and `feedback_count`: These were optional and only showed conditionally. Since they're not in IndexedDB, remove those display lines from SellerDetailPanel (they were server-only fields not synced to IndexedDB).
   - `created_at`: Not in SellerRecord (uses `updated_at` instead). Replace with `updated_at` in the "Discovered" display, or remove if not meaningful.
   - `flagged`: Changed from `boolean | undefined` to `boolean`. Simplifies comparisons -- remove `=== true` guards where just `seller.flagged` suffices.

3. **Update filteredSellers to use sellers directly from hook:**

   The current `filteredSellers` memo applies search filtering. Since useSyncSellers already handles search via filters.search, simplify:
   ```typescript
   // useSyncSellers already handles search filtering via debouncedSearch
   // No additional client-side filtering needed
   const filteredSellers = sellers;
   ```

   This is important: do NOT double-filter. The hook does the filtering.

4. **Remove the flaggedCount memo:**

   Current: `const flaggedCount = useMemo(() => sellers.filter(s => s.flagged).length, [sellers]);`
   Replace: Use `flaggedCount` from useSyncSellers directly (already destructured above).

5. **Update sellersRef to track sellers from hook:**

   Keep `const sellersRef = useRef<SellerRecord[]>([]);` and `sellersRef.current = sellers;` -- this is needed for stable callbacks in drag selection. The ref update pattern works the same whether sellers comes from useState or useSyncSellers.

   Similarly keep `filteredSellersRef.current = filteredSellers;`.

6. **Update refreshTrigger to use refetch:**

   The `refreshTrigger` prop currently drives `fetchSellers()` via useEffect. Replace with:
   ```typescript
   useEffect(() => {
     refetch();
   }, [refreshTrigger, refetch]);
   ```

   This triggers a background re-sync when the parent signals a data change.

7. **Add isSyncing indicator to UI (optional but recommended):**

   In the header stats area, after the sellers count display, add a subtle sync indicator:
   ```tsx
   {isSyncing && (
     <span className="text-muted-foreground/60 text-xs ml-1">(syncing...)</span>
   )}
   ```

8. **Keep ALL remaining code unchanged:**
   - SellerCell component: unchanged (uses sellers array from cellProps)
   - SellerDetailPanel: updated for SellerRecord type (step 2)
   - Selection state and handlers: unchanged
   - Drag selection: unchanged
   - Right-click flag painting: unchanged (still uses setSellers for now -- Plan 05 migrates)
   - Export functions: unchanged (Plan 05 migrates)
   - Undo/redo: unchanged (Plan 05 migrates)
   - handleAddSeller: unchanged (Plan 05 migrates)
   - saveEdit: unchanged (Plan 05 migrates)
   - All keyboard shortcuts: unchanged
   - cellProps memo: update Seller type to SellerRecord

**IMPORTANT: This plan ONLY replaces the data source. Plan 05 will replace the mutation calls (setSellers, direct fetch for flag/edit/delete/add/export). For this plan, keep the existing mutation code even though it still uses setSellers and direct fetch. After this plan, the data loads from IndexedDB but mutations still go through the old path. This is intentional -- incremental migration reduces risk of breaking the complex interaction patterns.**

Note: After this plan, `setSellers` calls in mutation code will still work but will be redundant (useLiveQuery will re-render with the authoritative IndexedDB data). They won't cause bugs, just unnecessary state updates. Plan 05 will clean these up.
  </action>
  <verify>
    - `npx tsc --noEmit` passes.
    - `npm run build` succeeds (full build including SellersGrid).
    - Grep confirms `useSyncSellers` import in sellers-grid.tsx.
    - Grep confirms NO `fetch.*sellers.*limit=100000` in sellers-grid.tsx.
    - Grep confirms `SellerRecord` type used (not local `Seller` interface).
    - The file still compiles with the remaining setSellers/fetch calls (they'll be cleaned up in Plan 05).
  </verify>
  <done>
    - SellersGrid loads sellers from IndexedDB via useSyncSellers.
    - Background sync fetches latest sellers on mount.
    - Search is debounced at 300ms through useSyncSellers filters.
    - Data persists across page navigation (IndexedDB cache).
    - All existing interaction patterns still work (drag, flag paint, click, keyboard).
    - Sync status indicator shows when background sync is active.
    - SellerRecord type replaces local Seller interface.
    - refreshTrigger triggers re-sync instead of full fetch.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` and `npm run build` from apps/web/ both pass.
- SellersGrid renders correctly with data from IndexedDB.
- No regression in existing seller interactions.
- sellers-grid.tsx no longer imports createClient or uses direct fetch for data loading.
</verification>

<success_criteria>
- Data source migration complete: useSyncSellers replaces fetch+useState.
- SellersGrid loads instantly from IndexedDB cache on subsequent visits.
- Background sync refreshes data without blocking UI.
- All existing interactions preserved (verified by no changes to interaction code).
- Ready for mutation migration in Plan 05.
</success_criteria>

<output>
After completion, create `.planning/phases/28-collection-storage-rendering-infrastructure/28-04-SUMMARY.md`
</output>
