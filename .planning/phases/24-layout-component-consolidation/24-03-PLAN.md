---
phase: 24-layout-component-consolidation
plan: 03
type: execute
wave: 3
depends_on: ["24-02"]
files_modified:
  - apps/web/src/app/admin/layout.tsx
  - apps/web/src/app/va/layout.tsx
  - apps/web/src/app/client/layout.tsx
  - apps/web/src/components/admin/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin layout uses SidebarProvider + AppSidebar with adminNavItems and showSyncStatus=true"
    - "Admin layout preserves SyncProvider, AdminLayoutClient, and ConflictResolutionModal wiring"
    - "VA layout uses SidebarProvider + AppSidebar with RBAC-filtered vaNavItems"
    - "VA layout preserves hasAccessProfile conditional filtering and redirect logic"
    - "Client layout uses SidebarProvider + AppSidebar with clientNavItems"
    - "All three layouts include BreadcrumbNav in the main content area"
    - "All three layouts use bg-background instead of bg-gray-950"
    - "Old AdminSidebar component file is deleted (replaced by AppSidebar)"
    - "Sidebar collapse via Cmd+B / Ctrl+B keyboard shortcut works in all layouts"
  artifacts:
    - path: "apps/web/src/app/admin/layout.tsx"
      provides: "Admin layout using SidebarProvider + AppSidebar + BreadcrumbNav"
      contains: "SidebarProvider"
    - path: "apps/web/src/app/va/layout.tsx"
      provides: "VA layout using SidebarProvider + AppSidebar with RBAC filtering + BreadcrumbNav"
      contains: "SidebarProvider"
    - path: "apps/web/src/app/client/layout.tsx"
      provides: "Client layout using SidebarProvider + AppSidebar + BreadcrumbNav"
      contains: "SidebarProvider"
  key_links:
    - from: "apps/web/src/app/admin/layout.tsx"
      to: "apps/web/src/components/layout/app-sidebar.tsx"
      via: "imports AppSidebar"
      pattern: "import.*AppSidebar.*from.*components/layout/app-sidebar"
    - from: "apps/web/src/app/admin/layout.tsx"
      to: "apps/web/src/lib/navigation.ts"
      via: "imports adminNavItems"
      pattern: "import.*adminNavItems.*from.*lib/navigation"
    - from: "apps/web/src/app/va/layout.tsx"
      to: "apps/web/src/lib/navigation.ts"
      via: "imports vaNavItems"
      pattern: "import.*vaNavItems.*from.*lib/navigation"
    - from: "apps/web/src/app/client/layout.tsx"
      to: "apps/web/src/lib/navigation.ts"
      via: "imports clientNavItems"
      pattern: "import.*clientNavItems.*from.*lib/navigation"
---

<objective>
Refactor all three dashboard layouts (Admin, VA, Client) to use the unified AppSidebar + SidebarProvider + BreadcrumbNav components, then delete the old AdminSidebar component.

Purpose: Complete the layout consolidation by wiring the new unified components into all three layouts, replacing ~350 lines of duplicated sidebar code with imports from shared components. This is the integration step that makes the consolidation real.
Output: 3 updated layout files using shared components, 1 deleted sidebar file.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-layout-component-consolidation/24-01-SUMMARY.md
@.planning/phases/24-layout-component-consolidation/24-02-SUMMARY.md

# Current layout files to refactor:
@apps/web/src/app/admin/layout.tsx
@apps/web/src/app/va/layout.tsx
@apps/web/src/app/client/layout.tsx

# Old sidebar to delete:
@apps/web/src/components/admin/sidebar.tsx

# New components to use:
@apps/web/src/components/layout/app-sidebar.tsx
@apps/web/src/components/layout/breadcrumb-nav.tsx
@apps/web/src/lib/navigation.ts

# Components that must be preserved in admin layout:
@apps/web/src/components/admin/admin-layout-client.tsx
@apps/web/src/components/providers/sync-provider.tsx
@apps/web/src/components/sync/conflict-resolution-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Admin layout to use AppSidebar</name>
  <files>
    apps/web/src/app/admin/layout.tsx
    apps/web/src/components/admin/sidebar.tsx
  </files>
  <action>
    **Refactor `apps/web/src/app/admin/layout.tsx`:**

    Replace the current admin layout that imports AdminSidebar with the new SidebarProvider + AppSidebar pattern.

    The current layout is a server component (no "use client"). It must remain a server component because it wraps children with SyncProvider (which is a client component boundary itself). SidebarProvider can be used in server components — it reads cookies server-side for initial state.

    New implementation:
    ```tsx
    import { cookies } from "next/headers"
    import { SidebarProvider } from "@/components/ui/sidebar"
    import { AppSidebar } from "@/components/layout/app-sidebar"
    import { BreadcrumbNav } from "@/components/layout/breadcrumb-nav"
    import { AdminLayoutClient } from "@/components/admin/admin-layout-client"
    import { SyncProvider } from "@/components/providers/sync-provider"
    import { ConflictResolutionModal } from "@/components/sync/conflict-resolution-modal"
    import { adminNavItems } from "@/lib/navigation"

    export default async function AdminLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      const cookieStore = await cookies()
      const defaultOpen = cookieStore.get("sidebar:state")?.value !== "false"

      return (
        <SidebarProvider defaultOpen={defaultOpen}>
          <div className="flex min-h-screen w-full bg-background">
            <AppSidebar
              navItems={adminNavItems}
              dashboardTitle="Admin Dashboard"
              showSyncStatus={true}
            />
            <main className="flex-1 overflow-auto">
              <div className="p-8">
                <BreadcrumbNav />
                <SyncProvider>
                  <AdminLayoutClient>{children}</AdminLayoutClient>
                  <ConflictResolutionModal />
                </SyncProvider>
              </div>
            </main>
          </div>
        </SidebarProvider>
      )
    }
    ```

    Key changes:
    - Replace `<AdminSidebar />` with `<AppSidebar navItems={adminNavItems} ... />`
    - Wrap in `<SidebarProvider>` with cookie-based defaultOpen
    - Add `<BreadcrumbNav />` before content
    - Change `bg-gray-950` to `bg-background` (semantic token)
    - Add `overflow-auto` to main for proper scrolling with collapsible sidebar
    - Make function async to use `cookies()` API
    - Preserve SyncProvider, AdminLayoutClient, and ConflictResolutionModal exactly as-is

    IMPORTANT: Check whether the shadcn/ui SidebarProvider expects to read cookies itself or if we need to pass defaultOpen. The shadcn/ui sidebar component typically reads the cookie named "sidebar:state" internally. If SidebarProvider handles cookies automatically, just use `<SidebarProvider defaultOpen={true}>` without manual cookie reading. Inspect the generated `sidebar.tsx` to determine the correct approach.

    **Delete `apps/web/src/components/admin/sidebar.tsx`:**

    After the admin layout is updated to use AppSidebar, delete the old AdminSidebar component file:
    ```bash
    rm apps/web/src/components/admin/sidebar.tsx
    ```

    Verify no other files import from this path:
    ```bash
    grep -r "admin/sidebar" apps/web/src/ --include="*.tsx" --include="*.ts"
    ```
    Should return NO matches after the admin layout is updated.
  </action>
  <verify>
    - `grep "SidebarProvider" apps/web/src/app/admin/layout.tsx` confirms new pattern
    - `grep "AppSidebar" apps/web/src/app/admin/layout.tsx` confirms using unified component
    - `grep "adminNavItems" apps/web/src/app/admin/layout.tsx` confirms using navigation config
    - `grep "BreadcrumbNav" apps/web/src/app/admin/layout.tsx` confirms breadcrumbs added
    - `grep "AdminLayoutClient" apps/web/src/app/admin/layout.tsx` confirms preserved
    - `grep "SyncProvider" apps/web/src/app/admin/layout.tsx` confirms preserved
    - `grep "bg-gray-950" apps/web/src/app/admin/layout.tsx` should NOT match
    - `ls apps/web/src/components/admin/sidebar.tsx 2>/dev/null` should fail (file deleted)
    - `grep -r "admin/sidebar" apps/web/src/ --include="*.tsx" --include="*.ts"` should return nothing
    - `cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` shows no type errors
  </verify>
  <done>Admin layout uses SidebarProvider + AppSidebar + BreadcrumbNav. SyncProvider, AdminLayoutClient, and ConflictResolutionModal are preserved. Old AdminSidebar file is deleted. No hardcoded gray colors remain in layout.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor VA and Client layouts to use AppSidebar</name>
  <files>
    apps/web/src/app/va/layout.tsx
    apps/web/src/app/client/layout.tsx
  </files>
  <action>
    **Refactor `apps/web/src/app/va/layout.tsx`:**

    The VA layout MUST remain a "use client" component because it uses hooks: usePathname, useRouter, useUserRole, useEffect for RBAC filtering.

    New implementation — PRESERVE all RBAC logic:
    ```tsx
    "use client"

    import { useEffect } from "react"
    import { usePathname, useRouter } from "next/navigation"
    import { SidebarProvider } from "@/components/ui/sidebar"
    import { AppSidebar } from "@/components/layout/app-sidebar"
    import { BreadcrumbNav } from "@/components/layout/breadcrumb-nav"
    import { vaNavItems } from "@/lib/navigation"
    import { useUserRole } from "@/hooks/use-user-role"

    export default function VALayout({ children }: { children: React.ReactNode }) {
      const pathname = usePathname()
      const router = useRouter()
      const { role, hasAccessProfile, loading } = useUserRole()

      // RBAC: Filter nav items based on access profile
      const navItemsToShow =
        role === "va" && !hasAccessProfile
          ? vaNavItems.filter((item) => item.href === "/va")
          : vaNavItems

      // RBAC: Redirect VA without access profile away from non-dashboard pages
      useEffect(() => {
        if (!loading && role === "va" && !hasAccessProfile && pathname !== "/va") {
          router.replace("/va")
        }
      }, [loading, role, hasAccessProfile, pathname, router])

      // Loading state
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-background">
            <div className="text-muted-foreground">Loading...</div>
          </div>
        )
      }

      return (
        <SidebarProvider defaultOpen={true}>
          <div className="flex min-h-screen w-full bg-background">
            <AppSidebar
              navItems={navItemsToShow}
              dashboardTitle="VA Dashboard"
            />
            <main className="flex-1 overflow-auto">
              <div className="p-8">
                <BreadcrumbNav />
                {children}
              </div>
            </main>
          </div>
        </SidebarProvider>
      )
    }
    ```

    Key changes:
    - Remove inline sidebar (~100 lines of JSX with inline SVGs)
    - Remove local navItems definition (use imported vaNavItems)
    - Remove useState for profileOpen (handled by AppSidebar internally)
    - Remove ProfileSettingsDialog render (handled by AppSidebar)
    - Wrap in SidebarProvider
    - Add BreadcrumbNav
    - Change bg-gray-950 to bg-background, text-gray-400 to text-muted-foreground
    - PRESERVE all RBAC logic: hasAccessProfile filter, useEffect redirect, loading state

    **Refactor `apps/web/src/app/client/layout.tsx`:**

    The Client layout can be simplified significantly. Currently "use client" with inline sidebar. Change to use AppSidebar.

    It must remain "use client" because AppSidebar uses hooks internally, and SidebarProvider is a client component.

    New implementation:
    ```tsx
    "use client"

    import { SidebarProvider } from "@/components/ui/sidebar"
    import { AppSidebar } from "@/components/layout/app-sidebar"
    import { BreadcrumbNav } from "@/components/layout/breadcrumb-nav"
    import { clientNavItems } from "@/lib/navigation"

    export default function ClientLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      return (
        <SidebarProvider defaultOpen={true}>
          <div className="flex min-h-screen w-full bg-background">
            <AppSidebar
              navItems={clientNavItems}
              dashboardTitle="Client Dashboard"
            />
            <main className="flex-1 overflow-auto">
              <div className="p-8">
                <BreadcrumbNav />
                {children}
              </div>
            </main>
          </div>
        </SidebarProvider>
      )
    }
    ```

    Key changes:
    - Remove entire inline sidebar (~60 lines of JSX)
    - Remove local navItems, useState, usePathname, ProfileSettingsDialog
    - All handled by AppSidebar internally
    - Change bg-gray-950 to bg-background
    - Add BreadcrumbNav
  </action>
  <verify>
    - `grep "SidebarProvider" apps/web/src/app/va/layout.tsx` confirms new pattern
    - `grep "AppSidebar" apps/web/src/app/va/layout.tsx` confirms unified component
    - `grep "hasAccessProfile" apps/web/src/app/va/layout.tsx` confirms RBAC preserved
    - `grep "router.replace" apps/web/src/app/va/layout.tsx` confirms redirect preserved
    - `grep "BreadcrumbNav" apps/web/src/app/va/layout.tsx` confirms breadcrumbs added
    - `grep "bg-gray-950" apps/web/src/app/va/layout.tsx` should NOT match
    - `grep "SidebarProvider" apps/web/src/app/client/layout.tsx` confirms new pattern
    - `grep "AppSidebar" apps/web/src/app/client/layout.tsx` confirms unified component
    - `grep "clientNavItems" apps/web/src/app/client/layout.tsx` confirms nav config
    - `grep "BreadcrumbNav" apps/web/src/app/client/layout.tsx` confirms breadcrumbs added
    - `grep "bg-gray-950" apps/web/src/app/client/layout.tsx` should NOT match
    - `grep -r "<svg" apps/web/src/app/va/layout.tsx apps/web/src/app/client/layout.tsx` should return nothing (no inline SVGs)
    - `cd apps/web && npx tsc --noEmit --pretty 2>&1 | head -30` shows no type errors
  </verify>
  <done>VA layout uses AppSidebar with RBAC filtering preserved (hasAccessProfile conditional, redirect logic, loading state). Client layout uses AppSidebar with clientNavItems. Both layouts use BreadcrumbNav, SidebarProvider, and semantic color tokens. All inline SVG icons eliminated.</done>
</task>

</tasks>

<verification>
1. All 3 layouts use SidebarProvider + AppSidebar + BreadcrumbNav
2. No import references to old `@/components/admin/sidebar` remain anywhere in codebase
3. VA layout RBAC logic fully preserved (filter + redirect + loading state)
4. Admin layout SyncProvider + AdminLayoutClient + ConflictResolutionModal preserved
5. Zero hardcoded gray colors (bg-gray-950, text-gray-400, etc.) in any layout file
6. Zero inline SVG icons in any layout file
7. `npx tsc --noEmit` passes
8. `npm run build` passes (if feasible to run)
</verification>

<success_criteria>
- Three duplicate sidebar implementations consolidated into single AppSidebar usage
- Old AdminSidebar file deleted
- All layouts use semantic color tokens
- VA RBAC behavior identical to before refactor
- Admin layout preserves all existing providers and wrappers
- Sidebar collapsible via Cmd+B/Ctrl+B keyboard shortcut in all dashboards
- Breadcrumb navigation visible on sub-pages in all dashboards
</success_criteria>

<output>
After completion, create `.planning/phases/24-layout-component-consolidation/24-03-SUMMARY.md`
</output>
