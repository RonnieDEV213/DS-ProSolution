---
phase: 19-sync-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/hooks/sync/use-online-status.ts
  - apps/web/src/hooks/sync/use-sync-status.ts
  - apps/web/src/components/sync/sync-status-indicator.tsx
  - apps/web/src/components/admin/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Global sync indicator appears in sidebar during active sync"
    - "Indicator hidden when all data synced (clean state)"
    - "Indicator shows spinner and progress count during sync"
    - "Indicator shows error icon and 'Sync failed' on error"
    - "Indicator shows offline icon when network unavailable"
    - "'Last synced X ago' timestamp displays relative time"
  artifacts:
    - path: "apps/web/src/hooks/sync/use-online-status.ts"
      provides: "Online/offline detection hook using useSyncExternalStore"
      exports: ["useOnlineStatus"]
    - path: "apps/web/src/hooks/sync/use-sync-status.ts"
      provides: "Global sync status aggregation from multiple sources"
      exports: ["useSyncStatus", "SyncState"]
    - path: "apps/web/src/components/sync/sync-status-indicator.tsx"
      provides: "Header sync indicator component"
      exports: ["SyncStatusIndicator"]
  key_links:
    - from: "apps/web/src/components/sync/sync-status-indicator.tsx"
      to: "apps/web/src/hooks/sync/use-sync-status.ts"
      via: "useSyncStatus hook call"
      pattern: "useSyncStatus\\(\\)"
    - from: "apps/web/src/hooks/sync/use-sync-status.ts"
      to: "apps/web/src/hooks/sync/use-online-status.ts"
      via: "useOnlineStatus for network detection"
      pattern: "useOnlineStatus\\(\\)"
    - from: "apps/web/src/components/admin/sidebar.tsx"
      to: "apps/web/src/components/sync/sync-status-indicator.tsx"
      via: "SyncStatusIndicator rendered in sidebar"
      pattern: "<SyncStatusIndicator"
---

<objective>
Create global sync status indicator that shows sync progress, errors, and offline state in the admin sidebar.

Purpose: Users need clear visibility into data synchronization state - when syncing, synced, or failed (SYNC-01, SYNC-02, SYNC-04).

Output:
- `useOnlineStatus` hook for network detection
- `useSyncStatus` hook for aggregated sync state
- `SyncStatusIndicator` component rendered in sidebar
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-sync-protocol/19-CONTEXT.md
@.planning/phases/19-sync-protocol/19-RESEARCH.md
@.planning/phases/18-client-persistence/18-02-SUMMARY.md
@apps/web/src/hooks/sync/use-sync-records.ts
@apps/web/src/lib/db/sync.ts
@apps/web/src/components/admin/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create online status and sync status hooks</name>
  <files>
    apps/web/src/hooks/sync/use-online-status.ts
    apps/web/src/hooks/sync/use-sync-status.ts
  </files>
  <action>
Create `use-online-status.ts`:
- Use React's `useSyncExternalStore` pattern (see RESEARCH.md code example)
- Subscribe to `window.addEventListener('online'/'offline')` events
- Return boolean for current online state
- Server-side rendering: return `true` as default

Create `use-sync-status.ts`:
- Define `SyncState` interface with: `status: 'idle' | 'syncing' | 'error' | 'offline'`, `pendingCount: number`, `lastSyncAt: Date | null`, `error: string | null`
- Use `useOnlineStatus()` for network state
- Use TanStack Query's `useMutationState` to track pending mutations (filter by status: 'pending')
- Use Dexie's `useLiveQuery` to count pending items from `_sync_meta` table (where cursor is not null = partial sync in progress)
- Use `getLastSyncTime('records:*')` pattern from db/sync.ts for last sync timestamp
- Compute combined status: offline -> syncing (if any pending) -> error (if has error) -> idle

NOTE: For now, pendingCount combines TanStack Query pending mutations + incomplete syncs. Phase 19-03 will add `_pending_mutations` table for offline queue.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/web && npx tsc --noEmit
```
  </verify>
  <done>
- `useOnlineStatus` returns boolean tracking navigator.onLine
- `useSyncStatus` returns SyncState with status/pendingCount/lastSyncAt/error
- Both hooks export properly typed interfaces
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sync status indicator component</name>
  <files>
    apps/web/src/components/sync/sync-status-indicator.tsx
  </files>
  <action>
Create `sync-status-indicator.tsx`:
- Import icons from lucide-react: `Cloud`, `CloudOff`, `Loader2`, `AlertCircle`, `RefreshCw`
- Import `formatDistanceToNow` from date-fns
- Use `useSyncStatus()` hook
- Render based on status:
  - `idle`: Return null (hidden per CONTEXT.md - "only appears during active sync or errors")
  - `syncing`: Show Loader2 spinning + "Syncing {pendingCount} records" text (blue color)
  - `error`: Show AlertCircle + "Sync failed" text + retry button (red color, persistent)
  - `offline`: Show CloudOff + "Offline" text (yellow color)
- Below status, show "Last synced X ago" using `formatDistanceToNow(lastSyncAt, { addSuffix: true })`
- Retry button onClick: Call `refetch` from useSyncStatus (need to add this to hook - triggers manual sync)
- Style: Small text, subtle colors, fits in sidebar bottom area
- Use framer-motion for smooth transitions between states

Structure:
```tsx
export function SyncStatusIndicator() {
  const { status, pendingCount, lastSyncAt, error, retry } = useSyncStatus();
  // Return null when idle
  // Otherwise render status + last synced time
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd apps/web && npx tsc --noEmit
```
  </verify>
  <done>
- Component renders appropriate icon/text for each status
- Hidden when idle (synced state)
- Shows "Last synced X ago" when lastSyncAt available
- Retry button visible on error state
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire sync indicator into admin sidebar</name>
  <files>
    apps/web/src/components/admin/sidebar.tsx
  </files>
  <action>
Modify `sidebar.tsx`:
- Import `SyncStatusIndicator` from `@/components/sync/sync-status-indicator`
- Add `SyncStatusIndicator` above the "Profile Settings" button in the bottom section
- Place inside a small container div with appropriate spacing (mb-2 or similar)

The sidebar structure should be:
```tsx
<div className="p-4 border-t border-gray-800">
  <SyncStatusIndicator />  {/* NEW */}
  <button onClick={() => setProfileOpen(true)} ...>
    Profile Settings
  </button>
</div>
```
  </action>
  <verify>
1. Start dev server and navigate to admin page
2. Verify indicator appears during initial sync (brief spinner)
3. Verify indicator disappears when sync complete
4. Verify "Last synced X ago" shows after first sync
  </verify>
  <done>
- SyncStatusIndicator renders in sidebar
- Indicator shows during active sync
- Indicator hidden when synced
- Last synced timestamp visible
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd apps/web && npx tsc --noEmit`
2. App runs without console errors: `cd apps/web && npm run dev`
3. Navigate to /admin - sync indicator appears briefly during load, then hides
4. Disconnect network (DevTools > Network > Offline) - indicator shows "Offline"
5. Reconnect network - indicator shows syncing then hides
</verification>

<success_criteria>
- SYNC-01: Sync status indicator visible during sync/error/offline states
- SYNC-02: "Last synced X ago" displays relative timestamp
- SYNC-04 (partial): Error state shows message with retry button
- Indicator hidden when fully synced (clean, unobtrusive UX)
</success_criteria>

<output>
After completion, create `.planning/phases/19-sync-protocol/19-01-SUMMARY.md`
</output>
