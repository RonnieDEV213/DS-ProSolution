---
phase: 26-polish-micro-interactions
plan: 05
type: execute
wave: 2
depends_on: ["26-02"]
files_modified:
  - apps/web/src/components/command-palette/command-palette.tsx
  - apps/web/src/hooks/use-global-shortcuts.ts
  - apps/web/src/components/command-palette/shortcuts-reference.tsx
  - apps/web/src/app/admin/layout.tsx
  - apps/web/src/app/va/layout.tsx
  - apps/web/src/app/client/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Cmd+K opens command palette with navigation + action items"
    - "Command palette fuzzy-searches across all pages and actions"
    - "Vim-style navigation shortcuts work (G then D for dashboard, etc.)"
    - "? key opens shortcuts reference modal"
    - "Shortcuts reference shows all available keyboard shortcuts"
    - "Command palette and shortcuts are wired into all three dashboard layouts"
  artifacts:
    - path: "apps/web/src/components/command-palette/command-palette.tsx"
      provides: "Command palette dialog with navigation, actions, search"
      exports: ["CommandPalette"]
    - path: "apps/web/src/hooks/use-global-shortcuts.ts"
      provides: "Global keyboard shortcuts registration hook"
      exports: ["useGlobalShortcuts"]
    - path: "apps/web/src/components/command-palette/shortcuts-reference.tsx"
      provides: "Shortcuts reference modal (? key)"
      exports: ["ShortcutsReference"]
  key_links:
    - from: "command-palette.tsx"
      to: "apps/web/src/lib/command-items.ts"
      via: "imports navigationItems, actionItems"
      pattern: "navigationItems|actionItems"
    - from: "use-global-shortcuts.ts"
      to: "react-hotkeys-hook"
      via: "useHotkeys hook"
      pattern: "useHotkeys"
    - from: "use-global-shortcuts.ts"
      to: "apps/web/src/lib/shortcuts.ts"
      via: "imports SHORTCUTS registry"
      pattern: "SHORTCUTS"
    - from: "admin/layout.tsx"
      to: "command-palette.tsx"
      via: "renders CommandPalette + ShortcutsReference + ProfileSettingsDialog"
      pattern: "CommandPalette"
    - from: "command-palette.tsx onOpenSettings"
      to: "ProfileSettingsDialog"
      via: "LayoutShortcuts settingsOpen state from useGlobalShortcuts"
      pattern: "ProfileSettingsDialog open={settingsOpen}"
---

<objective>
Build the command palette, global keyboard shortcuts, and shortcuts reference modal, then wire everything into all dashboard layouts.

Purpose: Give power users instant access to any page/action via Cmd+K (POLISH-09) and keyboard shortcuts (POLISH-10). This is the signature power-user feature of the v4 polish layer.

Output: Working command palette with fuzzy search, global vim-style shortcuts, shortcuts reference modal, all integrated into Admin/VA/Client layouts.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/26-polish-micro-interactions/26-02-SUMMARY.md
@apps/web/src/lib/shortcuts.ts
@apps/web/src/lib/command-items.ts
@apps/web/src/lib/navigation.ts
@apps/web/src/components/ui/command.tsx
@apps/web/src/components/ui/kbd.tsx
@apps/web/src/components/layout/app-sidebar.tsx
@apps/web/src/app/admin/layout.tsx
@apps/web/src/app/va/layout.tsx
@apps/web/src/app/client/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build CommandPalette component with navigation and actions</name>
  <files>apps/web/src/components/command-palette/command-palette.tsx</files>
  <action>
Create `apps/web/src/components/command-palette/command-palette.tsx`:

```tsx
"use client"

import { useCallback } from "react"
import { useRouter } from "next/navigation"
import * as LucideIcons from "lucide-react"
import {
  CommandDialog,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
  CommandSeparator,
  CommandShortcut,
} from "@/components/ui/command"
import { navigationItems, actionItems, type CommandItemDef } from "@/lib/command-items"
import { useSidebar } from "@/components/ui/sidebar"

interface CommandPaletteProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onOpenSettings?: () => void
  basePath?: string  // "/admin", "/va", "/client" -- adjusts navigation hrefs
}

export function CommandPalette({
  open,
  onOpenChange,
  onOpenSettings,
  basePath = "/admin",
}: CommandPaletteProps) {
  const router = useRouter()
  const sidebar = useSidebar()

  const handleSelect = useCallback(
    (item: CommandItemDef) => {
      onOpenChange(false)

      if (item.href) {
        // Adapt navigation path based on user role
        // Admin paths work as-is; VA/Client need base path substitution
        let href = item.href
        if (basePath !== "/admin" && href.startsWith("/admin")) {
          // Only substitute routes that exist for this role
          // VA has: /va, /va/accounts, /va/order-tracking
          // Client has: /client
          const adminSubPath = href.replace("/admin", "")
          if (adminSubPath === "" || adminSubPath === "/accounts" || adminSubPath === "/order-tracking") {
            href = basePath + adminSubPath
          } else {
            // Route doesn't exist for this role; skip navigation
            return
          }
        }
        router.push(href)
        return
      }

      if (item.action) {
        switch (item.action) {
          case "toggle-sidebar":
            sidebar.toggleSidebar()
            break
          case "open-theme":
            // Theme popover is in sidebar footer; open sidebar if collapsed
            if (sidebar.state === "collapsed") {
              sidebar.toggleSidebar()
            }
            break
          case "open-settings":
            onOpenSettings?.()
            break
        }
      }
    },
    [router, onOpenChange, onOpenSettings, sidebar, basePath]
  )

  // Filter navigation items based on role
  const filteredNavItems = navigationItems.filter((item) => {
    if (basePath === "/admin") return true
    if (item.adminOnly) return false
    // VA sees dashboard, accounts, order-tracking
    if (basePath === "/va") {
      const vaRoutes = ["/admin", "/admin/accounts", "/admin/order-tracking"]
      return item.href ? vaRoutes.includes(item.href) : true
    }
    // Client sees dashboard only
    if (basePath === "/client") {
      return item.href === "/admin"
    }
    return true
  })

  return (
    <CommandDialog open={open} onOpenChange={onOpenChange}>
      <CommandInput placeholder="Type a command or search..." />
      <CommandList>
        <CommandEmpty>No results found.</CommandEmpty>

        <CommandGroup heading="Navigation">
          {filteredNavItems.map((item) => {
            const Icon = LucideIcons[item.icon as keyof typeof LucideIcons] as React.ElementType
            return (
              <CommandItem
                key={item.id}
                value={item.label}
                keywords={item.keywords}
                onSelect={() => handleSelect(item)}
              >
                {Icon && <Icon className="mr-2 h-4 w-4" />}
                <span>{item.label}</span>
                {item.shortcut && (
                  <CommandShortcut>{item.shortcut.join(" ")}</CommandShortcut>
                )}
              </CommandItem>
            )
          })}
        </CommandGroup>

        <CommandSeparator />

        <CommandGroup heading="Actions">
          {actionItems.map((item) => {
            const Icon = LucideIcons[item.icon as keyof typeof LucideIcons] as React.ElementType
            return (
              <CommandItem
                key={item.id}
                value={item.label}
                keywords={item.keywords}
                onSelect={() => handleSelect(item)}
              >
                {Icon && <Icon className="mr-2 h-4 w-4" />}
                <span>{item.label}</span>
                {item.shortcut && (
                  <CommandShortcut>{item.shortcut.join(" ")}</CommandShortcut>
                )}
              </CommandItem>
            )
          })}
        </CommandGroup>
      </CommandList>
    </CommandDialog>
  )
}
```

Design decisions:
- `basePath` prop enables role-based route adaptation (Admin uses /admin, VA uses /va, Client uses /client)
- `adminOnly` items filtered out for non-admin roles
- VA routes limited to dashboard/accounts/order-tracking (matches vaNavItems from navigation.ts)
- Client routes limited to dashboard only (matches clientNavItems from navigation.ts)
- Action handling uses switch statement for extensibility
- `useSidebar()` used for toggle-sidebar action
- `onOpenSettings` callback allows parent to control profile settings dialog
- Uses Lucide icon dynamic rendering pattern (Phase 24 decision)
- cmdk handles fuzzy search, keyboard navigation (arrow keys, Enter, Escape) automatically

Important: The CommandDialog component (from shadcn/ui) already includes:
- Overlay with fade animation
- Content with scale + fade animation (POLISH-05 satisfied)
- Keyboard navigation (up/down arrows, Enter to select, Escape to close)
- Focus management and accessibility
  </action>
  <verify>
Run `npm run build` in apps/web. Verify command-palette.tsx exports CommandPalette component with open/onOpenChange props. Check TypeScript compiles clean with no type errors on LucideIcons dynamic rendering.
  </verify>
  <done>
CommandPalette renders navigation + action groups with fuzzy search, keyboard navigation, role-based filtering, and shortcut badges. Dialog animations satisfy POLISH-05.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useGlobalShortcuts hook and ShortcutsReference modal</name>
  <files>apps/web/src/hooks/use-global-shortcuts.ts, apps/web/src/components/command-palette/shortcuts-reference.tsx</files>
  <action>
1. **Create `apps/web/src/hooks/use-global-shortcuts.ts`**:

```tsx
"use client"

import { useState, useCallback } from "react"
import { useRouter } from "next/navigation"
import { useHotkeys } from "react-hotkeys-hook"
import { useSidebar } from "@/components/ui/sidebar"

interface UseGlobalShortcutsOptions {
  basePath?: string  // "/admin", "/va", "/client"
}

export function useGlobalShortcuts({ basePath = "/admin" }: UseGlobalShortcutsOptions = {}) {
  const router = useRouter()
  const { toggleSidebar } = useSidebar()
  const [commandOpen, setCommandOpen] = useState(false)
  const [shortcutsOpen, setShortcutsOpen] = useState(false)
  const [settingsOpen, setSettingsOpen] = useState(false)

  // Command palette: Cmd+K / Ctrl+K
  useHotkeys("mod+k", (e) => {
    e.preventDefault()
    setCommandOpen(true)
  }, { enableOnFormTags: false })

  // Shortcuts reference: ? (Shift+/)
  useHotkeys("shift+/", (e) => {
    // Don't trigger if user is typing in an input/textarea
    const target = e.target as HTMLElement
    if (target.tagName === "INPUT" || target.tagName === "TEXTAREA" || target.isContentEditable) {
      return
    }
    e.preventDefault()
    setShortcutsOpen(true)
  })

  // Navigate function that adapts paths based on role
  const navigateTo = useCallback((adminPath: string) => {
    if (basePath === "/admin") {
      router.push(adminPath)
      return
    }
    // Adapt path for VA/Client
    const subPath = adminPath.replace("/admin", "")
    router.push(basePath + subPath)
  }, [router, basePath])

  // Vim-style navigation: G then D for Dashboard
  useHotkeys("g,d", () => navigateTo("/admin"), {
    enableOnFormTags: false,
  })

  // G then B for Order Tracking (bookkeeping)
  useHotkeys("g,b", () => navigateTo("/admin/order-tracking"), {
    enableOnFormTags: false,
  })

  // G then U for Users (admin only)
  useHotkeys("g,u", () => {
    if (basePath === "/admin") router.push("/admin/users")
  }, { enableOnFormTags: false })

  // G then A for Accounts
  useHotkeys("g,a", () => navigateTo("/admin/accounts"), {
    enableOnFormTags: false,
  })

  // NOTE: Cmd+B/Ctrl+B for sidebar toggle is already implemented in sidebar.tsx (Phase 24)
  // We don't re-register it here to avoid conflicts.

  return {
    commandOpen,
    setCommandOpen,
    shortcutsOpen,
    setShortcutsOpen,
    settingsOpen,
    setSettingsOpen,
  }
}
```

Key decisions:
- `enableOnFormTags: false` prevents shortcuts from firing when typing in inputs
- Separate check for `shift+/` against input/textarea elements (extra safety)
- `navigateTo` function adapts admin paths to VA/Client paths automatically
- Admin-only shortcuts (G,U) check basePath before navigating
- Sidebar toggle NOT re-registered (already in sidebar.tsx from Phase 24)
- Returns state setters for CommandPalette and ShortcutsReference open states

2. **Create `apps/web/src/components/command-palette/shortcuts-reference.tsx`**:

```tsx
"use client"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Kbd } from "@/components/ui/kbd"
import { SHORTCUTS, SHORTCUT_GROUPS, type ShortcutGroup } from "@/lib/shortcuts"

interface ShortcutsReferenceProps {
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function ShortcutsReference({ open, onOpenChange }: ShortcutsReferenceProps) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-lg bg-card border-border text-card-foreground">
        <DialogHeader>
          <DialogTitle>Keyboard Shortcuts</DialogTitle>
          <DialogDescription className="text-muted-foreground">
            Navigate faster with keyboard shortcuts. Press <Kbd>?</Kbd> to toggle this reference.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-6 max-h-[60vh] overflow-y-auto scrollbar-thin pr-2">
          {SHORTCUT_GROUPS.map((group) => {
            const groupShortcuts = SHORTCUTS.filter((s) => s.group === group)
            if (groupShortcuts.length === 0) return null

            return (
              <div key={group}>
                <h4 className="text-sm font-semibold text-foreground mb-3">{group}</h4>
                <div className="grid grid-cols-[1fr,auto] gap-y-2.5 gap-x-4">
                  {groupShortcuts.map((shortcut) => (
                    <div key={shortcut.key} className="contents">
                      <span className="text-sm text-muted-foreground">{shortcut.description}</span>
                      <div className="flex items-center gap-1">
                        {shortcut.display.map((key, i) => (
                          <span key={i} className="flex items-center gap-1">
                            {i > 0 && <span className="text-muted-foreground/50 text-xs">then</span>}
                            <Kbd>{key}</Kbd>
                          </span>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )
          })}
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

Design decisions:
- Uses SHORTCUTS registry as single source of truth
- Groups shortcuts by SHORTCUT_GROUPS categories
- Sequential keys (G then D) show "then" text between Kbd badges
- `scrollbar-thin` for scrollable content (matches Phase 25 pattern)
- `max-h-[60vh]` prevents the modal from being too tall
- Uses Kbd component for consistent shortcut badges
- Dialog already has open/close animations (POLISH-05)
  </action>
  <verify>
Run `npm run build` in apps/web. Verify use-global-shortcuts.ts exports useGlobalShortcuts hook and shortcuts-reference.tsx exports ShortcutsReference component.
  </verify>
  <done>
useGlobalShortcuts registers Cmd+K, ? shortcut, and vim-style navigation. ShortcutsReference modal displays all shortcuts grouped by category with Kbd badges.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire command palette, shortcuts, and settings dialog into all dashboard layouts</name>
  <files>apps/web/src/app/admin/layout.tsx, apps/web/src/app/va/layout.tsx, apps/web/src/app/client/layout.tsx</files>
  <action>
Integrate CommandPalette, ShortcutsReference, ProfileSettingsDialog, and useGlobalShortcuts into all three dashboard layouts.

**Critical wiring note:** The `ProfileSettingsDialog` component already exists at `apps/web/src/components/profile/profile-settings-dialog.tsx` (created in Phase 24). It accepts `open: boolean` and `onOpenChange: (open: boolean) => void` props. It is currently rendered inside `AppSidebar` with local state for the sidebar's "Profile Settings" button. The command palette also has an "open-settings" action (in `command-items.ts`) that calls `onOpenSettings?.()`. The LayoutShortcuts wrapper MUST render its own `ProfileSettingsDialog` instance wired to the `settingsOpen`/`setSettingsOpen` state from `useGlobalShortcuts` so that the command palette's "Profile Settings" action actually opens the dialog. This is safe because only one dialog instance can be open at a time (sidebar button opens AppSidebar's instance, command palette opens LayoutShortcuts' instance).

**Pattern for each layout:**

Add imports:
```tsx
import { CommandPalette } from "@/components/command-palette/command-palette"
import { ShortcutsReference } from "@/components/command-palette/shortcuts-reference"
import { ProfileSettingsDialog } from "@/components/profile/profile-settings-dialog"
import { useGlobalShortcuts } from "@/hooks/use-global-shortcuts"
```

Inside the layout component function (INSIDE SidebarProvider since useGlobalShortcuts needs useSidebar context), create a wrapper component that uses the hooks:

Create an inner component pattern because useGlobalShortcuts calls useSidebar() which requires SidebarProvider context:

```tsx
function LayoutShortcuts({ basePath, children }: { basePath: string; children: React.ReactNode }) {
  const { commandOpen, setCommandOpen, shortcutsOpen, setShortcutsOpen, settingsOpen, setSettingsOpen } = useGlobalShortcuts({ basePath })

  return (
    <>
      {children}
      <CommandPalette
        open={commandOpen}
        onOpenChange={setCommandOpen}
        onOpenSettings={() => setSettingsOpen(true)}
        basePath={basePath}
      />
      <ShortcutsReference open={shortcutsOpen} onOpenChange={setShortcutsOpen} />
      <ProfileSettingsDialog open={settingsOpen} onOpenChange={setSettingsOpen} />
    </>
  )
}
```

**Admin layout (apps/web/src/app/admin/layout.tsx):**

Current structure:
```tsx
<SidebarProvider>
  <AppSidebar ... />
  <SidebarInset>
    ...
  </SidebarInset>
</SidebarProvider>
```

Updated structure -- wrap existing content with LayoutShortcuts inside SidebarProvider:
```tsx
<SidebarProvider>
  <AdminLayoutShortcuts>
    <AppSidebar ... />
    <SidebarInset>
      ...
    </SidebarInset>
  </AdminLayoutShortcuts>
</SidebarProvider>
```

Where AdminLayoutShortcuts is defined in the same file:
```tsx
function AdminLayoutShortcuts({ children }: { children: React.ReactNode }) {
  const { commandOpen, setCommandOpen, shortcutsOpen, setShortcutsOpen, settingsOpen, setSettingsOpen } = useGlobalShortcuts({ basePath: "/admin" })

  return (
    <>
      {children}
      <CommandPalette open={commandOpen} onOpenChange={setCommandOpen} onOpenSettings={() => setSettingsOpen(true)} basePath="/admin" />
      <ShortcutsReference open={shortcutsOpen} onOpenChange={setShortcutsOpen} />
      <ProfileSettingsDialog open={settingsOpen} onOpenChange={setSettingsOpen} />
    </>
  )
}
```

**VA layout (apps/web/src/app/va/layout.tsx):**
Same pattern with `basePath="/va"`. Name the inner component `VaLayoutShortcuts`.

**Client layout (apps/web/src/app/client/layout.tsx):**
Same pattern with `basePath="/client"`. Name the inner component `ClientLayoutShortcuts`.

Important implementation notes:
- The inner component MUST be inside SidebarProvider (it calls useSidebar via useGlobalShortcuts)
- CommandPalette, ShortcutsReference, and ProfileSettingsDialog render as portaled dialogs (no layout impact)
- Keep existing layout structure intact -- only add the wrapper and dialog components
- Each layout already has `"use client"` directive (Phase 24)
- Don't remove or modify any existing components (AppSidebar, BreadcrumbNav, SyncProvider, etc.)
- AppSidebar already has its own ProfileSettingsDialog for the sidebar "Profile Settings" button click -- that stays as-is. The LayoutShortcuts wrapper adds a second instance for the command palette trigger. Only one can be open at a time, so there is no conflict.
  </action>
  <verify>
Run `npm run build` in apps/web. Verify all three layout files import and render CommandPalette + ShortcutsReference + ProfileSettingsDialog. Use grep to confirm `ProfileSettingsDialog` appears in all three layout files. Check no TypeScript errors with useSidebar context.
  </verify>
  <done>
Command palette and keyboard shortcuts are wired into Admin, VA, and Client layouts. Cmd+K opens command palette, ? opens shortcuts reference, and vim-style navigation shortcuts work across all dashboards. The "Profile Settings" action in the command palette opens ProfileSettingsDialog via the settingsOpen state in LayoutShortcuts.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. CommandPalette opens via Cmd+K with navigation + action groups
3. ShortcutsReference opens via ? key with all shortcuts displayed
4. Vim-style shortcuts (G+D, G+B, G+U, G+A) navigate to correct pages
5. All three dashboard layouts (admin, va, client) have command palette + shortcuts
6. Shortcuts don't fire when typing in form inputs
7. Role-based filtering works (VA sees subset of navigation items)
</verification>

<success_criteria>
- Power users can access any page via Cmd+K fuzzy search
- Vim-style G+key navigation works for common pages
- ? key shows comprehensive shortcuts reference
- Command palette adapts to user role (admin/VA/client)
- All shortcuts disabled when typing in inputs
- Dialog animations are smooth (POLISH-05)
</success_criteria>

<output>
After completion, create `.planning/phases/26-polish-micro-interactions/26-05-SUMMARY.md`
</output>
