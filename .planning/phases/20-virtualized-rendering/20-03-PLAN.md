---
phase: 20-virtualized-rendering
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - apps/web/src/components/bookkeeping/quick-filter-chips.tsx
  - apps/web/src/components/bookkeeping/keyboard-shortcuts-modal.tsx
  - apps/web/src/hooks/use-scroll-restoration.ts
  - apps/web/src/components/bookkeeping/records-toolbar.tsx
  - apps/web/src/components/bookkeeping/bookkeeping-content.tsx
autonomous: true

must_haves:
  truths:
    - "Quick filter chips filter records by status"
    - "Active filters are visually indicated"
    - "Clear all filters button resets to showing all records"
    - "Scroll position restores when navigating back to list"
    - "? key opens keyboard shortcuts help modal"
  artifacts:
    - path: "apps/web/src/components/bookkeeping/quick-filter-chips.tsx"
      provides: "Status filter chip buttons"
      exports: ["QuickFilterChips"]
    - path: "apps/web/src/components/bookkeeping/keyboard-shortcuts-modal.tsx"
      provides: "Keyboard shortcuts help dialog"
      exports: ["KeyboardShortcutsModal"]
    - path: "apps/web/src/hooks/use-scroll-restoration.ts"
      provides: "Scroll position save/restore hook"
      exports: ["useScrollRestoration"]
    - path: "apps/web/src/components/bookkeeping/records-toolbar.tsx"
      provides: "Toolbar with filter chips and density toggle"
      exports: ["RecordsToolbar"]
  key_links:
    - from: "quick-filter-chips.tsx"
      to: "bookkeeping-content.tsx"
      via: "activeFilters state and onToggle callback"
      pattern: "onToggle.*filter"
    - from: "use-scroll-restoration.ts"
      to: "sessionStorage"
      via: "STORAGE_KEYS.SCROLL_OFFSET"
      pattern: "sessionStorage.*SCROLL_OFFSET"
---

<objective>
Add quick filter chips for common status filters and implement scroll position restoration for better UX.

Purpose: Enable one-click filtering by order status (avoiding full search UI complexity) and maintain scroll position when navigating away and back.

Output: Status filter chips in toolbar, keyboard shortcuts modal, scroll position persisted to sessionStorage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-virtualized-rendering/20-CONTEXT.md
@.planning/phases/20-virtualized-rendering/20-RESEARCH.md
@.planning/phases/20-virtualized-rendering/20-01-SUMMARY.md

# Files from Plan 01
@apps/web/src/components/bookkeeping/virtualized-records-list.tsx
@apps/web/src/lib/storage-keys.ts
@apps/web/src/hooks/use-row-density.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quick filter chips and scroll restoration hook</name>
  <files>
    apps/web/src/components/bookkeeping/quick-filter-chips.tsx
    apps/web/src/hooks/use-scroll-restoration.ts
  </files>
  <action>
Create QuickFilterChips component following RESEARCH.md Pattern 5:

Define filter options (based on STATUS_OPTIONS in records-table.tsx):
```typescript
const QUICK_FILTERS = [
  { id: 'all', label: 'All' },
  { id: 'successful', label: 'Successful', status: 'SUCCESSFUL' },
  { id: 'returns', label: 'Returns', statuses: ['RETURN_LABEL_PROVIDED', 'RETURN_CLOSED'] },
  { id: 'refunds', label: 'Refunds', status: 'REFUND_NO_RETURN' },
];
```

Props:
- activeFilter: string ('all' | 'successful' | 'returns' | 'refunds')
- onFilterChange: (filterId: string) => void

Rendering:
- Use Badge component from ui/badge
- Active filter: variant="default" (filled)
- Inactive filters: variant="outline"
- onClick toggles filter (clicking active filter goes back to 'all')
- Add role="radiogroup" and role="radio" for accessibility

Note: Unlike RESEARCH.md Pattern 5 which uses multi-select, use single-select (radio-style) for simpler UX.

Create useScrollRestoration hook following RESEARCH.md scroll restoration pattern:

Parameters:
- listRef: RefObject<List> (react-window List ref)
- key: string (unique key for this scroll position, e.g., accountId)

Behavior:
- On mount: Read scroll offset from sessionStorage using STORAGE_KEYS.SCROLL_OFFSET:{key}
- If found and listRef.current exists: call listRef.current.scrollTo(offset)
- On unmount: Save current scrollOffset to sessionStorage
- Use useEffect with cleanup function for unmount save

Import STORAGE_KEYS from lib/storage-keys.ts.
  </action>
  <verify>
npx tsc --noEmit
  </verify>
  <done>
QuickFilterChips renders status filter badges with active indication; useScrollRestoration saves/restores scroll position via sessionStorage
  </done>
</task>

<task type="auto">
  <name>Task 2: Create keyboard shortcuts modal and records toolbar</name>
  <files>
    apps/web/src/components/bookkeeping/keyboard-shortcuts-modal.tsx
    apps/web/src/components/bookkeeping/records-toolbar.tsx
  </files>
  <action>
Create KeyboardShortcutsModal component:

Props:
- open: boolean
- onOpenChange: (open: boolean) => void

Content (using Dialog from ui/dialog):
- Title: "Keyboard Shortcuts"
- Grid layout with shortcut descriptions:
  - j / Down Arrow: Next row
  - k / Up Arrow: Previous row
  - Enter: Expand/collapse row
  - Escape: Clear focus
  - ?: Show this help
- Footer: "Press Escape or click outside to close"

Create RecordsToolbar component:

Props:
- activeFilter: string
- onFilterChange: (filterId: string) => void
- density: 'compact' | 'comfortable'
- onToggleDensity: () => void
- recordCount: number
- isFiltered: boolean

Layout (flex row, justify-between):
Left side:
- QuickFilterChips component
- Record count text: "{count} record(s)" or "{count} record(s) (filtered)"

Right side:
- Density toggle button:
  - Icon: Rows2 (lucide-react) for comfortable, Rows3 for compact
  - Tooltip: "Switch to compact/comfortable view"
- Keyboard help button:
  - Icon: Keyboard (lucide-react)
  - Tooltip: "Keyboard shortcuts (?)"
  - Opens KeyboardShortcutsModal

Manage modal state internally (useState for open).
  </action>
  <verify>
npx tsc --noEmit
  </verify>
  <done>
KeyboardShortcutsModal displays all shortcuts; RecordsToolbar integrates filter chips, density toggle, and help button
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire toolbar and scroll restoration into bookkeeping flow</name>
  <files>
    apps/web/src/components/bookkeeping/bookkeeping-content.tsx
    apps/web/src/components/bookkeeping/virtualized-records-list.tsx
  </files>
  <action>
Update bookkeeping-content.tsx:

1. Add filter state:
```typescript
const [activeFilter, setActiveFilter] = useState<string>('all');
```

2. Filter records before passing to VirtualizedRecordsList:
```typescript
const filteredRecords = useMemo(() => {
  if (activeFilter === 'all') return records;
  if (activeFilter === 'successful') return records.filter(r => r.status === 'SUCCESSFUL');
  if (activeFilter === 'returns') return records.filter(r =>
    r.status === 'RETURN_LABEL_PROVIDED' || r.status === 'RETURN_CLOSED');
  if (activeFilter === 'refunds') return records.filter(r => r.status === 'REFUND_NO_RETURN');
  return records;
}, [records, activeFilter]);
```

3. Add RecordsToolbar above VirtualizedRecordsList:
- Pass activeFilter, setActiveFilter (as onFilterChange)
- Pass density and toggleDensity from useRowDensity (lift hook to this component)
- Pass filteredRecords.length as recordCount
- Pass activeFilter !== 'all' as isFiltered

4. Pass filteredRecords to VirtualizedRecordsList instead of records

5. Reset filter to 'all' when account changes (in handleAccountSelect)

6. Add keyboard listener for ? key to trigger help modal:
   - Manage helpModalOpen state
   - Add global keydown listener for '?' that opens modal
   - Only trigger when not in input/textarea

Update virtualized-records-list.tsx:

1. Accept listRef from parent (forwardRef) OR expose ref via useImperativeHandle
2. Call useScrollRestoration with listRef and accountId
3. Ensure scrollTo is called after initial render (useEffect delay or requestAnimationFrame)

Integration with ? keyboard shortcut:
- RecordsToolbar manages its own modal state
- OR bookkeeping-content manages modal and passes props to toolbar
- Either approach works; keep it simple
  </action>
  <verify>
npm run dev (visual check: filter chips work, scroll position restores after navigation)
npx tsc --noEmit
  </verify>
  <done>
Quick filter chips filter records by status; toolbar shows density toggle and keyboard help; scroll position restores when returning to page; ? opens help modal
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Clicking filter chip updates displayed records
3. Active filter chip shows filled variant
4. Clicking active filter returns to "All"
5. Record count updates when filtering
6. ? key opens keyboard shortcuts modal
7. Scroll position saves on unmount and restores on mount
8. Density toggle persists preference
</verification>

<success_criteria>
- Quick filter chips show All, Successful, Returns, Refunds
- Clicking chip filters records (single-select behavior)
- Active filter visually distinct (filled badge)
- Record count shows "(filtered)" when filter active
- ? key opens help modal with all shortcuts listed
- Scroll position restores when navigating away and back
- Density toggle in toolbar persists to localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/20-virtualized-rendering/20-03-SUMMARY.md`
</output>
