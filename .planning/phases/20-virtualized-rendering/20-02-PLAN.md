---
phase: 20-virtualized-rendering
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - apps/web/src/components/bookkeeping/virtualized-records-list.tsx
  - apps/web/src/components/bookkeeping/result-summary.tsx
  - apps/web/src/hooks/use-keyboard-navigation.ts
  - apps/web/src/components/bookkeeping/bookkeeping-content.tsx
autonomous: true

must_haves:
  truths:
    - "Lists display row count and result summary (Showing 1-50 of N)"
    - "j/k keys navigate between rows, Enter toggles expand, Escape clears focus"
    - "Keyboard shortcut hints visible via tooltips"
  artifacts:
    - path: "apps/web/src/hooks/use-keyboard-navigation.ts"
      provides: "Keyboard navigation hook with j/k/Enter/Escape handlers"
      exports: ["useKeyboardNavigation"]
    - path: "apps/web/src/components/bookkeeping/result-summary.tsx"
      provides: "Result count display component"
      exports: ["ResultSummary"]
  key_links:
    - from: "virtualized-records-list.tsx"
      to: "react-window-infinite-loader"
      via: "useInfiniteLoader + onRowsRendered"
      pattern: "onRowsRendered"
    - from: "use-keyboard-navigation.ts"
      to: "virtualized-records-list.tsx"
      via: "focusedIndex state and scrollToItem"
      pattern: "scrollToItem"
---

<objective>
Integrate infinite scroll with virtual scrolling and add keyboard navigation for efficient list browsing.

Purpose: Enable seamless pagination as user scrolls (no "Load More" button), provide keyboard shortcuts for power users, and show result summary for context.

Output: Infinite scroll triggers when user nears bottom, j/k navigates rows, Enter expands focused row, result summary shows current position in list.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-virtualized-rendering/20-CONTEXT.md
@.planning/phases/20-virtualized-rendering/20-RESEARCH.md
@.planning/phases/20-virtualized-rendering/20-01-SUMMARY.md

# Files from Plan 01
@apps/web/src/components/bookkeeping/virtualized-records-list.tsx
@apps/web/src/components/bookkeeping/record-row.tsx
@apps/web/src/hooks/use-row-density.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create keyboard navigation hook</name>
  <files>
    apps/web/src/hooks/use-keyboard-navigation.ts
  </files>
  <action>
Create useKeyboardNavigation hook following RESEARCH.md Pattern 4:

Parameters:
- listRef: RefObject<List> (react-window List ref for scrollToItem)
- rowCount: number (total virtual rows for bounds checking)
- onSelect: (index: number) => void (callback when Enter pressed)
- containerRef: RefObject<HTMLElement> (to check if list container has focus)

Returns:
- focusedIndex: number (-1 when no focus)
- setFocusedIndex: (index: number) => void

Keyboard handlers (only when container has focus):
- j or ArrowDown: Move focus to next row (clamp at rowCount - 1)
- k or ArrowUp: Move focus to previous row (clamp at 0)
- Enter: Call onSelect with focusedIndex (if focusedIndex >= 0)
- Escape: Clear focus (setFocusedIndex(-1))

Additional behavior:
- When focusedIndex changes, call listRef.current?.scrollToItem(focusedIndex, 'smart')
- Use 'smart' scroll alignment (only scrolls if item not visible)
- Add/remove keydown listener in useEffect with cleanup
- Only handle keys when containerRef.current matches document.activeElement or contains it
  </action>
  <verify>
npx tsc --noEmit
  </verify>
  <done>
useKeyboardNavigation hook handles j/k/Enter/Escape with focus tracking and auto-scroll
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ResultSummary and add infinite scroll to VirtualizedRecordsList</name>
  <files>
    apps/web/src/components/bookkeeping/result-summary.tsx
    apps/web/src/components/bookkeeping/virtualized-records-list.tsx
  </files>
  <action>
Create ResultSummary component:
- Props: { visibleStart: number; visibleEnd: number; total: number; isFiltered: boolean }
- Display: "Showing {start+1}-{end} of {total}" with locale-formatted numbers
- Add "(filtered)" suffix when isFiltered is true
- Styling: text-sm text-gray-400

Update VirtualizedRecordsList to integrate infinite scroll:

1. Add new props:
   - hasMore: boolean (whether more records available to load)
   - loadMore: () => Promise<void> (callback to fetch next page)
   - isLoading: boolean (whether currently loading more)

2. Import useInfiniteLoader from react-window-infinite-loader

3. Wire infinite loader:
```typescript
const { onRowsRendered, setItemCount } = useInfiniteLoader({
  isRowLoaded: (index) => index < virtualRows.length,
  loadMoreRows: loadMore,
  rowCount: hasMore ? virtualRows.length + 1 : virtualRows.length,
  minimumBatchSize: 50,
  threshold: 15, // Trigger load when 15 rows from end
});
```

4. Pass onRowsRendered to List component

5. Track visible row range from onRowsRendered for ResultSummary:
   - Store visibleStartIndex and visibleStopIndex in state
   - Update on each onRowsRendered callback

6. Add keyboard navigation:
   - Add containerRef to wrapper div with tabIndex={0}
   - Use useKeyboardNavigation hook
   - Pass focusedIndex to RecordRow via rowProps
   - RecordRow applies ring-2 ring-blue-500 when focused

7. Add ResultSummary above list, showing visible range and total

8. Add keyboard hint tooltip on container: "Press j/k to navigate, Enter to expand, ? for help"
  </action>
  <verify>
npx tsc --noEmit
  </verify>
  <done>
VirtualizedRecordsList integrates infinite scroll with threshold trigger; ResultSummary displays current position; keyboard navigation works with visual focus indicator
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire VirtualizedRecordsList into BookkeepingContent</name>
  <files>
    apps/web/src/components/bookkeeping/bookkeeping-content.tsx
  </files>
  <action>
Replace RecordsTable with VirtualizedRecordsList in bookkeeping-content.tsx:

1. Import VirtualizedRecordsList (remove RecordsTable import)

2. Remove prefetchSentinelRef and usePrefetchOnScroll hook (infinite scroll handles this now)

3. Calculate container height for virtualized list:
   - Use window.innerHeight - header height - footer margins
   - Or fixed height of 600px as fallback
   - Consider: useLayoutEffect to measure available space

4. Pass required props to VirtualizedRecordsList:
   - records: computed records with derived fields
   - userRole
   - orgId: DEFAULT_ORG_ID
   - accountId: selectedAccountId
   - height: calculated container height
   - hasMore: false (useSyncRecords loads all records - no pagination from server)
   - loadMore: syncResult.refetch (triggers resync when scrolled to bottom)
   - isLoading: recordsFetching

5. Keep the existing computed fields logic (profit, earnings, COGS calculation)

6. Update loading state display - VirtualizedRecordsList handles skeleton rows internally

Note: hasMore is false because useSyncRecords loads all records for an account. The infinite scroll trigger calls refetch to check for new/updated records. True pagination would require changes to the sync protocol (out of scope for Phase 20).
  </action>
  <verify>
npm run dev (visual check that list renders with virtualization)
npx tsc --noEmit
  </verify>
  <done>
BookkeepingContent uses VirtualizedRecordsList; old RecordsTable no longer used; infinite scroll triggers resync
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Scrolling near bottom triggers loadMore callback
3. j/k keys navigate between rows with visual focus indicator
4. Enter key toggles expansion of focused row
5. Escape key clears focus
6. ResultSummary displays correct counts
7. Keyboard navigation only active when list container is focused
</verification>

<success_criteria>
- Infinite scroll loads more records when user scrolls within 15 rows of bottom
- Result summary shows "Showing X-Y of Z" with correct numbers
- j/k navigates rows with ring-2 focus indicator
- Enter toggles expand on focused row
- Escape clears focus
- Keyboard shortcuts only work when list is focused (not when typing in inputs)
</success_criteria>

<output>
After completion, create `.planning/phases/20-virtualized-rendering/20-02-SUMMARY.md`
</output>
