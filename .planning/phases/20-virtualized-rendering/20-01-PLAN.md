---
phase: 20-virtualized-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/bookkeeping/virtualized-records-list.tsx
  - apps/web/src/components/bookkeeping/record-row.tsx
  - apps/web/src/components/bookkeeping/skeleton-row.tsx
  - apps/web/src/hooks/use-row-density.ts
  - apps/web/src/lib/storage-keys.ts
autonomous: true

must_haves:
  truths:
    - "Lists render using virtual scrolling with constant DOM elements (~50 visible rows)"
    - "User can toggle between compact (36px) and comfortable (52px) row density"
    - "Density preference persists across browser sessions"
    - "Skeleton rows display while loading"
  artifacts:
    - path: "apps/web/src/components/bookkeeping/virtualized-records-list.tsx"
      provides: "Virtual scrolling container with react-window v2"
      exports: ["VirtualizedRecordsList"]
    - path: "apps/web/src/components/bookkeeping/record-row.tsx"
      provides: "Single row component for virtual list"
      exports: ["RecordRow"]
    - path: "apps/web/src/components/bookkeeping/skeleton-row.tsx"
      provides: "Loading placeholder row"
      exports: ["SkeletonRow"]
    - path: "apps/web/src/hooks/use-row-density.ts"
      provides: "Density state with localStorage persistence"
      exports: ["useRowDensity"]
    - path: "apps/web/src/lib/storage-keys.ts"
      provides: "Centralized localStorage key constants"
      exports: ["STORAGE_KEYS"]
  key_links:
    - from: "virtualized-records-list.tsx"
      to: "RecordRow"
      via: "rowComponent prop"
      pattern: "rowComponent={RecordRow}"
    - from: "use-row-density.ts"
      to: "localStorage"
      via: "STORAGE_KEYS.TABLE_DENSITY"
      pattern: "localStorage\\.getItem.*TABLE_DENSITY"
---

<objective>
Create virtualized table component using react-window v2 that renders records with constant DOM elements.

Purpose: Replace current RecordsTable that renders all records as DOM nodes (performance degrades at scale) with a virtualized approach that only renders visible rows plus overscan.

Output: VirtualizedRecordsList component with row density toggle, RecordRow component preserving all existing functionality (inline editing, status dropdown, expand/collapse, sync badges), and SkeletonRow for loading states.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-virtualized-rendering/20-CONTEXT.md
@.planning/phases/20-virtualized-rendering/20-RESEARCH.md

# Existing implementation to preserve
@apps/web/src/components/bookkeeping/records-table.tsx
@apps/web/src/components/bookkeeping/bookkeeping-content.tsx
@apps/web/src/hooks/sync/use-sync-records.ts
@apps/web/src/hooks/sync/use-pending-mutations.ts
@apps/web/src/lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage keys and row density hook</name>
  <files>
    apps/web/src/lib/storage-keys.ts
    apps/web/src/hooks/use-row-density.ts
  </files>
  <action>
Create centralized storage keys file:
```typescript
// storage-keys.ts
export const STORAGE_KEYS = {
  LAST_ACCOUNT_ID: 'dspro:last_order_tracking_account_id',
  TABLE_DENSITY: 'dspro:table_density',
  SCROLL_OFFSET: 'dspro:records_scroll',
} as const;
```

Create useRowDensity hook following RESEARCH.md Pattern 3:
- Type: 'compact' | 'comfortable'
- Default: 'comfortable'
- Persist to localStorage using STORAGE_KEYS.TABLE_DENSITY
- Handle SSR (check typeof window !== 'undefined' in initializer)
- Return { density, toggleDensity, rowHeight } where rowHeight is 36 for compact, 52 for comfortable
  </action>
  <verify>
npx tsc --noEmit
  </verify>
  <done>
useRowDensity hook returns density state with localStorage persistence; STORAGE_KEYS exported from lib/storage-keys.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RecordRow and SkeletonRow components</name>
  <files>
    apps/web/src/components/bookkeeping/record-row.tsx
    apps/web/src/components/bookkeeping/skeleton-row.tsx
  </files>
  <action>
Extract row rendering logic from records-table.tsx into RecordRow component:

RecordRow props via rowProps (react-window v2 pattern):
- records: BookkeepingRecord[]
- expandedIds: Set<string>
- onToggleExpand: (id: string) => void
- density: 'compact' | 'comfortable'
- userRole: UserRole
- orgId: string
- accountId: string
- editingState: { id: string | null; field: string | null; value: string; saving: boolean }
- onEditStart: (recordId: string, field: string) => void
- onEditSave: () => void
- onEditCancel: () => void
- onEditValueChange: (value: string) => void
- pendingMutations: Map<string, PendingMutation>
- onStatusChange: (recordId: string, status: BookkeepingStatus) => void
- onDeleteClick: (recordId: string) => void

RecordRow receives from react-window:
- index: number
- style: CSSProperties

RecordRow must:
1. Look up record by index from records array
2. Apply style prop for positioning (critical for virtualization)
3. Preserve ALL existing functionality from records-table.tsx:
   - SyncRowBadge in expand column
   - Expand/collapse chevron button
   - Inline editing (click to edit, blur to save, Escape to cancel)
   - Status dropdown with optimistic updates
   - Delete button (admin only)
   - Strikethrough styling for RETURN_CLOSED and REFUND_NO_RETURN
   - Tooltips for struck-through values
4. Support focused state (for keyboard navigation in Plan 02)
5. Use flex layout instead of table elements (react-window requires div-based layout)

SkeletonRow component:
- Receives style and density props
- Renders animated placeholder divs matching column widths
- Uses Tailwind animate-pulse for loading effect
  </action>
  <verify>
npx tsc --noEmit
  </verify>
  <done>
RecordRow component renders single record with all existing functionality; SkeletonRow displays animated loading placeholder
  </done>
</task>

<task type="auto">
  <name>Task 3: Create VirtualizedRecordsList container</name>
  <files>
    apps/web/src/components/bookkeeping/virtualized-records-list.tsx
  </files>
  <action>
Create VirtualizedRecordsList using react-window v2 List component:

Props:
- records: BookkeepingRecord[]
- userRole: UserRole
- orgId: string
- accountId: string
- height: number (container height, passed from parent)

Implementation:
1. Use react-window List with rowComponent prop (v2 API, NOT children render prop)
2. Track expandedIds in state (Set<string>)
3. Handle row expansion by flattening data per RESEARCH.md Pattern 2:
   - Create VirtualRow type: { type: 'record' | 'expanded'; record: BookkeepingRecord }
   - flattenRecords function inserts 'expanded' row after each expanded record
   - getRowHeight function returns 180px for expanded rows, rowHeight (36/52) for record rows
4. Use useRowDensity hook for density toggle
5. Wire all editing state and callbacks (same pattern as current RecordsTable)
6. Use usePendingMutations('records') for sync badges
7. Pass rowProps with all data and callbacks to RecordRow
8. Set overscanCount={5} for smooth scrolling
9. Add ref for scrollTo (used in Plan 02 for keyboard navigation)
10. Include density toggle button in header area

Do NOT wire infinite scroll yet (Plan 02). Do NOT add keyboard navigation yet (Plan 02).

Note: Delete confirmation dialog stays in this component (manages dialog state).
  </action>
  <verify>
npx tsc --noEmit
  </verify>
  <done>
VirtualizedRecordsList renders records using react-window with virtual scrolling, density toggle, and preserved editing functionality
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All components export correctly from their files
3. RecordRow preserves all functionality from records-table.tsx (inline editing, status, delete, expand, sync badge)
4. VirtualizedRecordsList uses react-window v2 List with rowComponent pattern
5. Row density toggle persists to localStorage
</verification>

<success_criteria>
- VirtualizedRecordsList component renders records with constant DOM elements (only visible rows + overscan in DOM)
- RecordRow preserves all existing inline editing, status changes, delete functionality
- Density toggle switches between compact (36px) and comfortable (52px) rows
- Expanded rows render as separate virtual rows with fixed 180px height
- Skeleton rows display for loading placeholders
</success_criteria>

<output>
After completion, create `.planning/phases/20-virtualized-rendering/20-01-SUMMARY.md`
</output>
