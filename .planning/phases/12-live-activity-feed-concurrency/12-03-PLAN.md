---
phase: 12-live-activity-feed-concurrency
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - apps/web/src/components/admin/collection/activity-feed.tsx
  - apps/web/src/components/admin/collection/progress-detail-modal.tsx
  - apps/web/src/components/admin/collection/progress-bar.tsx
  - apps/web/src/components/admin/collection/run-config-modal.tsx
  - apps/web/src/components/admin/collection/history-panel.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Progress detail modal shows live activity feed with creative visual cards"
    - "Activity feed displays worker ID, category, product, action type"
    - "Activity text removed from main progress bar"
    - "Concurrency slider removed from run config modal"
    - "History panel shows seller snapshot count for each entry"
  artifacts:
    - path: "apps/web/src/components/admin/collection/activity-feed.tsx"
      provides: "ActivityFeed component with visual card design"
      exports: ["ActivityFeed"]
    - path: "apps/web/src/components/admin/collection/progress-detail-modal.tsx"
      provides: "Modal with embedded ActivityFeed and EventSource subscription"
      contains: "EventSource"
    - path: "apps/web/src/components/admin/collection/progress-bar.tsx"
      provides: "Simplified progress bar without activity text"
    - path: "apps/web/src/components/admin/collection/run-config-modal.tsx"
      provides: "Config modal without concurrency slider"
    - path: "apps/web/src/components/admin/collection/history-panel.tsx"
      provides: "History panel displaying seller snapshot counts"
  key_links:
    - from: "apps/web/src/components/admin/collection/progress-detail-modal.tsx"
      to: "apps/web/src/components/admin/collection/activity-feed.tsx"
      via: "component import"
      pattern: "import.*ActivityFeed"
    - from: "apps/web/src/components/admin/collection/progress-detail-modal.tsx"
      to: "/collection/runs/{run_id}/activity"
      via: "EventSource connection"
      pattern: "new EventSource"
---

<objective>
Create frontend activity feed UI and integrate with SSE streaming. Remove concurrency slider and activity text from main progress bar.

Purpose: Provide real-time visual activity feed in detail modal, clean up progress bar, and show seller counts in history.
Output: New ActivityFeed component, updated modal/progress bar/history panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-live-activity-feed-concurrency/12-CONTEXT.md
@.planning/phases/12-live-activity-feed-concurrency/12-RESEARCH.md
@.planning/phases/12-live-activity-feed-concurrency/12-01-SUMMARY.md
@apps/web/src/components/admin/collection/progress-detail-modal.tsx
@apps/web/src/components/admin/collection/progress-bar.tsx
@apps/web/src/components/admin/collection/run-config-modal.tsx
@apps/web/src/components/admin/collection/history-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActivityFeed component with visual card design</name>
  <files>apps/web/src/components/admin/collection/activity-feed.tsx</files>
  <action>
Create new ActivityFeed component with creative visual design per CONTEXT.md requirements (NOT terminal-style, use cards/structured entries).

```tsx
"use client";

import { useEffect, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Badge } from "@/components/ui/badge";
import {
  ShoppingCart,
  Search,
  AlertCircle,
  Clock,
  CheckCircle,
  User,
  Package,
  FolderOpen,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { formatDistanceToNow } from "date-fns";

// Activity entry type from backend
interface ActivityEntry {
  id: string;
  timestamp: string;
  worker_id: number;
  phase: "amazon" | "ebay";
  action: "fetching" | "found" | "error" | "rate_limited" | "complete";
  category?: string;
  product_name?: string;
  seller_found?: string;
  new_sellers_count?: number;
  error_message?: string;
}

interface ActivityFeedProps {
  activities: ActivityEntry[];
  maxEntries?: number;
}

// Worker colors for visual distinction
const workerColors = [
  "bg-blue-500/20 text-blue-400 border-blue-500/30",
  "bg-green-500/20 text-green-400 border-green-500/30",
  "bg-purple-500/20 text-purple-400 border-purple-500/30",
  "bg-orange-500/20 text-orange-400 border-orange-500/30",
  "bg-pink-500/20 text-pink-400 border-pink-500/30",
];

// Action icons
const actionIcons = {
  fetching: <FolderOpen className="h-4 w-4" />,
  found: <CheckCircle className="h-4 w-4" />,
  error: <AlertCircle className="h-4 w-4" />,
  rate_limited: <Clock className="h-4 w-4" />,
  complete: <CheckCircle className="h-4 w-4" />,
};

// Action styles
const actionStyles = {
  fetching: "border-l-blue-400",
  found: "border-l-green-400",
  error: "border-l-red-400",
  rate_limited: "border-l-yellow-400",
  complete: "border-l-emerald-400",
};

function ActivityCard({ entry }: { entry: ActivityEntry }) {
  const workerColor = entry.worker_id > 0
    ? workerColors[(entry.worker_id - 1) % workerColors.length]
    : "bg-gray-500/20 text-gray-400 border-gray-500/30";

  const isPhaseComplete = entry.action === "complete";

  return (
    <motion.div
      initial={{ opacity: 0, y: -10, scale: 0.95 }}
      animate={{ opacity: 1, y: 0, scale: 1 }}
      exit={{ opacity: 0, scale: 0.95 }}
      transition={{ duration: 0.2 }}
      className={cn(
        "p-3 rounded-lg bg-gray-800/50 border-l-4",
        actionStyles[entry.action],
        isPhaseComplete && "bg-gradient-to-r from-emerald-900/30 to-gray-800/50"
      )}
    >
      {/* Header row: Worker badge + Phase + Timestamp */}
      <div className="flex items-center gap-2 mb-2">
        {entry.worker_id > 0 && (
          <Badge className={cn("text-[10px] px-1.5 py-0", workerColor)}>
            <User className="h-2.5 w-2.5 mr-0.5" />
            W{entry.worker_id}
          </Badge>
        )}

        <Badge
          className={cn(
            "text-[10px] px-1.5 py-0",
            entry.phase === "amazon"
              ? "bg-orange-500/20 text-orange-400"
              : "bg-blue-500/20 text-blue-400"
          )}
        >
          {entry.phase === "amazon" ? (
            <ShoppingCart className="h-2.5 w-2.5 mr-0.5" />
          ) : (
            <Search className="h-2.5 w-2.5 mr-0.5" />
          )}
          {entry.phase === "amazon" ? "Amazon" : "eBay"}
        </Badge>

        <span className="text-[10px] text-gray-500 ml-auto">
          {formatDistanceToNow(new Date(entry.timestamp), { addSuffix: true })}
        </span>
      </div>

      {/* Content based on action type */}
      <div className="flex items-start gap-2">
        <div className={cn(
          "mt-0.5",
          entry.action === "error" ? "text-red-400" :
          entry.action === "rate_limited" ? "text-yellow-400" :
          entry.action === "found" ? "text-green-400" :
          entry.action === "complete" ? "text-emerald-400" :
          "text-gray-400"
        )}>
          {actionIcons[entry.action]}
        </div>

        <div className="flex-1 min-w-0">
          {/* Action text */}
          {entry.action === "fetching" && (
            <div className="text-sm text-gray-300">
              <span className="text-gray-400">Fetching </span>
              {entry.category && (
                <span className="text-white font-medium">{entry.category}</span>
              )}
              {entry.product_name && (
                <>
                  <span className="text-gray-400"> - </span>
                  <span className="text-gray-300 truncate">{entry.product_name}</span>
                </>
              )}
            </div>
          )}

          {entry.action === "found" && (
            <div className="text-sm">
              <span className="text-green-400 font-medium">
                +{entry.new_sellers_count || 0}
              </span>
              <span className="text-gray-400">
                {entry.phase === "amazon" ? " products" : " sellers"}
              </span>
              {entry.category && (
                <span className="text-gray-500 text-xs ml-2">
                  in {entry.category}
                </span>
              )}
            </div>
          )}

          {entry.action === "error" && (
            <div className="text-sm text-red-300">
              {entry.error_message || "Unknown error"}
            </div>
          )}

          {entry.action === "rate_limited" && (
            <div className="text-sm text-yellow-300">
              Rate limited - waiting before retry...
            </div>
          )}

          {entry.action === "complete" && (
            <div className="text-sm text-emerald-300 font-medium">
              {entry.phase === "amazon" ? "Amazon phase complete!" : (
                <>
                  eBay search complete!
                  {entry.new_sellers_count !== undefined && (
                    <span className="text-green-400 ml-2">
                      +{entry.new_sellers_count} new sellers
                    </span>
                  )}
                </>
              )}
            </div>
          )}
        </div>
      </div>
    </motion.div>
  );
}

export function ActivityFeed({ activities, maxEntries = 50 }: ActivityFeedProps) {
  const containerRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to top when new entries arrive (newest at top)
  useEffect(() => {
    if (containerRef.current) {
      containerRef.current.scrollTop = 0;
    }
  }, [activities.length]);

  // Limit entries to prevent memory issues
  const displayedActivities = activities.slice(0, maxEntries);

  if (displayedActivities.length === 0) {
    return (
      <div className="flex items-center justify-center h-32 text-gray-500 text-sm">
        Waiting for activity...
      </div>
    );
  }

  return (
    <div
      ref={containerRef}
      className="space-y-2 max-h-[400px] overflow-y-auto pr-2"
    >
      <AnimatePresence mode="popLayout">
        {displayedActivities.map((entry) => (
          <ActivityCard key={entry.id} entry={entry} />
        ))}
      </AnimatePresence>
    </div>
  );
}
```

Key design decisions per CONTEXT.md:
- NOT terminal-style - uses visual cards with icons and badges
- Worker ID shown as colored badge (W1, W2, etc.)
- Phase badge (Amazon orange, eBay blue)
- Action type indicated by left border color and icon
- Timestamp shown relatively (e.g., "2s ago")
- Newest entries at top (prepend)
- Max 50 entries to prevent memory issues
- Framer Motion for smooth entry animations
  </action>
  <verify>
- File exists at apps/web/src/components/admin/collection/activity-feed.tsx
- Exports ActivityFeed component
- Uses visual cards, not terminal text
- Shows worker ID, phase, action type with appropriate styling
  </verify>
  <done>ActivityFeed component created with creative visual card design</done>
</task>

<task type="auto">
  <name>Task 2: Update progress-detail-modal with EventSource and ActivityFeed</name>
  <files>apps/web/src/components/admin/collection/progress-detail-modal.tsx</files>
  <action>
Update the progress detail modal to:
1. Subscribe to SSE activity stream via EventSource
2. Display ActivityFeed component
3. Manage activity buffer state

Add to existing imports:

```tsx
import { ActivityFeed } from "./activity-feed";
```

Add state for activities inside the component:

```tsx
const [activities, setActivities] = useState<ActivityEntry[]>([]);
```

Add interface for ActivityEntry (can import from activity-feed if exported, or define inline):

```tsx
interface ActivityEntry {
  id: string;
  timestamp: string;
  worker_id: number;
  phase: "amazon" | "ebay";
  action: "fetching" | "found" | "error" | "rate_limited" | "complete";
  category?: string;
  product_name?: string;
  seller_found?: string;
  new_sellers_count?: number;
  error_message?: string;
}
```

Add useEffect for EventSource subscription. Note: EventSource doesn't support headers, so pass token via query param:

```tsx
useEffect(() => {
  if (!open || !progress?.run_id) {
    setActivities([]);
    return;
  }

  // Get auth token for SSE connection
  const setupEventSource = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return null;

    // EventSource doesn't support Authorization header, but our SSE endpoint
    // uses the same Bearer token validation via require_permission_key
    // We need to pass via query param
    const url = `${API_BASE}/collection/runs/${progress.run_id}/activity?token=${session.access_token}`;

    const eventSource = new EventSource(url);

    eventSource.onmessage = (event) => {
      try {
        const activity = JSON.parse(event.data);
        setActivities((prev) => [activity, ...prev].slice(0, 100)); // Buffer 100
      } catch (e) {
        console.error("Failed to parse activity:", e);
      }
    };

    eventSource.onerror = (error) => {
      console.error("SSE Error:", error);
      // EventSource auto-reconnects
    };

    return eventSource;
  };

  let eventSource: EventSource | null = null;

  setupEventSource().then((es) => {
    eventSource = es;
  });

  return () => {
    if (eventSource) {
      eventSource.close();
    }
    setActivities([]);
  };
}, [open, progress?.run_id, supabase.auth]);
```

Note: The backend SSE endpoint currently uses Bearer token auth. We need to update the backend to also accept token as query param. Add this note and implement a workaround:

Actually, let's use a different approach - the standard fetch-based polling for now can work alongside SSE. For MVP, we can poll the activity or use the EventSource with a modified backend. Let's modify the backend in a follow-up to accept query param auth.

For now, implement EventSource with the assumption that backend will be updated to accept `?token=` query param in the SSE endpoint. Update the backend endpoint (small change to collection.py):

In the SSE endpoint, add query param support:

```python
@router.get("/runs/{run_id}/activity")
async def stream_activity(
    run_id: str,
    token: str | None = None,  # Query param for EventSource
    user: dict = Depends(require_permission_key("admin.automation")),
    # ...
):
```

But require_permission_key uses Authorization header. We need a custom dependency for SSE that accepts either header or query param. This is a common pattern.

For the frontend, just implement EventSource assuming the backend will handle it:

```tsx
useEffect(() => {
  if (!open || !progress?.run_id) {
    setActivities([]);
    return;
  }

  let eventSource: EventSource | null = null;

  const connectSSE = async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      // SSE with token query param
      const url = `${API_BASE}/collection/runs/${progress.run_id}/activity?token=${session.access_token}`;

      eventSource = new EventSource(url);

      eventSource.onmessage = (event) => {
        try {
          const activity = JSON.parse(event.data) as ActivityEntry;
          setActivities((prev) => [activity, ...prev].slice(0, 100));
        } catch (e) {
          console.error("Failed to parse activity:", e);
        }
      };

      eventSource.onerror = () => {
        // Reconnect is automatic, but log for debugging
        console.log("SSE connection error, auto-reconnecting...");
      };
    } catch (e) {
      console.error("Failed to connect SSE:", e);
    }
  };

  connectSSE();

  return () => {
    if (eventSource) {
      eventSource.close();
    }
  };
}, [open, progress?.run_id, supabase.auth]);
```

Update the modal content to include ActivityFeed. Find the hierarchical progress section and add ActivityFeed after it:

```tsx
{/* Activity Feed - Live updates */}
<div className="space-y-2">
  <div className="text-sm font-medium text-gray-300">Live Activity</div>
  <ActivityFeed activities={activities} maxEntries={50} />
</div>
```

Also need to add API_BASE constant and supabase client if not already present:

```tsx
import { createClient } from "@/lib/supabase/client";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";
```

And initialize supabase in component:

```tsx
const supabase = createClient();
```
  </action>
  <verify>
- progress-detail-modal.tsx imports ActivityFeed
- Has activities state with ActivityEntry array
- Has useEffect with EventSource subscription
- Displays ActivityFeed component in modal body
- EventSource closes on modal close
  </verify>
  <done>Progress detail modal updated with EventSource subscription and ActivityFeed display</done>
</task>

<task type="auto">
  <name>Task 3: Update progress-bar, run-config-modal, and history-panel</name>
  <files>apps/web/src/components/admin/collection/progress-bar.tsx, apps/web/src/components/admin/collection/run-config-modal.tsx, apps/web/src/components/admin/collection/history-panel.tsx</files>
  <action>
1. **progress-bar.tsx** - Remove activity text display

Find and remove the "Current activity text" section in the progress bar. The activity text section shows `progress.checkpoint?.current_activity`. Remove this animated text display since activity now shows in the detail modal.

Look for this section (around lines 190-205):

```tsx
{/* Current activity text with animation */}
<AnimatePresence mode="wait">
  <motion.span
    key={progress.checkpoint?.current_activity || "idle"}
    // ...
  >
    {progress.checkpoint?.current_activity || "Starting..."}
  </motion.span>
</AnimatePresence>
```

Replace with simpler status text or remove entirely. The phase badge already indicates what's happening. Replace with:

```tsx
{/* Simple status text */}
<span className="text-gray-400 text-sm">
  {progress.status === "paused" ? "Paused" : "Running..."}
</span>
```

2. **run-config-modal.tsx** - Remove concurrency slider

Per CONTEXT.md: "Remove concurrency slider - system uses optimal concurrency automatically"

Find and remove the entire concurrency slider section (around lines 294-324):

```tsx
{/* Concurrency slider */}
<div className="space-y-2">
  <div className="flex justify-between">
    <Label className="text-gray-300">Concurrency</Label>
    // ...
  </div>
  // ... slider and tick marks ...
  <p className="text-xs text-gray-500">
    Higher values = faster collection, more API load
  </p>
</div>
```

Delete this entire block. Also remove the concurrency state:

```tsx
const [concurrency, setConcurrency] = useState(3);  // DELETE THIS LINE
```

And remove the Slider import if no longer needed:

```tsx
import { Slider } from "@/components/ui/slider";  // DELETE if Slider not used elsewhere
```

3. **history-panel.tsx** - Display seller snapshot count

Update the history panel to show "X sellers at this point" for each entry.

First, update the backend to return seller_count_snapshot in the history endpoint response. The backend needs to include this field.

On frontend, update the CollectionRunEntry interface to include seller_count_snapshot:

```tsx
interface CollectionRunEntry {
  type: "collection_run";
  id: string;
  name: string;
  started_at: string;
  completed_at: string | null;
  status: "completed" | "failed" | "cancelled";
  sellers_new: number;
  categories_count: number;
  category_ids: string[];
  seller_count_snapshot?: number;  // ADD THIS
}
```

Similarly for ManualEditEntry:

```tsx
interface ManualEditEntry {
  type: "manual_edit";
  id: string;
  action: "add" | "edit" | "remove";
  seller_name: string;
  affected_count: number;
  created_at: string;
  seller_count_snapshot?: number;  // ADD THIS
}
```

Update the fetch to include seller_count_snapshot in the data:

In `fetchHistory`, when processing runs:
```tsx
for (const run of runs) {
  mergedEntries.push({
    // ... existing fields ...
    seller_count_snapshot: run.seller_count_snapshot,
  });
}
```

And when processing manual edits:
```tsx
for (const log of logs) {
  mergedEntries.push({
    // ... existing fields ...
    seller_count_snapshot: log.seller_count_snapshot,
  });
}
```

Update `renderCollectionRun` to display snapshot:

Add after the existing stats display:

```tsx
{entry.seller_count_snapshot !== undefined && (
  <span className="text-gray-500 text-xs">
    ({entry.seller_count_snapshot} total)
  </span>
)}
```

Update `renderManualEdit` similarly:

```tsx
{entry.seller_count_snapshot !== undefined && (
  <div className="text-gray-500 text-xs">
    {entry.seller_count_snapshot} sellers total
  </div>
)}
```

NOTE: The backend also needs to be updated to return seller_count_snapshot in the history and audit-log endpoints. Add this to the backend changes in Plan 01/02 if not already done, or note it here for implementation.

For the history endpoint, update collection.py get_history to include seller_count_snapshot:

In the SELECT clause, add `seller_count_snapshot`:
```python
.select(
    "id, name, status, category_ids, "
    "started_at, completed_at, "
    "products_total, products_searched, "
    "sellers_found, sellers_new, "
    "failed_items, created_by, seller_count_snapshot",  # ADD
    count="exact"
)
```

And include in the return dict:
```python
runs.append({
    # ... existing fields ...
    "seller_count_snapshot": r.get("seller_count_snapshot"),
})
```

Update CollectionHistoryEntry model in models.py to include:
```python
seller_count_snapshot: int | None = None
```

Similarly update get_audit_log to return seller_count_snapshot.
  </action>
  <verify>
- progress-bar.tsx no longer shows activity text (current_activity)
- run-config-modal.tsx no longer has concurrency slider
- history-panel.tsx displays seller_count_snapshot for entries
- Types updated to include seller_count_snapshot
  </verify>
  <done>Progress bar simplified, concurrency slider removed, history panel shows seller snapshots</done>
</task>

</tasks>

<verification>
- [ ] activity-feed.tsx exists with visual card design
- [ ] progress-detail-modal.tsx has EventSource subscription
- [ ] progress-detail-modal.tsx displays ActivityFeed component
- [ ] progress-bar.tsx no longer shows current_activity text
- [ ] run-config-modal.tsx no longer has concurrency slider or state
- [ ] history-panel.tsx displays seller_count_snapshot
- [ ] CollectionHistoryEntry model includes seller_count_snapshot
- [ ] No TypeScript errors in modified files
</verification>

<success_criteria>
1. ActivityFeed component renders visual cards (not terminal text)
2. Progress detail modal subscribes to SSE and displays live activity
3. Activity text removed from main progress bar
4. Concurrency slider removed from run config modal
5. History panel shows seller snapshot count for each entry
6. All TypeScript types are correct
</success_criteria>

<output>
After completion, create `.planning/phases/12-live-activity-feed-concurrency/12-03-SUMMARY.md`
</output>
