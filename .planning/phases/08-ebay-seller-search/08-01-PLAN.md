---
phase: 08-ebay-seller-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/app/services/scrapers/ebay_base.py
  - apps/api/src/app/services/scrapers/oxylabs_ebay.py
  - apps/api/src/app/services/scrapers/__init__.py
autonomous: true

must_haves:
  truths:
    - "eBay search returns sellers matching dropshipper criteria"
    - "All five filters applied: Brand New, free shipping, US only, 80-120% price"
    - "Seller info parsed from search results (username, feedback, percent)"
    - "Rate limiting handled with error field (not exception)"
  artifacts:
    - path: "apps/api/src/app/services/scrapers/ebay_base.py"
      provides: "EbaySeller, EbaySearchResult, EbayScraperService abstract class"
      exports: ["EbaySeller", "EbaySearchResult", "EbayScraperService"]
    - path: "apps/api/src/app/services/scrapers/oxylabs_ebay.py"
      provides: "OxylabsEbayScraper implementation"
      exports: ["OxylabsEbayScraper"]
    - path: "apps/api/src/app/services/scrapers/__init__.py"
      provides: "Module exports for eBay scraper classes"
      contains: "OxylabsEbayScraper"
  key_links:
    - from: "oxylabs_ebay.py"
      to: "ebay_base.py"
      via: "class inheritance"
      pattern: "class OxylabsEbayScraper\\(EbayScraperService\\)"
    - from: "oxylabs_ebay.py"
      to: "https://realtime.oxylabs.io"
      via: "httpx POST"
      pattern: 'source.*ebay'
---

<objective>
Create eBay scraper service with Oxylabs implementation for dropshipper-filtered searches.

Purpose: Enable searching eBay with Amazon product titles and extracting sellers who exhibit dropshipper characteristics (Brand New items, free shipping, 80-120% Amazon price markup, US location).

Output: Abstract EbayScraperService interface and OxylabsEbayScraper implementation, following the same pattern as the existing Amazon scraper.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ebay-seller-search/08-CONTEXT.md
@.planning/phases/08-ebay-seller-search/08-RESEARCH.md
@apps/api/src/app/services/scrapers/base.py
@apps/api/src/app/services/scrapers/oxylabs.py
@apps/api/src/app/services/scrapers/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create eBay scraper base interface</name>
  <files>apps/api/src/app/services/scrapers/ebay_base.py</files>
  <action>
Create abstract base interface for eBay scraping, following the pattern from base.py (Amazon).

Define dataclasses:
- `EbaySeller`: username (str), feedback_count (int|None), positive_percent (float|None), item_url (str)
- `EbaySearchResult`: sellers (list[EbaySeller]), page (int), has_more (bool), error (str|None = None)

Define abstract class `EbayScraperService`:
- `async def search_sellers(self, query: str, amazon_price: float, page: int = 1) -> EbaySearchResult`
- Docstring should specify that filters are applied: Brand New, free shipping, US only, price 80-120% of amazon_price

Use `from __future__ import annotations` for forward references.
Use ABC and abstractmethod from abc module.
  </action>
  <verify>
```bash
cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/api && python -c "from app.services.scrapers.ebay_base import EbaySeller, EbaySearchResult, EbayScraperService; print('OK')"
```
  </verify>
  <done>ebay_base.py exists with EbaySeller, EbaySearchResult, EbayScraperService classes importable without error</done>
</task>

<task type="auto">
  <name>Task 2: Create Oxylabs eBay scraper implementation</name>
  <files>apps/api/src/app/services/scrapers/oxylabs_ebay.py</files>
  <action>
Create OxylabsEbayScraper class implementing EbayScraperService.

Constructor:
- Read OXYLABS_USERNAME and OXYLABS_PASSWORD from environment
- Set base_url = "https://realtime.oxylabs.io/v1/queries"
- Raise ValueError if credentials missing

Private method `_build_search_url(query: str, amazon_price: float, page: int) -> str`:
- Build eBay search URL with ALL dropshipper filters embedded:
  - `_nkw={quote_plus(query)}` - search term
  - `LH_ItemCondition=1000` - Brand New (EBAY-02)
  - `LH_Free=1` - Free shipping (EBAY-03)
  - `LH_PrefLoc=1` - US sellers only (EBAY-05)
  - `_udlo={int(amazon_price * 0.80)}` - Min price 80% (EBAY-04)
  - `_udhi={int(amazon_price * 1.20)}` - Max price 120% (EBAY-04)
  - `_ipg=60` - Items per page
  - `_pgn={page}` - Page number
- Return full URL: https://www.ebay.com/sch/i.html?{params}

Private method `_parse_seller_info(seller_text: str | None) -> dict`:
- Parse eBay seller info string like "username (1,234) 99.5%"
- Use regex: `r"^(.+?)\s*\(([0-9,]+)\)\s*([0-9.]+)%?$"` for full format
- Fallback regex: `r"^(.+?)\s*\(([0-9,]+)\)$"` for username + count only
- Final fallback: return username as-is if no parentheses
- Return dict with username, feedback_count, positive_percent

Async method `search_sellers(query, amazon_price, page=1) -> EbaySearchResult`:
- Build URL with _build_search_url
- Create Oxylabs payload with:
  - `source`: "ebay" (NOT ebay_search - we're using pre-filtered URLs)
  - `url`: constructed URL
  - `parse`: True
  - `parsing_instructions`: Extract items using CSS selectors:
    - Items container: `li.s-item`
    - seller_info: `span.s-item__seller-info-text` -> element_text
    - item_link: `a.s-item__link` -> attribute href
    - has_next: `a.pagination__next` -> exists
- Make POST to Oxylabs with httpx.AsyncClient, auth=(username, password), timeout=30
- Handle 429 response: return EbaySearchResult with error="rate_limited"
- Parse response: extract items from results[0].content.items, has_more from results[0].content.has_next
- Dedupe sellers within page (use seen_usernames set)
- Return EbaySearchResult

Error handling:
- TimeoutException -> error="timeout"
- Other exceptions -> log and return error=str(e)

Use logging module (logger = logging.getLogger(__name__)).
  </action>
  <verify>
```bash
cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/api && python -c "
from app.services.scrapers.oxylabs_ebay import OxylabsEbayScraper
# Test URL building (doesn't need credentials)
scraper = type('MockScraper', (), {'_build_search_url': OxylabsEbayScraper._build_search_url})()
url = scraper._build_search_url(scraper, 'Apple AirPods Pro', 249.99, 1)
assert 'LH_ItemCondition=1000' in url, 'Missing Brand New filter'
assert 'LH_Free=1' in url, 'Missing free shipping filter'
assert 'LH_PrefLoc=1' in url, 'Missing US only filter'
assert '_udlo=199' in url, 'Missing min price (80%)'
assert '_udhi=299' in url, 'Missing max price (120%)'
print('URL filters verified OK')
"
```
  </verify>
  <done>OxylabsEbayScraper class exists with all five dropshipper filters embedded in URL construction</done>
</task>

<task type="auto">
  <name>Task 3: Update module exports</name>
  <files>apps/api/src/app/services/scrapers/__init__.py</files>
  <action>
Update the scrapers __init__.py to export eBay scraper classes alongside Amazon ones.

Add imports:
- from .ebay_base import EbaySeller, EbaySearchResult, EbayScraperService
- from .oxylabs_ebay import OxylabsEbayScraper

Update __all__ to include:
- "EbaySeller"
- "EbaySearchResult"
- "EbayScraperService"
- "OxylabsEbayScraper"

Keep existing Amazon exports (AmazonProduct, ScrapeResult, AmazonScraperService, OxylabsAmazonScraper).

Update module docstring to reflect both Amazon and eBay scraper services.
  </action>
  <verify>
```bash
cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/api && python -c "
from app.services.scrapers import (
    # Amazon (existing)
    AmazonProduct, ScrapeResult, AmazonScraperService, OxylabsAmazonScraper,
    # eBay (new)
    EbaySeller, EbaySearchResult, EbayScraperService, OxylabsEbayScraper
)
print('All exports verified OK')
"
```
  </verify>
  <done>scrapers/__init__.py exports all Amazon and eBay scraper classes</done>
</task>

</tasks>

<verification>
All three files created and exports working:
```bash
cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/api && python -c "
from app.services.scrapers import OxylabsEbayScraper, EbaySeller, EbaySearchResult
print('eBay scraper module fully functional')
"
```

Verify URL filter embedding (EBAY-02, EBAY-03, EBAY-04, EBAY-05):
```bash
cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/api && python -c "
from app.services.scrapers.oxylabs_ebay import OxylabsEbayScraper
scraper = type('MockScraper', (), {'_build_search_url': OxylabsEbayScraper._build_search_url})()
url = scraper._build_search_url(scraper, 'Test Product', 100.00, 1)
filters = {
    'Brand New': 'LH_ItemCondition=1000',
    'Free shipping': 'LH_Free=1',
    'US only': 'LH_PrefLoc=1',
    'Min price 80%': '_udlo=80',
    'Max price 120%': '_udhi=120',
}
for name, param in filters.items():
    assert param in url, f'Missing {name}: {param}'
print('All dropshipper filters verified in URL')
"
```
</verification>

<success_criteria>
- ebay_base.py defines EbaySeller, EbaySearchResult, EbayScraperService
- oxylabs_ebay.py implements OxylabsEbayScraper with all five dropshipper filters
- __init__.py exports both Amazon and eBay scraper classes
- URL construction embeds Brand New, free shipping, US only, 80-120% price filters
- Seller info parsing handles multiple formats (full, partial, username-only)
- Rate limiting returns error field (not exception)
</success_criteria>

<output>
After completion, create `.planning/phases/08-ebay-seller-search/08-01-SUMMARY.md`
</output>
