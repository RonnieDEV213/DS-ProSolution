---
phase: 02-profile-settings-account-permissions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/app/permissions.py
  - apps/web/src/components/admin/department-role-dialog.tsx
  - apps/web/src/components/admin/accounts-table.tsx
  - apps/api/src/app/routers/accounts.py
autonomous: true

must_haves:
  truths:
    - "accounts.view permission key exists in RBAC system"
    - "VAs with accounts.view see only their assigned accounts"
    - "VAs with accounts.view see only account name and occupied status"
    - "VAs with accounts.view cannot see VA assignment counts"
    - "VAs with accounts.view cannot see edit buttons or create account"
    - "Admins see full account list with all metadata and actions"
  artifacts:
    - path: "apps/api/src/app/permissions.py"
      provides: "accounts.view permission key"
      contains: "accounts.view"
    - path: "apps/web/src/components/admin/accounts-table.tsx"
      provides: "Permission-aware account list"
      min_lines: 200
    - path: "apps/api/src/app/routers/accounts.py"
      provides: "VA-filtered accounts endpoint"
      min_lines: 30
  key_links:
    - from: "apps/web/src/components/admin/accounts-table.tsx"
      to: "useUserRole hook"
      via: "imports and uses role/permission checks"
      pattern: "useUserRole|isAdmin"
    - from: "apps/api/src/app/routers/accounts.py"
      to: "RLS on account_assignments"
      via: "filters accounts by user assignments"
      pattern: "account_assignments|assigned"
---

<objective>
Add accounts.view permission to RBAC system and implement restricted account view for VAs

Purpose: VAs with accounts.view permission see only their assigned accounts with minimal metadata (no edit, no VA counts)
Output: New permission key, updated accounts table with role-aware display
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profile-settings-account-permissions/02-CONTEXT.md
@.planning/phases/02-profile-settings-account-permissions/02-RESEARCH.md

Reference existing permission system:
@apps/api/src/app/permissions.py

Reference accounts table for modification:
@apps/web/src/components/admin/accounts-table.tsx

Reference accounts router:
@apps/api/src/app/routers/accounts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accounts.view permission to RBAC system</name>
  <files>
    apps/api/src/app/permissions.py
    apps/web/src/components/admin/department-role-dialog.tsx
  </files>
  <action>
**apps/api/src/app/permissions.py:**
Add accounts.view to the permission system:

1. Add to DEPT_ROLE_PERMISSION_KEYS set:
```python
DEPT_ROLE_PERMISSION_KEYS = {
    # Order Tracking - page access
    "order_tracking.read",
    ...
    # Accounts - view only access
    "accounts.view",
}
```

2. Add to PERMISSION_LABELS dict:
```python
PERMISSION_LABELS = {
    ...
    "accounts.view": "View Assigned Accounts",
}
```

**apps/web/src/components/admin/department-role-dialog.tsx:**
Find where permission checkboxes are rendered and add accounts.view to the UI.

Look for the permissions list/array and add the new key. The dialog should already iterate over available permissions, so adding to the backend list may be sufficient.

If there's a hardcoded frontend permission list, add:
```typescript
{ key: "accounts.view", label: "View Assigned Accounts", description: "Can view assigned accounts (read-only)" }
```

Check the dialog to see how permissions are fetched/displayed. If it uses PERMISSION_LABELS from backend, no frontend change needed beyond ensuring the key is recognized.
  </action>
  <verify>
1. Run API: `cd apps/api && uvicorn app.main:app --reload --app-dir src`
2. Check /docs endpoint - verify no startup errors
3. Navigate to /admin/department-roles
4. Create or edit a department role
5. Verify "View Assigned Accounts" permission checkbox appears in the dialog
  </verify>
  <done>
accounts.view permission key added to DEPT_ROLE_PERMISSION_KEYS and PERMISSION_LABELS. Permission visible in department role dialog for assignment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VA-specific accounts endpoint</name>
  <files>apps/api/src/app/routers/accounts.py</files>
  <action>
Create a new endpoint for VAs to fetch their assigned accounts with minimal data.

The existing /admin/accounts endpoint is admin-only. VAs need a different endpoint.

**Option A (Preferred):** Create GET /accounts endpoint (non-admin) that:
- Requires authentication (get_current_user_with_membership)
- For admins: redirect logic or return all (but admins use /admin/accounts)
- For VAs: return only accounts where user has an assignment in account_assignments table
- Returns minimal fields: id, account_code, name, occupied (boolean, from presence - if presence exists)

Add to accounts.py or create new router:

```python
@router.get("", response_model=list[AccountBasicResponse])
async def get_my_accounts(
    user: dict = Depends(get_current_user_with_membership),
):
    """
    Get accounts accessible to the current user.

    For VAs: Returns only assigned accounts with minimal info.
    For Admins: Returns all accounts (but admins should use /admin/accounts for full data).
    """
    membership = user["membership"]
    role = membership.get("role")
    user_id = user["user_id"]
    org_id = membership["org_id"]

    supabase = get_supabase()

    if role == "admin":
        # Admins see all accounts in org
        result = supabase.table("accounts").select("id, account_code, name").eq("org_id", org_id).execute()
    else:
        # VAs see only assigned accounts
        # Join through account_assignments
        result = supabase.table("account_assignments").select(
            "accounts(id, account_code, name)"
        ).eq("user_id", user_id).execute()

        # Flatten the response
        accounts = []
        for row in result.data or []:
            if row.get("accounts"):
                accounts.append(row["accounts"])
        return [AccountBasicResponse(**a) for a in accounts]

    return [AccountBasicResponse(**row) for row in result.data or []]
```

Create AccountBasicResponse model in models.py if not exists:
```python
class AccountBasicResponse(BaseModel):
    id: str
    account_code: str
    name: str | None
```

Note: The accounts router might already have GET /accounts. Check existing implementation. If it exists and uses RLS, the RLS policies should already filter by account_assignments. In that case, verify RLS is working and the endpoint returns correct data for VAs.
  </action>
  <verify>
1. Login as VA user with accounts.view permission
2. Call GET /accounts (or /admin/accounts if that's the pattern)
3. Verify only assigned accounts are returned
4. Response should contain only id, account_code, name (no assignment_count, no admin_remarks)
  </verify>
  <done>
API endpoint returns filtered accounts for VAs (only assigned accounts with minimal fields). Admins get all accounts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement permission-aware accounts table</name>
  <files>apps/web/src/components/admin/accounts-table.tsx</files>
  <action>
Modify AccountsTable to support two modes:
1. Admin mode: Full features (current behavior)
2. VA mode: Read-only, minimal columns, no actions

Changes to accounts-table.tsx:

1. Add props for permission-aware rendering:
```typescript
interface AccountsTableProps {
  search: string;
  refreshTrigger: number;
  onAccountUpdated: () => void;
  viewOnly?: boolean;  // New prop for VA mode
}
```

2. Import useUserRole hook:
```typescript
import { useUserRole } from "@/hooks/use-user-role";
```

3. Determine display mode:
```typescript
const { role, isAdmin } = useUserRole();
const isViewOnly = viewOnly || role === "va";
```

4. Conditionally render table columns:
- Always show: Account Code, Name
- Admin only: VAs Assigned, Created, Actions
- For VAs, hide these columns entirely

5. Conditionally render header actions:
```typescript
{!isViewOnly && (
  <Button onClick={() => setCreateDialogOpen(true)}>
    Create Account
  </Button>
)}
```

6. Conditionally render row actions:
```typescript
{!isViewOnly && (
  <TableCell className="text-right">
    <Button ... onClick={() => setEditingAccount(account)}>
      Edit icon
    </Button>
  </TableCell>
)}
```

7. Use different API endpoint based on role:
```typescript
// For VAs, use the simpler /accounts endpoint
// For admins, use /admin/accounts with full data
const endpoint = isAdmin
  ? `${API_BASE}/admin/accounts?${params}`
  : `${API_BASE}/accounts`;
```

8. Adjust Account interface for VA mode (minimal fields):
```typescript
interface AccountBasic {
  id: string;
  account_code: string;
  name: string | null;
}

interface AccountFull extends AccountBasic {
  client_user_id: string | null;
  assignment_count: number;
  created_at: string | null;
  admin_remarks: string | null;
}

type Account = AccountBasic | AccountFull;
```

9. Empty state for VAs with no assigned accounts:
```typescript
{accounts.length === 0 && !loading && (
  <TableRow>
    <TableCell colSpan={isViewOnly ? 2 : 5} className="text-center text-gray-500 py-8">
      {isViewOnly
        ? "No accounts assigned to you. Contact an administrator."
        : "No accounts found. Create one to get started."}
    </TableCell>
  </TableRow>
)}
```

10. Remove pagination for VA mode (they typically have few assigned accounts):
```typescript
{!isViewOnly && totalPages > 1 && (
  // Pagination UI
)}
```
  </action>
  <verify>
1. Login as admin - full accounts table with all columns and Create button
2. Login as VA with accounts.view permission - see only Account Code and Name columns, no Create button, no edit icons
3. VA sees only their assigned accounts
4. VA with no assigned accounts sees appropriate empty message
5. `npm run build` passes
  </verify>
  <done>
AccountsTable renders in two modes: full admin view with all features, and restricted VA view with only assigned accounts showing minimal data (name only) with no edit capabilities.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] accounts.view permission key in DEPT_ROLE_PERMISSION_KEYS
- [ ] Permission label "View Assigned Accounts" in PERMISSION_LABELS
- [ ] Department role dialog shows accounts.view checkbox
- [ ] API returns only assigned accounts for VAs
- [ ] Admin sees full account list with all columns
- [ ] VA sees restricted view (2 columns: Account Code, Name)
- [ ] VA cannot see Create Account button
- [ ] VA cannot see edit icons
- [ ] VA sees empty state message when no accounts assigned
- [ ] `npm run build` passes
</verification>

<success_criteria>
1. accounts.view permission exists in RBAC system and can be assigned to department roles
2. VAs with accounts.view see only assigned accounts with minimal metadata
3. VAs cannot create or edit accounts
4. Admins retain full account management capabilities
5. All requirements covered: ACCT-01 to ACCT-03
</success_criteria>

<output>
After completion, create `.planning/phases/02-profile-settings-account-permissions/02-02-SUMMARY.md`
</output>
