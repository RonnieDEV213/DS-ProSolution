---
phase: 02-profile-settings-account-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/profile/profile-settings-dialog.tsx
  - apps/web/src/components/profile/profile-tab.tsx
  - apps/web/src/components/profile/extension-tab.tsx
  - apps/web/src/components/profile/access-code-display.tsx
  - apps/web/src/components/admin/sidebar.tsx
  - apps/web/src/app/va/layout.tsx
  - apps/web/src/app/client/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can open Profile Settings from sidebar bottom-left area"
    - "Profile tab shows user name, email, and role"
    - "Extension tab shows download button and installation guide"
    - "Admin/VA users see access code section in Extension tab"
    - "Access code is masked by default, revealed only while holding button"
    - "User can copy access code to clipboard with feedback"
    - "User can rotate access code secret (prefix stays same)"
    - "User can set custom secret with validation"
    - "Client users see Extension tab but without access code section"
  artifacts:
    - path: "apps/web/src/components/profile/profile-settings-dialog.tsx"
      provides: "Main modal with vertical tabs"
      min_lines: 80
    - path: "apps/web/src/components/profile/profile-tab.tsx"
      provides: "User info display"
      min_lines: 30
    - path: "apps/web/src/components/profile/extension-tab.tsx"
      provides: "Download button, access code UI"
      min_lines: 60
    - path: "apps/web/src/components/profile/access-code-display.tsx"
      provides: "Hold-to-reveal, copy, rotate widget"
      min_lines: 100
  key_links:
    - from: "apps/web/src/components/admin/sidebar.tsx"
      to: "profile-settings-dialog.tsx"
      via: "imports and renders ProfileSettingsDialog"
      pattern: "ProfileSettingsDialog"
    - from: "apps/web/src/components/profile/access-code-display.tsx"
      to: "/access-codes API"
      via: "fetch calls to generate/rotate/me endpoints"
      pattern: "fetch.*access-codes"
---

<objective>
Create Profile Settings modal with vertical tabs (Profile, Extension) and access code management UI

Purpose: Enable users to view their profile info and manage access codes for extension authentication
Output: ProfileSettingsDialog component triggered from sidebar, with full access code lifecycle UI
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profile-settings-account-permissions/02-CONTEXT.md
@.planning/phases/02-profile-settings-account-permissions/02-RESEARCH.md
@.planning/phases/01-access-code-foundation/01-02-SUMMARY.md

Reference existing modal pattern:
@apps/web/src/components/admin/user-edit-dialog.tsx

Reference sidebar for trigger location:
@apps/web/src/components/admin/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile components with access code UI</name>
  <files>
    apps/web/src/components/profile/profile-settings-dialog.tsx
    apps/web/src/components/profile/profile-tab.tsx
    apps/web/src/components/profile/extension-tab.tsx
    apps/web/src/components/profile/access-code-display.tsx
  </files>
  <action>
Create `apps/web/src/components/profile/` directory with four components:

**profile-settings-dialog.tsx:**
- Copy vertical-tab modal structure from user-edit-dialog.tsx
- Two tabs: "Profile" and "Extension" (always visible)
- Use hideCloseButton, sm:max-w-3xl, h-[500px] pattern
- Header shows "Profile Settings" title
- No footer buttons (read-only modal, actions are inline)
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`
- Pass user data (email, displayName, role) from parent via props or fetch internally
- Fetch user data on mount using Supabase client (profiles table + memberships)

**profile-tab.tsx:**
- Display user info in clean layout
- Show: Display name (or email prefix if none), Email, Role (formatted: "Admin", "Virtual Assistant", "Client")
- Use Label + value pairs with gray-400 text for labels
- Props: `displayName: string | null`, `email: string`, `role: string`

**extension-tab.tsx:**
- Show "Download Extension" section with:
  - Download button linking to placeholder URL (use env var NEXT_PUBLIC_EXTENSION_URL or hardcode "#" with TODO comment)
  - Installation steps (numbered list): 1. Click download, 2. Install from Chrome Web Store, 3. Follow pairing instructions
- Show "Access Code" section conditionally (only if role is "admin" or "va")
- Render AccessCodeDisplay component in access code section
- Props: `role: string`

**access-code-display.tsx:**
- Core widget for access code management
- States: loading, no-code (generate prompt), has-code (display)
- On mount, fetch GET /access-codes/me to check if code exists
- If 404, show "Generate Access Code" button
- If code exists, show:
  - Masked display: prefix visible, secret as dots (e.g., "ABCD-************")
  - Hold-to-reveal button: onPointerDown shows full code, onPointerUp/onPointerLeave/onPointerCancel hides
  - CRITICAL: Full code only available after generate/rotate. For existing codes, prefix is known but secret is NOT retrievable. Show "Rotate to reveal new code" hint.
  - Copy button: copies prefix + dots for existing (useless), or full code if just generated/rotated
  - Rotate button: calls POST /access-codes/rotate, shows confirmation dialog first
  - Custom secret option: expandable section, input field, validation (8+ chars, alphanumeric), save calls POST /access-codes/rotate with custom_secret
- Handle window blur to clear revealed state
- Use toast for feedback: "Copied to clipboard", "Access code rotated", errors
- Store "just generated" code in local state so user can copy it before leaving modal

API calls pattern:
```typescript
const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";
const supabase = createClient();
const { data: { session } } = await supabase.auth.getSession();
fetch(`${API_BASE}/access-codes/me`, { headers: { Authorization: `Bearer ${session.access_token}` }})
```

Use existing UI components: Button, Input, Label, Dialog (for rotate confirm), toast from sonner.
  </action>
  <verify>
Run `npm run build` in apps/web - no TypeScript errors.
Visual inspection: Component files exist with proper structure.
  </verify>
  <done>
Four profile components created with vertical-tab modal, profile info display, extension download section, and access code management UI with hold-to-reveal pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add profile trigger to all sidebar layouts</name>
  <files>
    apps/web/src/components/admin/sidebar.tsx
    apps/web/src/app/va/layout.tsx
    apps/web/src/app/client/layout.tsx
  </files>
  <action>
Modify all three sidebar implementations to replace static user info with profile modal trigger.

**apps/web/src/components/admin/sidebar.tsx:**
1. Import ProfileSettingsDialog from "@/components/profile/profile-settings-dialog"
2. Add state: `const [profileOpen, setProfileOpen] = useState(false);`
3. Replace the bottom user info section (lines 206-217 approx) with a clickable trigger:
   - Wrap user info in a button/div with `onClick={() => setProfileOpen(true)}`
   - Add hover state: `hover:bg-gray-800 cursor-pointer rounded-lg transition-colors`
   - Keep existing display (name, email) but make it interactive
   - Remove or keep sign out button below (keep it - sign out stays separate)
4. Render `<ProfileSettingsDialog open={profileOpen} onOpenChange={setProfileOpen} />` at component bottom

**apps/web/src/app/va/layout.tsx:**
1. Import ProfileSettingsDialog
2. Add state for profile modal
3. Add user info section above sign out button (currently VA layout has no user info display)
4. Fetch user data (email, displayName) same pattern as admin sidebar
5. Make user info clickable to open profile modal
6. Render ProfileSettingsDialog

**apps/web/src/app/client/layout.tsx:**
1. Same changes as VA layout
2. Import, state, user info display, clickable trigger, render modal

For VA and Client layouts, add a new section in the sidebar footer:
```tsx
<div className="p-4 border-t border-gray-800">
  {/* User info trigger */}
  {userEmail && (
    <button
      onClick={() => setProfileOpen(true)}
      className="w-full text-left px-4 py-2 mb-2 rounded-lg hover:bg-gray-800 transition-colors"
    >
      <p className="text-white font-medium text-sm truncate">
        {displayName || userEmail.split("@")[0]}
      </p>
      <p className="text-gray-400 text-xs truncate">{userEmail}</p>
    </button>
  )}
  {/* Sign out button */}
  <button onClick={handleSignOut} ...>Sign Out</button>
</div>
```
  </action>
  <verify>
Run `npm run dev` in apps/web.
1. Navigate to /admin - click user info in sidebar, profile modal opens
2. Navigate to /va - click user info in sidebar, profile modal opens
3. Navigate to /client - click user info in sidebar, profile modal opens
Modal shows Profile and Extension tabs in all cases.
  </verify>
  <done>
All three sidebar layouts (admin, va, client) have clickable user info that opens Profile Settings modal. Sign out button remains separate.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end access code flow verification</name>
  <files>apps/web/src/components/profile/access-code-display.tsx</files>
  <action>
Verify the complete access code flow works:

1. Ensure API_BASE is correctly configured in access-code-display.tsx
2. Test error handling for all API states:
   - Network errors: show toast with "Failed to load access code"
   - 403 errors: should not happen (hidden for clients), but handle gracefully
   - 404 on /me: show "Generate" state
   - 200 on /me: show masked code display

3. Add AlertDialog for rotate confirmation:
```tsx
<AlertDialog open={rotateConfirmOpen} onOpenChange={setRotateConfirmOpen}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Rotate Access Code</AlertDialogTitle>
      <AlertDialogDescription>
        This will generate a new secret. Your current code will stop working immediately.
        The extension will need to re-authenticate.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction onClick={handleRotate}>Rotate</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

4. After generate/rotate success:
   - Store full_code in state: `setNewlyGeneratedCode(response.full_code)`
   - Show the full code in display (not masked)
   - Enable copy button to copy full code
   - Show toast: "Access code generated! Copy it now - the secret won't be shown again."
   - On modal close or tab switch, clear newlyGeneratedCode (code becomes masked again)

5. Custom secret section:
   - Collapsible "Use custom secret" section
   - Input with validation: 8-32 chars, alphanumeric only
   - Show inline validation errors
   - "Save Custom Secret" button calls rotate with custom_secret body
  </action>
  <verify>
Manual test flow:
1. Login as admin/VA user
2. Open Profile Settings > Extension tab
3. If no code: click Generate, see full code, copy works
4. If has code: see masked display
5. Click Rotate, confirm, see new full code
6. Test hold-to-reveal (should show "Rotate to reveal" hint for existing codes)
7. Test custom secret with invalid input (error shown), then valid input (rotates)
  </verify>
  <done>
Access code UI complete with generate, rotate (with confirmation), copy, hold-to-reveal (with appropriate hints), and custom secret functionality. Error handling for all API states.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] `npm run build` passes in apps/web
- [ ] Profile modal opens from all three layouts (admin, va, client)
- [ ] Profile tab shows correct user info
- [ ] Extension tab shows download section for all users
- [ ] Access code section visible only for admin/va, hidden for clients
- [ ] Generate access code works (first time)
- [ ] Masked display shows prefix + dots
- [ ] Hold-to-reveal shows hint about rotation for existing codes
- [ ] Rotate with confirmation works
- [ ] Copy to clipboard works
- [ ] Custom secret validation and save works
- [ ] Toast notifications appear for all actions
</verification>

<success_criteria>
1. Profile Settings modal accessible from sidebar in all layouts
2. Two tabs (Profile, Extension) working correctly
3. Access code UI complete with generate/rotate/copy/custom functionality
4. Proper role-based visibility (access code section hidden for clients)
5. All requirements covered: PROF-01 to PROF-05, ACC-02 to ACC-06
</success_criteria>

<output>
After completion, create `.planning/phases/02-profile-settings-account-permissions/02-01-SUMMARY.md`
</output>
