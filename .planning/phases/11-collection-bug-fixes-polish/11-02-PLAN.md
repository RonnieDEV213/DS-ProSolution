---
phase: 11-collection-bug-fixes-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/app/routers/collection.py
  - apps/web/src/components/admin/collection/hierarchical-run-modal.tsx
autonomous: true

must_haves:
  truths:
    - "Run detail modal shows actual category data, not placeholder"
    - "Category breakdown displays real sellers-per-category counts"
    - "Run modal fetches from dedicated endpoint, not history list"
  artifacts:
    - path: "apps/api/src/app/routers/collection.py"
      provides: "Run breakdown endpoint"
      exports: ["GET /collection/runs/{run_id}/breakdown"]
    - path: "apps/web/src/components/admin/collection/hierarchical-run-modal.tsx"
      provides: "Category breakdown display"
      contains: "breakdown"
  key_links:
    - from: "apps/web/src/components/admin/collection/hierarchical-run-modal.tsx"
      to: "/api/collection/runs/{run_id}/breakdown"
      via: "fetch in useEffect"
      pattern: "fetch.*breakdown"
---

<objective>
Add category breakdown endpoint and display real data in run modal

Purpose: Replace the "Detailed category breakdown coming soon" placeholder with actual per-category statistics from collection runs
Output: Run modal shows real category-level data (products searched, sellers found per category)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-collection-bug-fixes-polish/11-CONTEXT.md
@.planning/phases/11-collection-bug-fixes-polish/11-RESEARCH.md
@apps/api/src/app/routers/collection.py
@apps/web/src/components/admin/collection/hierarchical-run-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add category breakdown API endpoint</name>
  <files>apps/api/src/app/routers/collection.py</files>
  <action>
  Add a new endpoint `GET /collection/runs/{run_id}/breakdown` that returns per-category statistics.

  The data exists in the `collection_items` table. Each item has a `data` JSONB column that contains `category_id`. Query the items for the given run, group by category_id, and return counts.

  Endpoint implementation:
  ```python
  @router.get("/runs/{run_id}/breakdown")
  async def get_run_breakdown(
      run_id: str,
      current_user: dict = Depends(get_current_user),
  ):
      """Get per-category breakdown for a completed run."""
      org_id = current_user["org_id"]
      supabase = get_supabase()

      # Verify run exists and belongs to org
      run_result = (
          supabase.table("collection_runs")
          .select("id, status")
          .eq("id", run_id)
          .eq("org_id", org_id)
          .execute()
      )
      if not run_result.data:
          raise HTTPException(status_code=404, detail="Run not found")

      # Get all items for this run, extract category_id from data JSONB
      items_result = (
          supabase.table("collection_items")
          .select("data")
          .eq("run_id", run_id)
          .execute()
      )

      # Aggregate by category
      category_stats: dict[str, dict] = {}
      for item in items_result.data or []:
          data = item.get("data", {}) or {}
          cat_id = data.get("category_id", "unknown")
          if cat_id not in category_stats:
              category_stats[cat_id] = {
                  "category_id": cat_id,
                  "products_count": 0,
                  "sellers_found": 0,
              }
          category_stats[cat_id]["products_count"] += 1
          # If item has sellers_found in data, add it
          category_stats[cat_id]["sellers_found"] += data.get("sellers_found", 0)

      return {
          "run_id": run_id,
          "categories": list(category_stats.values()),
      }
  ```

  Note: The collection_items table stores one row per product. The `data` JSONB field contains `category_id` and potentially `sellers_found` count for that product.
  </action>
  <verify>
  Run `ruff check apps/api/src/app/routers/collection.py` to verify no Python errors.
  Start the API server and test endpoint returns data: `curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/collection/runs/{run_id}/breakdown`
  </verify>
  <done>
  API endpoint returns per-category breakdown with products_count and sellers_found
  </done>
</task>

<task type="auto">
  <name>Task 2: Display category breakdown in run modal</name>
  <files>apps/web/src/components/admin/collection/hierarchical-run-modal.tsx</files>
  <action>
  Replace the "Detailed category breakdown coming soon" placeholder with actual category data.

  1. Add state for category breakdown:
  ```typescript
  const [breakdown, setBreakdown] = useState<Array<{
    category_id: string;
    products_count: number;
    sellers_found: number;
  }>>([]);
  const [breakdownLoading, setBreakdownLoading] = useState(true);
  ```

  2. In the useEffect that fetches run data, also fetch breakdown:
  ```typescript
  // Add to the Promise.all array
  fetch(`${API_BASE}/collection/runs/${runId}/breakdown`, {
    headers: { Authorization: `Bearer ${session.access_token}` },
  }),
  ```

  3. Process the breakdown response:
  ```typescript
  if (breakdownResponse.ok) {
    const breakdownData = await breakdownResponse.json();
    setBreakdown(breakdownData.categories || []);
  }
  setBreakdownLoading(false);
  ```

  4. Replace the placeholder div (lines 285-289) with actual breakdown display:
  ```tsx
  {/* Category breakdown */}
  <div className="mt-3 flex-shrink-0">
    <h4 className="text-sm font-medium text-gray-300 mb-2">
      Category Breakdown ({breakdown.length})
    </h4>
    <div className="bg-gray-800/50 rounded border border-gray-700/50 max-h-48 overflow-y-auto">
      {breakdownLoading ? (
        <div className="p-3 text-gray-500 text-sm text-center">Loading...</div>
      ) : breakdown.length === 0 ? (
        <div className="p-3 text-gray-500 text-sm text-center">No category data</div>
      ) : (
        <div className="divide-y divide-gray-700/50">
          {breakdown.map((cat) => (
            <div key={cat.category_id} className="px-3 py-2 flex items-center justify-between">
              <span className="text-sm text-gray-300 truncate flex-1">
                {cat.category_id.replace(/-/g, ' ')}
              </span>
              <div className="flex items-center gap-4 text-xs text-gray-400">
                <span>{cat.products_count} products</span>
                <span className="text-green-400">+{cat.sellers_found} sellers</span>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  </div>
  ```

  The category_id uses namespaced format like "electronics-computers" so replace hyphens with spaces for display.
  </action>
  <verify>
  Run `npm run lint` in apps/web to verify no syntax errors.
  Open the run modal in browser and verify category breakdown displays real data instead of placeholder.
  </verify>
  <done>
  Run detail modal shows actual per-category breakdown with products and sellers counts
  </done>
</task>

</tasks>

<verification>
- [ ] GET /collection/runs/{run_id}/breakdown endpoint returns category data
- [ ] HierarchicalRunModal displays category breakdown section
- [ ] Placeholder text "coming soon" is removed
- [ ] No lint errors in frontend or backend
</verification>

<success_criteria>
- Run detail modal shows real category breakdown data
- Each category displays products_count and sellers_found
- Loading and empty states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/11-collection-bug-fixes-polish/11-02-SUMMARY.md`
</output>
