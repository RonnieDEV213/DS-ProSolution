---
phase: 11-collection-bug-fixes-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/app/services/collection.py
  - apps/web/src/hooks/use-collection-polling.ts
autonomous: true

must_haves:
  truths:
    - "Progress bar updates within 500ms during active collection"
    - "History 'sellers at this point' shows complete seller list, not truncated"
  artifacts:
    - path: "apps/api/src/app/services/collection.py"
      provides: "Fixed audit log replay for bulk operations"
      contains: "new_value"
    - path: "apps/web/src/hooks/use-collection-polling.ts"
      provides: "Faster polling during active collection"
      contains: "500"
  key_links:
    - from: "apps/api/src/app/services/collection.py"
      to: "seller_audit_log table"
      via: "get_sellers_at_log method"
      pattern: "new_value"

# NOTE: Success criterion #3 (progress bar persistence) is ALREADY IMPLEMENTED.
# The useCollectionPolling hook calls poll() on mount (line 127) which fetches
# the current active run and its progress state. No new task needed.
---

<objective>
Fix progress polling responsiveness and history snapshot accuracy

Purpose: Address two core bugs - polling delay during active collection and inaccurate seller counts in history "sellers at this point" feature
Output: Responsive progress bar and accurate historical seller snapshots
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-collection-bug-fixes-polish/11-CONTEXT.md
@.planning/phases/11-collection-bug-fixes-polish/11-RESEARCH.md
@apps/web/src/hooks/use-collection-polling.ts
@apps/api/src/app/services/collection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce polling interval during active collection</name>
  <files>apps/web/src/hooks/use-collection-polling.ts</files>
  <action>
  Modify useCollectionPolling hook to use adaptive polling:

  1. Change default polling interval from 1000ms to 500ms when there is an active run
  2. The polling interval parameter should be 500ms for active runs, can remain 1000ms when no active run (optional optimization)
  3. Keep the existing error suppression for transient network errors

  The current implementation at line 42 uses `pollingInterval = 1000`. Change the default to 500 for more responsive updates during collection.

  No complex logic needed - simply change the default interval to 500ms. The 500ms interval is acceptable for the polling endpoint since it only reads a single collection_runs row.
  </action>
  <verify>
  Run `npm run lint` in apps/web to verify no syntax errors.
  Verify by reading the file that pollingInterval default is 500.
  </verify>
  <done>
  Polling hook defaults to 500ms interval, reducing maximum perceived delay from 1s to 0.5s
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix audit log replay for bulk operations</name>
  <files>apps/api/src/app/services/collection.py</files>
  <action>
  Fix the `get_sellers_at_log` method (around line 823-871) to correctly handle bulk add operations.

  Current bug: When bulk adds occur, the audit log stores a summary like "seller1 (+49 more)" in the `seller_name` field, but the full list is stored in `new_value` JSON field as `{"names": ["seller1", "seller2", ...]}`.

  The current replay logic only reads `seller_name`, missing the bulk names.

  Fix:
  1. In the SELECT query (line 843), add `new_value` to the selected columns (it's already selected for edits)
  2. In the replay loop for "add" action, check if `affected_count > 1` (indicating bulk)
  3. If bulk add: parse `new_value` JSON to get the full names list and add all of them
  4. If single add: use existing `seller_name` behavior

  Code change for the "add" branch:
  ```python
  if entry["action"] == "add":
      affected = entry.get("affected_count", 1)
      if affected > 1 and entry.get("new_value"):
          # Bulk add - parse full names from new_value
          try:
              data = json.loads(entry["new_value"])
              names = data.get("names", [])
              for name in names:
                  sellers.add(name)
          except (json.JSONDecodeError, TypeError):
              # Fallback to summary name
              sellers.add(entry["seller_name"])
      else:
          sellers.add(entry["seller_name"])
  ```

  Also update the SELECT to include `affected_count` if not already there.
  </action>
  <verify>
  Run `ruff check apps/api/src/app/services/collection.py` to verify no Python errors.
  Verify by reading the file that the get_sellers_at_log method now parses new_value for bulk adds.
  </verify>
  <done>
  Audit log replay correctly reconstructs seller list for bulk add operations, history "sellers at this point" shows accurate count
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify progress persistence on refresh</name>
  <files>apps/web/src/hooks/use-collection-polling.ts</files>
  <action>
  Verify that progress bar persistence on page refresh is working correctly.

  The useCollectionPolling hook already implements this:
  - Line 127: `poll()` is called on component mount
  - `poll()` calls `checkActiveRun()` which fetches the current active run
  - If an active run exists, `fetchProgress(run)` is called to get current progress
  - Progress state is set and UI renders immediately

  This task is verification only - confirm the existing implementation:
  1. Read use-collection-polling.ts and verify poll() is called in useEffect
  2. Verify checkActiveRun fetches from /collection/runs endpoint
  3. Verify fetchProgress fetches from /collection/runs/{id}/progress endpoint
  4. No code changes needed if verification passes

  If any issues are found (e.g., initial state shows 0% before first fetch completes), add a loading state or skeleton to prevent flash of empty state.
  </action>
  <verify>
  Read the file and confirm:
  - poll() is called on mount (in useEffect)
  - Active run and progress are fetched from backend
  - No race conditions in initial load
  </verify>
  <done>
  Progress bar persistence confirmed working - on page refresh, hook immediately fetches current run state from backend
  </done>
</task>

</tasks>

<verification>
- [ ] Polling interval is 500ms by default in use-collection-polling.ts
- [ ] get_sellers_at_log method parses new_value JSON for bulk adds
- [ ] Progress persistence on refresh verified working
- [ ] No lint errors in frontend or backend
</verification>

<success_criteria>
- Progress bar polling reduced to 500ms for more responsive updates
- History "sellers at this point" correctly shows all sellers from bulk operations
- Progress bar restores state on page refresh (existing behavior confirmed)
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/11-collection-bug-fixes-polish/11-01-SUMMARY.md`
</output>
