---
phase: 13-worker-status-dashboard-metrics
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web/src/components/admin/collection/activity-feed.tsx
  - apps/web/src/components/admin/collection/worker-card.tsx
  - apps/web/src/components/admin/collection/worker-status-panel.tsx
  - apps/web/src/components/admin/collection/worker-detail-view.tsx
autonomous: true

must_haves:
  truths:
    - "All 5 worker cards visible without scrolling"
    - "Each worker card shows URL, API params, timing, phase"
    - "Idle workers show muted styling with last activity summary"
    - "Clicking a worker card calls onExpand with worker_id"
    - "Worker detail view shows full scrollable log filtered by worker"
    - "Worker detail view shows per-worker metrics"
  artifacts:
    - path: "apps/web/src/components/admin/collection/activity-feed.tsx"
      provides: "Extended ActivityEntry type with new fields"
      contains: "url?: string"
    - path: "apps/web/src/components/admin/collection/worker-card.tsx"
      provides: "Individual worker card component"
      exports: ["WorkerCard"]
    - path: "apps/web/src/components/admin/collection/worker-status-panel.tsx"
      provides: "Container for 5 worker cards"
      exports: ["WorkerStatusPanel"]
    - path: "apps/web/src/components/admin/collection/worker-detail-view.tsx"
      provides: "Expanded worker view with log and metrics"
      exports: ["WorkerDetailView"]
  key_links:
    - from: "worker-status-panel.tsx"
      to: "worker-card.tsx"
      via: "renders WorkerCard for each worker 1-5"
      pattern: "WorkerCard.*worker_id="
    - from: "worker-card.tsx"
      to: "parent onClick"
      via: "onExpand callback"
      pattern: "onExpand\\(worker_id\\)"
---

<objective>
Create frontend types and worker status panel components

Purpose: Display 5 worker cards with real-time status and click-to-expand functionality per CONTEXT.md decisions
Output: Extended types, WorkerCard, WorkerStatusPanel, WorkerDetailView components
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-worker-status-dashboard-metrics/13-CONTEXT.md
@.planning/phases/13-worker-status-dashboard-metrics/13-RESEARCH.md
@.planning/phases/13-worker-status-dashboard-metrics/13-01-SUMMARY.md
@apps/web/src/components/admin/collection/activity-feed.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ActivityEntry Type and Add WorkerMetrics Interface</name>
  <files>apps/web/src/components/admin/collection/activity-feed.tsx</files>
  <action>
Extend the ActivityEntry interface to include all new fields from backend:

```typescript
// Activity entry type from backend
export interface ActivityEntry {
  // Existing fields
  id: string;
  timestamp: string;
  worker_id: number;
  phase: "amazon" | "ebay";
  action: "fetching" | "found" | "error" | "rate_limited" | "complete"
        | "uploading" | "deduped" | "inserted" | "updated";  // Add pipeline actions
  category?: string;
  product_name?: string;
  seller_found?: string;
  new_sellers_count?: number;
  error_message?: string;

  // NEW: Request details (for full transparency)
  url?: string;
  api_params?: {
    query?: string;
    price_min?: number;
    price_max?: number;
    node_id?: string;
    page?: number;
  };

  // NEW: Timing
  duration_ms?: number;
  started_at?: string;

  // NEW: Retry context
  attempt?: number;

  // NEW: Error classification
  error_type?: string;  // "rate_limit", "timeout", "http_500", "parse_error"
  error_stage?: string; // "api", "product_extraction", "seller_extraction", "price_parsing"

  // NEW: Pipeline context (for worker_id=0 system events)
  items_count?: number;
  source_worker_id?: number;
  operation_type?: string;
}
```

Add WorkerMetrics interface (export it):

```typescript
export interface WorkerMetrics {
  worker_id: number;

  // API stats
  api_requests_total: number;
  api_requests_success: number;
  api_requests_failed: number;
  api_retries: number;
  total_duration_ms: number;  // Sum for avg calculation

  // Output stats
  products_found: number;   // Amazon phase
  sellers_found: number;    // eBay phase
  sellers_new: number;

  // Error breakdown
  errors_by_type: Record<string, number>;  // {rate_limit: 2, timeout: 1, parse_error: 3}

  // Last activity for summary line
  last_activity?: ActivityEntry;
}
```

Add WorkerState type:

```typescript
export type WorkerState =
  | "idle"
  | "searching_products"    // Amazon phase: fetching
  | "returning_products"    // Amazon phase: found
  | "searching_sellers"     // eBay phase: fetching
  | "returning_sellers"     // eBay phase: found
  | "rate_limited"
  | "error"
  | "complete";

export function deriveWorkerState(entry: ActivityEntry | undefined): WorkerState {
  if (!entry) return "idle";

  if (entry.action === "complete") return "complete";
  if (entry.action === "error") return "error";
  if (entry.action === "rate_limited") return "rate_limited";

  if (entry.phase === "amazon") {
    return entry.action === "fetching" ? "searching_products" : "returning_products";
  } else {
    return entry.action === "fetching" ? "searching_sellers" : "returning_sellers";
  }
}
```

Update actionIcons and actionStyles to include new pipeline actions (optional, but keeps things consistent):

```typescript
const actionIcons = {
  // Existing
  fetching: <FolderOpen className="h-4 w-4" />,
  found: <CheckCircle className="h-4 w-4" />,
  error: <AlertCircle className="h-4 w-4" />,
  rate_limited: <Clock className="h-4 w-4" />,
  complete: <CheckCircle className="h-4 w-4" />,
  // Pipeline
  uploading: <Upload className="h-4 w-4" />,
  deduped: <Copy className="h-4 w-4" />,
  inserted: <Plus className="h-4 w-4" />,
  updated: <RefreshCw className="h-4 w-4" />,
};

const actionStyles = {
  // Existing
  fetching: "border-l-blue-400",
  found: "border-l-green-400",
  error: "border-l-red-400",
  rate_limited: "border-l-yellow-400",
  complete: "border-l-emerald-400",
  // Pipeline
  uploading: "border-l-purple-400",
  deduped: "border-l-gray-400",
  inserted: "border-l-green-400",
  updated: "border-l-blue-400",
};
```

Add imports for new icons: `Upload, Copy, Plus, RefreshCw` from lucide-react.
  </action>
  <verify>
1. TypeScript compiles without errors: `cd apps/web && npm run build`
2. ActivityEntry includes all new optional fields
3. WorkerMetrics and WorkerState types are exported
  </verify>
  <done>
- ActivityEntry extended with url, api_params, duration_ms, error_type, error_stage, items_count, source_worker_id
- WorkerMetrics interface exported
- WorkerState type and deriveWorkerState helper exported
- Pipeline actions added to icons/styles
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkerCard Component</name>
  <files>apps/web/src/components/admin/collection/worker-card.tsx</files>
  <action>
Create `worker-card.tsx` for individual worker status display.

Per CONTEXT.md decisions:
- Full transparency: shows URL, API params, timing, phase
- Idle state has muted styling
- Last activity summary line below main state
- Click triggers onExpand callback

```typescript
"use client";

import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import {
  ShoppingCart,
  Search,
  AlertCircle,
  Clock,
  Loader2,
  CheckCircle,
  User,
} from "lucide-react";
import { ActivityEntry, WorkerState, deriveWorkerState } from "./activity-feed";

interface WorkerCardProps {
  worker_id: number;
  lastActivity?: ActivityEntry;
  onClick: () => void;
}

// Worker colors for visual distinction (same as activity-feed.tsx)
const workerColors = [
  "border-blue-500/50 hover:border-blue-500",
  "border-green-500/50 hover:border-green-500",
  "border-purple-500/50 hover:border-purple-500",
  "border-orange-500/50 hover:border-orange-500",
  "border-pink-500/50 hover:border-pink-500",
];

const workerBgColors = [
  "bg-blue-500/10",
  "bg-green-500/10",
  "bg-purple-500/10",
  "bg-orange-500/10",
  "bg-pink-500/10",
];

function StateIcon({ state }: { state: WorkerState }) {
  switch (state) {
    case "searching_products":
    case "searching_sellers":
      return <Loader2 className="h-4 w-4 animate-spin" />;
    case "returning_products":
    case "returning_sellers":
      return <CheckCircle className="h-4 w-4 text-green-400" />;
    case "rate_limited":
      return <Clock className="h-4 w-4 text-yellow-400" />;
    case "error":
      return <AlertCircle className="h-4 w-4 text-red-400" />;
    case "complete":
      return <CheckCircle className="h-4 w-4 text-emerald-400" />;
    default:
      return <User className="h-4 w-4 text-gray-500" />;
  }
}

function stateLabel(state: WorkerState): string {
  switch (state) {
    case "searching_products": return "Searching products...";
    case "returning_products": return "Products found";
    case "searching_sellers": return "Searching sellers...";
    case "returning_sellers": return "Sellers found";
    case "rate_limited": return "Rate limited";
    case "error": return "Error";
    case "complete": return "Complete";
    default: return "Idle";
  }
}

function formatLastActivity(entry: ActivityEntry): string {
  if (entry.action === "found") {
    const count = entry.new_sellers_count || 0;
    return entry.phase === "amazon"
      ? `Found ${count} products`
      : `Found ${count} sellers`;
  }
  if (entry.action === "error") {
    return `Error: ${entry.error_message?.slice(0, 30) || "Unknown"}`;
  }
  if (entry.action === "rate_limited") {
    return "Rate limited - waiting...";
  }
  if (entry.action === "fetching") {
    return `Fetching ${entry.category || entry.product_name || "..."}`;
  }
  if (entry.action === "complete") {
    return entry.phase === "amazon" ? "Amazon phase done" : "eBay phase done";
  }
  return "";
}

export function WorkerCard({ worker_id, lastActivity, onClick }: WorkerCardProps) {
  const state = deriveWorkerState(lastActivity);
  const isIdle = state === "idle";
  const colorIdx = (worker_id - 1) % workerColors.length;

  return (
    <div
      onClick={onClick}
      className={cn(
        "p-3 rounded-lg border-2 cursor-pointer transition-all",
        workerColors[colorIdx],
        isIdle ? "bg-gray-800/30" : workerBgColors[colorIdx],
        "hover:bg-gray-800/50"
      )}
    >
      {/* Header: Worker badge + Phase */}
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <Badge className="text-xs bg-gray-700 text-gray-300">
            W{worker_id}
          </Badge>
          {lastActivity && (
            <Badge
              className={cn(
                "text-[10px]",
                lastActivity.phase === "amazon"
                  ? "bg-orange-500/20 text-orange-400"
                  : "bg-blue-500/20 text-blue-400"
              )}
            >
              {lastActivity.phase === "amazon" ? (
                <ShoppingCart className="h-2.5 w-2.5 mr-0.5" />
              ) : (
                <Search className="h-2.5 w-2.5 mr-0.5" />
              )}
              {lastActivity.phase === "amazon" ? "Amazon" : "eBay"}
            </Badge>
          )}
        </div>
        <StateIcon state={state} />
      </div>

      {/* State label */}
      <div className={cn(
        "text-sm font-medium mb-1",
        isIdle ? "text-gray-500" : "text-white"
      )}>
        {stateLabel(state)}
      </div>

      {/* Request details (when active) */}
      {lastActivity?.api_params && !isIdle && (
        <div className="text-[10px] text-gray-500 mb-1 truncate">
          {lastActivity.api_params.query && (
            <span>Query: {lastActivity.api_params.query.slice(0, 25)}...</span>
          )}
          {lastActivity.api_params.node_id && (
            <span>Node: {lastActivity.api_params.node_id}</span>
          )}
          {lastActivity.api_params.page && (
            <span className="ml-2">Page {lastActivity.api_params.page}</span>
          )}
        </div>
      )}

      {/* Duration (when available) */}
      {lastActivity?.duration_ms && (
        <div className="text-[10px] text-gray-500 mb-1">
          {lastActivity.duration_ms}ms
        </div>
      )}

      {/* Last activity summary line */}
      {lastActivity && (
        <div className={cn(
          "text-xs mt-2 pt-2 border-t border-gray-700/50 truncate",
          state === "error" ? "text-red-400" : "text-gray-400"
        )}>
          {formatLastActivity(lastActivity)}
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
1. File exists and exports WorkerCard
2. TypeScript compiles: `cd apps/web && npm run build`
3. Component renders without errors (will test in integration)
  </verify>
  <done>
- WorkerCard component created
- Shows worker badge, phase indicator, state icon
- Full transparency: API params, duration when available
- Last activity summary line
- Click handler for expansion
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WorkerStatusPanel and WorkerDetailView</name>
  <files>
    apps/web/src/components/admin/collection/worker-status-panel.tsx
    apps/web/src/components/admin/collection/worker-detail-view.tsx
  </files>
  <action>
Create `worker-status-panel.tsx` - container for all 5 worker cards:

```typescript
"use client";

import { WorkerCard } from "./worker-card";
import { ActivityEntry, WorkerMetrics } from "./activity-feed";

interface WorkerStatusPanelProps {
  activities: ActivityEntry[];
  workerMetrics: Map<number, WorkerMetrics>;
  onExpandWorker: (workerId: number) => void;
}

export function WorkerStatusPanel({
  activities,
  workerMetrics,
  onExpandWorker,
}: WorkerStatusPanelProps) {
  // Get last activity per worker
  const lastActivityByWorker = new Map<number, ActivityEntry>();
  for (const activity of activities) {
    if (activity.worker_id > 0 && !lastActivityByWorker.has(activity.worker_id)) {
      lastActivityByWorker.set(activity.worker_id, activity);
    }
  }

  return (
    <div className="space-y-2">
      <div className="text-sm font-medium text-gray-300 mb-3">Workers</div>
      {/* Vertical stack of 5 workers - all visible without scroll */}
      <div className="flex flex-col gap-2">
        {[1, 2, 3, 4, 5].map((workerId) => (
          <WorkerCard
            key={workerId}
            worker_id={workerId}
            lastActivity={lastActivityByWorker.get(workerId)}
            onClick={() => onExpandWorker(workerId)}
          />
        ))}
      </div>
    </div>
  );
}
```

Create `worker-detail-view.tsx` - expanded view when worker card is clicked:

```typescript
"use client";

import { useState, useMemo } from "react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { ArrowLeft, User, Activity, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";
import { ActivityEntry, WorkerMetrics, deriveWorkerState } from "./activity-feed";
import { formatDistanceToNow } from "date-fns";

interface WorkerDetailViewProps {
  workerId: number;
  activities: ActivityEntry[];
  metrics: WorkerMetrics | undefined;
  totalMetrics: {
    total_requests: number;
    total_errors: number;
    total_sellers: number;
  };
  onBack: () => void;
}

// Worker colors
const workerBgColors = [
  "bg-blue-500/10",
  "bg-green-500/10",
  "bg-purple-500/10",
  "bg-orange-500/10",
  "bg-pink-500/10",
];

type FilterType = "all" | "fetching" | "found" | "error" | "rate_limited";

export function WorkerDetailView({
  workerId,
  activities,
  metrics,
  totalMetrics,
  onBack,
}: WorkerDetailViewProps) {
  const [filter, setFilter] = useState<FilterType>("all");

  // Filter activities for this worker
  const workerActivities = useMemo(() => {
    return activities
      .filter((a) => a.worker_id === workerId)
      .filter((a) => filter === "all" || a.action === filter);
  }, [activities, workerId, filter]);

  const colorIdx = (workerId - 1) % workerBgColors.length;

  // Calculate average response time
  const avgResponseTime = metrics && metrics.api_requests_total > 0
    ? Math.round(metrics.total_duration_ms / metrics.api_requests_total)
    : 0;

  return (
    <div className="h-full flex flex-col">
      {/* Header with back button */}
      <div className="flex items-center gap-3 mb-4">
        <Button
          variant="ghost"
          size="sm"
          onClick={onBack}
          className="text-gray-400 hover:text-white"
        >
          <ArrowLeft className="h-4 w-4" />
        </Button>
        <Badge className={cn("text-sm", workerBgColors[colorIdx])}>
          <User className="h-3 w-3 mr-1" />
          Worker {workerId}
        </Badge>
      </div>

      {/* Dual metrics: Worker + Total */}
      <div className="grid grid-cols-2 gap-4 mb-4">
        {/* Worker metrics */}
        <div className={cn("p-3 rounded-lg", workerBgColors[colorIdx])}>
          <div className="text-xs text-gray-400 uppercase mb-2">This Worker</div>
          <div className="grid grid-cols-2 gap-2 text-sm">
            <div>
              <div className="text-gray-400">Requests</div>
              <div className="text-white font-medium">
                {metrics?.api_requests_total || 0}
              </div>
            </div>
            <div>
              <div className="text-gray-400">Avg Time</div>
              <div className="text-white font-medium">{avgResponseTime}ms</div>
            </div>
            <div>
              <div className="text-gray-400">Success</div>
              <div className="text-green-400 font-medium">
                {metrics?.api_requests_success || 0}
              </div>
            </div>
            <div>
              <div className="text-gray-400">Failed</div>
              <div className="text-red-400 font-medium">
                {metrics?.api_requests_failed || 0}
              </div>
            </div>
          </div>
        </div>

        {/* Total run metrics */}
        <div className="p-3 rounded-lg bg-gray-800/50">
          <div className="text-xs text-gray-400 uppercase mb-2">Run Totals</div>
          <div className="grid grid-cols-2 gap-2 text-sm">
            <div>
              <div className="text-gray-400">Total Requests</div>
              <div className="text-white font-medium">{totalMetrics.total_requests}</div>
            </div>
            <div>
              <div className="text-gray-400">Total Errors</div>
              <div className="text-red-400 font-medium">{totalMetrics.total_errors}</div>
            </div>
            <div className="col-span-2">
              <div className="text-gray-400">Sellers Found</div>
              <div className="text-green-400 font-medium">{totalMetrics.total_sellers}</div>
            </div>
          </div>
        </div>
      </div>

      {/* Error breakdown (if any errors) */}
      {metrics && Object.keys(metrics.errors_by_type).length > 0 && (
        <div className="mb-4 p-3 rounded-lg bg-red-900/20 border border-red-800/30">
          <div className="flex items-center gap-2 text-xs text-red-400 uppercase mb-2">
            <AlertTriangle className="h-3 w-3" />
            Error Breakdown
          </div>
          <div className="flex flex-wrap gap-2">
            {Object.entries(metrics.errors_by_type).map(([type, count]) => (
              <Badge key={type} variant="outline" className="text-red-300 border-red-700">
                {type}: {count}
              </Badge>
            ))}
          </div>
        </div>
      )}

      {/* Filter dropdown */}
      <div className="flex items-center justify-between mb-3">
        <div className="text-sm font-medium text-gray-300 flex items-center gap-2">
          <Activity className="h-4 w-4" />
          Activity Log
        </div>
        <Select value={filter} onValueChange={(v) => setFilter(v as FilterType)}>
          <SelectTrigger className="w-32 h-8 text-xs bg-gray-800 border-gray-700">
            <SelectValue placeholder="Filter" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All</SelectItem>
            <SelectItem value="fetching">Fetching</SelectItem>
            <SelectItem value="found">Found</SelectItem>
            <SelectItem value="error">Errors</SelectItem>
            <SelectItem value="rate_limited">Rate Limited</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Scrollable log */}
      <div className="flex-1 overflow-y-auto space-y-1 pr-2">
        <TooltipProvider>
          {workerActivities.length === 0 ? (
            <div className="text-gray-500 text-sm text-center py-8">
              No activity yet
            </div>
          ) : (
            workerActivities.map((entry) => (
              <Tooltip key={entry.id}>
                <TooltipTrigger asChild>
                  <div
                    className={cn(
                      "p-2 rounded text-xs cursor-default",
                      entry.action === "error" ? "bg-red-900/20" :
                      entry.action === "rate_limited" ? "bg-yellow-900/20" :
                      entry.action === "found" ? "bg-green-900/20" :
                      "bg-gray-800/50"
                    )}
                  >
                    <div className="flex items-center justify-between">
                      <span className={cn(
                        "font-medium",
                        entry.action === "error" ? "text-red-400" :
                        entry.action === "rate_limited" ? "text-yellow-400" :
                        entry.action === "found" ? "text-green-400" :
                        "text-gray-300"
                      )}>
                        {entry.action}
                      </span>
                      <span className="text-gray-500">
                        {formatDistanceToNow(new Date(entry.timestamp), { addSuffix: true })}
                      </span>
                    </div>
                    <div className="text-gray-400 truncate mt-1">
                      {entry.category || entry.product_name || ""}
                      {entry.duration_ms && (
                        <span className="ml-2 text-gray-500">{entry.duration_ms}ms</span>
                      )}
                    </div>
                  </div>
                </TooltipTrigger>
                <TooltipContent side="left" className="max-w-xs">
                  <div className="space-y-1 text-xs">
                    {entry.url && <div><strong>URL:</strong> {entry.url}</div>}
                    {entry.api_params && (
                      <div><strong>Params:</strong> {JSON.stringify(entry.api_params)}</div>
                    )}
                    {entry.error_message && (
                      <div className="text-red-300"><strong>Error:</strong> {entry.error_message}</div>
                    )}
                    {entry.error_type && (
                      <div><strong>Type:</strong> {entry.error_type} ({entry.error_stage})</div>
                    )}
                  </div>
                </TooltipContent>
              </Tooltip>
            ))
          )}
        </TooltipProvider>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
1. Both files exist and export their components
2. TypeScript compiles: `cd apps/web && npm run build`
3. WorkerStatusPanel renders 5 WorkerCard components
4. WorkerDetailView shows metrics and filterable log
  </verify>
  <done>
- WorkerStatusPanel renders all 5 workers in vertical stack
- Derives last activity per worker from activities array
- Calls onExpandWorker when card clicked
- WorkerDetailView shows dual metrics (worker + total)
- Error breakdown shown when errors exist
- Filterable scrollable log with hover tooltips
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds in apps/web
2. ActivityEntry type includes all new fields
3. WorkerMetrics interface exported
4. WorkerCard, WorkerStatusPanel, WorkerDetailView all export correctly
5. Components use consistent worker colors matching activity-feed.tsx
</verification>

<success_criteria>
- ActivityEntry extended with url, api_params, duration_ms, error_type, error_stage, pipeline fields
- WorkerMetrics interface available for metrics aggregation
- WorkerState type with deriveWorkerState helper
- WorkerCard shows full transparency per CONTEXT.md
- WorkerStatusPanel displays all 5 cards without scroll
- WorkerDetailView has back button, dual metrics, error breakdown, filterable log
</success_criteria>

<output>
After completion, create `.planning/phases/13-worker-status-dashboard-metrics/13-02-SUMMARY.md`
</output>
