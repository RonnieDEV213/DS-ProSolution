---
phase: 33-collection-keyboard-shortcuts
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - apps/web/src/hooks/use-collection-shortcuts.ts
  - apps/web/src/components/admin/collection/sellers-grid.tsx
  - apps/web/src/app/admin/automation/page.tsx
autonomous: true

must_haves:
  truths:
    - "Pressing Delete/Backspace with sellers selected opens the delete confirmation dialog"
    - "Pressing F with sellers selected toggles flag using Google Docs Ctrl+B pattern (any unflagged -> flag all; all flagged -> unflag all)"
    - "Pressing E opens export dialog scoped to selected sellers (or all sellers if none selected)"
    - "Pressing S opens the run configuration dialog (selection does not affect scope)"
    - "Pressing Escape clears seller selection (only when no dialog is open)"
    - "Ctrl+Z remains working for undo bulk delete (kept as-is per CONTEXT.md)"
    - "Shortcuts do NOT fire when typing in the add seller textarea or any input"
    - "Global F (focus search) still works when no sellers are selected"
    - "Selection toolbar shows Flag and Export buttons with keyboard shortcut badges when sellers are selected"
    - "First-visit hint appears once, dismissible, stored in localStorage"
  artifacts:
    - path: "apps/web/src/hooks/use-collection-shortcuts.ts"
      provides: "useCollectionShortcuts hook with Delete, F, E, S, Escape bindings"
      exports: ["useCollectionShortcuts"]
    - path: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      provides: "Wired shortcuts, flag toggle handler, selection-scoped export, toolbar with shortcut badges, first-visit hint"
      contains: "useCollectionShortcuts"
    - path: "apps/web/src/app/admin/automation/page.tsx"
      provides: "S shortcut event listener that opens RunConfigModal"
      contains: "dspro:shortcut:startrun"
  key_links:
    - from: "apps/web/src/hooks/use-collection-shortcuts.ts"
      to: "sellers-grid.tsx"
      via: "hook called with callback props"
      pattern: "useCollectionShortcuts\\("
    - from: "apps/web/src/hooks/use-collection-shortcuts.ts"
      to: "react-hotkeys-hook"
      via: "useHotkeys calls with enabled callbacks"
      pattern: "useHotkeys\\("
    - from: "sellers-grid.tsx"
      to: "seller-export-modal.tsx"
      via: "selection-scoped sellers prop"
      pattern: "selectedIds\\.size > 0.*filteredSellers\\.filter"
    - from: "sellers-grid.tsx"
      to: "page.tsx"
      via: "CustomEvent dispatch for S shortcut"
      pattern: "dspro:shortcut:startrun"
---

<objective>
Create the useCollectionShortcuts hook, wire all keyboard shortcuts into the sellers grid, add the flag toggle handler with Google Docs pattern, scope exports to selection, enhance the toolbar with action buttons + keyboard badges, add the first-visit hint, and connect S shortcut to RunConfigModal.

Purpose: This is the core implementation -- every keyboard shortcut becomes functional, the toolbar becomes action-rich when selection is active, and new users discover shortcuts via a dismissible hint.
Output: Working keyboard shortcuts on the collection page with full integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-collection-keyboard-shortcuts/33-CONTEXT.md
@.planning/phases/33-collection-keyboard-shortcuts/33-RESEARCH.md
@.planning/phases/33-collection-keyboard-shortcuts/33-01-SUMMARY.md

Source files:
@apps/web/src/components/admin/collection/sellers-grid.tsx
@apps/web/src/app/admin/automation/page.tsx
@apps/web/src/hooks/use-global-shortcuts.ts
@apps/web/src/lib/shortcuts.ts
@apps/web/src/lib/storage-keys.ts
@apps/web/src/components/admin/collection/seller-export-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCollectionShortcuts hook</name>
  <files>apps/web/src/hooks/use-collection-shortcuts.ts</files>
  <action>
Create a new file `apps/web/src/hooks/use-collection-shortcuts.ts`. This hook encapsulates all collection-page keyboard shortcut bindings using `useHotkeys` from `react-hotkeys-hook`.

```typescript
"use client"

import { useHotkeys } from "react-hotkeys-hook"

interface UseCollectionShortcutsOptions {
  /** Master enable switch (e.g., page is active) */
  enabled: boolean
  /** Current selection set */
  selectedCount: number
  /** Whether any dialog/modal is currently open */
  isDialogOpen: boolean
  /** Callbacks */
  onDelete: () => void
  onFlag: () => void
  onExport: () => void
  onStartRun: () => void
  onClearSelection: () => void
}

export function useCollectionShortcuts({
  enabled,
  selectedCount,
  isDialogOpen,
  onDelete,
  onFlag,
  onExport,
  onStartRun,
  onClearSelection,
}: UseCollectionShortcutsOptions) {
  // Delete/Backspace - delete selected sellers (requires selection)
  useHotkeys("Delete,Backspace", (e) => {
    e.preventDefault()
    e.stopImmediatePropagation()
    onDelete()
  }, {
    enabled: () => enabled && selectedCount > 0 && !isDialogOpen,
    enableOnFormTags: false,
  }, [enabled, selectedCount, isDialogOpen, onDelete])

  // F - flag toggle (Google Docs Ctrl+B pattern, requires selection)
  // stopImmediatePropagation prevents global F (focus search) from also firing
  useHotkeys("f", (e) => {
    e.preventDefault()
    e.stopImmediatePropagation()
    onFlag()
  }, {
    enabled: () => enabled && selectedCount > 0 && !isDialogOpen,
    enableOnFormTags: false,
  }, [enabled, selectedCount, isDialogOpen, onFlag])

  // E - export (always available on collection page, scoping handled by caller)
  // stopImmediatePropagation prevents global E (dispatch export event) from also firing
  useHotkeys("e", (e) => {
    e.preventDefault()
    e.stopImmediatePropagation()
    onExport()
  }, {
    enabled: () => enabled && !isDialogOpen,
    enableOnFormTags: false,
  }, [enabled, isDialogOpen, onExport])

  // S - start run (always available on collection page, selection does NOT affect scope)
  useHotkeys("s", (e) => {
    e.preventDefault()
    e.stopImmediatePropagation()
    onStartRun()
  }, {
    enabled: () => enabled && !isDialogOpen,
    enableOnFormTags: false,
  }, [enabled, isDialogOpen, onStartRun])

  // Escape - clear selection (only when no dialog is open)
  useHotkeys("Escape", (e) => {
    e.preventDefault()
    onClearSelection()
  }, {
    enabled: () => enabled && selectedCount > 0 && !isDialogOpen,
    enableOnFormTags: false,
  }, [enabled, selectedCount, isDialogOpen, onClearSelection])
}
```

Key design decisions:
- `enabled` master switch is always `true` on the collection page (no pathname check needed -- the hook is only called from sellers-grid which only renders on that page).
- `selectedCount` is passed as a number (not the Set) to keep the interface simple. The `enabled` callbacks use it for gating.
- `isDialogOpen` gates ALL shortcuts to prevent conflicts with dialog Escape handlers and accidental actions while dialogs are open (Pitfall 4 from RESEARCH.md).
- `stopImmediatePropagation()` on `f` and `e` prevents global handlers from also firing (Pitfall 1).
- The `s` shortcut also uses `stopImmediatePropagation()` to prevent any global handlers.
- `enableOnFormTags: false` prevents firing when typing in inputs/textareas (Pitfall 2). This is the default in v5 but we're explicit.
- The last argument to `useHotkeys` is the dependency array for the `enabled` callback and handler.
  </action>
  <verify>
Run `cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/web && npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>
New `use-collection-shortcuts.ts` exports `useCollectionShortcuts` hook with 5 keyboard bindings (Delete, F, E, S, Escape), all gated by enabled/selectedCount/isDialogOpen, all using stopImmediatePropagation for conflict resolution. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire shortcuts into sellers-grid with flag toggle, export scoping, toolbar, and hint</name>
  <files>apps/web/src/components/admin/collection/sellers-grid.tsx, apps/web/src/app/admin/automation/page.tsx</files>
  <action>
This task makes multiple coordinated changes to `sellers-grid.tsx` and `page.tsx`.

### A. sellers-grid.tsx -- Wire useCollectionShortcuts hook

1. Add imports at the top:
```typescript
import { useCollectionShortcuts } from "@/hooks/use-collection-shortcuts"
import { Kbd } from "@/components/ui/kbd"
import { Flag } from "lucide-react"  // add to existing lucide imports
import { STORAGE_KEYS } from "@/lib/storage-keys"
```

2. Add `isDialogOpen` derived state after existing state declarations (after line ~288):
```typescript
const isDialogOpen = deleteDialogOpen || exportModalOpen;
```

3. Create the flag toggle handler (Google Docs Ctrl+B pattern). Place it near the existing `handleBulkDeleteClick` (~line 440):
```typescript
const handleFlagToggle = useCallback(() => {
  if (selectedIds.size === 0) return;
  const selectedSellers = filteredSellers.filter(s => selectedIds.has(s.id));
  const allFlagged = selectedSellers.every(s => s.flagged);
  const newFlagState = !allFlagged;
  const idsToChange = selectedSellers
    .filter(s => s.flagged !== newFlagState)
    .map(s => s.id);
  if (idsToChange.length > 0) {
    batchFlagMutation.mutate(
      { ids: idsToChange, flagged: newFlagState },
      { onSuccess: () => onSellerChange() }
    );
  }
}, [selectedIds, filteredSellers, batchFlagMutation, onSellerChange]);
```

4. Create the S shortcut handler that dispatches a custom event (since RunConfigModal is in page.tsx, not sellers-grid):
```typescript
const handleStartRunShortcut = useCallback(() => {
  window.dispatchEvent(new CustomEvent("dspro:shortcut:startrun"));
}, []);
```

5. Create the clear selection handler:
```typescript
const handleClearSelection = useCallback(() => {
  setSelectedIds(new Set());
  setSelectionAnchor(null);
}, []);
```

6. Call the hook (after all handler definitions, before the loading return):
```typescript
useCollectionShortcuts({
  enabled: true,
  selectedCount: selectedIds.size,
  isDialogOpen,
  onDelete: handleBulkDeleteClick,
  onFlag: handleFlagToggle,
  onExport: () => setExportModalOpen(true),
  onStartRun: handleStartRunShortcut,
  onClearSelection: handleClearSelection,
});
```

### B. sellers-grid.tsx -- Selection-scoped export

7. Change the `SellerExportModal` usage (currently around line 1063) to scope sellers when selection exists:
```typescript
<SellerExportModal
  open={exportModalOpen}
  onOpenChange={setExportModalOpen}
  sellers={selectedIds.size > 0 ? filteredSellers.filter(s => selectedIds.has(s.id)) : filteredSellers}
  totalCount={selectedIds.size > 0 ? selectedIds.size : totalCount}
  onExportComplete={() => onSellerChange?.()}
/>
```

### C. sellers-grid.tsx -- Enhanced selection toolbar with action buttons + keyboard badges

8. Enhance the selection toolbar area (the `<div data-selection-control>` block, around lines 1024-1059). When `selectedIds.size > 0`, show Flag and Export action buttons alongside the existing Delete button, each with a subtle Kbd badge:

Replace the existing toolbar section (from the `<div data-selection-control>` block) with:
```tsx
<div className="flex items-center gap-2" data-selection-control>
  <Checkbox
    checked={allSelected ? true : someSelected ? "indeterminate" : false}
    onCheckedChange={toggleSelectAll}
    className="border-border data-[state=checked]:bg-primary"
  />
  <span className="text-muted-foreground text-sm">
    {selectedIds.size > 0
      ? `${selectedIds.size.toLocaleString()} selected / `
      : ""}
    {filteredSellers.length !== totalCount
      ? `${filteredSellers.length.toLocaleString()} / ${totalCount.toLocaleString()}`
      : `${totalCount.toLocaleString()} sellers`}
    {flaggedCount > 0 && (
      <span className="text-yellow-500 ml-2">({flaggedCount} flagged)</span>
    )}
    {isSyncing && (
      <span className="text-muted-foreground/60 text-xs ml-1">(syncing...)</span>
    )}
  </span>
  {selectedIds.size > 0 && (
    <>
      <Button
        size="sm"
        variant="ghost"
        onClick={handleFlagToggle}
        className="text-yellow-500 hover:text-yellow-400 hover:bg-yellow-900/30"
      >
        <Flag className="h-4 w-4 mr-1" />
        Flag
        <Kbd className="ml-1.5 text-[10px]">F</Kbd>
      </Button>
      <Button
        size="sm"
        variant="ghost"
        onClick={handleBulkDeleteClick}
        disabled={isDeleting}
        className="text-red-400 hover:text-red-300 hover:bg-red-900/30"
      >
        {isDeleting ? <Loader2 className="h-4 w-4 animate-spin" /> : <Trash2 className="h-4 w-4 mr-1" />}
        Delete
        <Kbd className="ml-1.5 text-[10px]">Del</Kbd>
      </Button>
    </>
  )}
  <Button variant="outline" size="sm" onClick={() => setExportModalOpen(true)}>
    <Download className="h-4 w-4 mr-1" />
    Export
    <Kbd className="ml-1.5 text-[10px]">E</Kbd>
  </Button>
</div>
```

Note: The Flag and Delete buttons only appear when selection > 0. The Export button always appears (but its keyboard shortcut scopes to selection when available). The `Kbd` badges are subtle (10px font, small margin).

IMPORTANT: Check if the `Kbd` component accepts `className` prop. If it does not, wrap it in a `<span className="ml-1.5">` instead and use `<Kbd>` without className. Read `apps/web/src/components/ui/kbd.tsx` to confirm.

### D. sellers-grid.tsx -- First-visit hint

9. Add first-visit hint state and effect at the top of the component (after existing state declarations):
```typescript
const [showShortcutsHint, setShowShortcutsHint] = useState(false);

useEffect(() => {
  const dismissed = localStorage.getItem(STORAGE_KEYS.COLLECTION_SHORTCUTS_HINT_DISMISSED);
  if (!dismissed) setShowShortcutsHint(true);
}, []);

const dismissHint = useCallback(() => {
  localStorage.setItem(STORAGE_KEYS.COLLECTION_SHORTCUTS_HINT_DISMISSED, "true");
  setShowShortcutsHint(false);
}, []);
```

10. Render the hint banner just above the grid container (before the `<div ref={gridContainerRef}>` block), only when `showShortcutsHint` is true:
```tsx
{showShortcutsHint && (
  <div className="flex items-center justify-between bg-muted/50 border border-border rounded-md px-3 py-2 mb-2 text-sm text-muted-foreground">
    <span>
      Tip: Press <Kbd>?</Kbd> for keyboard shortcuts
    </span>
    <Button variant="ghost" size="sm" onClick={dismissHint} className="text-xs h-6 px-2">
      Dismiss
    </Button>
  </div>
)}
```

### E. page.tsx -- Listen for S shortcut custom event

11. In `apps/web/src/app/admin/automation/page.tsx`, add a `useEffect` to listen for the `dspro:shortcut:startrun` custom event and open the RunConfigModal:

```typescript
// Listen for S keyboard shortcut from SellersGrid
useEffect(() => {
  const handleStartRun = () => setRunConfigOpen(true);
  window.addEventListener("dspro:shortcut:startrun", handleStartRun);
  return () => window.removeEventListener("dspro:shortcut:startrun", handleStartRun);
}, []);
```

Place this after the existing useEffect hooks in the component.

### Things NOT to change:
- Do NOT remove the existing Ctrl+A, Ctrl+C, or Ctrl+Z useEffect handlers in sellers-grid.tsx. They work fine as-is (raw addEventListener). The collection hook handles Delete, F, E, S, Escape only. Ctrl+A/C/Z are already implemented via useEffect and do not need migration.
- Do NOT modify `use-global-shortcuts.ts`. Conflict resolution is handled via stopImmediatePropagation in the collection hook.
- Do NOT add shortcuts to the command palette.
  </action>
  <verify>
1. Run `cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/web && npx tsc --noEmit` -- no type errors
2. Run `npm run build` -- build passes
3. Verify `use-collection-shortcuts.ts` exists and exports the hook
4. Verify `sellers-grid.tsx` imports and calls `useCollectionShortcuts`
5. Verify `page.tsx` has the `dspro:shortcut:startrun` event listener
6. Verify export modal receives selection-scoped sellers when selection exists
7. Verify toolbar has Flag button with Kbd badge, Delete button with Kbd badge, Export with Kbd badge
8. Verify first-visit hint renders and uses STORAGE_KEYS.COLLECTION_SHORTCUTS_HINT_DISMISSED
  </verify>
  <done>
All collection keyboard shortcuts are functional:
- Delete/Backspace opens delete confirmation when sellers selected
- F toggles flags using Google Docs Ctrl+B pattern when sellers selected
- E opens export dialog (scoped to selection if any)
- S opens run config dialog (via custom event to page.tsx)
- Escape clears selection (when no dialog open)
- Ctrl+Z undo remains working (untouched)
- Global F (focus search) still works when nothing selected
- Toolbar shows Flag [F], Delete [Del] when selection active, Export [E] always
- First-visit hint appears once and is dismissible
- No shortcuts fire when typing in inputs
- Build passes with no errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Build: `npm run build` passes
3. File check: `use-collection-shortcuts.ts` exists with 5 useHotkeys bindings
4. Integration check: `sellers-grid.tsx` calls `useCollectionShortcuts` with correct callbacks
5. Export scoping: `SellerExportModal` receives selection-filtered sellers
6. Toolbar: Flag and Delete buttons appear with Kbd badges when selection > 0
7. Hint: First-visit banner renders once, dismisses to localStorage
8. Page event: `page.tsx` listens for `dspro:shortcut:startrun` and opens RunConfigModal
9. No regressions: Ctrl+A, Ctrl+C, Ctrl+Z still work (untouched useEffect handlers)
</verification>

<success_criteria>
- Delete key with selection -> opens delete confirmation dialog
- F key with selection -> toggles flag (Ctrl+B pattern: any unflagged -> flag all, all flagged -> unflag all)
- E key -> opens export dialog scoped to selected sellers (all if none selected)
- S key -> opens run config dialog (selection-independent)
- Escape with selection -> clears selection (no-op if dialog open)
- Ctrl+Z -> undo bulk delete (existing, untouched)
- No shortcuts fire when typing in text inputs
- Global F works when no selection (not blocked by collection hook)
- Toolbar shows Flag [F], Delete [Del] buttons when selection active
- Export [E] badge always visible on export button
- First-visit "Press ? for shortcuts" hint appears once, dismissible
- TypeScript and build pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/33-collection-keyboard-shortcuts/33-02-SUMMARY.md`
</output>
