---
phase: 10-collection-ui-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/web/src/components/admin/collection/sellers-grid.tsx
autonomous: true

must_haves:
  truths:
    - "Single click toggles seller selection"
    - "Drag selection selects multiple sellers"
    - "Double-click enters edit mode"
    - "Header checkbox toggles select all"
    - "Selected count shows when selection active"
    - "Delete button appears when selection > 0"
    - "Hover over seller shows metadata popover"
  artifacts:
    - path: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      provides: "Enhanced sellers grid with selection and hover cards"
      contains: "useSelectionContainer|HoverCard"
  key_links:
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "@air/react-drag-to-select"
      via: "useSelectionContainer hook"
      pattern: "useSelectionContainer"
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "components/ui/hover-card"
      via: "HoverCard component import"
      pattern: "from.*hover-card"
---

<objective>
Enhance sellers grid with bulk selection (click, drag, Ctrl+A), hover cards for seller metadata, and bulk delete capability.

Purpose: Enable power-user workflows for managing large seller lists efficiently. Per CONTEXT.md, add drag selection, double-click to edit, and hover cards showing seller metadata.
Output: Enhanced sellers-grid.tsx with selection mechanics and hover cards.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-collection-ui-cleanup/10-CONTEXT.md
@.planning/phases/10-collection-ui-cleanup/10-RESEARCH.md
@apps/web/src/components/admin/collection/sellers-grid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection state and click/double-click handling</name>
  <files>apps/web/src/components/admin/collection/sellers-grid.tsx</files>
  <action>
Add selection state management:

```typescript
const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
const clickTimeoutRef = useRef<NodeJS.Timeout | null>(null);
```

**Distinguish single vs double click** (per RESEARCH.md pitfall):
```typescript
const handleSellerClick = (seller: Seller, event: React.MouseEvent) => {
  // Don't trigger if clicking delete button
  if ((event.target as HTMLElement).closest('button')) return;

  if (clickTimeoutRef.current) {
    // Double-click detected
    clearTimeout(clickTimeoutRef.current);
    clickTimeoutRef.current = null;
    startEdit(seller);
  } else {
    // Potential single click - wait to confirm
    clickTimeoutRef.current = setTimeout(() => {
      clickTimeoutRef.current = null;
      toggleSelection(seller.id);
    }, 200);
  }
};

const toggleSelection = (id: string) => {
  setSelectedIds(prev => {
    const next = new Set(prev);
    if (next.has(id)) {
      next.delete(id);
    } else {
      next.add(id);
    }
    return next;
  });
};
```

**Header with selection controls:**
Update header to show:
- Checkbox for select all (using shadcn Checkbox)
- Counter: "N sellers" when no selection, "X selected / N total" when selection active
- Delete button (Trash2 icon, red, only visible when selectedIds.size > 0)
- Existing Export dropdown

```typescript
const allSelected = sellers.length > 0 && sellers.every(s => selectedIds.has(s.id));
const someSelected = selectedIds.size > 0 && !allSelected;

const toggleSelectAll = () => {
  if (allSelected) {
    setSelectedIds(new Set());
  } else {
    setSelectedIds(new Set(sellers.map(s => s.id)));
  }
};
```

**Bulk delete handler:**
```typescript
const handleBulkDelete = async () => {
  if (selectedIds.size === 0) return;

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return;

  // Delete each selected seller
  for (const id of selectedIds) {
    await fetch(`${API_BASE}/sellers/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${session.access_token}` },
    });
  }

  setSelectedIds(new Set());
  onSellerChange();
  fetchSellers();
};
```

**Keyboard shortcut** (Ctrl+A):
Add useEffect to listen for keyboard:
```typescript
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
      e.preventDefault();
      setSelectedIds(new Set(sellers.map(s => s.id)));
    }
  };
  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [sellers]);
```

**Visual feedback on selected items:**
Add to seller card className:
```typescript
selectedIds.has(seller.id) && "ring-2 ring-blue-500 bg-blue-900/30"
```

Clear selection when sellers list changes significantly (e.g., after delete or refresh):
```typescript
useEffect(() => {
  // Clear selection when seller list changes
  setSelectedIds(prev => {
    const validIds = new Set(sellers.map(s => s.id));
    const filtered = new Set([...prev].filter(id => validIds.has(id)));
    return filtered.size === prev.size ? prev : filtered;
  });
}, [sellers]);
```
  </action>
  <verify>
Single click toggles selection (highlighted border). Double-click enters edit mode. Ctrl+A selects all. Header checkbox works.
  </verify>
  <done>Selection state works with click toggle, double-click edit, Ctrl+A select all, and header checkbox</done>
</task>

<task type="auto">
  <name>Task 2: Add drag selection with @air/react-drag-to-select</name>
  <files>apps/web/src/components/admin/collection/sellers-grid.tsx</files>
  <action>
Import drag selection library:
```typescript
import { useSelectionContainer, Box } from '@air/react-drag-to-select';
```

Add refs for selectable elements:
```typescript
const selectableRefs = useRef<Map<string, HTMLElement>>(new Map());

const setSelectableRef = (id: string, el: HTMLElement | null) => {
  if (el) {
    selectableRefs.current.set(id, el);
  } else {
    selectableRefs.current.delete(id);
  }
};
```

Configure drag selection (per RESEARCH.md pattern):
```typescript
const { DragSelection } = useSelectionContainer({
  onSelectionChange: (box: Box) => {
    const selected = new Set<string>();
    selectableRefs.current.forEach((element, id) => {
      const rect = element.getBoundingClientRect();
      // Check if element intersects with selection box
      if (
        rect.left < box.left + box.width &&
        rect.left + rect.width > box.left &&
        rect.top < box.top + box.height &&
        rect.top + rect.height > box.top
      ) {
        selected.add(id);
      }
    });
    setSelectedIds(selected);
  },
  selectionProps: {
    style: {
      border: '1px solid rgb(59, 130, 246)',
      backgroundColor: 'rgba(59, 130, 246, 0.1)',
      borderRadius: 4,
    },
  },
  eventsElement: typeof document !== 'undefined' ? document.getElementById('sellers-grid-container') : undefined,
});
```

Wrap grid in container with DragSelection:
```typescript
<div id="sellers-grid-container" className="relative flex-1 min-h-0 overflow-y-auto bg-gray-900 border border-gray-800 rounded-lg">
  <DragSelection />
  {sellers.length === 0 ? (
    // empty state
  ) : (
    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-1 p-2">
      {sellers.map((seller) => (
        <div
          key={seller.id}
          ref={(el) => setSelectableRef(seller.id, el)}
          // ... rest of seller card
        >
  )}
</div>
```

Note: Reduce grid columns per CONTEXT.md (from 6 to 5 max) to accommodate wider history panel.
  </action>
  <verify>
Click and drag creates selection box; releasing selects intersected sellers.
  </verify>
  <done>Drag selection working with visual selection box and multi-select on release</done>
</task>

<task type="auto">
  <name>Task 3: Add hover cards for seller metadata</name>
  <files>apps/web/src/components/admin/collection/sellers-grid.tsx</files>
  <action>
Import HoverCard components:
```typescript
import {
  HoverCard,
  HoverCardContent,
  HoverCardTrigger,
} from "@/components/ui/hover-card";
```

Extend Seller interface to include metadata:
```typescript
interface Seller {
  id: string;
  display_name: string;
  normalized_name: string;
  platform: string;
  times_seen: number;
  feedback_percent?: number;  // May be null if not scraped
  feedback_count?: number;
  created_at?: string;  // discovered_at
}
```

Wrap each seller card in HoverCard:
```typescript
<HoverCard openDelay={300} closeDelay={100}>
  <HoverCardTrigger asChild>
    <div
      key={seller.id}
      ref={(el) => setSelectableRef(seller.id, el)}
      className={cn(
        "group relative px-2 py-1 bg-gray-800 rounded text-sm text-gray-200 truncate",
        "hover:bg-gray-700 transition-colors cursor-pointer",
        newSellerIds.has(seller.id) && "ring-1 ring-green-500 bg-green-900/20",
        selectedIds.has(seller.id) && "ring-2 ring-blue-500 bg-blue-900/30"
      )}
      onClick={(e) => handleSellerClick(seller, e)}
    >
      {/* existing seller card content */}
    </div>
  </HoverCardTrigger>
  <HoverCardContent
    className="w-56 bg-gray-800 border-gray-700"
    side="top"
    align="center"
  >
    <div className="space-y-2">
      <h4 className="text-sm font-semibold text-white truncate">
        {seller.display_name}
      </h4>
      <div className="text-xs text-gray-400 space-y-1">
        {seller.feedback_percent !== undefined && (
          <div className="flex justify-between">
            <span>Feedback:</span>
            <span className="text-gray-200">{seller.feedback_percent}%</span>
          </div>
        )}
        {seller.feedback_count !== undefined && (
          <div className="flex justify-between">
            <span>Reviews:</span>
            <span className="text-gray-200">{seller.feedback_count.toLocaleString()}</span>
          </div>
        )}
        <div className="flex justify-between">
          <span>Times seen:</span>
          <span className="text-gray-200">{seller.times_seen}</span>
        </div>
        {seller.created_at && (
          <div className="flex justify-between">
            <span>Discovered:</span>
            <span className="text-gray-200">
              {new Date(seller.created_at).toLocaleDateString()}
            </span>
          </div>
        )}
      </div>
    </div>
  </HoverCardContent>
</HoverCard>
```

Note: If backend doesn't return feedback_percent/feedback_count, the hover card will simply not show those fields (conditional rendering handles undefined gracefully).
  </action>
  <verify>
Hover over seller shows popover with metadata. Popover disappears when mouse leaves.
  </verify>
  <done>Hover cards show seller metadata (times_seen, discovered date, feedback if available)</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` in apps/web passes without errors
- [ ] Single click toggles selection with blue ring
- [ ] Double-click enters edit mode
- [ ] Drag selection creates box and selects multiple
- [ ] Ctrl+A selects all sellers
- [ ] Header checkbox toggles select all
- [ ] Delete button visible when selection > 0
- [ ] Bulk delete removes selected sellers
- [ ] Hover shows metadata popover after 300ms delay
</verification>

<success_criteria>
Sellers grid supports full selection mechanics: single click toggle, double-click edit, drag multi-select, Ctrl+A, header checkbox. Bulk delete available. Hover cards show seller metadata. Counter updates to show "X selected / N total" during selection.
</success_criteria>

<output>
After completion, create `.planning/phases/10-collection-ui-cleanup/10-03-SUMMARY.md`
</output>
