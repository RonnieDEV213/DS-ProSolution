---
phase: 10-collection-ui-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/admin/collection/history-panel.tsx
  - apps/web/src/components/admin/collection/hierarchical-run-modal.tsx
autonomous: true

must_haves:
  truths:
    - "History panel shows unified chronological list of collection runs and manual edits"
    - "Collection runs display with bot icon and blue accent"
    - "Manual edits display with user icon and gray accent"
    - "Clicking collection entry opens run detail modal"
    - "Hierarchical modal shows expandable department->category->product->sellers tree"
  artifacts:
    - path: "apps/web/src/components/admin/collection/history-panel.tsx"
      provides: "Unified history timeline component"
      min_lines: 100
    - path: "apps/web/src/components/admin/collection/hierarchical-run-modal.tsx"
      provides: "Expandable tree view of collection run details"
      min_lines: 150
  key_links:
    - from: "apps/web/src/components/admin/collection/history-panel.tsx"
      to: "/sellers/audit-log"
      via: "fetch for manual edit entries"
      pattern: "fetch.*audit-log"
    - from: "apps/web/src/components/admin/collection/history-panel.tsx"
      to: "/collection/runs/history"
      via: "fetch for collection run entries"
      pattern: "fetch.*history"
---

<objective>
Create unified history panel that merges Recent Activity sidebar and Collection History table into a single chronological timeline with visual distinction between collection runs and manual edits.

Purpose: Reduce UI clutter by consolidating two separate history views into one unified activity feed. Per CONTEXT.md, this replaces both recent-logs-sidebar and collection-history components.
Output: New history-panel.tsx and hierarchical-run-modal.tsx components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-collection-ui-cleanup/10-CONTEXT.md
@.planning/phases/10-collection-ui-cleanup/10-RESEARCH.md
@apps/web/src/components/admin/collection/recent-logs-sidebar.tsx
@apps/web/src/components/admin/collection/collection-history.tsx
@apps/web/src/components/admin/collection/log-detail-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history-panel component</name>
  <files>apps/web/src/components/admin/collection/history-panel.tsx</files>
  <action>
Create new component that merges functionality from recent-logs-sidebar.tsx and collection-history.tsx.

**Props interface:**
```typescript
interface HistoryPanelProps {
  refreshTrigger: number;
  onStartRunClick: () => void;
  hasActiveRun: boolean;
  onManualEditClick: (logId: string) => void;  // Opens existing LogDetailModal
  onCollectionRunClick: (runId: string) => void;  // Opens new HierarchicalRunModal
}
```

**Data model (discriminated union):**
```typescript
interface CollectionRunEntry {
  type: "collection_run";
  id: string;
  name: string;
  started_at: string;
  completed_at: string | null;
  status: "completed" | "failed" | "cancelled";
  sellers_new: number;
  categories_count: number;
  category_ids: string[];
}

interface ManualEditEntry {
  type: "manual_edit";
  id: string;
  action: "add" | "edit" | "remove";
  seller_name: string;
  affected_count: number;
  created_at: string;
}

type HistoryEntry = CollectionRunEntry | ManualEditEntry;
```

**Fetch logic:**
- Fetch both endpoints in parallel: `/collection/runs/history?limit=50` and `/sellers/audit-log?limit=50`
- Merge and sort by timestamp (completed_at for runs, created_at for edits) descending
- Limit combined result to 30 most recent entries

**Visual design:**
- Header: "History" with History icon (like recent-logs-sidebar)
- Scrollable list of entries
- Each entry has left border accent color:
  - Collection run: `border-l-2 border-blue-500` + Bot icon
  - Manual edit: `border-l-2 border-gray-600` + User/Edit3 icon based on action

**Collection run entry display:**
- Bot icon + run name (truncated)
- Status badge (completed/failed/cancelled with existing statusStyles)
- "+N sellers" in green if sellers_new > 0
- Relative time (formatDistanceToNow)

**Manual edit entry display:**
- Action icon (Plus/Edit3/Minus based on action)
- Seller name or "N sellers" if affected_count > 1
- Relative time

**Footer:**
- "Start Collection" button (same as recent-logs-sidebar, disabled when hasActiveRun)

**Click handlers:**
- Collection run entry: calls onCollectionRunClick(entry.id)
- Manual edit entry: calls onManualEditClick(entry.id)
  </action>
  <verify>
TypeScript compilation: `cd apps/web && npx tsc --noEmit` should pass.
File exists and exports HistoryPanel component.
  </verify>
  <done>history-panel.tsx created with unified timeline showing both collection runs and manual edits with visual distinction</done>
</task>

<task type="auto">
  <name>Task 2: Create hierarchical run modal</name>
  <files>apps/web/src/components/admin/collection/hierarchical-run-modal.tsx</files>
  <action>
Create new modal component that shows collection run details in expandable hierarchy.

**Props interface:**
```typescript
interface HierarchicalRunModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  runId: string | null;
}
```

**Data structure to fetch/build:**
Note: This requires data from collection_items table grouped by category. For now, we'll fetch from `/collection/runs/{runId}` and `/sellers/export?run_id={runId}&format=json` and organize client-side.

```typescript
interface RunDetails {
  id: string;
  name: string;
  status: string;
  started_at: string;
  completed_at: string;
  categories_count: number;
  products_total: number;
  sellers_found: number;
  sellers_new: number;
}
```

**Modal layout:**
- DialogTitle: Run name + status badge
- Summary row: Date | Duration | Categories | Products | Sellers

**Hierarchy display:**
Since detailed per-category breakdown requires backend changes (out of scope for this UI cleanup phase), show a simplified view:
- Summary stats (same as collection-history table row)
- Sellers found in this run (grid of seller names, like log-detail-modal sellers view)
- Export button to download sellers from this run (existing functionality from collection-history)
- "Re-run" button to start new run with same categories

Use the expandedDepts Set pattern from amazon-category-selector for future expansion when backend supports it. For now, the hierarchy is placeholder text noting "Detailed category breakdown coming soon."

**Simpler MVP approach:**
Given backend constraints, make this modal a "Run Details" view:
- Left side: Run metadata (name, status, date, duration, category count, product count)
- Right side: Sellers from this run (fetch from `/sellers/export?run_id={runId}&format=json`, display as scrollable grid)
- Footer: Export dropdown (CSV/JSON) + Re-run button
  </action>
  <verify>
TypeScript compilation passes. Component renders without errors when runId is provided.
  </verify>
  <done>hierarchical-run-modal.tsx created showing run details with sellers grid and export/re-run actions</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` in apps/web passes without errors
- [ ] history-panel.tsx exists and exports HistoryPanel
- [ ] hierarchical-run-modal.tsx exists and exports HierarchicalRunModal
- [ ] HistoryPanel fetches from both audit-log and history endpoints
- [ ] Visual distinction between collection runs (blue) and manual edits (gray)
</verification>

<success_criteria>
New history-panel component shows unified chronological timeline with collection runs and manual edits visually distinguished. Clicking collection run opens hierarchical-run-modal with run details and sellers. Start Collection button present in history panel.
</success_criteria>

<output>
After completion, create `.planning/phases/10-collection-ui-cleanup/10-02-SUMMARY.md`
</output>
