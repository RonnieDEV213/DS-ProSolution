---
phase: 10-collection-ui-cleanup
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/web/src/components/admin/collection/run-config-modal.tsx
autonomous: true

must_haves:
  truths:
    - "Modal has two-panel layout (categories left, controls right)"
    - "Schedule toggle reveals calendar and recurring presets"
    - "Calendar highlights scheduled dates based on recurring pattern"
    - "Both one-time and recurring schedules supported"
    - "Start Collection button triggers immediate run"
  artifacts:
    - path: "apps/web/src/components/admin/collection/run-config-modal.tsx"
      provides: "Two-panel run config with integrated scheduling"
      contains: "Calendar|schedule|recurring"
  key_links:
    - from: "apps/web/src/components/admin/collection/run-config-modal.tsx"
      to: "components/ui/calendar"
      via: "Calendar component import"
      pattern: "from.*calendar"
    - from: "apps/web/src/components/admin/collection/run-config-modal.tsx"
      to: "/collection/schedule"
      via: "fetch to save schedule"
      pattern: "fetch.*schedule"
---

<objective>
Consolidate run config modal into two-panel layout with category selector on left and run controls with scheduling on right. Integrate scheduling functionality from schedule-config.tsx.

Purpose: Per CONTEXT.md, merge schedule-config into run-config-modal for unified collection configuration. Two-panel layout keeps categories prominent while adding scheduling.
Output: Enhanced run-config-modal.tsx with scheduling integrated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-collection-ui-cleanup/10-CONTEXT.md
@.planning/phases/10-collection-ui-cleanup/10-RESEARCH.md
@apps/web/src/components/admin/collection/run-config-modal.tsx
@apps/web/src/components/admin/collection/schedule-config.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure modal to two-panel layout</name>
  <files>apps/web/src/components/admin/collection/run-config-modal.tsx</files>
  <action>
Widen modal and restructure to two-panel layout:

```typescript
<DialogContent className="bg-gray-900 border-gray-800 sm:max-w-[900px] max-h-[90vh] overflow-hidden flex flex-col">
```

Change content area from single column to two-panel grid:

```typescript
<div className="flex-1 overflow-hidden">
  <div className="grid grid-cols-[1fr_320px] gap-4 h-full">
    {/* Left Panel: Category Selector */}
    <div className="overflow-y-auto pr-2">
      <AmazonCategorySelector
        selectedCategoryIds={selectedCategoryIds}
        onSelectionChange={setSelectedCategoryIds}
      />
    </div>

    {/* Right Panel: Run Controls */}
    <div className="border-l border-gray-800 pl-4 space-y-4 overflow-y-auto">
      {/* Presets dropdown */}
      {/* Concurrency placeholder */}
      {/* Schedule section */}
      {/* Start button */}
    </div>
  </div>
</div>
```

**Right panel contents (top to bottom):**

1. **Presets dropdown** (move from within category selector):
```typescript
<div className="space-y-2">
  <Label className="text-gray-300">Quick Presets</Label>
  <CategoryPresetDropdown
    onPresetSelect={(categoryIds) => setSelectedCategoryIds(categoryIds)}
  />
</div>
```

2. **Concurrency slider** (existing, mark as placeholder):
```typescript
<div className="space-y-2">
  <div className="flex justify-between">
    <Label className="text-gray-300">Concurrency</Label>
    <span className="text-sm text-gray-500">{concurrency} workers</span>
  </div>
  <Slider
    value={[concurrency]}
    onValueChange={([v]) => setConcurrency(v)}
    min={1}
    max={10}
    step={1}
    className="w-full"
  />
  <p className="text-xs text-gray-500">(Coming soon)</p>
</div>
```

3. **Schedule toggle** (new):
```typescript
<div className="flex items-center justify-between py-2">
  <div>
    <Label className="text-gray-200">Schedule Run</Label>
    <p className="text-xs text-gray-500">Set up recurring or one-time</p>
  </div>
  <Switch
    checked={scheduleEnabled}
    onCheckedChange={setScheduleEnabled}
  />
</div>
```

4. **Start Collection button:**
```typescript
<Button
  onClick={startRun}
  disabled={loading || selectedCategoryIds.length === 0}
  className="w-full bg-blue-600 hover:bg-blue-700"
>
  {loading ? (
    <>
      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
      Starting...
    </>
  ) : (
    "Start Collection Now"
  )}
</Button>
```

Remove DialogFooter - put button in right panel instead.
  </action>
  <verify>
Modal opens with two-panel layout. Categories on left, controls on right. Start button in right panel works.
  </verify>
  <done>Two-panel layout with category selector left and run controls right</done>
</task>

<task type="auto">
  <name>Task 2: Add schedule section with calendar and recurring presets</name>
  <files>apps/web/src/components/admin/collection/run-config-modal.tsx</files>
  <action>
Import Calendar and date utilities:
```typescript
import { Calendar } from "@/components/ui/calendar";
import { addDays, addWeeks, addMonths, isSameDay, startOfDay } from "date-fns";
```

Add state for scheduling:
```typescript
const [scheduleEnabled, setScheduleEnabled] = useState(false);
const [selectedDate, setSelectedDate] = useState<Date | undefined>(undefined);
const [recurringPreset, setRecurringPreset] = useState<string>("once");
```

**Recurring presets:**
```typescript
const RECURRING_PRESETS = [
  { value: "once", label: "One-time", cron: null },
  { value: "weekly", label: "Weekly", cron: "0 0 * * {day}" },
  { value: "biweekly", label: "Bi-weekly", cron: "0 0 {dom}/14 * *" },
  { value: "monthly", label: "Monthly", cron: "0 0 {dom} * *" },
  { value: "quarterly", label: "Quarterly", cron: "0 0 {dom} */3 *" },
];
```

**Calculate highlighted dates based on preset:**
```typescript
const getHighlightedDates = useMemo(() => {
  if (!selectedDate || recurringPreset === "once") return [];

  const dates: Date[] = [];
  let current = startOfDay(selectedDate);
  const endDate = addMonths(current, 6); // Show 6 months ahead

  while (current <= endDate) {
    dates.push(current);
    switch (recurringPreset) {
      case "weekly":
        current = addWeeks(current, 1);
        break;
      case "biweekly":
        current = addWeeks(current, 2);
        break;
      case "monthly":
        current = addMonths(current, 1);
        break;
      case "quarterly":
        current = addMonths(current, 3);
        break;
      default:
        current = addDays(current, 999); // exit loop
    }
  }
  return dates;
}, [selectedDate, recurringPreset]);
```

**Schedule section UI (shown when scheduleEnabled):**
```typescript
{scheduleEnabled && (
  <div className="space-y-4 border-t border-gray-800 pt-4">
    {/* Recurring preset dropdown */}
    <div className="space-y-2">
      <Label className="text-gray-300">Recurrence</Label>
      <Select value={recurringPreset} onValueChange={setRecurringPreset}>
        <SelectTrigger className="bg-gray-800 border-gray-700 text-white">
          <SelectValue />
        </SelectTrigger>
        <SelectContent className="bg-gray-800 border-gray-700">
          {RECURRING_PRESETS.map((preset) => (
            <SelectItem
              key={preset.value}
              value={preset.value}
              className="text-gray-200"
            >
              {preset.label}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>

    {/* Calendar */}
    <div className="space-y-2">
      <Label className="text-gray-300">
        {recurringPreset === "once" ? "Run Date" : "Starting Date"}
      </Label>
      <Calendar
        mode="single"
        selected={selectedDate}
        onSelect={setSelectedDate}
        disabled={(date) => date < startOfDay(new Date())}
        modifiers={{
          scheduled: getHighlightedDates,
        }}
        modifiersStyles={{
          scheduled: {
            backgroundColor: "rgba(59, 130, 246, 0.2)",
            borderRadius: "100%",
          },
        }}
        className="rounded-md border border-gray-700 bg-gray-800"
      />
    </div>

    {/* Save Schedule button */}
    <Button
      onClick={saveSchedule}
      disabled={savingSchedule || !selectedDate || selectedCategoryIds.length === 0}
      variant="outline"
      className="w-full border-gray-700"
    >
      {savingSchedule ? (
        <>
          <Loader2 className="h-4 w-4 mr-2 animate-spin" />
          Saving...
        </>
      ) : (
        "Save Schedule"
      )}
    </Button>
  </div>
)}
```

**Save schedule handler:**
```typescript
const [savingSchedule, setSavingSchedule] = useState(false);

const saveSchedule = async () => {
  if (!selectedDate || selectedCategoryIds.length === 0) return;

  setSavingSchedule(true);
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    // First, save categories as a preset (or use existing)
    // For simplicity, we'll create a temporary preset or require user to select one
    // This implementation uses the existing schedule endpoint

    const preset = RECURRING_PRESETS.find(p => p.value === recurringPreset);
    const cronExpression = preset?.cron
      ? preset.cron
          .replace("{day}", selectedDate.getDay().toString())
          .replace("{dom}", selectedDate.getDate().toString())
      : `${selectedDate.getMinutes()} ${selectedDate.getHours()} ${selectedDate.getDate()} ${selectedDate.getMonth() + 1} *`;

    await fetch(`${API_BASE}/collection/schedule`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        cron_expression: cronExpression,
        enabled: true,
      }),
    });

    toast.success(recurringPreset === "once" ? "Run scheduled" : "Recurring schedule saved");
    setScheduleEnabled(false);
  } catch (err) {
    toast.error("Failed to save schedule");
  } finally {
    setSavingSchedule(false);
  }
};
```
  </action>
  <verify>
Toggle schedule reveals calendar section. Selecting recurring preset and date highlights future dates on calendar. Save schedule button calls API.
  </verify>
  <done>Schedule section with calendar, recurring presets, and date highlighting integrated into modal</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` in apps/web passes without errors
- [ ] Modal opens with two-panel layout (categories left, controls right)
- [ ] Schedule toggle reveals calendar section
- [ ] Recurring preset selection (Weekly, Monthly, etc.) works
- [ ] Calendar highlights scheduled dates based on recurring pattern
- [ ] Start Collection button triggers immediate run
- [ ] Save Schedule button saves to backend
</verification>

<success_criteria>
Run config modal has two-panel layout with category selector prominent on left. Right panel contains presets dropdown, concurrency placeholder, schedule toggle with calendar and recurring options. Both immediate runs and scheduled runs configurable from single modal.
</success_criteria>

<output>
After completion, create `.planning/phases/10-collection-ui-cleanup/10-04-SUMMARY.md`
</output>
