---
phase: 27-sidebar-folder-reorganization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/components/admin/pairing-request-modal.tsx
  - apps/web/src/app/admin/accounts/page.tsx
  - apps/web/src/components/admin/accounts-table.tsx
autonomous: true

must_haves:
  truths:
    - "Pairing Request modal opens from toolbar button on Accounts page (admin only)"
    - "Pairing Request modal displays the full PairingRequestsTable content"
    - "Agents appear as expandable rows within each account in the Accounts table"
    - "Clicking an account row expands/collapses to show its linked agents"
    - "Admin users see the Pairing Request toolbar button; non-admins do not"
  artifacts:
    - path: "apps/web/src/components/admin/pairing-request-modal.tsx"
      provides: "Dialog wrapper around PairingRequestsTable"
      exports: ["PairingRequestModal"]
    - path: "apps/web/src/app/admin/accounts/page.tsx"
      provides: "Accounts page with Pairing Request toolbar button"
      contains: "PairingRequestModal"
    - path: "apps/web/src/components/admin/accounts-table.tsx"
      provides: "Accounts table with expandable agent rows per account"
      contains: "expandedAccountIds"
  key_links:
    - from: "apps/web/src/app/admin/accounts/page.tsx"
      to: "apps/web/src/components/admin/pairing-request-modal.tsx"
      via: "state-controlled Dialog open prop"
      pattern: "pairingOpen"
    - from: "apps/web/src/components/admin/accounts-table.tsx"
      to: "agents"
      via: "expandable rows with agent data per account"
      pattern: "expandedAccountIds"
---

<objective>
Add Pairing Request modal to the Accounts page and integrate agent expandable rows within the Accounts table.

Purpose: Move Pairing Request from the Automation/Extension Hub page to a modal on the Accounts page (admin only). Show agents as expandable child rows under each account instead of a separate agents table.
Output: PairingRequestModal component, updated Accounts page with toolbar button, AccountsTable with expandable agent rows.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/src/app/admin/accounts/page.tsx
@apps/web/src/components/admin/accounts-table.tsx
@apps/web/src/components/admin/automation/pairing-requests-table.tsx
@apps/web/src/components/admin/automation/agents-table.tsx
@apps/web/src/hooks/use-user-role.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PairingRequestModal and add to Accounts page</name>
  <files>
    apps/web/src/components/admin/pairing-request-modal.tsx
    apps/web/src/app/admin/accounts/page.tsx
  </files>
  <action>
**PairingRequestModal** — Create a Dialog wrapper around PairingRequestsTable:

```typescript
"use client";

import { useState } from "react";
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription,
} from "@/components/ui/dialog";
import { PairingRequestsTable } from "@/components/admin/automation/pairing-requests-table";

interface PairingRequestModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onActionComplete?: () => void;
}

export function PairingRequestModal({ open, onOpenChange, onActionComplete }: PairingRequestModalProps) {
  const [refreshTrigger, setRefreshTrigger] = useState(0);

  const handleActionComplete = () => {
    setRefreshTrigger((prev) => prev + 1);
    onActionComplete?.();
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Pairing Requests</DialogTitle>
          <DialogDescription>
            Review and manage Chrome Extension pairing requests
          </DialogDescription>
        </DialogHeader>
        <PairingRequestsTable
          refreshTrigger={refreshTrigger}
          onActionComplete={handleActionComplete}
        />
      </DialogContent>
    </Dialog>
  );
}
```

**Accounts page** — Add a Pairing Request toolbar button (admin only):

Update `apps/web/src/app/admin/accounts/page.tsx`:
- Import `useUserRole` hook to check if user is admin
- Import `PairingRequestModal` component
- Import `Link2` (or similar pairing icon) from lucide-react and `Button` from ui
- Add `pairingOpen` state
- Use PageHeader `actions` prop to render "Pairing Requests" button (only if isAdmin)
- Render PairingRequestModal at bottom of JSX
- Pass `onActionComplete` to refresh accounts after pairing actions

The Accounts page toolbar button:
```tsx
actions={
  isAdmin ? (
    <Button variant="outline" onClick={() => setPairingOpen(true)}>
      <Link2 className="mr-2 h-4 w-4" />
      Pairing Requests
    </Button>
  ) : undefined
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Visit /admin/accounts as admin — "Pairing Requests" button appears in toolbar
3. Click it — modal opens showing PairingRequestsTable
4. Modal closes cleanly
  </verify>
  <done>
- PairingRequestModal component created wrapping PairingRequestsTable
- Accounts page shows "Pairing Requests" toolbar button for admin users
- Non-admin users do not see the button
  </done>
</task>

<task type="auto">
  <name>Task 2: Add expandable agent rows to AccountsTable</name>
  <files>apps/web/src/components/admin/accounts-table.tsx</files>
  <action>
Add expandable rows to the AccountsTable that show agents linked to each account.

Read the existing accounts-table.tsx fully first to understand the current structure, then add:

1. **State for expanded accounts:**
   ```typescript
   const [expandedAccountIds, setExpandedAccountIds] = useState<Set<string>>(new Set())
   ```

2. **Toggle function:**
   ```typescript
   const toggleAccount = (accountId: string) => {
     setExpandedAccountIds(prev => {
       const next = new Set(prev)
       if (next.has(accountId)) next.delete(accountId)
       else next.add(accountId)
       return next
     })
   }
   ```

3. **Fetch agents** — Add agent fetching alongside existing account fetching. Use the existing API pattern from the codebase. Fetch all agents once and group by account_id client-side. The agents endpoint is already available at `/automation/agents` (check agents-table.tsx for the exact API call pattern). Store agents in state:
   ```typescript
   const [agents, setAgents] = useState<Agent[]>([])
   ```
   Fetch agents in the same useEffect where accounts are fetched (only for admins, since clients/VAs see limited data).

4. **Expand/collapse icon** — Add an expand column as the first TableHead. Use `ChevronDown` (expanded) and `ChevronRight` (collapsed) icons from lucide-react. Only show the chevron if the account has agents.

5. **Expanded rows** — After each account's TableRow, conditionally render agent child rows when expanded. Use `Fragment` to group the account row + agent rows. Agent rows should:
   - Have `bg-muted/30` background for visual nesting
   - Show agent_id/label, status, last_seen_at
   - Have `pl-8` padding on the first cell for indentation
   - Show a `User` icon next to agent name
   - Be read-only for non-admin users (no action buttons)

6. **Row click handling** — Make account rows clickable (cursor-pointer on hover) to toggle expansion. But keep existing edit button functionality — don't let the row click interfere with the edit button click (use event.stopPropagation on the edit button if needed).

Import `Fragment` from "react", `ChevronDown`, `ChevronRight`, `User` from "lucide-react".

**Agent type** (inline or import from existing):
```typescript
interface Agent {
  id: string;
  agent_id: string;
  account_id: string;
  label: string | null;
  status: string;
  last_seen_at: string | null;
}
```

Reference `apps/web/src/components/admin/automation/agents-table.tsx` for the agent fetch pattern and data structure.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Visit /admin/accounts — accounts table renders with expand chevrons
3. Click an account row — agent rows expand underneath
4. Click again — rows collapse
5. Accounts with no agents show no chevron
6. Edit button still works (doesn't toggle expand)
  </verify>
  <done>
- AccountsTable has expandable rows showing agents per account
- Chevron icons indicate expand/collapse state
- Agent rows show agent details with visual nesting
- Toggle works correctly; edit button still functional
- Agents fetched from API and grouped by account_id
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. PairingRequestModal opens from Accounts page toolbar
3. Agent expandable rows work in AccountsTable
4. Existing account CRUD functionality preserved
5. Non-admin users don't see Pairing Requests button
6. Non-admin users see agent rows as read-only
</verification>

<success_criteria>
- PairingRequestModal wraps PairingRequestsTable in Dialog
- Accounts page has admin-only Pairing Requests toolbar button
- AccountsTable shows expandable agent rows per account
- All existing account management features still work
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/27-sidebar-folder-reorganization/27-03-SUMMARY.md`
</output>
