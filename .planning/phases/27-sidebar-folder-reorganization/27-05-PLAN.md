---
phase: 27-sidebar-folder-reorganization
plan: 05
type: execute
wave: 2
depends_on: ["27-01", "27-04"]
files_modified:
  - apps/web/src/components/layout/app-sidebar.tsx
  - apps/web/src/app/admin/layout.tsx
  - apps/web/src/app/va/layout.tsx
  - apps/web/src/app/client/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar shows Dashboard as a top-level nav item above all sections"
    - "Sidebar renders 3 collapsible sections: Admin, Monitoring, Automation Hub"
    - "Each section can be expanded/collapsed independently (not accordion)"
    - "Section open/closed state persists across page loads via cookies"
    - "Admin sees all 3 sections, Client sees only Dashboard (no sections), VA sees Monitoring + Automation Hub"
    - "Empty sections (no items for role) are hidden entirely"
    - "Theme picker removed from sidebar footer"
    - "Sync status removed from sidebar footer"
    - "Sidebar footer contains only Profile Settings button + Collapse toggle"
    - "Active nav item highlighting works correctly within sections"
  artifacts:
    - path: "apps/web/src/components/layout/app-sidebar.tsx"
      provides: "Sidebar with collapsible sections, cookie persistence, role-based visibility"
      contains: "CollapsibleSection"
    - path: "apps/web/src/app/admin/layout.tsx"
      provides: "Admin layout passing role and sections to AppSidebar"
      contains: "adminSidebarSections"
    - path: "apps/web/src/app/va/layout.tsx"
      provides: "VA layout passing role and sections to AppSidebar"
      contains: "vaSidebarSections"
    - path: "apps/web/src/app/client/layout.tsx"
      provides: "Client layout passing role to AppSidebar"
      contains: "clientSidebarSections"
  key_links:
    - from: "apps/web/src/components/layout/app-sidebar.tsx"
      to: "apps/web/src/lib/navigation.ts"
      via: "import SidebarSection configs"
      pattern: "SidebarSection"
    - from: "apps/web/src/components/layout/app-sidebar.tsx"
      to: "@radix-ui/react-collapsible"
      via: "Radix Collapsible for independent section toggling"
      pattern: "Collapsible"
    - from: "apps/web/src/components/layout/app-sidebar.tsx"
      to: "document.cookie"
      via: "Cookie persistence for section state"
      pattern: "sidebar:section"
---

<objective>
Refactor AppSidebar to use collapsible sections with cookie persistence and role-based visibility. Clean up the sidebar footer. Update all role layouts to pass the new props.

Purpose: This is the core sidebar restructuring. Transforms the flat nav list into grouped, collapsible, role-aware sections. Removes theme picker and sync status from footer (sync status already moved to Profile Settings in Plan 04).
Output: Fully restructured AppSidebar with collapsible sections, cleaned-up footer, and updated layouts.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/27-sidebar-folder-reorganization/27-01-SUMMARY.md
@apps/web/src/components/layout/app-sidebar.tsx
@apps/web/src/components/ui/sidebar.tsx
@apps/web/src/app/admin/layout.tsx
@apps/web/src/app/va/layout.tsx
@apps/web/src/app/client/layout.tsx
@apps/web/src/lib/navigation.ts
@apps/web/src/types/navigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor AppSidebar with collapsible sections and footer cleanup</name>
  <files>apps/web/src/components/layout/app-sidebar.tsx</files>
  <action>
Complete rewrite of AppSidebar to support collapsible sections. This is the main structural change.

**New props interface:**
```typescript
interface AppSidebarProps {
  sections: SidebarSection[]   // Grouped sections (replaces navItems)
  basePath: string             // "/admin", "/va", "/client"
  roleLabel: string            // "Admin", "VA", "Client"
  role: "admin" | "va" | "client"  // For section filtering
}
```

**Cookie persistence hook for section state:**
```typescript
const SIDEBAR_SECTION_COOKIE_MAX_AGE = 60 * 60 * 24 * 7 // 7 days

function useSectionState(sectionId: string, defaultOpen = true) {
  const [open, setOpen] = useState(() => {
    if (typeof document !== "undefined") {
      const match = document.cookie.match(
        new RegExp(`(?:^|; )sidebar:section:${sectionId}=([^;]*)`)
      )
      return match ? match[1] === "true" : defaultOpen
    }
    return defaultOpen
  })

  const handleOpenChange = (nextOpen: boolean) => {
    setOpen(nextOpen)
    document.cookie = `sidebar:section:${sectionId}=${nextOpen}; path=/; max-age=${SIDEBAR_SECTION_COOKIE_MAX_AGE}`
  }

  return [open, handleOpenChange] as const
}
```

**CollapsibleSection component** (render each section with Collapsible):
```typescript
import * as Collapsible from "@radix-ui/react-collapsible"
import { ChevronDown } from "lucide-react"

function CollapsibleSection({
  section,
  pathname,
  isItemActive,
}: {
  section: SidebarSection
  pathname: string
  isItemActive: (item: NavItem) => boolean
}) {
  const [open, setOpen] = useSectionState(section.id)
  const SectionIcon = LucideIcons[section.icon as keyof typeof LucideIcons] as React.ElementType

  return (
    <Collapsible.Root open={open} onOpenChange={setOpen}>
      <SidebarGroup className="py-0">
        <Collapsible.Trigger asChild>
          <SidebarGroupLabel className="cursor-pointer hover:bg-sidebar-accent/50 rounded-md transition-colors">
            {SectionIcon && <SectionIcon className="mr-2" />}
            <span>{section.label}</span>
            <ChevronDown className={cn(
              "ml-auto h-4 w-4 transition-transform duration-200",
              open && "rotate-180"
            )} />
          </SidebarGroupLabel>
        </Collapsible.Trigger>
        <Collapsible.Content>
          <SidebarGroupContent>
            <SidebarMenu>
              {section.items.map((item) => {
                const Icon = LucideIcons[item.icon as keyof typeof LucideIcons] as React.ElementType
                const isActive = isItemActive(item)

                return (
                  <SidebarMenuItem key={item.href}>
                    <SidebarMenuButton asChild isActive={isActive} tooltip={item.label}>
                      <Link href={item.href}>
                        {Icon && <Icon />}
                        <span>{item.label}</span>
                      </Link>
                    </SidebarMenuButton>
                  </SidebarMenuItem>
                )
              })}
            </SidebarMenu>
          </SidebarGroupContent>
        </Collapsible.Content>
      </SidebarGroup>
    </Collapsible.Root>
  )
}
```

**Main AppSidebar component:**
- Import `getVisibleSections`, `dashboardNavItem` from `@/lib/navigation`
- Filter sections by role using `getVisibleSections(sections, role)`
- Render Dashboard as top-level SidebarMenuItem above all sections (using `dashboardNavItem(basePath)`)
- Render each visible section using CollapsibleSection
- Import `SidebarGroup`, `SidebarGroupLabel`, `SidebarGroupContent` from `@/components/ui/sidebar`

**Active state detection** — update `isItemActive`:
- For the dashboard item: exact match only (`pathname === basePath`)
- For section items: exact match OR startsWith with trailing slash
- No longer needs the `indent` logic or flat navItems array

**Footer cleanup — REMOVE:**
- Theme picker Popover (the entire `<SidebarMenuItem>` containing `<Popover>` with ThemePickerCompact)
- SyncStatusIndicator component and `showSyncStatus` prop
- All imports: `Popover`, `PopoverContent`, `PopoverTrigger`, `ThemePickerCompact`, `SyncStatusIndicator`, `Palette`

**Footer — KEEP:**
- Profile Settings button (SidebarMenuButton with Settings icon)
- Collapse toggle button (SidebarMenuButton with ChevronsLeft/ChevronsRight)
- ProfileSettingsDialog rendered as sibling (Fragment pattern from Phase 24)

**Important considerations:**
- Keep "use client" directive
- Keep the Fragment (`<>...</>`) wrapper pattern that renders ProfileSettingsDialog as sibling to Sidebar
- When sidebar is collapsed to icon-only mode, section labels should hide (this is handled by existing SidebarGroupLabel CSS: `group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0`)
- When collapsed, section items should still show as icon-only tooltips (existing SidebarMenuButton tooltip behavior handles this)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Import `@radix-ui/react-collapsible` resolves (already installed in package.json)
3. No unused imports or variables
  </verify>
  <done>
- AppSidebar renders Dashboard above collapsible sections
- Each section can be expanded/collapsed independently
- Section state persists via cookies (sidebar:section:{id})
- Role-based filtering hides sections the user shouldn't see
- Theme picker removed from footer
- Sync status removed from footer
- Footer has only Profile Settings + Collapse toggle
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Admin layout to pass sections and role to AppSidebar</name>
  <files>apps/web/src/app/admin/layout.tsx</files>
  <action>
Update admin layout to use the new AppSidebar props.

Change imports:
- Replace `import { adminNavItems } from "@/lib/navigation"` with `import { adminSidebarSections } from "@/lib/navigation"`

Update AppSidebar usage:
```tsx
<AppSidebar
  sections={adminSidebarSections}
  basePath="/admin"
  roleLabel="Admin"
  role="admin"
/>
```

Remove the `showSyncStatus={true}` prop (no longer exists on AppSidebar).
  </action>
  <verify>`npx tsc --noEmit` passes, admin layout renders correctly</verify>
  <done>Admin layout passes sections and role to AppSidebar instead of flat navItems</done>
</task>

<task type="auto">
  <name>Task 3: Update VA and Client layouts to pass sections and role</name>
  <files>
    apps/web/src/app/va/layout.tsx
    apps/web/src/app/client/layout.tsx
  </files>
  <action>
**VA layout:**
- Import `vaSidebarSections` from `@/lib/navigation` (replacing `vaNavItems`)
- Update the RBAC filtering: Instead of filtering `vaNavItems`, filter the sections:
  ```typescript
  const sectionsToShow = role === "va" && !hasAccessProfile
    ? []  // No sections if VA has no access profile (only Dashboard visible)
    : vaSidebarSections
  ```
- Update AppSidebar:
  ```tsx
  <AppSidebar
    sections={sectionsToShow}
    basePath="/va"
    roleLabel="VA"
    role="va"
  />
  ```

**Client layout:**
- Import `clientSidebarSections` from `@/lib/navigation` (replacing `clientNavItems`)
- Update AppSidebar:
  ```tsx
  <AppSidebar
    sections={clientSidebarSections}
    basePath="/client"
    roleLabel="Client"
    role="client"
  />
  ```

Both layouts keep all existing functionality (SidebarProvider, ShortcutsReference, CommandPalette, BreadcrumbNav, etc.).
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. VA layout with access profile shows Monitoring section
3. VA layout without access profile shows only Dashboard
4. Client layout shows only Dashboard (no sections)
  </verify>
  <done>
- VA layout passes vaSidebarSections with RBAC filtering
- Client layout passes clientSidebarSections
- Both layouts use new AppSidebar props
- All existing layout functionality preserved
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Admin sidebar shows Dashboard + 3 collapsible sections (Admin, Monitoring, Automation Hub)
3. Sections can be expanded/collapsed independently
4. Section state persists across page navigation (cookie check)
5. VA sidebar shows Dashboard + Monitoring (and possibly Automation Hub)
6. Client sidebar shows only Dashboard
7. Theme picker gone from footer
8. Sync status gone from footer
9. Active item highlighting works within sections
10. Collapsed sidebar shows icon-only nav correctly
</verification>

<success_criteria>
- AppSidebar renders collapsible sections with cookie persistence
- All 3 role layouts updated and working
- Footer cleaned up (only Profile Settings + Collapse)
- Role-based section visibility working
- Active state detection working within sections
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/27-sidebar-folder-reorganization/27-05-SUMMARY.md`
</output>
