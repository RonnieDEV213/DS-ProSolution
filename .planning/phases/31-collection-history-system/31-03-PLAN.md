---
phase: 31-collection-history-system
plan: 03
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - apps/web/src/hooks/mutations/use-flag-seller.ts
  - apps/web/src/components/admin/collection/sellers-grid.tsx
  - apps/web/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "Flagging/unflagging sellers creates a history entry in the audit log"
    - "Right-click drag flag painting records a single batch audit entry (not N individual entries)"
    - "Individual flag toggles record individual audit entries"
    - "Flag mutation hook calls the flag-batch endpoint for batch operations"
  artifacts:
    - path: "apps/web/src/hooks/mutations/use-flag-seller.ts"
      provides: "Flag mutation with audit logging support"
      contains: "log.*flag|flag.*batch"
    - path: "apps/web/src/lib/api.ts"
      provides: "sellerApi.logFlagEvent and sellerApi.flagBatch methods"
      contains: "log-export|flag-batch"
  key_links:
    - from: "apps/web/src/hooks/mutations/use-flag-seller.ts"
      to: "/api/sellers/flag-batch"
      via: "sellerApi.flagBatch() or direct fetch"
      pattern: "flag-batch|flagBatch"
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "apps/web/src/hooks/mutations/use-flag-seller.ts"
      via: "useFlagSeller hook"
      pattern: "useFlagSeller"
---

<objective>
Add audit log recording for all flag/unflag operations, including both individual toggles and batch operations (right-click drag painting). Create a batch flag API call for bulk flag operations.

Purpose: HIST-02 requires flag events recorded in the collection history system. Currently, `toggle_seller_flag()` in the backend does NOT call `_log_seller_change()` -- this is the primary gap.
Output: Updated flag mutation hook with audit logging, new API helper methods, updated sellers-grid for batch flag recording.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-collection-history-system/31-CONTEXT.md
@.planning/phases/31-collection-history-system/31-RESEARCH.md
@.planning/phases/31-collection-history-system/31-01-SUMMARY.md
@apps/web/src/hooks/mutations/use-flag-seller.ts
@apps/web/src/components/admin/collection/sellers-grid.tsx
@apps/web/src/lib/api.ts
@apps/api/src/app/services/collection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API helpers and update flag mutation hook</name>
  <files>
    apps/web/src/lib/api.ts
    apps/web/src/hooks/mutations/use-flag-seller.ts
  </files>
  <action>
    **api.ts additions:**
    Add to the `sellerApi` object (or create equivalent functions near existing seller API helpers):

    1. `flagBatch(sellerIds: string[], flagged: boolean)` - calls `POST /sellers/flag-batch` with `{ seller_ids: sellerIds, flagged }`. Returns `{ updated_count: number }`.
    2. `logExportEvent(sellerNames: string[], exportFormat: string)` - calls `POST /sellers/log-export` with `{ seller_names: sellerNames, export_format: exportFormat }`. Returns void.

    Both methods use `getAccessToken()` for auth and follow the existing fetch pattern in api.ts.

    **use-flag-seller.ts updates:**
    The current hook does individual flag toggles via `sellerApi.flagSeller(id)`. The backend `toggle_seller_flag()` does NOT log to the audit log. There are two approaches:

    **Approach A (Preferred):** Update the individual flag mutation to also log the flag event. After the API call succeeds in `mutationFn`:
    - After `sellerApi.flagSeller(id)` succeeds, fire-and-forget a call to record the flag event.
    - But wait -- the backend should handle this. Since Plan 01 adds `log_flag_event()` to the service, we should update `toggle_seller_flag()` in collection.py to call `_log_seller_change()` internally. However, Plan 01 already handles the backend; this plan handles the frontend.

    **Approach B (Simpler frontend, preferred):** Since Plan 01 added `batch_toggle_flag()` which already includes audit logging, update the individual flag mutation to use the batch endpoint with a single-item array:
    - Change `mutationFn` to call `sellerApi.flagBatch([id], flagged)` instead of `sellerApi.flagSeller(id)` when online
    - This way, every flag operation goes through the batch endpoint which logs to audit
    - The optimistic IndexedDB update remains the same (update before API call)
    - Offline queue remains the same

    **Go with Approach B.** Update `use-flag-seller.ts`:
    1. Import `sellerApi` (already imported)
    2. In `mutationFn`, replace `await sellerApi.flagSeller(id)` with `await sellerApi.flagBatch([id], flagged)`
    3. Optimistic update and rollback remain unchanged
    4. The batch endpoint handles audit logging server-side

    Also, add a `useBatchFlagSellers()` hook (or export from same file) for bulk operations:
    ```typescript
    export function useBatchFlagSellers() {
      return useMutation<{ updated_count: number }, Error, { ids: string[]; flagged: boolean }>({
        mutationFn: async ({ ids, flagged }) => {
          // Optimistic: update all in IndexedDB
          await Promise.all(ids.map(id => db.sellers.update(id, { flagged })));
          // Call batch API (includes audit logging)
          return sellerApi.flagBatch(ids, flagged);
        },
        onError: async (_error, { ids, flagged }) => {
          // Rollback all
          await Promise.all(ids.map(id => db.sellers.update(id, { flagged: !flagged })));
        },
      });
    }
    ```
  </action>
  <verify>
    - grep confirms `flagBatch` function exists in api.ts
    - grep confirms `logExportEvent` function exists in api.ts
    - grep confirms `useBatchFlagSellers` export in use-flag-seller.ts
    - grep confirms individual flag mutation uses flagBatch endpoint (not flagSeller for the toggle)
  </verify>
  <done>
    api.ts has flagBatch() and logExportEvent() helpers. Individual flag toggle now routes through batch endpoint (which includes audit logging). New useBatchFlagSellers hook available for bulk operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire batch flag recording in sellers-grid drag painting</name>
  <files>
    apps/web/src/components/admin/collection/sellers-grid.tsx
  </files>
  <action>
    The sellers-grid has right-click drag flag painting (around lines 715-762) that currently calls `flagMutation.mutate()` individually for each seller in the selection rectangle.

    **Update the drag painting handler to use batch flagging:**

    1. Import `useBatchFlagSellers` from `@/hooks/mutations/use-flag-seller`
    2. Add `const batchFlagMutation = useBatchFlagSellers();` in the component
    3. In the drag painting end handler (around line 742-762), instead of:
       ```
       for (const id of idsToChange) {
         flagMutation.mutate({ id, flagged: mode });
       }
       ```
       Replace with:
       ```
       if (idsToChange.length > 0) {
         batchFlagMutation.mutate({ ids: idsToChange, flagged: mode });
       }
       ```
       This creates ONE audit log entry for the entire drag operation instead of N individual entries.

    4. Keep the individual `flagMutation` for single-click flag toggles (line 742 area where individual seller click toggles flag). Those should continue using the individual mutation (which now goes through flagBatch([id], flagged) anyway from Task 1).

    **Also update the `flagExportedSellers` function** (if it still exists in sellers-grid after Plan 02 runs -- it should have been moved to the export modal). If it's been moved, skip this. If it's still in sellers-grid, update it to use `batchFlagMutation.mutate()` instead of individual mutations.

    **IMPORTANT:** This plan depends on Plan 01 (backend) but is independent of Plan 02 (export modal). If Plan 02 has already run and removed export state from sellers-grid, that's fine -- just skip the flagExportedSellers update. If Plan 02 hasn't run yet, the flagExportedSellers function will still be in sellers-grid; update it to use batch.
  </action>
  <verify>
    - grep confirms `useBatchFlagSellers` import in sellers-grid.tsx
    - grep confirms `batchFlagMutation.mutate` call in the drag painting handler
    - Drag painting section no longer has a for loop calling individual flagMutation.mutate for each seller
    - Individual click-to-flag still works (uses flagMutation from useFlagSeller)
  </verify>
  <done>
    Right-click drag flag painting uses batch flag mutation (one API call + one audit entry). Individual flag toggles route through batch endpoint (single-item array). All flag operations now create audit log entries.
  </done>
</task>

</tasks>

<verification>
1. sellerApi.flagBatch() and sellerApi.logExportEvent() exist in api.ts
2. Individual flag toggle uses flagBatch([id], flagged) -- audit logged server-side
3. Drag painting uses batchFlagMutation.mutate({ ids, flagged }) -- single audit entry
4. useBatchFlagSellers hook exists for bulk flag operations
5. No flag operation bypasses audit logging
</verification>

<success_criteria>
- Every flag toggle (individual click) creates an audit log entry on the server
- Drag-painting 10 sellers creates exactly 1 audit log entry (not 10)
- The batch flag endpoint updates all sellers and logs the event atomically
- Offline flag operations still queue correctly and will be logged when replayed
</success_criteria>

<output>
After completion, create `.planning/phases/31-collection-history-system/31-03-SUMMARY.md`
</output>
