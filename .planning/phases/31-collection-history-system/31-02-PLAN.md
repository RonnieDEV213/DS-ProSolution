---
phase: 31-collection-history-system
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - apps/web/src/components/admin/collection/seller-export-modal.tsx
  - apps/web/src/components/admin/collection/sellers-grid.tsx
autonomous: true

must_haves:
  truths:
    - "Seller export uses a modal dialog instead of a popover dropdown"
    - "Export modal matches the order tracking ExportDialog layout pattern"
    - "Completing an export records the event to the server via POST /sellers/log-export"
    - "Export modal has format selection (CSV/JSON/Clipboard), flag on export toggle, first N / range inputs, and preview count"
    - "Export state is encapsulated in the modal component (not in sellers-grid)"
  artifacts:
    - path: "apps/web/src/components/admin/collection/seller-export-modal.tsx"
      provides: "Seller export modal component"
      min_lines: 120
    - path: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      provides: "Updated grid with modal trigger instead of popover"
      contains: "SellerExportModal"
  key_links:
    - from: "apps/web/src/components/admin/collection/seller-export-modal.tsx"
      to: "/api/sellers/log-export"
      via: "fetch POST after successful export"
      pattern: "sellers/log-export"
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "apps/web/src/components/admin/collection/seller-export-modal.tsx"
      via: "import and render SellerExportModal"
      pattern: "SellerExportModal"
---

<objective>
Convert the seller export popover in the sellers grid into a modal dialog matching the order tracking ExportDialog pattern, and record export events to the backend audit log after every successful export.

Purpose: HIST-01 requires export events in the history system. The export modal conversion (CONTEXT.md decision) provides a better UX and a clean point to trigger audit logging.
Output: New SellerExportModal component, updated sellers-grid.tsx with modal instead of popover.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-collection-history-system/31-CONTEXT.md
@.planning/phases/31-collection-history-system/31-RESEARCH.md
@.planning/phases/31-collection-history-system/31-01-SUMMARY.md
@apps/web/src/components/admin/collection/sellers-grid.tsx
@apps/web/src/components/data-management/export-dialog.tsx
@apps/web/src/hooks/mutations/use-flag-seller.ts
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SellerExportModal component</name>
  <files>
    apps/web/src/components/admin/collection/seller-export-modal.tsx
  </files>
  <action>
    Create a new `SellerExportModal` component that matches the layout and structure of the existing `ExportDialog` (apps/web/src/components/data-management/export-dialog.tsx) but adapted for seller collection exports.

    **Props interface:**
    ```typescript
    interface SellerExportModalProps {
      open: boolean;
      onOpenChange: (open: boolean) => void;
      sellers: Array<{ id: string; display_name: string; flagged: boolean }>;
      totalCount: number;
      onExportComplete?: () => void;
    }
    ```

    **Layout (matching ExportDialog pattern):**
    1. DialogHeader: Download icon + "Export Sellers" title + "Export N sellers to a file." description
    2. Format selection: Three buttons (CSV, JSON, Copy to Clipboard) using same pattern as ExportDialog's FORMAT_OPTIONS
    3. Flag on export toggle: Checkbox "Flag exported sellers" (defaults to checked)
    4. First N input: Number input "Export first N sellers" (clears range if set)
    5. Range inputs: From/To number inputs (clears first N if set) -- same as current popover
    6. Preview count: Mono font showing how many sellers will be exported based on options
    7. DialogFooter: Cancel + Export button

    **State management:**
    - All export state (format, flagOnExport, firstN, rangeStart, rangeEnd) lives inside this component
    - Format state: `'csv' | 'json' | 'clipboard'` (default 'csv')
    - Compute filtered sellers based on firstN / range options (same logic as current sellers-grid getFilteredSellersForExport)

    **Export execution:**
    - Reuse the same export logic currently in sellers-grid (CSV download, JSON download, clipboard copy)
    - For CSV: Generate CSV string from filtered sellers, create blob, download
    - For JSON: Generate JSON string, create blob, download
    - For Clipboard: Copy display names as newline-separated text

    **After successful export:**
    1. If flagOnExport is checked, call the flag mutation for each exported seller (same as current flagExportedSellers logic in sellers-grid)
    2. Call POST `/sellers/log-export` with `{ seller_names: [list of display_names], export_format: format }` to record the export event
    3. Call `onExportComplete?.()` callback
    4. Close the modal

    **Server-side export routing:** If totalCount > 10000 (LARGE_DATASET_THRESHOLD), route CSV and JSON exports through the server-side streaming endpoint (`/export/sellers/{format}`), same as current sellers-grid logic.

    **Important:** Use `getAccessToken()` from `@/lib/api` for the log-export fetch call. Follow the same auth pattern used in the rest of the codebase.
  </action>
  <verify>
    - File exists at apps/web/src/components/admin/collection/seller-export-modal.tsx
    - grep confirms Dialog/DialogContent/DialogHeader/DialogFooter imports (modal pattern)
    - grep confirms `sellers/log-export` fetch call
    - grep confirms format selection state management
    - No Popover imports (this is a Dialog, not a Popover)
  </verify>
  <done>
    SellerExportModal component created with format selection, flag on export toggle, first N / range inputs, preview count, and export execution that records events via POST /sellers/log-export. Layout matches ExportDialog pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace export popover with modal in sellers-grid</name>
  <files>
    apps/web/src/components/admin/collection/sellers-grid.tsx
  </files>
  <action>
    **Remove export popover and related state from sellers-grid.tsx:**

    1. Remove these state variables (around lines 297-302):
       - `exportOpen` (repurpose as modal open state)
       - `exportFlagOnExport`
       - `exportFirstN`
       - `exportRangeStart`
       - `exportRangeEnd`

    2. Remove these functions (they move into the modal):
       - `getFilteredSellersForExport` (around line 932)
       - `flagExportedSellers` (around line 950)
       - `exportPreviewCount` (around line 969)
       - `serverSideExport` (around line 984)
       - `downloadCSV` (around line 1007-1034)
       - `downloadJSON` (around line 1036-1064)
       - `copyRawText` (around line 1066-1075)

    3. Remove Popover-related imports: `Popover, PopoverContent, PopoverTrigger` (lines 11-14) -- only remove if no other usage of Popover in the file

    4. Keep `exportOpen` state but rename to `exportModalOpen` for clarity. Keep it as `useState(false)`.

    5. Replace the Popover block (lines 1218-1326) with:
       - A simple "Export" Button that sets `exportModalOpen(true)` on click
       - Render `<SellerExportModal>` at the bottom of the component, passing:
         - `open={exportModalOpen}`
         - `onOpenChange={setExportModalOpen}`
         - `sellers={filteredSellers}` (the search-filtered sellers array)
         - `totalCount={totalCount}`
         - `onExportComplete={() => onSellerChange?.()}`

    6. Add import: `import { SellerExportModal } from "./seller-export-modal";`

    7. Remove unused imports that were only needed for the popover export UI (Checkbox, Label, Input for export -- but check if they are used elsewhere in sellers-grid before removing).

    **Be careful to preserve all other sellers-grid functionality.** The grid has 1442 lines. Only modify the export-related sections. Do NOT touch flag mutation logic (the individual flag toggle on right-click remains), selection, search, bulk delete, or any other grid behavior.
  </action>
  <verify>
    - grep confirms no `PopoverContent` in sellers-grid.tsx (unless used for non-export purposes -- check first)
    - grep confirms `SellerExportModal` import and render
    - grep confirms `exportModalOpen` state variable
    - grep confirms `exportFlagOnExport`, `exportFirstN`, `exportRangeStart`, `exportRangeEnd` are GONE from sellers-grid
    - `npm run build` in apps/web succeeds (or at minimum, TypeScript compilation of the file produces no errors)
  </verify>
  <done>
    Sellers-grid uses SellerExportModal instead of export popover. All export state and logic is encapsulated in the modal. Grid retains all other functionality (flag toggle, selection, search, bulk delete).
  </done>
</task>

</tasks>

<verification>
1. Export button in sellers-grid opens a modal (Dialog), not a popover
2. Modal layout matches ExportDialog pattern (format buttons, options, footer)
3. After export completes, POST /sellers/log-export is called with seller names and format
4. Flag on export functionality preserved (exported sellers get flagged if checkbox checked)
5. Server-side export routing for large datasets preserved (>10k sellers)
6. No export state variables remain in sellers-grid.tsx (all moved to modal)
7. sellers-grid.tsx still compiles and all non-export functionality is preserved
</verification>

<success_criteria>
- Clicking "Export" in the sellers grid opens a modal dialog (not a popover)
- The modal provides CSV, JSON, and Clipboard export options
- Flag on export, First N, and Range options work correctly
- Every successful export creates an audit log entry via POST /sellers/log-export
- Export state is fully encapsulated in SellerExportModal (sellers-grid is cleaner)
</success_criteria>

<output>
After completion, create `.planning/phases/31-collection-history-system/31-02-SUMMARY.md`
</output>
