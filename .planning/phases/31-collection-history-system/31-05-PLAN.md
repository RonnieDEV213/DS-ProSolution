---
phase: 31-collection-history-system
plan: 05
type: execute
wave: 3
depends_on: ["31-04"]
files_modified:
  - apps/web/src/components/admin/collection/log-detail-modal.tsx
  - apps/web/src/components/admin/collection/history-panel.tsx
  - apps/web/src/app/admin/automation/page.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking an export event shows a Changes panel with summary header and exported seller list"
    - "Clicking a flag event shows a Changes panel with colored flagged/unflagged sections"
    - "Export Changes panel shows 'Exported X sellers as FORMAT' header and purple-bordered seller rows"
    - "Flag Changes panel shows 'Flagged (N)' or 'Unflagged (N)' sections with yellow/gray styling"
    - "History section header in the sidebar is clickable and opens the full history viewer modal"
    - "Clicking History header opens modal with no entry pre-selected, showing most recent events"
  artifacts:
    - path: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      provides: "ExportChangesPanel and FlagChangesPanel rendering for new event types"
      contains: "ExportChangesPanel|FlagChangesPanel|export.*Changes|flag.*Changes"
    - path: "apps/web/src/components/admin/collection/history-panel.tsx"
      provides: "Clickable History header that opens full history modal"
      contains: "onClick.*History|cursor-pointer.*History"
  key_links:
    - from: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      to: "new_value JSON parsing"
      via: "JSON.parse(entry.new_value) for export/flag details"
      pattern: "JSON\\.parse.*new_value"
    - from: "apps/web/src/components/admin/collection/history-panel.tsx"
      to: "apps/web/src/app/admin/automation/page.tsx"
      via: "onHistoryClick callback"
      pattern: "onHistoryClick"
    - from: "apps/web/src/app/admin/automation/page.tsx"
      to: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      via: "opens LogDetailModal with no selected entry"
      pattern: "logDetailOpen.*true"
---

<objective>
Add Changes panel variants for export and flag events in the LogDetailModal, and make the History section header clickable to open the full history viewer.

Purpose: Complete the history viewer experience: export events show exported sellers with purple styling, flag events show flagged/unflagged sections with colored styling, and users can access the full history from the sidebar header.
Output: Enhanced LogDetailModal with new Changes panel variants, clickable History header in HistoryPanel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-collection-history-system/31-CONTEXT.md
@.planning/phases/31-collection-history-system/31-RESEARCH.md
@.planning/phases/31-collection-history-system/31-04-SUMMARY.md
@apps/web/src/components/admin/collection/log-detail-modal.tsx
@apps/web/src/components/admin/collection/history-panel.tsx
@apps/web/src/app/admin/automation/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export and flag Changes panel variants in LogDetailModal</name>
  <files>
    apps/web/src/components/admin/collection/log-detail-modal.tsx
  </files>
  <action>
    **1. Update fetchChangesForEntry to handle export and flag events:**

    The current `fetchChangesForEntry` fetches from `/sellers/audit-log/{logId}/sellers` which returns `{ sellers, count, added, removed }`. For export and flag events, we need a different approach since these events don't have traditional added/removed diffs.

    When an export or flag entry is clicked:
    - Parse the entry's `new_value` JSON (available from the allEntries state since Plan 04 added `new_value` to the ManualLogEntry type)
    - Set changes state to indicate it's an export or flag event

    Update the `changes` state type to accommodate all event types:
    ```typescript
    interface SellerChanges {
      type: "diff" | "export" | "flag";
      added: string[];
      removed: string[];
      // For export events:
      exportFormat?: string;
      exportedSellers?: string[];
      // For flag events:
      flagged?: boolean;
      flaggedSellers?: string[];
    }
    ```

    Update `handleEntryClick`:
    - When clicking a `manual_edit` entry with `action === "export"` or `action === "flag"`:
      - Parse `new_value` from the entry in `allEntries`
      - For export: `setChanges({ type: "export", added: [], removed: [], exportFormat: parsed.format, exportedSellers: parsed.sellers })`
      - For flag: `setChanges({ type: "flag", added: [], removed: [], flagged: parsed.flagged, flaggedSellers: parsed.sellers })`
      - Skip the fetch to `/sellers/audit-log/{logId}/sellers` (not needed for export/flag)
    - When clicking add/edit/remove entries: Existing behavior (fetch diff, set `type: "diff"`)
    - When clicking collection run entries: Existing behavior (fetch run sellers, set `type: "diff"`)

    **2. Add ExportChangesPanel inline component:**
    Renders when `changes.type === "export"`:
    - Summary header: `"Exported {N} sellers as {FORMAT}"` (bold, text-foreground)
    - Below: scrollable list of seller names, each with:
      - Purple left border: `border-l-2 border-purple-500`
      - Alternating backgrounds: `bg-purple-500/10` and `bg-purple-500/5`
      - Download icon (lucide `Download`, `h-3.5 w-3.5 text-purple-400`)
      - Seller name in `text-sm text-purple-300`
    - This matches the existing Added/Removed sections' styling pattern but with purple instead of green/red.

    **3. Add FlagChangesPanel inline component:**
    Renders when `changes.type === "flag"`:
    - Section header: `"Flagged ({N})"` or `"Unflagged ({N})"`
    - If `changes.flagged === true`:
      - Yellow left border: `border-l-2 border-yellow-500`
      - Alternating: `bg-yellow-500/10` and `bg-yellow-500/5`
      - Flag icon (lucide `Flag`, `h-3.5 w-3.5 text-yellow-400`)
      - Name in `text-sm text-yellow-300`
    - If `changes.flagged === false`:
      - Gray left border: `border-l-2 border-gray-500`
      - Alternating: `bg-gray-500/10` and `bg-gray-500/5`
      - FlagOff icon (lucide `FlagOff`, `h-3.5 w-3.5 text-gray-400`)
      - Name in `text-sm text-gray-300`
    - Hide the empty section (only show flagged OR unflagged, not both -- CONTEXT.md decision)

    **4. Update Changes panel rendering:**
    Replace the current `hasChanges ? (Added/Removed sections) : (empty state)` with:
    ```tsx
    {changesLoading ? (skeletons) :
     changes.type === "export" ? <ExportChangesPanel ... /> :
     changes.type === "flag" ? <FlagChangesPanel ... /> :
     !hasChanges ? (empty state) :
     (existing Added/Removed sections)}
    ```

    **5. Add required icon imports:**
    - Import `Download, Flag, FlagOff` from `lucide-react` (add to existing import)
    - Import `formatDistanceToNow` from `date-fns` if not already imported (should be from Plan 04)
  </action>
  <verify>
    - grep confirms `ExportChangesPanel` or export Changes rendering in log-detail-modal.tsx
    - grep confirms `FlagChangesPanel` or flag Changes rendering in log-detail-modal.tsx
    - grep confirms `border-purple-500` (export styling)
    - grep confirms `border-yellow-500` (flag styling)
    - grep confirms `JSON.parse` of `new_value` for export/flag entries
    - grep confirms `Download` and `Flag` icon imports from lucide-react
    - grep confirms changes state includes `type` discriminant
  </verify>
  <done>
    LogDetailModal Changes panel shows export events with purple-styled seller list and summary header, flag events with yellow/gray colored sections matching the add/remove pattern. Clicking export/flag entries parses new_value JSON and renders the appropriate panel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make History header clickable and wire to full history modal</name>
  <files>
    apps/web/src/components/admin/collection/history-panel.tsx
    apps/web/src/app/admin/automation/page.tsx
  </files>
  <action>
    **HistoryPanel changes (history-panel.tsx):**

    1. Add new prop to `HistoryPanelProps`:
       ```typescript
       onHistoryClick: () => void;  // Opens full history viewer modal
       ```

    2. Make the History header section clickable. Replace the current header (around line 213-216):
       ```tsx
       <div className="flex items-center gap-2 mb-3">
         <History className="h-4 w-4 text-muted-foreground" />
         <h3 className="text-sm font-medium text-foreground">History</h3>
       </div>
       ```
       With:
       ```tsx
       <button
         onClick={onHistoryClick}
         className="flex items-center gap-2 mb-3 group cursor-pointer w-full text-left"
       >
         <History className="h-4 w-4 text-muted-foreground group-hover:text-foreground transition-colors" />
         <h3 className="text-sm font-medium text-foreground group-hover:text-primary transition-colors">
           History
         </h3>
         <span className="text-xs text-muted-foreground/60 group-hover:text-muted-foreground transition-colors ml-auto">
           View all
         </span>
       </button>
       ```
       This creates a prominent, interactive header with hover effects and a "View all" hint. The entire header area is clickable.

    3. Also update ManualEditEntry types to include export/flag actions (matching the updated types from Plans 01/04):
       ```typescript
       action: "add" | "edit" | "remove" | "export" | "flag";
       ```
       And add `new_value?: string` field.

    4. Update `actionIcons` to include export and flag:
       ```typescript
       const actionIcons = {
         add: <Plus className="h-3 w-3 text-green-400" />,
         edit: <Edit3 className="h-3 w-3 text-yellow-400" />,
         remove: <Minus className="h-3 w-3 text-red-400" />,
         export: <Download className="h-3 w-3 text-purple-400" />,
         flag: <Flag className="h-3 w-3 text-yellow-400" />,
       };
       ```
       Import `Download` and `Flag` from lucide-react.

    5. Update `renderManualEdit` to handle the display of export and flag entries in the sidebar feed:
       - Export entries: Show Download icon + "Exported X sellers" text
       - Flag entries: Show Flag icon + "Flagged/Unflagged X sellers" text
       - These entries are already returned by the audit-log API now; they just need proper rendering.

    **Automation page changes (automation/page.tsx):**

    1. Add handler for History header click:
       ```typescript
       const handleHistoryHeaderClick = () => {
         // Open modal with no specific entry pre-selected
         setSelectedLogId(null);
         setSelectedRunId(null);
         setLogDetailOpen(true);
       };
       ```

    2. Pass to HistoryPanel:
       ```tsx
       <HistoryPanel
         ...existing props...
         onHistoryClick={handleHistoryHeaderClick}
       />
       ```

    3. Update LogDetailModal to handle opening with no selection:
       The modal already opens in this case, but the Changes panel will show "No changes" (FileQuestion empty state). This is correct behavior -- when opened via the header, the user browses the Full History list and clicks an entry to see changes.

       However, ensure the `useEffect` that fetches data on modal open also handles the case where `selectedLogId === null && selectedRunId === null`:
       - Still fetch the initial batch of all entries for the Full History list
       - Do NOT try to fetch changes for a null entry
       - Set `viewingEntry` to null (no entry pre-selected)
  </action>
  <verify>
    - grep confirms `onHistoryClick` prop in HistoryPanelProps
    - grep confirms clickable History header with `cursor-pointer` or `group` class
    - grep confirms "View all" text in header
    - grep confirms `handleHistoryHeaderClick` in automation/page.tsx
    - grep confirms `onHistoryClick={handleHistoryHeaderClick}` prop passing
    - grep confirms `Download` and `Flag` imports in history-panel.tsx
    - grep confirms export/flag entries handled in renderManualEdit or entry rendering
    - The modal opens when clicking the History header and shows the Full History list
  </verify>
  <done>
    History section header is clickable with hover effects and "View all" hint, opens the full history viewer modal with no pre-selected entry. HistoryPanel sidebar feed renders export and flag events with appropriate icons and labels. Modal handles opening with no selection (shows empty Changes panel, full history list for browsing).
  </done>
</task>

</tasks>

<verification>
1. Clicking an export event in the history shows "Exported X sellers as FORMAT" header with purple-bordered seller list
2. Clicking a flag event shows "Flagged (N)" or "Unflagged (N)" section with yellow/gray styling
3. Export Changes panel uses Download icon and purple color scheme
4. Flag Changes panel uses Flag/FlagOff icons and yellow/gray color scheme
5. Clicking the History header in the sidebar opens the modal with no pre-selected entry
6. The History header has hover effects (color transitions) and "View all" hint text
7. Export and flag entries appear correctly in the sidebar activity feed
8. Modal correctly handles null selectedLogId/selectedRunId (browses-only mode)
</verification>

<success_criteria>
- Export event details are visually distinct (purple) from add/remove (green/red) in the Changes panel
- Flag event details show correct flag state (flagged=yellow, unflagged=gray) matching the add/remove section pattern
- History header is an obvious interactive element with visual feedback on hover
- Clicking History header provides a quick way to browse all history without selecting a specific entry first
- All entry types (add, edit, remove, export, flag, collection_run) render correctly in both the sidebar feed and the modal
</success_criteria>

<output>
After completion, create `.planning/phases/31-collection-history-system/31-05-SUMMARY.md`
</output>
