---
phase: 31-collection-history-system
plan: 04
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - apps/web/src/components/admin/collection/log-detail-modal.tsx
  - apps/web/src/components/admin/collection/history-filter-chips.tsx
autonomous: true

must_haves:
  truths:
    - "Full History list supports filtering by event type via filter chips"
    - "Full History list supports filtering by date range via calendar picker"
    - "Full History list loads events in batches via infinite scroll (not all at once)"
    - "Events are grouped by day with sticky date headers (Today, Yesterday, Jan 25)"
    - "Modal layout is asymmetric: Changes panel narrower, Full History panel wider"
    - "Event rows show type badge + description + relative timestamp"
    - "Modal is wider to accommodate the filter UI and asymmetric layout"
  artifacts:
    - path: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      provides: "Enhanced history viewer with filtering, infinite scroll, day grouping, asymmetric layout"
      min_lines: 350
    - path: "apps/web/src/components/admin/collection/history-filter-chips.tsx"
      provides: "Filter chips component for history event types"
      min_lines: 30
  key_links:
    - from: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      to: "/api/sellers/audit-log"
      via: "fetch with action_types, date_from, date_to params"
      pattern: "audit-log.*action_types|action_types.*audit-log"
    - from: "apps/web/src/components/admin/collection/log-detail-modal.tsx"
      to: "apps/web/src/components/admin/collection/history-filter-chips.tsx"
      via: "import HistoryFilterChips"
      pattern: "HistoryFilterChips"
---

<objective>
Enhance the LogDetailModal with filtered history (filter chips, date range picker), infinite scroll with IntersectionObserver, day grouping with sticky headers, asymmetric layout, and new event row format with type badges and relative timestamps.

Purpose: HIST-03 requires a history viewer UI for browsing and filtering historical collection actions. The current modal loads 100 entries in a flat list with no filtering.
Output: Redesigned LogDetailModal with full browsing capabilities, new HistoryFilterChips component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/31-collection-history-system/31-CONTEXT.md
@.planning/phases/31-collection-history-system/31-RESEARCH.md
@.planning/phases/31-collection-history-system/31-01-SUMMARY.md
@apps/web/src/components/admin/collection/log-detail-modal.tsx
@apps/web/src/components/bookkeeping/quick-filter-chips.tsx
@apps/web/src/components/ui/calendar.tsx
@apps/web/src/components/ui/popover.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HistoryFilterChips component</name>
  <files>
    apps/web/src/components/admin/collection/history-filter-chips.tsx
  </files>
  <action>
    Create a filter chips component following the exact pattern from `quick-filter-chips.tsx` (Badge-based, radiogroup role).

    **Filter definitions:**
    ```typescript
    const HISTORY_FILTERS = [
      { id: "all", label: "All", actionTypes: null },
      { id: "exports", label: "Exports", actionTypes: ["export"] },
      { id: "flags", label: "Flags", actionTypes: ["flag"] },
      { id: "runs", label: "Runs", actionTypes: ["add"] },
      { id: "edits", label: "Edits", actionTypes: ["edit", "remove"] },
    ] as const;
    ```

    Note: "Runs" maps to action type "add" because collection runs create "add" audit entries with source "collection_run". The filter chips filter by action type at the API level.

    **Props:**
    ```typescript
    interface HistoryFilterChipsProps {
      activeFilter: string;
      onFilterChange: (filterId: string, actionTypes: string[] | null) => void;
    }
    ```

    **Component:** Same layout as QuickFilterChips:
    - `flex flex-wrap items-center gap-2` container with `role="radiogroup"`
    - Each filter is a Badge: `variant="default"` when active, `variant="outline"` when inactive
    - Click handler calls `onFilterChange(filter.id, filter.actionTypes)` (toggles back to "all" if clicking active filter)
    - Include a "Clear" button (X icon, outline variant) when active filter is not "all" -- same pattern as QuickFilterChips

    Export both the component and the `HISTORY_FILTERS` array (the modal needs actionTypes mapping).
  </action>
  <verify>
    - File exists at apps/web/src/components/admin/collection/history-filter-chips.tsx
    - grep confirms Badge import and radiogroup role
    - grep confirms HISTORY_FILTERS with all 5 filter options
    - grep confirms export of both HistoryFilterChips and HISTORY_FILTERS
  </verify>
  <done>
    HistoryFilterChips component created with All/Exports/Flags/Runs/Edits filter options following the QuickFilterChips pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Redesign LogDetailModal with filtering, infinite scroll, day grouping</name>
  <files>
    apps/web/src/components/admin/collection/log-detail-modal.tsx
  </files>
  <action>
    This is a significant rework of the existing 453-line LogDetailModal. The core layout changes but the Changes panel and entry click behavior remain.

    **1. Modal width and layout:**
    - Change `max-w-3xl` to `max-w-5xl` (wider to accommodate filter UI + asymmetric layout)
    - Change `grid grid-cols-2` to `grid grid-cols-5` with Changes panel `col-span-2` and Full History panel `col-span-3` (asymmetric: history gets more space)

    **2. Extend types to include export and flag:**
    - Update `ManualLogEntry.action` type to: `"add" | "edit" | "remove" | "export" | "flag"`
    - Add `new_value?: string` (JSON string) to `ManualLogEntry` interface
    - Add to `actionColors`:
      ```
      export: "text-purple-400 bg-purple-400/10",
      flag: "text-yellow-400 bg-yellow-400/10",
      ```

    **3. Add filter state:**
    - `const [activeFilter, setActiveFilter] = useState("all");`
    - `const [filterActionTypes, setFilterActionTypes] = useState<string[] | null>(null);`
    - `const [dateRange, setDateRange] = useState<DateRange | undefined>();` (import `DateRange` from `react-day-picker`)

    **4. Add pagination state for infinite scroll:**
    - `const [allEntries, setAllEntries] = useState<HistoryEntry[]>([])` (already exists)
    - `const [hasMore, setHasMore] = useState(true);`
    - `const [loadingMore, setLoadingMore] = useState(false);`
    - `const PAGE_SIZE = 30;`

    **5. Rewrite data fetching to use filtered API:**
    - Replace the current `fetchData` (which fetches all logs + runs in parallel with `limit=100`) with a function that calls the updated audit-log endpoint with filter params:
      ```
      const params = new URLSearchParams();
      params.set("limit", String(PAGE_SIZE));
      params.set("offset", String(allEntries.length));
      if (filterActionTypes) params.set("action_types", filterActionTypes.join(","));
      if (dateRange?.from) params.set("date_from", dateRange.from.toISOString());
      if (dateRange?.to) params.set("date_to", dateRange.to.toISOString());

      const res = await fetch(`${API_BASE}/sellers/audit-log?${params}`, { headers: { ... } });
      ```
    - Parse response entries into `ManualLogEntry[]` (now includes export/flag types)
    - Collection runs: Still fetch separately from `/collection/runs/history` and merge. BUT -- only fetch runs when filter is "all" or "runs". When filtering for "exports" or "flags", skip run fetch.
    - Append to allEntries (for infinite scroll). On filter change, reset to empty and refetch.

    **6. Implement loadMore for infinite scroll:**
    ```typescript
    const loadMore = useCallback(async () => {
      if (loadingMore || !hasMore) return;
      setLoadingMore(true);
      // Fetch next page with offset = allEntries.length
      // Append results to allEntries
      // If results < PAGE_SIZE, setHasMore(false)
      setLoadingMore(false);
    }, [loadingMore, hasMore, allEntries.length, filterActionTypes, dateRange]);
    ```

    **7. Implement IntersectionObserver sentinel for infinite scroll:**
    Use a ref callback pattern (as shown in RESEARCH.md):
    ```typescript
    const sentinelRef = useCallback((node: HTMLDivElement | null) => {
      if (!node || !hasMore) return;
      const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) loadMore();
      }, { threshold: 0.1 });
      observer.observe(node);
      return () => observer.disconnect();
    }, [loadMore, hasMore]);
    ```
    Place `<div ref={sentinelRef} className="h-8" />` at the bottom of the entries list.

    **8. Implement day grouping:**
    - Import `isToday, isYesterday, format, startOfDay` from `date-fns`
    - Create `groupByDay(entries)` function that returns `Map<string, HistoryEntry[]>`
    - Day labels: "Today", "Yesterday", or formatted date "Jan 25"
    - Render day groups with sticky headers:
      ```tsx
      <div className="sticky top-0 bg-muted/80 backdrop-blur-sm px-3 py-1 text-xs text-muted-foreground font-medium border-b border-border">
        {dayLabel}
      </div>
      ```

    **9. Add filter UI above the Full History panel:**
    In the Full History column, above the scrollable list:
    ```tsx
    <div className="flex items-center gap-2 mb-2 flex-shrink-0 flex-wrap">
      <HistoryFilterChips
        activeFilter={activeFilter}
        onFilterChange={(id, types) => {
          setActiveFilter(id);
          setFilterActionTypes(types);
          // Reset entries and refetch
          setAllEntries([]);
          setHasMore(true);
        }}
      />
      {/* Date range picker */}
      <Popover>
        <PopoverTrigger asChild>
          <Button variant="outline" size="sm" className="h-6 text-xs">
            <CalendarIcon className="h-3 w-3 mr-1" />
            {dateRange?.from ? (
              dateRange.to
                ? `${format(dateRange.from, "MMM d")} - ${format(dateRange.to, "MMM d")}`
                : format(dateRange.from, "MMM d")
            ) : "Date range"}
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-auto p-0" align="start">
          <Calendar
            mode="range"
            selected={dateRange}
            onSelect={(range) => {
              setDateRange(range);
              setAllEntries([]);
              setHasMore(true);
            }}
            numberOfMonths={2}
          />
        </PopoverContent>
      </Popover>
    </div>
    ```

    **10. Update event row format in Full History list:**
    Replace the current entry rendering with a unified format using type badges:
    ```tsx
    const eventBadgeStyles: Record<string, string> = {
      export: "bg-purple-500/20 text-purple-400",
      flag: "bg-yellow-500/20 text-yellow-400",
      add: "bg-green-500/20 text-green-400",
      edit: "bg-blue-500/20 text-blue-400",
      remove: "bg-red-500/20 text-red-400",
    };
    const eventLabels: Record<string, string> = {
      export: "Export", flag: "Flag", add: "Run", edit: "Edit", remove: "Remove",
    };
    ```
    Each entry row (for manual_edit type entries):
    - Type badge (colored per action) + description text + relative timestamp
    - Use `formatDistanceToNow` instead of full date format for compactness
    - Still clickable to load changes in the Changes panel

    Collection run entries keep their Bot icon + name + status badge format but also get relative timestamps.

    **11. Handle filter/date changes:**
    When filter or date range changes, reset `allEntries` to `[]`, set `hasMore` to `true`, and trigger refetch via a `useEffect` that depends on `activeFilter` and `dateRange`.

    **12. Loading states:**
    - Initial load: Show skeleton (already exists)
    - Loading more: Show a small spinner at the bottom of the list (above sentinel)
    - Filter change: Show skeleton for the history list while entries reload

    **IMPORTANT:** Preserve the Changes panel (left side) exactly as-is. It still shows Added/Removed sections. Plan 05 will add new panel variants for export/flag events. For now, if an export or flag entry is clicked, the Changes panel will show "No changes" (since the current fetchChangesForEntry fetches sellers at that log point, which doesn't apply to export/flag events). This is fine -- Plan 05 fixes it.
  </action>
  <verify>
    - grep confirms `max-w-5xl` (wider modal)
    - grep confirms `col-span-2` and `col-span-3` (asymmetric layout)
    - grep confirms `HistoryFilterChips` import and render
    - grep confirms `Calendar` and `mode="range"` (date range picker)
    - grep confirms `IntersectionObserver` or `sentinelRef` (infinite scroll)
    - grep confirms `isToday|isYesterday` imports (day grouping)
    - grep confirms `sticky top-0` class (sticky day headers)
    - grep confirms `eventBadgeStyles` or `eventLabels` with export/flag entries
    - grep confirms `formatDistanceToNow` import
    - grep confirms `action_types` parameter in audit-log fetch URL
    - `npm run build` in apps/web succeeds (or no TypeScript errors)
  </verify>
  <done>
    LogDetailModal redesigned with: asymmetric layout (2:3 split), filter chips for event types, date range picker, infinite scroll via IntersectionObserver, day grouping with sticky headers, type badge event rows with relative timestamps, wider modal (max-w-5xl). Filters and date range trigger server-side filtering via the extended audit-log API.
  </done>
</task>

</tasks>

<verification>
1. Modal opens at wider width (max-w-5xl) with asymmetric 2:3 column split
2. Filter chips (All/Exports/Flags/Runs/Edits) appear above Full History list
3. Date range picker opens a calendar popover with range selection
4. Selecting a filter or date range resets and refetches entries from server
5. Scrolling to the bottom of the list loads more entries (infinite scroll)
6. Events are grouped under day headers (Today, Yesterday, Jan 25)
7. Day headers are sticky while scrolling within their section
8. Event rows show colored type badge + description + relative timestamp
9. Clicking an entry still loads its changes in the Changes panel
</verification>

<success_criteria>
- History viewer supports browsing 100k+ events without performance issues (server-side filtering + pagination)
- Filter chips correctly filter to show only export events, only flag events, etc.
- Date range correctly limits events to the selected window
- Infinite scroll loads events in batches of ~30, triggered by scrolling near the bottom
- Day grouping provides clear temporal context for event browsing
- Asymmetric layout gives the history list adequate space for the new filter UI
</success_criteria>

<output>
After completion, create `.planning/phases/31-collection-history-system/31-04-SUMMARY.md`
</output>
