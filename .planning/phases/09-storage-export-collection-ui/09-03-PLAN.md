---
phase: 09-storage-export-collection-ui
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - apps/web/src/components/admin/collection/collection-history.tsx
  - apps/web/src/components/admin/collection/sellers-grid.tsx
  - apps/web/src/components/admin/collection/progress-detail-modal.tsx
  - apps/web/src/components/admin/collection/progress-bar.tsx
  - apps/web/src/app/admin/automation/page.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Admin can view collection history with past runs and stats"
    - "Admin can export sellers with full metadata from dropdown"
    - "Admin can download JSON file with all seller metadata"
    - "Admin can re-run a past collection with same categories"
    - "Admin can minimize progress modal to floating indicator"
    - "Admin can cancel a running collection from progress UI"
  artifacts:
    - path: "apps/web/src/components/admin/collection/collection-history.tsx"
      provides: "History table component"
      min_lines: 100
    - path: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      provides: "Enhanced export dropdown with JSON download"
      contains: "downloadJSON"
    - path: "apps/web/src/components/admin/collection/progress-detail-modal.tsx"
      provides: "Minimizable progress modal"
      contains: "isMinimized"
  key_links:
    - from: "apps/web/src/components/admin/collection/collection-history.tsx"
      to: "/collection/runs/history"
      via: "fetch in useEffect"
      pattern: "collection/runs/history"
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "/sellers/export"
      via: "downloadJSON function"
      pattern: "sellers/export.*format=json"
---

<objective>
Build the frontend UI components for collection history display, enhanced exports with full metadata, minimizable progress modal, and cancel functionality.

Purpose: Users need visual interfaces to view collection history, export with full data, monitor progress without blocking navigation, and control running collections.

Output: New collection-history.tsx component, enhanced sellers-grid.tsx export, minimizable progress-detail-modal.tsx, integrated automation page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-storage-export-collection-ui/09-CONTEXT.md
@.planning/phases/09-storage-export-collection-ui/09-RESEARCH.md

@apps/web/src/app/admin/automation/page.tsx
@apps/web/src/components/admin/collection/sellers-grid.tsx
@apps/web/src/components/admin/collection/progress-detail-modal.tsx
@apps/web/src/components/admin/collection/progress-bar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collection history component</name>
  <files>apps/web/src/components/admin/collection/collection-history.tsx</files>
  <action>
Create a new component that displays collection run history in a table format:

```typescript
"use client";

import { useState, useEffect, useCallback } from "react";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Download, RefreshCw, Play } from "lucide-react";
import { cn } from "@/lib/utils";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface HistoryEntry {
  id: string;
  name: string;
  status: "completed" | "failed" | "cancelled";
  started_at: string | null;
  completed_at: string | null;
  duration_seconds: number | null;
  categories_count: number;
  products_total: number;
  products_searched: number;
  sellers_found: number;
  sellers_new: number;
  cost_cents: number;
  failed_items: number;
}

interface CollectionHistoryProps {
  refreshTrigger: number;
  onRerun: (categoryIds: string[]) => void;
}

function formatDuration(seconds: number | null): string {
  if (seconds === null) return "-";
  if (seconds < 60) return `${seconds}s`;
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}m ${secs}s`;
}

function formatCost(cents: number): string {
  return `$${(cents / 100).toFixed(2)}`;
}

function formatDate(isoString: string | null): string {
  if (!isoString) return "-";
  return new Date(isoString).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

const statusStyles = {
  completed: "bg-green-500/20 text-green-400",
  failed: "bg-red-500/20 text-red-400",
  cancelled: "bg-yellow-500/20 text-yellow-400",
};

export function CollectionHistory({ refreshTrigger, onRerun }: CollectionHistoryProps) {
  const [history, setHistory] = useState<HistoryEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [total, setTotal] = useState(0);
  const supabase = createClient();

  const fetchHistory = useCallback(async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const response = await fetch(`${API_BASE}/collection/runs/history?limit=20`, {
        headers: { Authorization: `Bearer ${session.access_token}` },
      });

      if (response.ok) {
        const data = await response.json();
        setHistory(data.runs || []);
        setTotal(data.total || 0);
      }
    } catch (e) {
      console.error("Failed to fetch history:", e);
    } finally {
      setLoading(false);
    }
  }, [supabase.auth]);

  useEffect(() => {
    fetchHistory();
  }, [refreshTrigger, fetchHistory]);

  const handleExportRun = async (runId: string) => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const response = await fetch(
      `${API_BASE}/sellers/export?format=json&run_id=${runId}`,
      { headers: { Authorization: `Bearer ${session.access_token}` } }
    );
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `sellers_run-${runId.slice(0, 8)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  if (loading) {
    return <div className="text-gray-400 p-4">Loading history...</div>;
  }

  if (history.length === 0) {
    return (
      <div className="text-gray-500 text-center py-8">
        No collection runs yet. Start one to see history here.
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-medium text-white">Collection History</h3>
        <span className="text-sm text-gray-500">{total} total runs</span>
      </div>

      <div className="border border-gray-800 rounded-lg overflow-hidden">
        <Table>
          <TableHeader className="bg-gray-800/50">
            <TableRow>
              <TableHead className="text-gray-400">Run</TableHead>
              <TableHead className="text-gray-400">Status</TableHead>
              <TableHead className="text-gray-400">Date</TableHead>
              <TableHead className="text-gray-400 text-right">Duration</TableHead>
              <TableHead className="text-gray-400 text-right">Categories</TableHead>
              <TableHead className="text-gray-400 text-right">Products</TableHead>
              <TableHead className="text-gray-400 text-right">Sellers</TableHead>
              <TableHead className="text-gray-400 text-right">New</TableHead>
              <TableHead className="text-gray-400 text-right">Cost</TableHead>
              <TableHead className="text-gray-400">Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {history.map((entry) => (
              <TableRow key={entry.id} className="hover:bg-gray-800/30">
                <TableCell className="text-gray-200 font-medium truncate max-w-[150px]">
                  {entry.name}
                </TableCell>
                <TableCell>
                  <Badge className={cn(statusStyles[entry.status])}>
                    {entry.status}
                  </Badge>
                </TableCell>
                <TableCell className="text-gray-400 text-sm">
                  {formatDate(entry.completed_at)}
                </TableCell>
                <TableCell className="text-gray-300 text-right">
                  {formatDuration(entry.duration_seconds)}
                </TableCell>
                <TableCell className="text-gray-300 text-right">
                  {entry.categories_count}
                </TableCell>
                <TableCell className="text-gray-300 text-right">
                  {entry.products_searched}/{entry.products_total}
                </TableCell>
                <TableCell className="text-gray-300 text-right">
                  {entry.sellers_found}
                </TableCell>
                <TableCell className="text-green-400 text-right font-medium">
                  +{entry.sellers_new}
                </TableCell>
                <TableCell className="text-gray-300 text-right">
                  {formatCost(entry.cost_cents)}
                </TableCell>
                <TableCell>
                  <div className="flex gap-1">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleExportRun(entry.id)}
                      className="h-8 w-8 p-0"
                      title="Export sellers from this run"
                    >
                      <Download className="h-4 w-4" />
                    </Button>
                  </div>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  );
}
```

This component:
- Fetches from /collection/runs/history endpoint
- Displays table with all stats (duration, categories, products, sellers, cost)
- Color-coded status badges
- Export button per run (downloads JSON with run_id filter)
- Placeholder for re-run functionality (to be wired in future)
  </action>
  <verify>File exists at apps/web/src/components/admin/collection/collection-history.tsx with Table import and handleExportRun function</verify>
  <done>CollectionHistory component displays history table with status, stats, and per-run export</done>
</task>

<task type="auto">
  <name>Task 2: Enhance sellers-grid export with JSON download</name>
  <files>apps/web/src/components/admin/collection/sellers-grid.tsx</files>
  <action>
Update the export functions in sellers-grid.tsx to use the enhanced API endpoint:

1. Add a downloadJSON function that triggers actual file download:

```typescript
const downloadJSON = async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return;

  const response = await fetch(`${API_BASE}/sellers/export?format=json`, {
    headers: { Authorization: `Bearer ${session.access_token}` },
  });
  const blob = await response.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `sellers_${new Date().toISOString().split("T")[0]}_full.json`;
  a.click();
  URL.revokeObjectURL(url);
};
```

2. Update the DropdownMenu export options to include:
- "Download CSV" (existing downloadCSV)
- "Download JSON" (new downloadJSON)
- "Copy to Clipboard" (existing copyRawText, rename for clarity)

3. Update the dropdown menu items:

```tsx
<DropdownMenuContent align="end" className="bg-gray-800 border-gray-700">
  <DropdownMenuItem onClick={downloadCSV} className="text-gray-200 focus:bg-gray-700">
    <Download className="h-4 w-4 mr-2" />
    Download CSV
  </DropdownMenuItem>
  <DropdownMenuItem onClick={downloadJSON} className="text-gray-200 focus:bg-gray-700">
    <Braces className="h-4 w-4 mr-2" />
    Download JSON
  </DropdownMenuItem>
  <DropdownMenuItem onClick={copyRawText} className="text-gray-200 focus:bg-gray-700">
    <FileText className="h-4 w-4 mr-2" />
    Copy to Clipboard
  </DropdownMenuItem>
</DropdownMenuContent>
```

Remove the old copyJSON function (it just copied names, the new downloadJSON has full metadata).
  </action>
  <verify>sellers-grid.tsx has downloadJSON function that fetches from /sellers/export?format=json</verify>
  <done>Export dropdown has Download CSV, Download JSON (full metadata file), and Copy to Clipboard options</done>
</task>

<task type="auto">
  <name>Task 3: Add minimizable progress modal and cancel button</name>
  <files>apps/web/src/components/admin/collection/progress-detail-modal.tsx, apps/web/src/components/admin/collection/progress-bar.tsx</files>
  <action>
1. Update progress-detail-modal.tsx to support minimize:

Add minimize state and floating indicator:

```typescript
interface ProgressDetailModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  progress: { /* existing fields */ } | null;
  isMinimized: boolean;
  onMinimizeChange: (minimized: boolean) => void;
  onCancel: () => void;
}
```

Update the component to render a floating indicator when minimized:

```tsx
export function ProgressDetailModal({
  open,
  onOpenChange,
  progress,
  isMinimized,
  onMinimizeChange,
  onCancel,
}: ProgressDetailModalProps) {
  if (!progress) return null;

  // Minimized floating indicator
  if (isMinimized) {
    return (
      <div
        onClick={() => onMinimizeChange(false)}
        className="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg p-3 cursor-pointer shadow-lg z-50 min-w-[200px] hover:bg-gray-750"
      >
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium text-white">Collection Running</span>
          <Badge className="bg-blue-500/20 text-blue-400 text-xs">
            {progress.products_total > 0
              ? Math.round((progress.products_searched / progress.products_total) * 100)
              : 0}%
          </Badge>
        </div>
        <div className="h-1.5 bg-gray-700 rounded overflow-hidden">
          <div
            className="h-full bg-blue-500 transition-all"
            style={{
              width: `${(progress.products_searched / Math.max(1, progress.products_total)) * 100}%`,
            }}
          />
        </div>
        <div className="text-xs text-gray-400 mt-1">
          {progress.products_searched}/{progress.products_total} products
        </div>
      </div>
    );
  }

  // Full modal (existing content)
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="bg-gray-900 border-gray-800 max-w-2xl">
        <DialogHeader>
          <div className="flex items-center justify-between">
            <DialogTitle className="text-white">Collection Progress</DialogTitle>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => onMinimizeChange(true)}
              className="text-gray-400 hover:text-white"
            >
              <Minimize2 className="h-4 w-4" />
            </Button>
          </div>
        </DialogHeader>

        {/* ... existing progress content ... */}

        {/* Add cancel button at bottom */}
        <div className="flex justify-end pt-4 border-t border-gray-800">
          <Button
            variant="destructive"
            onClick={onCancel}
            className="bg-red-600 hover:bg-red-700"
          >
            Cancel Collection
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

Add import: `import { Minimize2 } from "lucide-react";`

2. Update progress-bar.tsx to add cancel button:

Add onCancel prop and cancel button next to the existing "Details" button:

```tsx
interface ProgressBarProps {
  progress: EnhancedProgress;
  onDetailsClick: () => void;
  onRunStateChange: () => void;
  onCancel: () => void;  // Add this
}

// In the component, add cancel button:
<div className="flex items-center gap-2">
  <Button
    variant="ghost"
    size="sm"
    onClick={onDetailsClick}
    className="text-gray-400 hover:text-white"
  >
    Details
  </Button>
  <Button
    variant="ghost"
    size="sm"
    onClick={onCancel}
    className="text-red-400 hover:text-red-300"
  >
    Cancel
  </Button>
</div>
```
  </action>
  <verify>
1. progress-detail-modal.tsx contains isMinimized prop and floating indicator JSX
2. progress-bar.tsx contains onCancel prop and cancel button
  </verify>
  <done>
- Progress modal has minimize button that collapses to floating indicator
- Floating indicator shows progress percentage and click expands back
- Cancel button visible in both progress bar and modal
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire up components in automation page</name>
  <files>apps/web/src/app/admin/automation/page.tsx</files>
  <action>
1. Add import for CollectionHistory:
```typescript
import { CollectionHistory } from "@/components/admin/collection/collection-history";
```

2. Add state for minimize:
```typescript
const [progressMinimized, setProgressMinimized] = useState(false);
```

3. Add cancel handler:
```typescript
const handleCancelRun = async () => {
  if (!activeRun) return;

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return;

  try {
    await fetch(`${API_BASE}/collection/runs/${activeRun.id}/cancel`, {
      method: "POST",
      headers: { Authorization: `Bearer ${session.access_token}` },
    });
    refresh();
    handleRefresh();
  } catch (e) {
    console.error("Failed to cancel run:", e);
  }
};
```

4. Add supabase client at component level:
```typescript
const supabase = createClient();
```

5. Update the collections tab content to include:
- CollectionHistory component below the sellers grid
- Updated ProgressDetailModal with minimize props
- Pass onCancel to both ProgressBar and ProgressDetailModal

6. Update the JSX in the collections tab:

```tsx
{activeTab === "collections" && (
  <div className="space-y-6">
    {/* Progress bar (shown during active runs) */}
    {progress && (
      <ProgressBar
        progress={progress}
        onDetailsClick={() => {
          setProgressMinimized(false);
          setProgressDetailOpen(true);
        }}
        onRunStateChange={refresh}
        onCancel={handleCancelRun}
      />
    )}

    {/* Main content: Grid + Sidebar */}
    <div className="flex gap-4 h-[calc(100vh-400px)] min-h-[400px]">
      <div className="flex-1 min-w-0">
        <SellersGrid
          refreshTrigger={refreshTrigger}
          onSellerChange={handleRefresh}
          newSellerIds={newSellerIds}
        />
      </div>
      <div className="w-64 flex-shrink-0">
        <RecentLogsSidebar
          refreshTrigger={refreshTrigger}
          onLogClick={handleLogClick}
          onHeaderClick={handleHeaderClick}
          onStartRunClick={() => setRunConfigOpen(true)}
          hasActiveRun={!!activeRun}
        />
      </div>
    </div>

    {/* Collection History */}
    <CollectionHistory
      refreshTrigger={refreshTrigger}
      onRerun={(categoryIds) => {
        // Future: open run config with pre-selected categories
        setRunConfigOpen(true);
      }}
    />

    {/* Modals */}
    <ProgressDetailModal
      open={progressDetailOpen && !progressMinimized}
      onOpenChange={setProgressDetailOpen}
      progress={progress}
      isMinimized={progressMinimized}
      onMinimizeChange={setProgressMinimized}
      onCancel={handleCancelRun}
    />
    {/* ... other modals ... */}
  </div>
)}
```
  </action>
  <verify>
1. automation/page.tsx imports CollectionHistory
2. automation/page.tsx has handleCancelRun function
3. CollectionHistory component is rendered in the collections tab
  </verify>
  <done>
- Collections tab shows CollectionHistory below sellers grid
- Progress modal can be minimized to floating indicator
- Cancel button calls /collection/runs/{id}/cancel
- All components properly wired together
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Collection history UI, enhanced exports, minimizable progress modal, and cancel functionality</what-built>
  <how-to-verify>
1. Start both API and web app:
   - `cd apps/api && uvicorn app.main:app --reload --app-dir src`
   - `cd apps/web && npm run dev`
2. Login as admin and navigate to Extension Hub -> Collections tab
3. Verify:
   - Collection History table appears below the sellers grid
   - History shows past runs with status, duration, sellers found/new, cost
   - Click Download icon on a history row -> downloads JSON file with seller data from that run
   - Click Export dropdown on sellers grid -> has "Download CSV", "Download JSON", "Copy to Clipboard"
   - Click "Download JSON" -> downloads file with full seller metadata
   - If a collection is running: progress bar shows Cancel button
   - Click Details on progress -> modal opens with Minimize button
   - Click Minimize -> modal collapses to floating indicator in bottom-right
   - Click floating indicator -> modal expands again
   - Click Cancel -> collection stops
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the UI</resume-signal>
</task>

</tasks>

<verification>
1. Collection History component renders with table of past runs
2. Each history row has status badge, stats columns, and export button
3. Export dropdown has Download CSV, Download JSON, Copy to Clipboard options
4. Progress modal has minimize button that shows floating indicator
5. Cancel button in progress bar and modal calls /cancel endpoint
6. All components integrated in automation page
</verification>

<success_criteria>
- Admin can see collection history with full statistics
- Admin can export all sellers with full metadata as JSON file
- Admin can export sellers from specific run via history row
- Admin can minimize progress modal to floating indicator
- Admin can cancel running collection from UI
</success_criteria>

<output>
After completion, create `.planning/phases/09-storage-export-collection-ui/09-03-SUMMARY.md`
</output>
