---
phase: 09-storage-export-collection-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/app/routers/sellers.py
  - apps/api/src/app/services/collection.py
  - apps/api/src/app/models.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can export all sellers as JSON with full metadata"
    - "Admin can export all sellers as CSV with full metadata"
    - "Admin can export sellers from a specific run"
    - "Export files have descriptive filenames with date"
  artifacts:
    - path: "apps/api/src/app/routers/sellers.py"
      provides: "Enhanced /sellers/export endpoint"
      exports: ["export_sellers"]
    - path: "apps/api/src/app/services/collection.py"
      provides: "get_sellers_by_run method"
      contains: "def get_sellers_by_run"
    - path: "apps/api/src/app/models.py"
      provides: "SellerExportResponse model"
      contains: "class SellerExportResponse"
  key_links:
    - from: "apps/api/src/app/routers/sellers.py"
      to: "apps/api/src/app/services/collection.py"
      via: "service.get_sellers_by_run call"
      pattern: "get_sellers_by_run"
---

<objective>
Enhance the existing export endpoint to include full seller metadata (feedback score, discovery date, source product, times seen) and support filtering by run_id for per-run exports.

Purpose: Users need complete seller data for external analysis, not just names. Per-run export allows tracking which sellers came from which collection.

Output: Enhanced /sellers/export endpoint with full metadata in JSON and CSV formats.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-storage-export-collection-ui/09-CONTEXT.md
@.planning/phases/09-storage-export-collection-ui/09-RESEARCH.md

@apps/api/src/app/routers/sellers.py
@apps/api/src/app/services/collection.py
@apps/api/src/app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add get_sellers_by_run method to CollectionService</name>
  <files>apps/api/src/app/services/collection.py</files>
  <action>
Add a new method to CollectionService that retrieves sellers from a specific collection run:

```python
async def get_sellers_by_run(
    self,
    org_id: str,
    run_id: str,
) -> list[dict]:
    """Get all sellers discovered in a specific collection run."""
    result = (
        self.supabase.table("sellers")
        .select("*")
        .eq("org_id", org_id)
        .eq("first_seen_run_id", run_id)
        .order("created_at", desc=True)
        .execute()
    )
    return result.data or []
```

Place this method in the "Seller Management" section of the class.
  </action>
  <verify>Grep for "get_sellers_by_run" in collection.py confirms method exists</verify>
  <done>CollectionService has get_sellers_by_run method that queries sellers by first_seen_run_id</done>
</task>

<task type="auto">
  <name>Task 2: Enhance export endpoint with full metadata and run filtering</name>
  <files>apps/api/src/app/routers/sellers.py, apps/api/src/app/models.py</files>
  <action>
1. Add Pydantic models to models.py for the export response:

```python
# After SellerListResponse class

class SellerExportItem(BaseModel):
    """Single seller in export format."""
    display_name: str
    platform: str
    feedback_score: Optional[int] = None
    times_seen: int
    discovered_at: datetime
    first_seen_run_id: Optional[str] = None

class SellerExportResponse(BaseModel):
    """JSON export format."""
    exported_at: datetime
    run_id: Optional[str] = None
    count: int
    sellers: list[SellerExportItem]
```

2. Rewrite the export endpoint in sellers.py to support full metadata and run filtering:

```python
import csv
import io
from datetime import datetime, timezone
from fastapi.responses import StreamingResponse, JSONResponse

@router.get("/export")
async def export_sellers(
    format: str = "json",
    run_id: str | None = None,
    user: dict = Depends(require_permission_key("admin.automation")),
    service: CollectionService = Depends(get_collection_service),
):
    """
    Export sellers in specified format (json, csv, text).

    Optional run_id filter to export only sellers from a specific collection run.

    Requires admin.automation permission.
    """
    org_id = user["membership"]["org_id"]

    # Get sellers (optionally filtered by run)
    if run_id:
        sellers = await service.get_sellers_by_run(org_id, run_id)
    else:
        sellers, _ = await service.get_sellers(org_id, limit=100000)

    # Generate descriptive filename
    date_str = datetime.now().strftime("%Y-%m-%d")
    suffix = f"_run-{run_id[:8]}" if run_id else "_full"

    if format == "csv":
        # Full metadata CSV with proper headers
        stream = io.StringIO()
        fieldnames = [
            "display_name", "platform", "feedback_score",
            "times_seen", "discovered_at", "first_seen_run_id"
        ]
        writer = csv.DictWriter(stream, fieldnames=fieldnames)
        writer.writeheader()

        for s in sellers:
            writer.writerow({
                "display_name": s["display_name"],
                "platform": s["platform"],
                "feedback_score": s.get("feedback_score", ""),
                "times_seen": s["times_seen"],
                "discovered_at": s["created_at"],
                "first_seen_run_id": s.get("first_seen_run_id", ""),
            })

        filename = f"sellers_{date_str}{suffix}.csv"
        stream.seek(0)
        return StreamingResponse(
            iter([stream.getvalue()]),
            media_type="text/csv",
            headers={"Content-Disposition": f"attachment; filename={filename}"}
        )

    elif format == "text":
        # Plain text (names only, for clipboard pasting)
        content = "\n".join(s["display_name"] for s in sellers)
        return PlainTextResponse(content, media_type="text/plain")

    else:  # json (default)
        filename = f"sellers_{date_str}{suffix}.json"
        return JSONResponse(
            content={
                "exported_at": datetime.now(timezone.utc).isoformat(),
                "run_id": run_id,
                "count": len(sellers),
                "sellers": [
                    {
                        "display_name": s["display_name"],
                        "platform": s["platform"],
                        "feedback_score": s.get("feedback_score"),
                        "times_seen": s["times_seen"],
                        "discovered_at": s["created_at"],
                        "first_seen_run_id": s.get("first_seen_run_id"),
                    }
                    for s in sellers
                ]
            },
            headers={"Content-Disposition": f"attachment; filename={filename}"}
        )
```

Add necessary imports at top of sellers.py:
- `import csv`
- `import io`
- `from datetime import datetime, timezone`
- `from fastapi.responses import StreamingResponse, JSONResponse`
  </action>
  <verify>
1. curl -X GET "http://localhost:8000/sellers/export?format=json" with auth returns JSON with exported_at, count, sellers array with full metadata
2. curl -X GET "http://localhost:8000/sellers/export?format=csv" with auth returns CSV file with headers
  </verify>
  <done>
- Export endpoint returns full metadata (display_name, platform, feedback_score, times_seen, discovered_at, first_seen_run_id)
- Export endpoint accepts optional run_id query param
- CSV export includes Content-Disposition header with descriptive filename
- JSON export includes exported_at timestamp
  </done>
</task>

</tasks>

<verification>
1. Start API server: `cd apps/api && uvicorn app.main:app --reload --app-dir src`
2. Authenticate and get token
3. Test JSON export: `curl -H "Authorization: Bearer TOKEN" "http://localhost:8000/sellers/export?format=json"` - should return sellers array with full metadata
4. Test CSV export: `curl -H "Authorization: Bearer TOKEN" "http://localhost:8000/sellers/export?format=csv"` - should return CSV with header row
5. Test run filter: `curl -H "Authorization: Bearer TOKEN" "http://localhost:8000/sellers/export?format=json&run_id=RUN_ID"` - should return only sellers from that run
</verification>

<success_criteria>
- GET /sellers/export returns JSON with full seller metadata by default
- GET /sellers/export?format=csv returns proper CSV with all columns
- GET /sellers/export?run_id=X filters to sellers from that collection run
- Response headers include Content-Disposition with descriptive filename
</success_criteria>

<output>
After completion, create `.planning/phases/09-storage-export-collection-ui/09-01-SUMMARY.md`
</output>
