---
phase: 21-export-import
plan: 04
type: execute
wave: 2
depends_on: ["21-03"]
files_modified:
  - apps/web/src/components/data-management/import-dialog.tsx
  - apps/web/src/components/data-management/import-preview.tsx
  - apps/web/src/components/data-management/import-history.tsx
  - apps/web/src/components/data-management/column-mapper.tsx
  - apps/web/src/hooks/use-import-records.ts
  - apps/web/src/lib/api.ts
  - apps/web/src/components/bookkeeping/records-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can open import dialog from records toolbar"
    - "Import dialog accepts file upload via drag-drop or file picker"
    - "Import shows column mapping UI with auto-suggested mappings"
    - "User can manually adjust column mappings before commit"
    - "Import preview shows first 100 rows with validation errors highlighted"
    - "Invalid rows are clearly marked with specific error messages"
    - "Import only proceeds when all rows are valid (all-or-nothing)"
    - "Import history shows past imports with rollback button"
    - "Rollback confirmation shows warning if records were modified"
  artifacts:
    - path: "apps/web/src/components/data-management/import-dialog.tsx"
      provides: "Import wizard with file upload, mapping, preview, commit steps"
      min_lines: 150
    - path: "apps/web/src/components/data-management/import-preview.tsx"
      provides: "Preview table showing validation results"
      min_lines: 80
    - path: "apps/web/src/components/data-management/import-history.tsx"
      provides: "Import history list with rollback UI"
      min_lines: 60
    - path: "apps/web/src/components/data-management/column-mapper.tsx"
      provides: "Column mapping configuration UI"
      min_lines: 100
    - path: "apps/web/src/hooks/use-import-records.ts"
      provides: "Import mutation hooks for validation, commit, rollback"
      exports: ["useImportRecords", "useImportHistory"]
  key_links:
    - from: "apps/web/src/components/data-management/import-dialog.tsx"
      to: "apps/web/src/hooks/use-import-records.ts"
      via: "hook import"
      pattern: "useImportRecords"
    - from: "apps/web/src/hooks/use-import-records.ts"
      to: "apps/web/src/lib/api.ts"
      via: "API calls"
      pattern: "importApi"
    - from: "apps/web/src/components/bookkeeping/records-toolbar.tsx"
      to: "apps/web/src/components/data-management/import-dialog.tsx"
      via: "component import"
      pattern: "ImportDialog"
---

<objective>
Implement frontend import UI with file upload, smart column mapping, validation preview, and import history with rollback capability.

Purpose: Enable users to import data with confidence through validation preview, smart column mapping suggestions, and ability to undo imports within 24 hours.

Output:
- Import dialog with multi-step wizard (upload -> map -> preview -> confirm)
- Column mapping component with auto-suggestions and manual adjustment
- Validation preview table with error highlighting
- Import history component with rollback functionality
- Integration with records toolbar
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-export-import/21-CONTEXT.md
@.planning/phases/21-export-import/21-RESEARCH.md
@.planning/phases/21-export-import/21-03-SUMMARY.md
@apps/web/src/components/bookkeeping/records-toolbar.tsx
@apps/web/src/lib/api.ts
@apps/web/src/hooks/sync/use-sync-records.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add import API functions and types</name>
  <files>apps/web/src/lib/api.ts</files>
  <action>
Add import-related types and API functions to lib/api.ts:

**Types:**
```typescript
export type ImportFormat = 'csv' | 'json' | 'excel';

export interface ImportValidationError {
  row: number;
  field: string;
  message: string;
}

export interface ImportPreviewRow {
  row_number: number;
  data: Record<string, unknown>;
  is_valid: boolean;
  errors: ImportValidationError[];
}

export interface ImportValidationResponse {
  preview: ImportPreviewRow[];
  errors: ImportValidationError[];
  total_rows: number;
  valid_rows: number;
  suggested_mapping: Record<string, string>;
}

export interface ImportCommitResponse {
  batch_id: string;
  rows_imported: number;
}

export interface ImportBatch {
  id: string;
  account_id: string;
  filename: string;
  row_count: number;
  format: string;
  created_at: string;
  can_rollback: boolean;
  rolled_back_at: string | null;
}

export interface ImportRollbackWarning {
  warning: string;
  modified_count: number;
  modified_record_ids: string[];
  requires_confirmation: boolean;
}

export interface ImportRollbackResponse {
  success: boolean;
  rows_deleted: number;
  warning?: ImportRollbackWarning;
}

// Known importable fields
export const IMPORT_FIELDS = [
  { field: 'ebay_order_id', label: 'eBay Order ID', required: true },
  { field: 'sale_date', label: 'Sale Date', required: true },
  { field: 'item_name', label: 'Item Name', required: true },
  { field: 'qty', label: 'Quantity', required: false },
  { field: 'sale_price_cents', label: 'Sale Price (cents)', required: true },
  { field: 'ebay_fees_cents', label: 'eBay Fees (cents)', required: false },
  { field: 'amazon_price_cents', label: 'Amazon Price (cents)', required: false },
  { field: 'amazon_tax_cents', label: 'Amazon Tax (cents)', required: false },
  { field: 'amazon_shipping_cents', label: 'Amazon Shipping (cents)', required: false },
  { field: 'amazon_order_id', label: 'Amazon Order ID', required: false },
  { field: 'status', label: 'Status', required: false },
  { field: 'order_remark', label: 'Order Remark', required: false },
] as const;
```

**API functions:**
```typescript
export const importApi = {
  // Validate file and get preview with suggested mapping
  validateFile: async (file: File, format: ImportFormat): Promise<ImportValidationResponse> => {
    const formData = new FormData();
    formData.append('file', file);

    const token = await getAccessToken();
    const res = await fetch(`${API_BASE}/import/records/validate?format=${format}`, {
      method: 'POST',
      headers: {
        ...(token && { Authorization: `Bearer ${token}` }),
      },
      body: formData,
    });

    if (!res.ok) {
      const error = await res.json().catch(() => ({ detail: 'Validation failed' }));
      throw new Error(error.detail || 'Validation failed');
    }

    return res.json();
  },

  // Commit import with user-confirmed mapping
  commitImport: async (
    file: File,
    accountId: string,
    format: ImportFormat,
    columnMapping: Record<string, string>
  ): Promise<ImportCommitResponse> => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('account_id', accountId);
    formData.append('filename', file.name);
    formData.append('format', format);
    formData.append('column_mapping', JSON.stringify(columnMapping));

    const token = await getAccessToken();
    const res = await fetch(`${API_BASE}/import/records/commit`, {
      method: 'POST',
      headers: {
        ...(token && { Authorization: `Bearer ${token}` }),
      },
      body: formData,
    });

    if (!res.ok) {
      const error = await res.json().catch(() => ({ detail: 'Import failed' }));
      throw new Error(error.detail || 'Import failed');
    }

    return res.json();
  },

  // Get import history
  getImportBatches: (accountId?: string) =>
    fetchAPI<{ batches: ImportBatch[] }>(
      `/import/batches${accountId ? `?account_id=${accountId}` : ''}`
    ),

  // Get single batch details
  getImportBatch: (batchId: string) =>
    fetchAPI<ImportBatch>(`/import/batches/${batchId}`),

  // Rollback import
  rollbackImport: (batchId: string, force: boolean = false) =>
    fetchAPI<ImportRollbackResponse>(`/import/batches/${batchId}/rollback?force=${force}`, {
      method: 'POST',
    }),

  // Disable rollback
  disableRollback: (batchId: string) =>
    fetchAPI<{ ok: boolean }>(`/import/batches/${batchId}/disable-rollback`, {
      method: 'POST',
    }),
};
```

Place after the `exportApi` object.
  </action>
  <verify>
TypeScript compilation: `cd apps/web && npx tsc --noEmit` should pass
  </verify>
  <done>Import API types and functions added to api.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create import hooks</name>
  <files>apps/web/src/hooks/use-import-records.ts</files>
  <action>
Create import hooks for validation, commit, rollback, and history:

```typescript
'use client';

import { useState, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';
import {
  importApi,
  type ImportFormat,
  type ImportValidationResponse,
  type ImportCommitResponse,
  type ImportBatch,
  type ImportRollbackResponse,
} from '@/lib/api';

interface UseImportRecordsResult {
  // Validation
  validateFile: (file: File, format: ImportFormat) => Promise<ImportValidationResponse>;
  validationResult: ImportValidationResponse | null;
  isValidating: boolean;
  validationError: string | null;

  // Commit
  commitImport: (
    file: File,
    accountId: string,
    format: ImportFormat,
    columnMapping: Record<string, string>
  ) => Promise<ImportCommitResponse>;
  isCommitting: boolean;
  commitError: string | null;

  // Reset state
  reset: () => void;
}

export function useImportRecords(): UseImportRecordsResult {
  const [validationResult, setValidationResult] = useState<ImportValidationResponse | null>(null);
  const [isValidating, setIsValidating] = useState(false);
  const [validationError, setValidationError] = useState<string | null>(null);
  const [isCommitting, setIsCommitting] = useState(false);
  const [commitError, setCommitError] = useState<string | null>(null);
  const queryClient = useQueryClient();

  const validateFile = useCallback(async (file: File, format: ImportFormat) => {
    setIsValidating(true);
    setValidationError(null);
    setValidationResult(null);

    try {
      const result = await importApi.validateFile(file, format);
      setValidationResult(result);
      return result;
    } catch (err) {
      const message = err instanceof Error ? err.message : 'Validation failed';
      setValidationError(message);
      throw err;
    } finally {
      setIsValidating(false);
    }
  }, []);

  const commitImport = useCallback(async (
    file: File,
    accountId: string,
    format: ImportFormat,
    columnMapping: Record<string, string>
  ) => {
    setIsCommitting(true);
    setCommitError(null);

    try {
      const result = await importApi.commitImport(file, accountId, format, columnMapping);
      toast.success('Import successful', {
        description: `${result.rows_imported} records imported`,
      });
      // Invalidate records query to refresh list
      queryClient.invalidateQueries({ queryKey: ['records'] });
      queryClient.invalidateQueries({ queryKey: ['import-batches'] });
      return result;
    } catch (err) {
      const message = err instanceof Error ? err.message : 'Import failed';
      setCommitError(message);
      toast.error('Import failed', { description: message });
      throw err;
    } finally {
      setIsCommitting(false);
    }
  }, [queryClient]);

  const reset = useCallback(() => {
    setValidationResult(null);
    setValidationError(null);
    setCommitError(null);
  }, []);

  return {
    validateFile,
    validationResult,
    isValidating,
    validationError,
    commitImport,
    isCommitting,
    commitError,
    reset,
  };
}

interface UseImportHistoryResult {
  batches: ImportBatch[];
  isLoading: boolean;
  error: Error | null;
  rollback: (batchId: string, force?: boolean) => Promise<ImportRollbackResponse>;
  isRollingBack: boolean;
  rollbackWarning: ImportRollbackResponse['warning'] | null;
  clearWarning: () => void;
}

export function useImportHistory(accountId?: string): UseImportHistoryResult {
  const queryClient = useQueryClient();
  const [isRollingBack, setIsRollingBack] = useState(false);
  const [rollbackWarning, setRollbackWarning] = useState<ImportRollbackResponse['warning'] | null>(null);

  const { data, isLoading, error } = useQuery({
    queryKey: ['import-batches', accountId],
    queryFn: () => importApi.getImportBatches(accountId),
  });

  const rollback = useCallback(async (batchId: string, force: boolean = false) => {
    setIsRollingBack(true);
    setRollbackWarning(null);

    try {
      const result = await importApi.rollbackImport(batchId, force);

      if (result.warning) {
        setRollbackWarning(result.warning);
        return result;
      }

      if (result.success) {
        toast.success('Rollback complete', {
          description: `${result.rows_deleted} records removed`,
        });
        queryClient.invalidateQueries({ queryKey: ['records'] });
        queryClient.invalidateQueries({ queryKey: ['import-batches'] });
      }

      return result;
    } catch (err) {
      const message = err instanceof Error ? err.message : 'Rollback failed';
      toast.error('Rollback failed', { description: message });
      throw err;
    } finally {
      setIsRollingBack(false);
    }
  }, [queryClient]);

  const clearWarning = useCallback(() => {
    setRollbackWarning(null);
  }, []);

  return {
    batches: data?.batches ?? [],
    isLoading,
    error: error as Error | null,
    rollback,
    isRollingBack,
    rollbackWarning,
    clearWarning,
  };
}
```
  </action>
  <verify>
TypeScript compilation: `cd apps/web && npx tsc --noEmit` should pass
  </verify>
  <done>Import hooks created for validation, commit, history, and rollback</done>
</task>

<task type="auto">
  <name>Task 3: Create import UI components and integrate with toolbar</name>
  <files>
    apps/web/src/components/data-management/column-mapper.tsx
    apps/web/src/components/data-management/import-preview.tsx
    apps/web/src/components/data-management/import-history.tsx
    apps/web/src/components/data-management/import-dialog.tsx
    apps/web/src/components/bookkeeping/records-toolbar.tsx
  </files>
  <action>
**Create apps/web/src/components/data-management/column-mapper.tsx:**

Column mapping configuration component:
- Props: headers (from file), suggestedMapping, onMappingChange
- Show table with:
  - File column header (from CSV/Excel)
  - Arrow icon
  - Dropdown to select target DB field (from IMPORT_FIELDS)
  - Auto-mapped indicator (checkmark) if suggested
  - "Skip this column" option in dropdown
- Highlight required fields that are not yet mapped
- Show validation: "3 required fields mapped, 2 missing"

**Create apps/web/src/components/data-management/import-preview.tsx:**

Validation preview table:
- Props: preview (ImportPreviewRow[]), totalRows, validRows
- Show summary: "100 rows previewed, 95 valid, 5 with errors"
- Table showing:
  - Row number
  - Mapped data columns
  - Status (checkmark for valid, X for invalid)
  - Error details (tooltip or expandable row)
- Invalid rows highlighted in red/warning color
- Scroll container for large preview

**Create apps/web/src/components/data-management/import-history.tsx:**

Import history with rollback:
- Props: accountId
- Use useImportHistory hook
- List showing:
  - Filename
  - Row count
  - Date imported
  - Rollback button (if can_rollback is true)
  - "Rolled back" badge (if rolled_back_at is set)
- Rollback confirmation dialog:
  - If warning returned, show modified records warning
  - "Force rollback" option
  - Cancel/Confirm buttons

**Create apps/web/src/components/data-management/import-dialog.tsx:**

Multi-step import wizard dialog:
- Step 1: File Upload
  - Drag-drop zone (use existing pattern or react-dropzone)
  - Supported formats: CSV, JSON, Excel
  - Auto-detect format from extension
  - Click "Validate" to proceed

- Step 2: Column Mapping
  - Show ColumnMapper component
  - User can adjust auto-suggested mappings
  - Validation: all required fields must be mapped
  - "Next" button (disabled until required fields mapped)

- Step 3: Preview & Confirm
  - Show ImportPreview component
  - If errors: show "Cannot proceed - fix errors in source file"
  - If all valid: show "Import" button
  - All-or-nothing: button disabled if ANY row invalid

- Navigation: Back/Next buttons, step indicator

**Update apps/web/src/components/bookkeeping/records-toolbar.tsx:**

Add import button:
1. Import ImportDialog component
2. Add state for import dialog open/close
3. Add "Import" button next to Export button (use Upload icon from lucide-react)
4. Render ImportDialog with current accountId
5. Also add small link/button to open import history (or include in dialog)

Use shadcn/ui components: Dialog, Select, Table, Button, Badge
Match existing component patterns from add-record-dialog.tsx and export-dialog.tsx
  </action>
  <verify>
1. TypeScript compilation: `cd apps/web && npx tsc --noEmit` should pass
2. Start dev server: `cd apps/web && npm run dev`
3. Navigate to bookkeeping page - Import button should appear in toolbar
4. Click Import - dialog should open with file upload step
5. Upload CSV - should show column mapping step
6. Adjust mapping - should show preview step
7. Check import history shows past imports with rollback option
  </verify>
  <done>Import dialog with multi-step wizard integrated into records toolbar</done>
</task>

</tasks>

<verification>
1. Import button visible in records toolbar
2. Import dialog opens with file upload (drag-drop works)
3. Column mapping shows suggestions and allows manual adjustment
4. Preview shows validation status for each row
5. Invalid rows clearly highlighted with error messages
6. Import blocked when any row is invalid
7. Successful import shows toast and refreshes record list
8. Import history shows past imports
9. Rollback works and soft-deletes records
10. Rollback warning shown when records were modified
</verification>

<success_criteria>
- Import dialog accepts file upload via drag-drop
- Column mapping UI shows auto-suggested mappings
- User can manually adjust column mappings
- Preview shows first 100 rows with validation errors highlighted
- Import only proceeds when all rows are valid
- Import history shows past imports with rollback button
- Rollback confirmation shows warning if records modified
</success_criteria>

<output>
After completion, create `.planning/phases/21-export-import/21-04-SUMMARY.md`
</output>
