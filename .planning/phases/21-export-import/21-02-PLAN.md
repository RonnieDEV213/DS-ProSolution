---
phase: 21-export-import
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - apps/web/src/components/data-management/export-dialog.tsx
  - apps/web/src/components/data-management/export-progress.tsx
  - apps/web/src/hooks/use-export-records.ts
  - apps/web/src/hooks/use-export-notification.ts
  - apps/web/src/lib/api.ts
  - apps/web/src/components/bookkeeping/records-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can open export dialog from records toolbar"
    - "Export dialog shows column selection checkboxes with preset groups"
    - "User can select export format (CSV, JSON, Excel)"
    - "Export progress shows row count being processed"
    - "Large exports trigger background job with browser notification when complete"
    - "Download link appears in toast/notification when export finishes"
  artifacts:
    - path: "apps/web/src/components/data-management/export-dialog.tsx"
      provides: "Export configuration dialog with column selection and format picker"
      min_lines: 100
    - path: "apps/web/src/components/data-management/export-progress.tsx"
      provides: "Export progress indicator component"
      min_lines: 40
    - path: "apps/web/src/hooks/use-export-records.ts"
      provides: "Export mutation hook for streaming and background exports"
      exports: ["useExportRecords"]
    - path: "apps/web/src/hooks/use-export-notification.ts"
      provides: "Browser notification hook for background exports"
      exports: ["useExportNotification"]
  key_links:
    - from: "apps/web/src/components/data-management/export-dialog.tsx"
      to: "apps/web/src/hooks/use-export-records.ts"
      via: "hook import"
      pattern: "useExportRecords"
    - from: "apps/web/src/hooks/use-export-records.ts"
      to: "apps/web/src/lib/api.ts"
      via: "API calls"
      pattern: "api\\.export"
    - from: "apps/web/src/components/bookkeeping/records-toolbar.tsx"
      to: "apps/web/src/components/data-management/export-dialog.tsx"
      via: "component import"
      pattern: "ExportDialog"
---

<objective>
Implement frontend export UI with column selection dialog, format picker, progress indicator, and browser notifications for background exports.

Purpose: Enable users to configure and monitor exports with clear progress feedback, including notifications when background exports complete.

Output:
- Export dialog component with column selection and format picker
- Export progress component showing row count
- Export hook managing streaming downloads and background job polling
- Browser notification hook for background export completion
- Integration with existing records toolbar
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-export-import/21-CONTEXT.md
@.planning/phases/21-export-import/21-RESEARCH.md
@.planning/phases/21-export-import/21-01-SUMMARY.md
@apps/web/src/components/bookkeeping/records-toolbar.tsx
@apps/web/src/lib/api.ts
@apps/web/src/hooks/sync/use-sync-records.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export API functions and types</name>
  <files>apps/web/src/lib/api.ts</files>
  <action>
Add export-related types and API functions to lib/api.ts:

**Types:**
```typescript
export type ExportFormat = 'csv' | 'json' | 'excel';

export interface ExportParams {
  account_id: string;
  format: ExportFormat;
  columns?: string[];
  status?: BookkeepingStatus;
  date_from?: string;
  date_to?: string;
}

export interface ExportJobStatus {
  job_id: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  row_count: number | null;
  file_url: string | null;
  error: string | null;
  created_at: string;
  completed_at: string | null;
}

export const EXPORT_COLUMNS = {
  essential: ['ebay_order_id', 'sale_date', 'item_name', 'sale_price_cents', 'status'],
  financial: ['ebay_order_id', 'sale_date', 'item_name', 'sale_price_cents', 'ebay_fees_cents', 'earnings_net_cents', 'amazon_price_cents', 'amazon_tax_cents', 'amazon_shipping_cents', 'cogs_total_cents', 'return_label_cost_cents', 'profit_cents', 'status'],
  all: ['id', 'ebay_order_id', 'sale_date', 'item_name', 'qty', 'sale_price_cents', 'ebay_fees_cents', 'earnings_net_cents', 'amazon_price_cents', 'amazon_tax_cents', 'amazon_shipping_cents', 'cogs_total_cents', 'amazon_order_id', 'status', 'return_label_cost_cents', 'profit_cents', 'order_remark', 'service_remark'],
} as const;

export const COLUMN_LABELS: Record<string, string> = {
  id: 'ID',
  ebay_order_id: 'eBay Order ID',
  sale_date: 'Sale Date',
  item_name: 'Item Name',
  qty: 'Quantity',
  sale_price_cents: 'Sale Price',
  ebay_fees_cents: 'eBay Fees',
  earnings_net_cents: 'Earnings Net',
  amazon_price_cents: 'Amazon Price',
  amazon_tax_cents: 'Amazon Tax',
  amazon_shipping_cents: 'Amazon Shipping',
  cogs_total_cents: 'COGS Total',
  amazon_order_id: 'Amazon Order ID',
  status: 'Status',
  return_label_cost_cents: 'Return Label Cost',
  profit_cents: 'Profit',
  order_remark: 'Order Remark',
  service_remark: 'Service Remark',
};
```

**API functions:**
```typescript
export const exportApi = {
  // Streaming exports (direct download)
  getExportUrl: (params: ExportParams): string => {
    const searchParams = new URLSearchParams();
    searchParams.set('account_id', params.account_id);
    if (params.columns?.length) searchParams.set('columns', params.columns.join(','));
    if (params.status) searchParams.set('status', params.status);
    if (params.date_from) searchParams.set('date_from', params.date_from);
    if (params.date_to) searchParams.set('date_to', params.date_to);
    return `${API_BASE}/export/records/${params.format}?${searchParams}`;
  },

  // Background export (returns job ID)
  createBackgroundExport: (params: ExportParams) =>
    fetchAPI<{ job_id: string; status: string }>('/export/records/background', {
      method: 'POST',
      body: JSON.stringify(params),
    }),

  // Poll job status
  getJobStatus: (jobId: string) =>
    fetchAPI<ExportJobStatus>(`/export/jobs/${jobId}`),

  // List user's export jobs
  getExportJobs: () =>
    fetchAPI<{ jobs: ExportJobStatus[] }>('/export/jobs'),
};
```

Place after the existing `automationApi` object.
  </action>
  <verify>
TypeScript compilation: `cd apps/web && npx tsc --noEmit` should pass
  </verify>
  <done>Export API types and functions added to api.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create export hooks</name>
  <files>apps/web/src/hooks/use-export-records.ts, apps/web/src/hooks/use-export-notification.ts</files>
  <action>
**Create apps/web/src/hooks/use-export-notification.ts:**

Browser notification hook for background exports:
```typescript
'use client';

import { useEffect, useState, useCallback } from 'react';
import { toast } from 'sonner';

export function useExportNotification() {
  const [permission, setPermission] = useState<NotificationPermission>('default');

  useEffect(() => {
    if ('Notification' in window) {
      setPermission(Notification.permission);
    }
  }, []);

  const requestPermission = useCallback(async () => {
    if ('Notification' in window && permission === 'default') {
      const result = await Notification.requestPermission();
      setPermission(result);
      return result;
    }
    return permission;
  }, [permission]);

  const notifyExportComplete = useCallback((downloadUrl: string, filename: string) => {
    // If tab is active, show toast
    if (document.visibilityState === 'visible') {
      toast.success('Export complete', {
        description: `${filename} is ready to download`,
        action: {
          label: 'Download',
          onClick: () => window.open(downloadUrl, '_blank'),
        },
        duration: 10000,
      });
    }
    // If tab is backgrounded and permission granted, show browser notification
    else if (permission === 'granted') {
      const notification = new Notification('Export complete', {
        body: `${filename} is ready to download`,
        icon: '/favicon.ico',
        tag: 'export-complete',
        requireInteraction: true,
      });

      notification.onclick = () => {
        window.focus();
        window.open(downloadUrl, '_blank');
        notification.close();
      };
    }
  }, [permission]);

  const notifyExportFailed = useCallback((error: string) => {
    toast.error('Export failed', {
      description: error,
      duration: 8000,
    });
  }, []);

  return { permission, requestPermission, notifyExportComplete, notifyExportFailed };
}
```

**Create apps/web/src/hooks/use-export-records.ts:**

Export mutation hook:
```typescript
'use client';

import { useState, useCallback, useRef, useEffect } from 'react';
import { exportApi, type ExportParams, type ExportJobStatus } from '@/lib/api';
import { useExportNotification } from './use-export-notification';
import { createClient } from '@/lib/supabase/client';

interface UseExportRecordsResult {
  // Streaming export (direct download)
  startStreamingExport: (params: ExportParams) => Promise<void>;
  // Background export (for large datasets)
  startBackgroundExport: (params: ExportParams) => Promise<string>;
  // Current job status (for background exports)
  currentJob: ExportJobStatus | null;
  isExporting: boolean;
  error: string | null;
}

export function useExportRecords(): UseExportRecordsResult {
  const [isExporting, setIsExporting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentJob, setCurrentJob] = useState<ExportJobStatus | null>(null);
  const pollIntervalRef = useRef<NodeJS.Timeout | null>(null);
  const { requestPermission, notifyExportComplete, notifyExportFailed } = useExportNotification();

  // Clean up polling on unmount
  useEffect(() => {
    return () => {
      if (pollIntervalRef.current) {
        clearInterval(pollIntervalRef.current);
      }
    };
  }, []);

  const startStreamingExport = useCallback(async (params: ExportParams) => {
    setIsExporting(true);
    setError(null);

    try {
      // Get auth token for download
      const supabase = createClient();
      const { data: { session } } = await supabase.auth.getSession();
      const token = session?.access_token;

      if (!token) {
        throw new Error('Not authenticated');
      }

      // Build URL with auth
      const url = exportApi.getExportUrl(params);

      // Trigger download
      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (!response.ok) {
        throw new Error('Export failed');
      }

      // Create blob and download
      const blob = await response.blob();
      const downloadUrl = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `records-${params.account_id}.${params.format}`;
      link.click();
      URL.revokeObjectURL(downloadUrl);

    } catch (err) {
      const message = err instanceof Error ? err.message : 'Export failed';
      setError(message);
      notifyExportFailed(message);
    } finally {
      setIsExporting(false);
    }
  }, [notifyExportFailed]);

  const pollJobStatus = useCallback(async (jobId: string) => {
    try {
      const status = await exportApi.getJobStatus(jobId);
      setCurrentJob(status);

      if (status.status === 'completed' && status.file_url) {
        // Stop polling
        if (pollIntervalRef.current) {
          clearInterval(pollIntervalRef.current);
          pollIntervalRef.current = null;
        }
        setIsExporting(false);
        notifyExportComplete(status.file_url, `export-${jobId}.${status.file_url.split('.').pop()}`);
      } else if (status.status === 'failed') {
        // Stop polling
        if (pollIntervalRef.current) {
          clearInterval(pollIntervalRef.current);
          pollIntervalRef.current = null;
        }
        setIsExporting(false);
        setError(status.error || 'Export failed');
        notifyExportFailed(status.error || 'Export failed');
      }
    } catch (err) {
      console.error('Failed to poll job status:', err);
    }
  }, [notifyExportComplete, notifyExportFailed]);

  const startBackgroundExport = useCallback(async (params: ExportParams): Promise<string> => {
    setIsExporting(true);
    setError(null);
    setCurrentJob(null);

    // Request notification permission for background exports
    await requestPermission();

    try {
      const result = await exportApi.createBackgroundExport(params);
      const jobId = result.job_id;

      // Start polling for status
      setCurrentJob({
        job_id: jobId,
        status: 'pending',
        row_count: null,
        file_url: null,
        error: null,
        created_at: new Date().toISOString(),
        completed_at: null,
      });

      // Poll every 2 seconds
      pollIntervalRef.current = setInterval(() => pollJobStatus(jobId), 2000);

      return jobId;
    } catch (err) {
      const message = err instanceof Error ? err.message : 'Failed to start export';
      setError(message);
      setIsExporting(false);
      throw err;
    }
  }, [requestPermission, pollJobStatus]);

  return {
    startStreamingExport,
    startBackgroundExport,
    currentJob,
    isExporting,
    error,
  };
}
```
  </action>
  <verify>
TypeScript compilation: `cd apps/web && npx tsc --noEmit` should pass
  </verify>
  <done>Export hooks created for streaming and background exports</done>
</task>

<task type="auto">
  <name>Task 3: Create export dialog and progress components</name>
  <files>apps/web/src/components/data-management/export-dialog.tsx, apps/web/src/components/data-management/export-progress.tsx, apps/web/src/components/bookkeeping/records-toolbar.tsx</files>
  <action>
**Create apps/web/src/components/data-management/export-progress.tsx:**

Progress indicator showing export status:
- Props: job (ExportJobStatus | null), isExporting (boolean)
- Shows spinner when exporting
- Shows row count when processing (if available)
- Shows download button when complete
- Shows error message on failure

**Create apps/web/src/components/data-management/export-dialog.tsx:**

Export configuration dialog with:
1. Format selector (radio group): CSV, JSON, Excel
2. Column selection with preset groups:
   - "Essential" preset (order ID, date, item, price, status)
   - "Financial" preset (+ profit, fees, costs)
   - "All Columns" preset
   - Individual checkboxes for fine-grained control
3. Optional filters section (collapsed by default):
   - Status filter dropdown
   - Date range picker (from/to)
4. Threshold info: "Exports over 10,000 rows will run in background"
5. Export button (disabled while exporting)
6. Inline ExportProgress component when job is active

Props:
- open: boolean
- onOpenChange: (open: boolean) => void
- accountId: string
- totalRecords: number (to decide streaming vs background)

Use shadcn/ui components: Dialog, RadioGroup, Checkbox, Button, Collapsible
Use existing patterns from record-row.tsx and add-record-dialog.tsx

**Update apps/web/src/components/bookkeeping/records-toolbar.tsx:**

Add export button to toolbar:
1. Import ExportDialog
2. Add state for dialog open/close
3. Add "Export" button next to existing buttons
4. Render ExportDialog with current accountId and totalCount from useSyncRecords

The export button should show a Download icon (from lucide-react).
  </action>
  <verify>
1. TypeScript compilation: `cd apps/web && npx tsc --noEmit` should pass
2. Start dev server: `cd apps/web && npm run dev`
3. Navigate to bookkeeping page - Export button should appear in toolbar
4. Click Export - dialog should open with column selection and format options
  </verify>
  <done>Export dialog integrated into records toolbar with column selection and format picker</done>
</task>

</tasks>

<verification>
1. Export button visible in records toolbar
2. Export dialog opens with format selection (CSV, JSON, Excel)
3. Column presets work (Essential, Financial, All)
4. Individual column checkboxes toggle correctly
5. Streaming export downloads file immediately for small datasets
6. Background export shows progress and notifies when complete
7. Browser notification appears when tab is backgrounded (after permission granted)
</verification>

<success_criteria>
- Export dialog allows column selection before export
- Export shows progress indicator with row count (for background exports)
- Large exports trigger background job
- Browser notification includes download link when export completes
- All three formats (CSV, JSON, Excel) can be downloaded
</success_criteria>

<output>
After completion, create `.planning/phases/21-export-import/21-02-SUMMARY.md`
</output>
