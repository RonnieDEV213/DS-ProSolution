---
phase: 03-extension-auth-flow
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/extension/sidepanel.html
  - packages/extension/sidepanel.js
  - packages/extension/sidepanel.css
autonomous: false

must_haves:
  truths:
    - "Extension shows Clock In form after pairing approval"
    - "Extension shows loading overlay during validation"
    - "Extension shows inline error messages on validation failure"
    - "Clock Out button visible in hub when clocked in"
    - "Inactivity warning displayed when 5 minutes remaining"
  artifacts:
    - path: "packages/extension/sidepanel.html"
      provides: "Clock In section, validating overlay, clocked-out section, Clock Out button in hub"
      contains: "clock-in-section"
    - path: "packages/extension/sidepanel.js"
      provides: "Clock in form handler, overlay management, error display, inactivity warning"
      exports: ["handleClockInSubmit", "showClockInError"]
    - path: "packages/extension/sidepanel.css"
      provides: "Clock in form styles, overlay styles, warning toast styles"
      contains: "clock-in-section"
  key_links:
    - from: "sidepanel.js clock-in submit"
      to: "service-worker.js CLOCK_IN handler"
      via: "port.postMessage"
      pattern: "postMessage.*CLOCK_IN"
    - from: "service-worker.js CLOCK_IN_SUCCESS"
      to: "sidepanel.js render"
      via: "port.onMessage listener"
      pattern: "CLOCK_IN_SUCCESS"
---

<objective>
Add Clock In UI to the extension side panel with form, validation overlay, error messages, and Clock Out button.

Purpose: Implements UI for EXT-01/EXT-03 - prompts for access code after pairing approval, shows validation feedback, and provides Clock Out button for session management.

Output: Side panel with clock-in form, loading overlay, error handling, inactivity warning, and Clock Out capability.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-extension-auth-flow/03-CONTEXT.md
@.planning/phases/03-extension-auth-flow/03-RESEARCH.md
@.planning/phases/03-extension-auth-flow/03-01-SUMMARY.md
@packages/extension/sidepanel.html
@packages/extension/sidepanel.js
@packages/extension/sidepanel.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Clock In section and validating overlay to HTML</name>
  <files>packages/extension/sidepanel.html</files>
  <action>
    Add new sections between the auto-approved section and the hub section:

    1. Clock In section (shown after pairing approval, before main hub):

    ```html
    <!-- Clock In Section (after pairing approved, before hub access) -->
    <section id="clock-in-section" class="section hidden">
      <h2>Clock In</h2>
      <div class="clock-in-form">
        <div class="input-group">
          <input
            type="password"
            id="access-code-input"
            placeholder="Enter access code"
            autocomplete="off"
            spellcheck="false"
          />
          <button id="btn-toggle-code-visibility" class="btn-icon" title="Show/hide code">
            <span class="icon-eye">&#128065;</span>
          </button>
        </div>
        <button id="btn-clock-in" class="btn btn-primary btn-full">Clock In</button>
        <div id="clock-in-error" class="error hidden"></div>
      </div>
    </section>
    ```

    2. Clocked Out section (shown after inactivity timeout or code rotation):

    ```html
    <!-- Clocked Out Section (after inactivity or manual clock out) -->
    <section id="clocked-out-section" class="section hidden">
      <h2>Session Ended</h2>
      <div class="clocked-out-state">
        <p id="clocked-out-message">You have been clocked out.</p>
        <button id="btn-clock-in-again" class="btn btn-primary btn-full">Clock In Again</button>
      </div>
    </section>
    ```

    3. Validating Overlay (full-screen overlay during validation):

    ```html
    <!-- Validating Overlay -->
    <div id="validating-overlay" class="overlay hidden">
      <div class="overlay-content">
        <div class="spinner"></div>
        <p>Clocking in...</p>
      </div>
    </div>

    <!-- Inactivity Warning Toast -->
    <div id="inactivity-warning" class="warning-toast hidden">
      <span class="warning-icon">&#9888;</span>
      <span>Session expiring in <strong id="warning-minutes">5</strong> minutes</span>
      <button id="btn-dismiss-warning" class="btn-icon" title="Dismiss">&#10005;</button>
    </div>
    ```

    4. Add Clock Out button to the hub section. Insert into the Quick Actions section (after the action-buttons div):

    ```html
    <div class="action-buttons session-actions" style="margin-top: 12px;">
      <button id="btn-clock-out" class="btn btn-danger btn-full">Clock Out</button>
    </div>
    ```

    Note: Place the overlay and warning toast OUTSIDE the #app div, directly in the body before the script tag, so they can cover the entire viewport.
  </action>
  <verify>Read the HTML file and confirm clock-in-section, clocked-out-section, validating-overlay, inactivity-warning, and btn-clock-out elements exist.</verify>
  <done>HTML updated with clock-in form, clocked-out section, validating overlay, inactivity warning toast, and Clock Out button in hub.</done>
</task>

<task type="auto">
  <name>Task 2: Add CSS styles for clock-in UI and overlay</name>
  <files>packages/extension/sidepanel.css</files>
  <action>
    Add styles at the end of the CSS file:

    ```css
    /* ============================================
       CLOCK IN / CLOCK OUT STYLES
       ============================================ */

    /* Clock In Form */
    .clock-in-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .clock-in-form .input-group {
      position: relative;
    }

    .clock-in-form .input-group input {
      width: 100%;
      padding: 12px 44px 12px 12px;
      font-size: 15px;
      letter-spacing: 2px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
    }

    .clock-in-form .input-group input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .clock-in-form .input-group input::placeholder {
      letter-spacing: normal;
    }

    .btn-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 16px;
    }

    .btn-icon:hover {
      color: var(--text-secondary);
    }

    /* Clocked Out State */
    .clocked-out-state {
      text-align: center;
      padding: 20px 0;
    }

    .clocked-out-state p {
      margin-bottom: 16px;
      color: var(--text-secondary);
    }

    /* Validating Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 15, 15, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .overlay-content {
      text-align: center;
    }

    .overlay-content p {
      margin-top: 12px;
      color: var(--text-secondary);
    }

    /* Inactivity Warning Toast */
    .warning-toast {
      position: fixed;
      bottom: 16px;
      left: 12px;
      right: 12px;
      background: var(--accent-yellow);
      color: black;
      padding: 12px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .warning-toast .warning-icon {
      font-size: 18px;
    }

    .warning-toast span {
      flex: 1;
      font-size: 13px;
    }

    .warning-toast .btn-icon {
      position: static;
      transform: none;
      color: rgba(0, 0, 0, 0.6);
      padding: 4px;
    }

    .warning-toast .btn-icon:hover {
      color: black;
    }

    /* Session Actions in Hub */
    .session-actions {
      border-top: 1px solid var(--border-color);
      padding-top: 12px;
    }
    ```
  </action>
  <verify>Read the CSS file and confirm styles for .clock-in-form, .overlay, .warning-toast, .clocked-out-state exist.</verify>
  <done>CSS styles added for clock-in form, validating overlay, inactivity warning toast, and clocked-out state.</done>
</task>

<task type="auto">
  <name>Task 3: Add clock-in/out logic to side panel JavaScript</name>
  <files>packages/extension/sidepanel.js</files>
  <action>
    1. Add new element references to the elements object:

    ```javascript
    // Clock In
    clockInSection: document.getElementById('clock-in-section'),
    accessCodeInput: document.getElementById('access-code-input'),
    btnToggleCodeVisibility: document.getElementById('btn-toggle-code-visibility'),
    btnClockIn: document.getElementById('btn-clock-in'),
    clockInError: document.getElementById('clock-in-error'),

    // Clocked Out
    clockedOutSection: document.getElementById('clocked-out-section'),
    clockedOutMessage: document.getElementById('clocked-out-message'),
    btnClockInAgain: document.getElementById('btn-clock-in-again'),

    // Overlay and Warning
    validatingOverlay: document.getElementById('validating-overlay'),
    inactivityWarning: document.getElementById('inactivity-warning'),
    warningMinutes: document.getElementById('warning-minutes'),
    btnDismissWarning: document.getElementById('btn-dismiss-warning'),

    // Hub Clock Out
    btnClockOut: document.getElementById('btn-clock-out'),
    ```

    2. Update hideAllSections() to include new sections:

    ```javascript
    elements.clockInSection?.classList.add('hidden');
    elements.clockedOutSection?.classList.add('hidden');
    elements.validatingOverlay?.classList.add('hidden');
    elements.inactivityWarning?.classList.add('hidden');
    ```

    3. Update showSection() map to include new sections:

    ```javascript
    clockIn: elements.clockInSection,
    clockedOut: elements.clockedOutSection,
    ```

    4. Update render() function to handle auth states. Replace the existing paired check with:

    ```javascript
    // State machine priority:
    // 1. If paired AND clocked_in -> show hub
    // 2. If paired AND needs_clock_in -> show clock-in
    // 3. If paired AND clocked_out -> show clocked-out
    // 4. If not paired -> show pairing flow

    if (currentState.paired) {
      if (currentState.auth_state === 'clocked_in') {
        showSection('hub');
        renderHub();
      } else if (currentState.auth_state === 'clocked_out') {
        showSection('clockedOut');
        renderClockedOut();
      } else {
        // needs_clock_in or null (fallback to clock-in)
        showSection('clockIn');
        renderClockIn();
      }
    } else {
      renderPairingFlow();
    }
    ```

    5. Add renderClockIn() function:

    ```javascript
    function renderClockIn() {
      // Clear any previous input and errors
      if (elements.accessCodeInput) {
        elements.accessCodeInput.value = '';
      }
      if (elements.clockInError) {
        elements.clockInError.textContent = '';
        elements.clockInError.classList.add('hidden');
      }
    }
    ```

    6. Add renderClockedOut() function:

    ```javascript
    function renderClockedOut() {
      const messages = {
        'manual': 'You have clocked out.',
        'inactivity': 'Clocked out due to inactivity.',
        'code_rotated': 'Your access code was changed. Please clock in again.',
        'token_expired': 'Your session has expired. Please clock in again.',
      };

      const reason = currentState.clock_out_reason || 'manual';
      if (elements.clockedOutMessage) {
        elements.clockedOutMessage.textContent = messages[reason] || messages.manual;
      }
    }
    ```

    7. Add message handling for clock-in flow in handleMessage():

    ```javascript
    case 'CLOCK_IN_STARTED':
      elements.validatingOverlay?.classList.remove('hidden');
      break;

    case 'CLOCK_IN_SUCCESS':
      elements.validatingOverlay?.classList.add('hidden');
      // State update will trigger render() which shows hub
      break;

    case 'CLOCK_IN_FAILED':
      elements.validatingOverlay?.classList.add('hidden');
      showClockInError(msg.error_code, msg.message, msg.retry_after);
      break;

    case 'INACTIVITY_WARNING':
      showInactivityWarning(msg.minutes_remaining);
      break;
    ```

    8. Add showClockInError() function:

    ```javascript
    function showClockInError(errorCode, message, retryAfter) {
      const errorMessages = {
        INVALID_CODE: 'Invalid access code',
        CODE_EXPIRED: 'Access code has expired. Generate a new one from your profile.',
        RATE_LIMITED: retryAfter ? `Too many attempts. Please wait ${retryAfter} seconds.` : 'Too many attempts. Please try again later.',
        ACCOUNT_DISABLED: 'Account is suspended. Contact an administrator.',
        NETWORK_ERROR: 'Connection error. Check your internet and try again.',
      };

      const displayMessage = errorMessages[errorCode] || message || 'Validation failed';

      if (elements.clockInError) {
        elements.clockInError.textContent = displayMessage;
        elements.clockInError.classList.remove('hidden');
      }

      // Clear input on error (user starts fresh)
      if (elements.accessCodeInput) {
        elements.accessCodeInput.value = '';
        elements.accessCodeInput.focus();
      }
    }
    ```

    9. Add showInactivityWarning() function:

    ```javascript
    function showInactivityWarning(minutes) {
      if (elements.warningMinutes) {
        elements.warningMinutes.textContent = minutes;
      }
      elements.inactivityWarning?.classList.remove('hidden');
    }
    ```

    10. Add event listeners at the bottom (in the EVENT LISTENERS section):

    ```javascript
    // Clock In form submit
    elements.btnClockIn?.addEventListener('click', () => {
      const code = elements.accessCodeInput?.value?.trim();
      if (!code) {
        showClockInError('INVALID_CODE', 'Please enter your access code');
        return;
      }
      // Clear any previous errors
      elements.clockInError?.classList.add('hidden');
      // Send to service worker
      send('CLOCK_IN', { code });
    });

    // Enter key submits clock-in form
    elements.accessCodeInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        elements.btnClockIn?.click();
      }
    });

    // Toggle code visibility
    elements.btnToggleCodeVisibility?.addEventListener('click', () => {
      if (elements.accessCodeInput) {
        const isPassword = elements.accessCodeInput.type === 'password';
        elements.accessCodeInput.type = isPassword ? 'text' : 'password';
      }
    });

    // Clock In Again button (from clocked out state)
    elements.btnClockInAgain?.addEventListener('click', () => {
      // Transition to clock-in section
      hideAllSections();
      showSection('clockIn');
      renderClockIn();
    });

    // Clock Out button in hub
    elements.btnClockOut?.addEventListener('click', () => {
      send('CLOCK_OUT');
    });

    // Dismiss inactivity warning
    elements.btnDismissWarning?.addEventListener('click', () => {
      elements.inactivityWarning?.classList.add('hidden');
      // Reset activity timer when user acknowledges warning
      send('RESET_ACTIVITY');
    });
    ```

    11. Add activity tracking for user interaction. Add near the bottom of the file:

    ```javascript
    // Track user activity to reset inactivity timer
    document.addEventListener('click', () => {
      if (currentState?.auth_state === 'clocked_in') {
        send('RESET_ACTIVITY');
      }
    });

    document.addEventListener('keydown', () => {
      if (currentState?.auth_state === 'clocked_in') {
        send('RESET_ACTIVITY');
      }
    });
    ```
  </action>
  <verify>
    Read the JS file and confirm:
    1. Element references for clock-in, clocked-out sections, overlay, warning exist
    2. hideAllSections and showSection handle new sections
    3. render() handles auth_state (clocked_in, clocked_out, needs_clock_in)
    4. handleMessage handles CLOCK_IN_STARTED, CLOCK_IN_SUCCESS, CLOCK_IN_FAILED, INACTIVITY_WARNING
    5. Event listeners for btnClockIn, btnClockInAgain, btnClockOut, btnDismissWarning, btnToggleCodeVisibility
    6. Activity tracking listeners for click and keydown
  </verify>
  <done>Side panel JavaScript handles clock-in flow, displays overlay during validation, shows errors, renders clocked-out state, and handles inactivity warning.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete clock-in flow in the Chrome extension side panel</what-built>
  <how-to-verify>
    1. Load the extension in Chrome (chrome://extensions, Developer mode, Load unpacked from packages/extension)
    2. Open the side panel on an eBay or Amazon tab
    3. Complete the pairing flow (Request Access, wait for approval)
    4. After pairing approval, confirm you see the "Clock In" section with:
       - Password input field for access code
       - Eye icon button to toggle visibility
       - "Clock In" button
    5. Enter an invalid code and click Clock In:
       - Confirm loading overlay appears briefly
       - Confirm error message appears below input
       - Confirm input is cleared
    6. Enter a valid access code (generate one from web app Profile > Security):
       - Confirm loading overlay appears
       - Confirm you transition to the hub view
       - Confirm "Clock Out" button is visible in Quick Actions
    7. Click "Clock Out":
       - Confirm you see "Session Ended" section
       - Confirm appropriate message displayed
       - Confirm "Clock In Again" button works
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. Extension shows clock-in form after pairing approval
2. Loading overlay appears during validation
3. Error messages display inline below input
4. Invalid code clears input and shows error
5. Valid code transitions to hub with Clock Out button
6. Clock Out returns to clocked-out section with reason message
7. Clock In Again returns to clock-in form
8. Inactivity warning appears (test by modifying INACTIVITY_TIMEOUT_MS temporarily)
</verification>

<success_criteria>
- Clock In section with password input and toggle visibility
- Validating overlay with spinner during backend call
- Error messages for INVALID_CODE, RATE_LIMITED, NETWORK_ERROR, etc.
- Hub shows Clock Out button when clocked in
- Clocked Out section shows reason-specific message
- Inactivity warning toast appears 5 minutes before timeout
- Activity tracking resets inactivity timer on user interaction
</success_criteria>

<output>
After completion, create `.planning/phases/03-extension-auth-flow/03-02-SUMMARY.md`
</output>
