---
phase: 22-theme-foundation-color-token-migration
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - apps/web/src/components/providers/theme-provider.tsx
  - apps/web/src/app/layout.tsx
  - apps/web/package.json
autonomous: false

must_haves:
  truths:
    - "next-themes is installed and listed in package.json dependencies"
    - "ThemeProvider wraps the entire application in root layout.tsx"
    - "HTML element has suppressHydrationWarning attribute"
    - "Hardcoded className='dark' is removed from HTML element"
    - "ThemeProvider uses attribute='data-theme' for CSS variable cascade"
    - "Application loads in dark theme without flash of unstyled/wrong-theme content"
    - "data-theme attribute appears on <html> element in browser DevTools"
    - "Switching data-theme attribute in DevTools changes all token-aware colors without page reload"
  artifacts:
    - path: "apps/web/src/components/providers/theme-provider.tsx"
      provides: "Client component wrapper for next-themes ThemeProvider"
      exports: ["ThemeProvider"]
      min_lines: 10
    - path: "apps/web/src/app/layout.tsx"
      provides: "Root layout with ThemeProvider wrapper and suppressHydrationWarning"
      contains: "ThemeProvider"
    - path: "apps/web/package.json"
      provides: "next-themes dependency"
      contains: "next-themes"
  key_links:
    - from: "apps/web/src/app/layout.tsx"
      to: "apps/web/src/components/providers/theme-provider.tsx"
      via: "import { ThemeProvider }"
      pattern: "import.*ThemeProvider.*from.*providers/theme-provider"
    - from: "apps/web/src/components/providers/theme-provider.tsx"
      to: "next-themes"
      via: "import { ThemeProvider as NextThemesProvider }"
      pattern: "from.*next-themes"
    - from: "apps/web/src/app/layout.tsx <html>"
      to: "apps/web/src/app/globals.css [data-theme='dark']"
      via: "next-themes sets data-theme attribute on <html>, globals.css applies token values via [data-theme='dark'] selector"
      pattern: "attribute.*data-theme"
---

<objective>
Install next-themes, create a ThemeProvider wrapper component, and integrate it into the root layout. Remove the hardcoded `className="dark"` from the HTML element and replace it with dynamic theme management via data-theme attribute. This completes the ThemeProvider infrastructure that enables zero-re-render theme switching.

Purpose: Without the ThemeProvider, the CSS token system from Plan 01 has no mechanism to switch themes. This plan connects the CSS foundation to runtime theme management, prevents flash of unstyled content on page load, and enables future theme preset work (Phase 23).

Output: Working ThemeProvider integration with dark theme active by default, no FOUC, and data-theme attribute on HTML element.
</objective>

<execution_context>
@C:\Users\User\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\User\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-theme-foundation-color-token-migration/22-RESEARCH.md
@.planning/phases/22-theme-foundation-color-token-migration/22-01-SUMMARY.md
@apps/web/src/app/layout.tsx
@apps/web/src/components/providers/query-provider.tsx
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-themes and create ThemeProvider component</name>
  <files>
    apps/web/package.json
    apps/web/src/components/providers/theme-provider.tsx
  </files>
  <action>
**Step 1: Install next-themes**
```bash
cd apps/web && npm install next-themes
```

**Step 2: Create `apps/web/src/components/providers/theme-provider.tsx`**

This follows the existing provider pattern in `components/providers/` (see query-provider.tsx and database-provider.tsx for convention). The component must be a client component since next-themes uses React context internally.

```tsx
"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}
```

**Key decisions:**
- Named export `ThemeProvider` (matches project convention -- no default exports)
- `"use client"` directive required (next-themes uses browser APIs)
- Props spread pattern allows parent to configure all next-themes options
- Placed in `providers/` directory following existing convention (query-provider.tsx, database-provider.tsx, sync-provider.tsx)
  </action>
  <verify>
1. Run `cd apps/web && node -e "require('next-themes')"` -- should not error (package installed)
2. Verify file exists: `apps/web/src/components/providers/theme-provider.tsx`
3. Grep for `"use client"` in theme-provider.tsx -- must be present
4. Grep for `NextThemesProvider` in theme-provider.tsx -- must be present
5. Grep for `export function ThemeProvider` in theme-provider.tsx -- must be present
  </verify>
  <done>
- next-themes is installed in apps/web/package.json
- theme-provider.tsx exists in components/providers/ with "use client" directive
- ThemeProvider is a named export wrapping NextThemesProvider
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ThemeProvider into root layout</name>
  <files>apps/web/src/app/layout.tsx</files>
  <action>
Modify `apps/web/src/app/layout.tsx` to:

1. **Add import** for ThemeProvider:
```tsx
import { ThemeProvider } from "@/components/providers/theme-provider";
```

2. **Remove hardcoded dark class** from `<html>` element (THEME-03):
Change `<html lang="en" className="dark">` to `<html lang="en" suppressHydrationWarning>`

The `suppressHydrationWarning` attribute prevents React hydration mismatch warnings because the server renders without knowing the theme, and next-themes' inline blocking script applies the theme before first paint (THEME-02).

3. **Wrap children with ThemeProvider** inside the body, as the OUTERMOST provider (before TooltipProvider):

```tsx
<ThemeProvider
  attribute="data-theme"
  defaultTheme="dark"
  enableSystem={false}
  disableTransitionOnChange
>
  <TooltipProvider>
    <DatabaseProvider>
      <QueryProvider>
        {children}
      </QueryProvider>
    </DatabaseProvider>
    <Toaster position="top-right" richColors duration={5000} closeButton />
  </TooltipProvider>
</ThemeProvider>
```

**Key config decisions:**
- `attribute="data-theme"`: Uses data attribute (matches globals.css `[data-theme="dark"]` selector). Do NOT use the default `class` attribute.
- `defaultTheme="dark"`: Preserves current behavior (app was hardcoded to dark). Future Phase 23 will add theme switching.
- `enableSystem={false}`: Disabled for now (Phase 23 will enable system preference detection). This ensures existing dark-only behavior is preserved.
- `disableTransitionOnChange`: Prevents jarring color transitions when theme changes. Theme switch should be instant via CSS variable cascade.

**The final layout.tsx should look like:**
```tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import { Toaster } from "sonner";
import { TooltipProvider } from "@/components/ui/tooltip";
import { QueryProvider } from "@/components/providers/query-provider";
import { DatabaseProvider } from "@/components/providers/database-provider";
import { ThemeProvider } from "@/components/providers/theme-provider";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "DS-ProSolution",
  description: "Order tracking and bookkeeping management",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <ThemeProvider
          attribute="data-theme"
          defaultTheme="dark"
          enableSystem={false}
          disableTransitionOnChange
        >
          <TooltipProvider>
            <DatabaseProvider>
              <QueryProvider>
                {children}
              </QueryProvider>
            </DatabaseProvider>
            <Toaster position="top-right" richColors duration={5000} closeButton />
          </TooltipProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}
```

**CRITICAL:** Do NOT add `className="dark"` anywhere. The theme is now managed dynamically by next-themes, which injects a blocking inline script that sets `data-theme="dark"` on `<html>` before React hydrates. This prevents FOUC.
  </action>
  <verify>
1. Grep for `className="dark"` in layout.tsx -- should return NO matches
2. Grep for `suppressHydrationWarning` in layout.tsx -- should be present on `<html>`
3. Grep for `attribute="data-theme"` in layout.tsx -- should be present in ThemeProvider config
4. Grep for `defaultTheme="dark"` in layout.tsx -- should be present
5. Grep for `import.*ThemeProvider.*from.*providers/theme-provider` in layout.tsx -- should match
6. Run `cd apps/web && npx next build 2>&1 | head -30` -- build should succeed
  </verify>
  <done>
- Hardcoded className="dark" removed from HTML element (THEME-03)
- suppressHydrationWarning added to HTML element (THEME-02)
- ThemeProvider wraps entire app with attribute="data-theme" (THEME-02, THEME-03)
- defaultTheme="dark" preserves current dark-only behavior
- next-themes inline blocking script prevents FOUC
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify theme foundation works end-to-end</name>
  <what-built>
Complete CSS token system with ThemeProvider integration:
- Semantic CSS variable tokens for application colors, scrollbars, typography
- next-themes ThemeProvider managing data-theme attribute on HTML
- Dark theme active by default (preserving current behavior)
- Theme-aware scrollbar styles (standards-first with webkit fallback)
  </what-built>
  <how-to-verify>
1. Run `cd apps/web && npm run dev` and open http://localhost:3000
2. **Visual check:** App should look identical to before (dark theme, same colors). No visual regressions.
3. **DevTools check:** Open browser DevTools (F12), inspect `<html>` element:
   - Should have `data-theme="dark"` attribute (NOT className="dark")
   - Should have `suppresshydrationwarning` attribute
   - No console errors about hydration mismatch
4. **Token cascade test:** In DevTools Console, run:
   ```js
   document.documentElement.setAttribute('data-theme', 'light')
   ```
   - App should switch to light theme (lighter backgrounds, darker text)
   - Switch back: `document.documentElement.setAttribute('data-theme', 'dark')`
   - App should return to dark theme
   - **This proves zero-JS theme switching works via CSS variable cascade**
5. **Scrollbar check:** Find a scrollable area (e.g., table or sidebar). Scrollbar should use theme colors (not bright blue browser default).
6. **No FOUC:** Reload the page (Ctrl+R). There should be NO flash of white/light content before dark theme appears. The page should load directly into dark theme.
  </how-to-verify>
  <resume-signal>Type "approved" if everything looks correct, or describe any issues you see</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **ThemeProvider active:** `data-theme="dark"` attribute on `<html>` in browser
2. **No FOUC:** Page loads directly into dark theme, no flash
3. **Zero re-renders:** Changing `data-theme` attribute in DevTools updates colors instantly without React re-render (check React Profiler if needed)
4. **Token cascade:** All CSS variable tokens resolve correctly in both light and dark themes
5. **Scrollbar theming:** Scrollbars use theme variables, not hardcoded hex
6. **Build success:** `npm run build` passes in apps/web
7. **No regressions:** App visually identical to before the changes
</verification>

<success_criteria>
- next-themes installed and ThemeProvider wrapping the app
- className="dark" fully removed, data-theme="dark" active via next-themes
- suppressHydrationWarning on HTML element
- No FOUC on page load
- Theme can be switched via data-theme attribute (CSS variable cascade, zero React re-renders)
- App visually identical to current state (dark theme preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/22-theme-foundation-color-token-migration/22-02-SUMMARY.md`
</output>
