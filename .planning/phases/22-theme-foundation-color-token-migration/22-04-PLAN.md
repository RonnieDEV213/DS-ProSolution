---
phase: 22-theme-foundation-color-token-migration
plan: 04
type: execute
wave: 1
depends_on: [22-02]
files_modified:
  - apps/web/src/app/layout.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ThemeProvider attribute prop includes both 'class' and 'data-theme'"
    - "HTML element gets class='dark' AND data-theme='dark' in dev mode"
    - "CSS custom properties resolve to dark-mode values in dev server"
  artifacts:
    - path: "apps/web/src/app/layout.tsx"
      provides: "ThemeProvider with dual class+attribute strategy"
      min_lines: 50
  key_links:
    - from: "apps/web/src/app/layout.tsx"
      to: "globals.css dark variable block"
      via: "class='dark' matches Turbopack .dark{} selector"
      pattern: 'attribute=.*class.*data-theme'
---

<objective>
Fix Turbopack dark theme CSS variable mismatch by configuring next-themes ThemeProvider to emit both class="dark" and data-theme="dark" on the HTML element.

Root cause: Turbopack (Next.js dev server) rewrites [data-theme="dark"] selector to .dark class selector in dev CSS output. HTML only had data-theme="dark" (not class="dark"), so .dark{} rules never matched in dev mode.

Fix: Change ThemeProvider attribute prop from "data-theme" to ["class", "data-theme"]. This is a one-line change.

Output: Dark CSS variables activate in both dev (Turbopack) and production builds.
</objective>

<context>
@./.planning/phases/22-theme-foundation-color-token-migration/22-UAT-recheck.md
@./apps/web/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dual class+attribute strategy to ThemeProvider</name>
  <files>
apps/web/src/app/layout.tsx
  </files>
  <action>
Change line 36 in layout.tsx:
- Current: `attribute="data-theme"`
- Replace: `attribute={["class", "data-theme"]}`

This tells next-themes to set BOTH class="dark" AND data-theme="dark" on the HTML element.
- Dev (Turbopack): .dark {} matches via class="dark"
- Production: [data-theme=dark] {} matches via data-theme="dark"
  </action>
  <verify>
Build succeeds:
```bash
cd apps/web && npm run build
```

Dev server check:
```bash
cd apps/web && npm run dev
# Visit http://localhost:3000 and verify dark CSS variables are active
```
  </verify>
  <done>
- ThemeProvider uses dual attribute strategy
- HTML element gets both class="dark" and data-theme="dark"
- Dark CSS custom properties activate in both dev and production
  </done>
</task>

</tasks>

<success_criteria>
- [ ] layout.tsx ThemeProvider has attribute={["class", "data-theme"]}
- [ ] Build succeeds with no TypeScript errors
- [ ] Dark CSS variables resolve correctly in dev mode
</success_criteria>
</plan>
