---
phase: 06-collection-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/migrations/037_collection_infrastructure.sql
autonomous: true

must_haves:
  truths:
    - "Collection tables exist in database"
    - "Budget settings configurable per org"
    - "Run state machine supports pending/running/paused/completed/failed/cancelled"
  artifacts:
    - path: "apps/api/migrations/037_collection_infrastructure.sql"
      provides: "Collection infrastructure schema"
      contains: "collection_settings"
  key_links:
    - from: "collection_runs"
      to: "orgs"
      via: "org_id foreign key"
      pattern: "REFERENCES orgs\\(id\\)"
    - from: "collection_items"
      to: "collection_runs"
      via: "run_id foreign key"
      pattern: "REFERENCES collection_runs\\(id\\)"
---

<objective>
Create database schema for collection infrastructure: settings, runs, items, and sellers tables.

Purpose: Foundation for all collection features - jobs, budget tracking, checkpointing
Output: Migration 037 with collection tables, RLS policies, and indexes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-collection-infrastructure/06-CONTEXT.md
@.planning/phases/06-collection-infrastructure/06-RESEARCH.md
@apps/api/migrations/035_access_codes.sql (migration pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collection infrastructure migration</name>
  <files>apps/api/migrations/037_collection_infrastructure.sql</files>
  <action>
Create migration 037_collection_infrastructure.sql with four tables following existing migration patterns:

**1. collection_settings** (Global admin settings per org)
```sql
- id: UUID PRIMARY KEY
- org_id: UUID NOT NULL UNIQUE REFERENCES orgs(id) ON DELETE CASCADE
- budget_cap_cents: INT NOT NULL DEFAULT 2500 (default $25)
- soft_warning_percent: INT NOT NULL DEFAULT 80
- max_concurrent_runs: INT NOT NULL DEFAULT 3
- created_at: TIMESTAMPTZ NOT NULL DEFAULT now()
- updated_at: TIMESTAMPTZ
```

**2. collection_runs** (Job state with checkpointing)
```sql
- id: UUID PRIMARY KEY
- org_id: UUID NOT NULL REFERENCES orgs(id) ON DELETE CASCADE
- name: TEXT NOT NULL (custom or auto-generated)
- status: TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'running', 'paused', 'completed', 'failed', 'cancelled'))

Cost tracking:
- estimated_cost_cents: INT NOT NULL
- actual_cost_cents: INT NOT NULL DEFAULT 0
- budget_cap_cents: INT NOT NULL (snapshot at run start)

Progress tracking:
- total_items: INT NOT NULL DEFAULT 0
- processed_items: INT NOT NULL DEFAULT 0
- failed_items: INT NOT NULL DEFAULT 0

Checkpoint (JSONB for flexibility):
- checkpoint: JSONB

Categories selected:
- category_ids: TEXT[] NOT NULL

Timing:
- started_at: TIMESTAMPTZ
- completed_at: TIMESTAMPTZ
- paused_at: TIMESTAMPTZ

Audit:
- created_by: UUID NOT NULL REFERENCES auth.users(id)
- created_at: TIMESTAMPTZ NOT NULL DEFAULT now()
- updated_at: TIMESTAMPTZ
```

**3. collection_items** (Per-item log)
```sql
- id: UUID PRIMARY KEY
- run_id: UUID NOT NULL REFERENCES collection_runs(id) ON DELETE CASCADE
- item_type: TEXT NOT NULL CHECK (item_type IN ('amazon_product', 'ebay_seller'))
- external_id: TEXT NOT NULL (ASIN or seller ID)
- status: TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'skipped'))
- data: JSONB (flexible storage for API responses)
- error_code: TEXT
- error_message: TEXT
- cost_cents: INT NOT NULL DEFAULT 0
- created_at: TIMESTAMPTZ NOT NULL DEFAULT now()
```

**4. sellers** (Deduplicated master list)
```sql
- id: UUID PRIMARY KEY
- org_id: UUID NOT NULL REFERENCES orgs(id) ON DELETE CASCADE
- display_name: TEXT NOT NULL
- normalized_name: TEXT NOT NULL (lowercase, stripped for dedup)
- platform: TEXT NOT NULL CHECK (platform IN ('ebay'))
- platform_id: TEXT (eBay seller ID if available)
- first_seen_run_id: UUID REFERENCES collection_runs(id) ON DELETE SET NULL
- last_seen_run_id: UUID REFERENCES collection_runs(id) ON DELETE SET NULL
- times_seen: INT NOT NULL DEFAULT 1
- feedback_score: INT (optional metadata)
- item_count: INT (optional metadata)
- created_at: TIMESTAMPTZ NOT NULL DEFAULT now()
- updated_at: TIMESTAMPTZ
- CONSTRAINT sellers_unique_normalized UNIQUE (org_id, normalized_name, platform)
```

**Indexes:**
- collection_runs: org_id, status, created_at
- collection_items: run_id, status, item_type
- sellers: org_id, normalized_name

**RLS Policies:**
- Enable RLS on all tables
- service_role bypass for all tables (FOR ALL TO service_role USING (true) WITH CHECK (true))

Follow the sectioned comment style from 035_access_codes.sql:
```sql
-- ============================================================
-- 1. Table Name
-- ============================================================
-- Description
```
  </action>
  <verify>
Migration file exists with valid SQL syntax:
- Check file: `cat apps/api/migrations/037_collection_infrastructure.sql | head -100`
- Verify table creates: `grep -c "CREATE TABLE" apps/api/migrations/037_collection_infrastructure.sql` should be 4
- Verify RLS enabled: `grep -c "ENABLE ROW LEVEL SECURITY" apps/api/migrations/037_collection_infrastructure.sql` should be 4
  </verify>
  <done>
Migration 037_collection_infrastructure.sql exists with:
- 4 tables (collection_settings, collection_runs, collection_items, sellers)
- RLS enabled on all tables with service_role bypass
- Appropriate indexes for query performance
- Status CHECK constraints matching state machine
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at apps/api/migrations/037_collection_infrastructure.sql
- [ ] SQL syntax is valid (no obvious errors)
- [ ] All four tables defined with correct columns
- [ ] Foreign keys reference correct tables
- [ ] RLS policies in place
- [ ] Index definitions present
</verification>

<success_criteria>
Database schema ready for collection infrastructure:
- collection_settings: per-org budget configuration
- collection_runs: job state with checkpointing support
- collection_items: per-item tracking for progress and errors
- sellers: deduplicated master list with normalization
</success_criteria>

<output>
After completion, create `.planning/phases/06-collection-infrastructure/06-01-SUMMARY.md`
</output>
