---
phase: 06-collection-infrastructure
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - apps/web/src/app/admin/automation/page.tsx
  - apps/web/src/components/admin/collection/sellers-grid.tsx
  - apps/web/src/components/admin/collection/recent-logs-sidebar.tsx
  - apps/web/src/components/admin/collection/log-detail-modal.tsx
  - apps/web/src/components/admin/collection/diff-modal.tsx
  - apps/web/src/components/admin/collection/progress-bar.tsx
  - apps/web/src/components/admin/collection/progress-detail-modal.tsx
  - apps/web/src/components/admin/collection/run-config-modal.tsx
  - apps/web/src/hooks/use-collection-polling.ts
autonomous: false

must_haves:
  truths:
    - "Admin sees Collections tab with sellers grid dominant on left"
    - "Sellers grid is resizable with snap-to-column behavior"
    - "Sellers can be added, edited, removed directly in grid"
    - "Export buttons work (CSV single column, JSON, clipboard)"
    - "Recent logs sidebar shows edit history"
    - "Clicking a log opens detail modal with seller list and full history"
    - "Compare button opens diff modal with side-by-side view"
    - "Progress bar shows during active runs with cost/depts/cats/products/sellers"
    - "Cost displays as current/budget with green/yellow/red coloring"
    - "Start Run button opens config modal with templates"
  artifacts:
    - path: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      provides: "Resizable multi-column grid of sellers"
      min_lines: 200
    - path: "apps/web/src/components/admin/collection/diff-modal.tsx"
      provides: "Side-by-side diff comparison"
      min_lines: 150
    - path: "apps/web/src/components/admin/collection/progress-bar.tsx"
      provides: "Full-width progress with quick info"
      min_lines: 100
  key_links:
    - from: "apps/web/src/app/admin/automation/page.tsx"
      to: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      via: "import and render"
      pattern: "SellersGrid"
    - from: "apps/web/src/components/admin/collection/sellers-grid.tsx"
      to: "/sellers"
      via: "fetch"
      pattern: "fetch.*sellers"
---

<objective>
Build the seller-focused Collections UI with:
1. Resizable sellers grid (left, dominant)
2. Recent logs sidebar (right) with detail/diff modals
3. Progress bar (top) with hierarchical counts and cost status
4. Run config modal with templates

Purpose: Admin can view/edit the master seller list, track all changes with full history/diff, and monitor collection runs in real-time.
Output: Collections tab in Extension Hub with all widgets and interactions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-collection-infrastructure/06-CONTEXT.md
@.planning/phases/06-collection-infrastructure/06-03-SUMMARY.md
@apps/web/src/app/admin/automation/page.tsx (tab pattern reference)
@apps/web/src/components/admin/automation/jobs-table.tsx (component pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sellers grid component</name>
  <files>apps/web/src/components/admin/collection/sellers-grid.tsx</files>
  <action>
Create the main sellers grid component with:
- Resizable width via right edge drag, snaps to column count (3/4/5/6/7/8 columns)
- Fixed height with internal scroll
- Sellers sorted by newest first
- Inline editing (click to edit, blur/enter to save)
- Add seller input at top
- Delete via hover X button
- Export buttons (CSV, JSON, Clipboard)

**Key behaviors:**
- Column width is fixed (e.g., 120px per seller cell)
- Dragging right edge resizes container, column count = floor(width / cell_width)
- Snap effect: container width snaps to exact multiple of cell_width
- New sellers highlighted with subtle animation

```tsx
"use client";

import { useState, useEffect, useRef, useCallback } from "react";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { X, Download, Copy, Plus, Check } from "lucide-react";
import { cn } from "@/lib/utils";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";
const CELL_WIDTH = 140; // pixels per seller cell
const MIN_COLUMNS = 3;
const MAX_COLUMNS = 8;

interface Seller {
  id: string;
  name: string;
  discovered_at: string;
}

interface SellersGridProps {
  refreshTrigger: number;
  onSellerChange: () => void;
  newSellerIds?: Set<string>; // IDs of sellers added in current run (for highlighting)
}

export function SellersGrid({ refreshTrigger, onSellerChange, newSellerIds = new Set() }: SellersGridProps) {
  const [sellers, setSellers] = useState<Seller[]>([]);
  const [loading, setLoading] = useState(true);
  const [columns, setColumns] = useState(5);
  const [newSellerName, setNewSellerName] = useState("");
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editValue, setEditValue] = useState("");
  const [addError, setAddError] = useState<string | null>(null);
  const [copySuccess, setCopySuccess] = useState(false);

  const containerRef = useRef<HTMLDivElement>(null);
  const resizeRef = useRef<HTMLDivElement>(null);
  const supabase = createClient();

  // Fetch sellers
  const fetchSellers = useCallback(async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const response = await fetch(`${API_BASE}/sellers`, {
        headers: { Authorization: `Bearer ${session.access_token}` },
      });

      if (response.ok) {
        const data = await response.json();
        setSellers(data.sellers || []);
      }
    } catch (e) {
      console.error("Failed to fetch sellers:", e);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchSellers();
  }, [refreshTrigger, fetchSellers]);

  // Resize handling
  useEffect(() => {
    const handle = resizeRef.current;
    if (!handle) return;

    let startX = 0;
    let startWidth = 0;

    const onMouseDown = (e: MouseEvent) => {
      startX = e.clientX;
      startWidth = containerRef.current?.offsetWidth || CELL_WIDTH * columns;
      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    };

    const onMouseMove = (e: MouseEvent) => {
      const delta = e.clientX - startX;
      const newWidth = startWidth + delta;
      const newCols = Math.max(MIN_COLUMNS, Math.min(MAX_COLUMNS, Math.round(newWidth / CELL_WIDTH)));
      setColumns(newCols);
    };

    const onMouseUp = () => {
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    };

    handle.addEventListener("mousedown", onMouseDown);
    return () => handle.removeEventListener("mousedown", onMouseDown);
  }, [columns]);

  // Add seller
  const handleAddSeller = async () => {
    if (!newSellerName.trim()) return;
    setAddError(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const response = await fetch(`${API_BASE}/sellers`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({ name: newSellerName.trim() }),
      });

      if (!response.ok) {
        const data = await response.json();
        setAddError(data.detail || "Failed to add seller");
        return;
      }

      setNewSellerName("");
      onSellerChange();
      fetchSellers();
    } catch (e) {
      setAddError("Failed to add seller");
    }
  };

  // Edit seller
  const startEdit = (seller: Seller) => {
    setEditingId(seller.id);
    setEditValue(seller.name);
  };

  const saveEdit = async () => {
    if (!editingId || !editValue.trim()) {
      setEditingId(null);
      return;
    }

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      await fetch(`${API_BASE}/sellers/${editingId}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({ name: editValue.trim() }),
      });

      setEditingId(null);
      onSellerChange();
      fetchSellers();
    } catch (e) {
      console.error("Failed to update seller:", e);
    }
  };

  // Delete seller
  const handleDelete = async (id: string) => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      await fetch(`${API_BASE}/sellers/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${session.access_token}` },
      });

      onSellerChange();
      fetchSellers();
    } catch (e) {
      console.error("Failed to delete seller:", e);
    }
  };

  // Export functions
  const exportCSV = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const response = await fetch(`${API_BASE}/sellers/export?format=csv`, {
      headers: { Authorization: `Bearer ${session.access_token}` },
    });
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "sellers.csv";
    a.click();
  };

  const exportJSON = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const response = await fetch(`${API_BASE}/sellers/export?format=json`, {
      headers: { Authorization: `Bearer ${session.access_token}` },
    });
    const data = await response.json();
    const blob = new Blob([JSON.stringify(data.sellers, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "sellers.json";
    a.click();
  };

  const copyToClipboard = async () => {
    const names = sellers.map(s => s.name).join("\n");
    await navigator.clipboard.writeText(names);
    setCopySuccess(true);
    setTimeout(() => setCopySuccess(false), 2000);
  };

  if (loading) {
    return <div className="text-gray-400 p-4">Loading sellers...</div>;
  }

  const gridWidth = columns * CELL_WIDTH;

  return (
    <div className="flex flex-col h-full">
      {/* Header with add + export */}
      <div className="flex items-center justify-between mb-3 gap-2">
        <div className="flex items-center gap-2 flex-1">
          <Input
            value={newSellerName}
            onChange={(e) => setNewSellerName(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && handleAddSeller()}
            placeholder="Add seller..."
            className="bg-gray-800 border-gray-700 text-white max-w-xs"
          />
          <Button
            size="sm"
            onClick={handleAddSeller}
            className="bg-blue-600 hover:bg-blue-700"
          >
            <Plus className="h-4 w-4" />
          </Button>
          {addError && <span className="text-red-400 text-sm">{addError}</span>}
        </div>

        <div className="flex items-center gap-1">
          <span className="text-gray-500 text-sm mr-2">{sellers.length} sellers</span>
          <Button variant="ghost" size="sm" onClick={exportCSV} title="Export CSV">
            <Download className="h-4 w-4" />
            <span className="ml-1 text-xs">CSV</span>
          </Button>
          <Button variant="ghost" size="sm" onClick={exportJSON} title="Export JSON">
            <Download className="h-4 w-4" />
            <span className="ml-1 text-xs">JSON</span>
          </Button>
          <Button variant="ghost" size="sm" onClick={copyToClipboard} title="Copy to clipboard">
            {copySuccess ? <Check className="h-4 w-4 text-green-400" /> : <Copy className="h-4 w-4" />}
          </Button>
        </div>
      </div>

      {/* Grid container with resize handle */}
      <div className="relative flex-1 min-h-0">
        <div
          ref={containerRef}
          style={{ width: gridWidth }}
          className="h-full overflow-y-auto bg-gray-900 border border-gray-800 rounded-lg"
        >
          {sellers.length === 0 ? (
            <div className="flex items-center justify-center h-full text-gray-500">
              No sellers yet. Add one above or run a collection.
            </div>
          ) : (
            <div
              className="grid gap-1 p-2"
              style={{ gridTemplateColumns: `repeat(${columns}, 1fr)` }}
            >
              {sellers.map((seller) => (
                <div
                  key={seller.id}
                  className={cn(
                    "group relative px-2 py-1 bg-gray-800 rounded text-sm text-gray-200 truncate",
                    "hover:bg-gray-700 transition-colors cursor-pointer",
                    newSellerIds.has(seller.id) && "ring-1 ring-green-500 bg-green-900/20"
                  )}
                  onClick={() => startEdit(seller)}
                >
                  {editingId === seller.id ? (
                    <input
                      value={editValue}
                      onChange={(e) => setEditValue(e.target.value)}
                      onBlur={saveEdit}
                      onKeyDown={(e) => e.key === "Enter" && saveEdit()}
                      className="w-full bg-gray-700 px-1 rounded outline-none"
                      autoFocus
                      onClick={(e) => e.stopPropagation()}
                    />
                  ) : (
                    <>
                      <span className="truncate">{seller.name}</span>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleDelete(seller.id);
                        }}
                        className="absolute right-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400"
                      >
                        <X className="h-3 w-3" />
                      </button>
                    </>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Resize handle */}
        <div
          ref={resizeRef}
          className="absolute right-0 top-0 h-full w-2 cursor-ew-resize hover:bg-blue-500/30"
          style={{ right: `calc(100% - ${gridWidth}px - 8px)` }}
        />
      </div>
    </div>
  );
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/components/admin/collection/sellers-grid.tsx && echo "exists"`
- Component exports: `grep "export function SellersGrid" apps/web/src/components/admin/collection/sellers-grid.tsx`
  </verify>
  <done>
SellersGrid component created:
- Resizable width with snap-to-columns (3-8 columns)
- Fixed height with internal scroll
- Add seller input + button
- Click to edit inline, blur/enter to save
- Hover X to delete
- Export buttons: CSV, JSON, Clipboard
- New sellers highlighted with green ring
  </done>
</task>

<task type="auto">
  <name>Task 2: Create recent logs sidebar</name>
  <files>apps/web/src/components/admin/collection/recent-logs-sidebar.tsx</files>
  <action>
Create sidebar showing recent audit log entries. Clicking a log opens the detail modal.

```tsx
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/lib/supabase/client";
import { Button } from "@/components/ui/button";
import { History, Plus, Minus, Edit3, Bot, User } from "lucide-react";
import { formatDistanceToNow } from "date-fns";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface LogEntry {
  id: string;
  action: "add" | "edit" | "remove";
  seller_name: string;
  source: "manual" | "collection_run" | "auto_remove";
  affected_count: number;
  created_at: string;
}

interface RecentLogsSidebarProps {
  refreshTrigger: number;
  onLogClick: (logId: string) => void;
  onStartRunClick: () => void;
  hasActiveRun: boolean;
}

const actionIcons = {
  add: <Plus className="h-3 w-3 text-green-400" />,
  edit: <Edit3 className="h-3 w-3 text-yellow-400" />,
  remove: <Minus className="h-3 w-3 text-red-400" />,
};

const sourceIcons = {
  manual: <User className="h-3 w-3" />,
  collection_run: <Bot className="h-3 w-3" />,
  auto_remove: <Bot className="h-3 w-3" />,
};

export function RecentLogsSidebar({
  refreshTrigger,
  onLogClick,
  onStartRunClick,
  hasActiveRun,
}: RecentLogsSidebarProps) {
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const supabase = createClient();

  useEffect(() => {
    const fetchLogs = async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const response = await fetch(`${API_BASE}/sellers/audit-log?limit=20`, {
          headers: { Authorization: `Bearer ${session.access_token}` },
        });

        if (response.ok) {
          const data = await response.json();
          setLogs(data.entries || []);
        }
      } catch (e) {
        console.error("Failed to fetch audit log:", e);
      } finally {
        setLoading(false);
      }
    };

    fetchLogs();
  }, [refreshTrigger]);

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center gap-2 mb-3">
        <History className="h-4 w-4 text-gray-400" />
        <h3 className="text-sm font-medium text-gray-300">Recent Activity</h3>
      </div>

      {/* Log entries */}
      <div className="flex-1 overflow-y-auto space-y-1 min-h-0">
        {loading ? (
          <div className="text-gray-500 text-sm">Loading...</div>
        ) : logs.length === 0 ? (
          <div className="text-gray-500 text-sm">No activity yet</div>
        ) : (
          logs.map((log) => (
            <button
              key={log.id}
              onClick={() => onLogClick(log.id)}
              className="w-full text-left px-2 py-1.5 rounded bg-gray-800 hover:bg-gray-700 transition-colors"
            >
              <div className="flex items-center gap-2">
                {actionIcons[log.action]}
                <span className="text-gray-300 text-sm truncate flex-1">
                  {log.affected_count > 1
                    ? `${log.affected_count} sellers`
                    : log.seller_name}
                </span>
                {sourceIcons[log.source]}
              </div>
              <div className="text-gray-500 text-xs mt-0.5">
                {formatDistanceToNow(new Date(log.created_at), { addSuffix: true })}
              </div>
            </button>
          ))
        )}
      </div>

      {/* Start Run button */}
      <div className="mt-3 pt-3 border-t border-gray-800">
        <Button
          onClick={onStartRunClick}
          disabled={hasActiveRun}
          className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50"
        >
          {hasActiveRun ? "Run in Progress..." : "Start Collection"}
        </Button>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/components/admin/collection/recent-logs-sidebar.tsx && echo "exists"`
- Component exports: `grep "export function RecentLogsSidebar" apps/web/src/components/admin/collection/recent-logs-sidebar.tsx`
  </verify>
  <done>
RecentLogsSidebar created:
- Shows last 20 audit log entries
- Action icons (add=green, edit=yellow, remove=red)
- Source icons (manual=user, auto=bot)
- Click to open detail modal
- Start Collection button (disabled during active run)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create log detail modal</name>
  <files>apps/web/src/components/admin/collection/log-detail-modal.tsx</files>
  <action>
Create modal that shows:
- Left side: seller list for the selected log entry
- Right side: full history of all logs with the selected log highlighted
- Compare button to open diff modal

```tsx
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/lib/supabase/client";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { GitCompare, Plus, Minus, Edit3, Check } from "lucide-react";
import { format } from "date-fns";
import { cn } from "@/lib/utils";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface LogEntry {
  id: string;
  action: "add" | "edit" | "remove";
  seller_name: string;
  source: string;
  affected_count: number;
  created_at: string;
}

interface LogDetailModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  selectedLogId: string | null;
  onCompare: (sourceId: string | null, targetId: string | null) => void;
}

const actionColors = {
  add: "text-green-400 bg-green-400/10",
  edit: "text-yellow-400 bg-yellow-400/10",
  remove: "text-red-400 bg-red-400/10",
};

export function LogDetailModal({
  open,
  onOpenChange,
  selectedLogId,
  onCompare,
}: LogDetailModalProps) {
  const [sellers, setSellers] = useState<string[]>([]);
  const [allLogs, setAllLogs] = useState<LogEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [compareMode, setCompareMode] = useState(false);
  const [compareSelection, setCompareSelection] = useState<(string | null)[]>([null, null]);

  const supabase = createClient();

  useEffect(() => {
    if (!open || !selectedLogId) return;

    const fetchData = async () => {
      setLoading(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        // Fetch sellers at this log point
        const sellersRes = await fetch(
          `${API_BASE}/sellers/audit-log/${selectedLogId}/sellers`,
          { headers: { Authorization: `Bearer ${session.access_token}` } }
        );
        if (sellersRes.ok) {
          const data = await sellersRes.json();
          setSellers(data.sellers || []);
        }

        // Fetch all logs
        const logsRes = await fetch(
          `${API_BASE}/sellers/audit-log?limit=100`,
          { headers: { Authorization: `Bearer ${session.access_token}` } }
        );
        if (logsRes.ok) {
          const data = await logsRes.json();
          setAllLogs(data.entries || []);
        }
      } catch (e) {
        console.error("Failed to fetch log data:", e);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [open, selectedLogId]);

  const handleLogSelect = (logId: string | null) => {
    if (!compareMode) return;

    if (compareSelection[0] === null) {
      setCompareSelection([logId, null]);
    } else if (compareSelection[1] === null) {
      setCompareSelection([compareSelection[0], logId]);
    } else {
      // Reset and start over
      setCompareSelection([logId, null]);
    }
  };

  const startCompare = () => {
    if (compareSelection[0] !== null || compareSelection[1] !== null) {
      onCompare(compareSelection[0], compareSelection[1]);
    }
  };

  const isSelected = (logId: string | null) =>
    compareSelection[0] === logId || compareSelection[1] === logId;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="bg-gray-900 border-gray-800 max-w-4xl max-h-[80vh]">
        <DialogHeader>
          <DialogTitle className="text-white flex items-center justify-between">
            <span>Log Details</span>
            <div className="flex items-center gap-2">
              {compareMode ? (
                <>
                  <span className="text-sm text-gray-400">
                    Select 2 logs to compare (or "Current" for live list)
                  </span>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => {
                      setCompareMode(false);
                      setCompareSelection([null, null]);
                    }}
                  >
                    Cancel
                  </Button>
                  <Button
                    size="sm"
                    onClick={startCompare}
                    disabled={compareSelection[0] === null && compareSelection[1] === null}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    <GitCompare className="h-4 w-4 mr-1" />
                    Compare
                  </Button>
                </>
              ) : (
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => setCompareMode(true)}
                >
                  <GitCompare className="h-4 w-4 mr-1" />
                  Compare
                </Button>
              )}
            </div>
          </DialogTitle>
        </DialogHeader>

        {loading ? (
          <div className="text-gray-400 p-4">Loading...</div>
        ) : (
          <div className="grid grid-cols-2 gap-4 h-[60vh]">
            {/* Left: Sellers at this log point */}
            <div className="flex flex-col">
              <h4 className="text-sm font-medium text-gray-300 mb-2">
                Sellers at this point ({sellers.length})
              </h4>
              <div className="flex-1 overflow-y-auto bg-gray-800 rounded border border-gray-700 p-2">
                {sellers.length === 0 ? (
                  <div className="text-gray-500 text-sm">No sellers at this point</div>
                ) : (
                  <div className="space-y-1">
                    {sellers.map((name, i) => (
                      <div key={i} className="text-sm text-gray-300 truncate">
                        {name}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Right: Full history */}
            <div className="flex flex-col">
              <h4 className="text-sm font-medium text-gray-300 mb-2">
                Full History
              </h4>
              <div className="flex-1 overflow-y-auto bg-gray-800 rounded border border-gray-700">
                {/* Current list option for compare */}
                {compareMode && (
                  <button
                    onClick={() => handleLogSelect(null)}
                    className={cn(
                      "w-full text-left px-3 py-2 border-b border-gray-700",
                      "hover:bg-gray-700 transition-colors",
                      isSelected(null) && "bg-blue-900/50 ring-1 ring-blue-500"
                    )}
                  >
                    <div className="flex items-center gap-2">
                      <Badge className="bg-blue-500/20 text-blue-400">Current</Badge>
                      <span className="text-gray-300 text-sm">Live seller list</span>
                      {isSelected(null) && <Check className="h-4 w-4 text-blue-400 ml-auto" />}
                    </div>
                  </button>
                )}

                {allLogs.map((log) => (
                  <button
                    key={log.id}
                    onClick={() => compareMode && handleLogSelect(log.id)}
                    className={cn(
                      "w-full text-left px-3 py-2 border-b border-gray-700 last:border-0",
                      "hover:bg-gray-700 transition-colors",
                      log.id === selectedLogId && "bg-gray-700",
                      compareMode && isSelected(log.id) && "bg-blue-900/50 ring-1 ring-blue-500"
                    )}
                  >
                    <div className="flex items-center gap-2">
                      <Badge className={actionColors[log.action]}>
                        {log.action === "add" && <Plus className="h-3 w-3 mr-1" />}
                        {log.action === "edit" && <Edit3 className="h-3 w-3 mr-1" />}
                        {log.action === "remove" && <Minus className="h-3 w-3 mr-1" />}
                        {log.action}
                      </Badge>
                      <span className="text-gray-300 text-sm truncate flex-1">
                        {log.affected_count > 1
                          ? `${log.affected_count} sellers`
                          : log.seller_name}
                      </span>
                      {compareMode && isSelected(log.id) && (
                        <Check className="h-4 w-4 text-blue-400" />
                      )}
                    </div>
                    <div className="text-gray-500 text-xs mt-1">
                      {format(new Date(log.created_at), "MMM d, yyyy h:mm a")}
                    </div>
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/components/admin/collection/log-detail-modal.tsx && echo "exists"`
- Component exports: `grep "export function LogDetailModal" apps/web/src/components/admin/collection/log-detail-modal.tsx`
  </verify>
  <done>
LogDetailModal created:
- Left side: seller list at that log point
- Right side: full history with selected log highlighted
- Compare mode: select 2 logs (or "Current" for live list)
- Opens diff modal when Compare clicked
  </done>
</task>

<task type="auto">
  <name>Task 4: Create diff modal</name>
  <files>apps/web/src/components/admin/collection/diff-modal.tsx</files>
  <action>
Create modal showing side-by-side diff with added (green) / removed (red) highlighting.

```tsx
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/lib/supabase/client";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Download, Copy, Check } from "lucide-react";
import { cn } from "@/lib/utils";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface DiffModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  sourceId: string | null; // null = current list
  targetId: string | null; // null = current list
}

interface DiffResult {
  added: string[];
  removed: string[];
  added_count: number;
  removed_count: number;
}

export function DiffModal({ open, onOpenChange, sourceId, targetId }: DiffModalProps) {
  const [diff, setDiff] = useState<DiffResult | null>(null);
  const [sourceSellers, setSourceSellers] = useState<string[]>([]);
  const [targetSellers, setTargetSellers] = useState<string[]>([]);
  const [loading, setLoading] = useState(true);
  const [copySuccess, setCopySuccess] = useState<string | null>(null);

  const supabase = createClient();

  useEffect(() => {
    if (!open) return;

    const fetchDiff = async () => {
      setLoading(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        // Fetch diff
        const diffRes = await fetch(`${API_BASE}/sellers/diff`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({
            source: sourceId ? "log" : "current",
            source_id: sourceId,
            target: targetId ? "log" : "current",
            target_id: targetId,
          }),
        });

        if (diffRes.ok) {
          const data = await diffRes.json();
          setDiff(data);
        }

        // Fetch source sellers
        if (sourceId) {
          const sourceRes = await fetch(
            `${API_BASE}/sellers/audit-log/${sourceId}/sellers`,
            { headers: { Authorization: `Bearer ${session.access_token}` } }
          );
          if (sourceRes.ok) {
            const data = await sourceRes.json();
            setSourceSellers(data.sellers || []);
          }
        } else {
          const sourceRes = await fetch(`${API_BASE}/sellers`, {
            headers: { Authorization: `Bearer ${session.access_token}` },
          });
          if (sourceRes.ok) {
            const data = await sourceRes.json();
            setSourceSellers(data.sellers.map((s: any) => s.name) || []);
          }
        }

        // Fetch target sellers
        if (targetId) {
          const targetRes = await fetch(
            `${API_BASE}/sellers/audit-log/${targetId}/sellers`,
            { headers: { Authorization: `Bearer ${session.access_token}` } }
          );
          if (targetRes.ok) {
            const data = await targetRes.json();
            setTargetSellers(data.sellers || []);
          }
        } else {
          const targetRes = await fetch(`${API_BASE}/sellers`, {
            headers: { Authorization: `Bearer ${session.access_token}` },
          });
          if (targetRes.ok) {
            const data = await targetRes.json();
            setTargetSellers(data.sellers.map((s: any) => s.name) || []);
          }
        }
      } catch (e) {
        console.error("Failed to fetch diff:", e);
      } finally {
        setLoading(false);
      }
    };

    fetchDiff();
  }, [open, sourceId, targetId]);

  const copyList = async (type: "added" | "removed" | "source" | "target") => {
    let list: string[] = [];
    switch (type) {
      case "added":
        list = diff?.added || [];
        break;
      case "removed":
        list = diff?.removed || [];
        break;
      case "source":
        list = sourceSellers;
        break;
      case "target":
        list = targetSellers;
        break;
    }
    await navigator.clipboard.writeText(list.join("\n"));
    setCopySuccess(type);
    setTimeout(() => setCopySuccess(null), 2000);
  };

  const downloadCSV = (type: "added" | "removed", list: string[]) => {
    const content = "seller_name\n" + list.join("\n");
    const blob = new Blob([content], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${type}_sellers.csv`;
    a.click();
  };

  const downloadJSON = (type: "added" | "removed", list: string[]) => {
    const blob = new Blob([JSON.stringify(list, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${type}_sellers.json`;
    a.click();
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="bg-gray-900 border-gray-800 max-w-5xl max-h-[85vh]">
        <DialogHeader>
          <DialogTitle className="text-white">
            Seller Comparison
          </DialogTitle>
        </DialogHeader>

        {loading ? (
          <div className="text-gray-400 p-4">Calculating diff...</div>
        ) : (
          <div className="space-y-4">
            {/* Summary */}
            <div className="flex items-center gap-4 text-sm">
              <span className="text-green-400">
                +{diff?.added_count || 0} added
              </span>
              <span className="text-red-400">
                -{diff?.removed_count || 0} removed
              </span>
            </div>

            <div className="grid grid-cols-2 gap-4 h-[50vh]">
              {/* Source list */}
              <div className="flex flex-col">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-sm font-medium text-gray-300">
                    {sourceId ? "Source Snapshot" : "Current List"} ({sourceSellers.length})
                  </h4>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => copyList("source")}
                  >
                    {copySuccess === "source" ? (
                      <Check className="h-4 w-4 text-green-400" />
                    ) : (
                      <Copy className="h-4 w-4" />
                    )}
                  </Button>
                </div>
                <div className="flex-1 overflow-y-auto bg-gray-800 rounded border border-gray-700 p-2">
                  {sourceSellers.map((name, i) => (
                    <div
                      key={i}
                      className={cn(
                        "text-sm py-0.5 truncate",
                        diff?.removed.includes(name)
                          ? "text-red-400 bg-red-900/20 px-1 rounded"
                          : "text-gray-300"
                      )}
                    >
                      {diff?.removed.includes(name) && "- "}
                      {name}
                    </div>
                  ))}
                </div>
              </div>

              {/* Target list */}
              <div className="flex flex-col">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-sm font-medium text-gray-300">
                    {targetId ? "Target Snapshot" : "Current List"} ({targetSellers.length})
                  </h4>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => copyList("target")}
                  >
                    {copySuccess === "target" ? (
                      <Check className="h-4 w-4 text-green-400" />
                    ) : (
                      <Copy className="h-4 w-4" />
                    )}
                  </Button>
                </div>
                <div className="flex-1 overflow-y-auto bg-gray-800 rounded border border-gray-700 p-2">
                  {targetSellers.map((name, i) => (
                    <div
                      key={i}
                      className={cn(
                        "text-sm py-0.5 truncate",
                        diff?.added.includes(name)
                          ? "text-green-400 bg-green-900/20 px-1 rounded"
                          : "text-gray-300"
                      )}
                    >
                      {diff?.added.includes(name) && "+ "}
                      {name}
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Added/Removed export sections */}
            <div className="grid grid-cols-2 gap-4">
              {/* Added sellers */}
              <div className="bg-green-900/10 border border-green-900/30 rounded p-3">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-sm font-medium text-green-400">
                    Added ({diff?.added_count || 0})
                  </h4>
                  <div className="flex gap-1">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => copyList("added")}
                      className="text-green-400"
                    >
                      {copySuccess === "added" ? <Check className="h-4 w-4" /> : <Copy className="h-4 w-4" />}
                    </Button>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => downloadCSV("added", diff?.added || [])}
                      className="text-green-400"
                    >
                      CSV
                    </Button>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => downloadJSON("added", diff?.added || [])}
                      className="text-green-400"
                    >
                      JSON
                    </Button>
                  </div>
                </div>
                <div className="max-h-24 overflow-y-auto text-sm text-green-300">
                  {diff?.added.slice(0, 10).join(", ")}
                  {(diff?.added.length || 0) > 10 && "..."}
                </div>
              </div>

              {/* Removed sellers */}
              <div className="bg-red-900/10 border border-red-900/30 rounded p-3">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-sm font-medium text-red-400">
                    Removed ({diff?.removed_count || 0})
                  </h4>
                  <div className="flex gap-1">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => copyList("removed")}
                      className="text-red-400"
                    >
                      {copySuccess === "removed" ? <Check className="h-4 w-4" /> : <Copy className="h-4 w-4" />}
                    </Button>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => downloadCSV("removed", diff?.removed || [])}
                      className="text-red-400"
                    >
                      CSV
                    </Button>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => downloadJSON("removed", diff?.removed || [])}
                      className="text-red-400"
                    >
                      JSON
                    </Button>
                  </div>
                </div>
                <div className="max-h-24 overflow-y-auto text-sm text-red-300">
                  {diff?.removed.slice(0, 10).join(", ")}
                  {(diff?.removed.length || 0) > 10 && "..."}
                </div>
              </div>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/components/admin/collection/diff-modal.tsx && echo "exists"`
- Component exports: `grep "export function DiffModal" apps/web/src/components/admin/collection/diff-modal.tsx`
  </verify>
  <done>
DiffModal created:
- Side-by-side comparison of two seller lists
- Added sellers highlighted green, removed highlighted red
- Summary counts at top
- Added/Removed sections with export (Copy, CSV, JSON)
- Supports comparing any two logs or current list
  </done>
</task>

<task type="auto">
  <name>Task 5: Create progress bar component</name>
  <files>apps/web/src/components/admin/collection/progress-bar.tsx</files>
  <action>
Create full-width progress bar with quick info section showing cost, departments, categories, products, and new sellers.

```tsx
"use client";

import { useState } from "react";
import { cn } from "@/lib/utils";
import { ChevronDown, ChevronUp } from "lucide-react";

interface ProgressBarProps {
  progress: {
    departments_total: number;
    departments_completed: number;
    categories_total: number;
    categories_completed: number;
    products_total: number;
    products_searched: number;
    sellers_found: number;
    sellers_new: number;
    actual_cost_cents: number;
    budget_cap_cents: number;
    cost_status: "safe" | "warning" | "exceeded";
  } | null;
  onDetailsClick: () => void;
}

function formatCost(cents: number): string {
  return `$${(cents / 100).toFixed(2)}`;
}

export function ProgressBar({ progress, onDetailsClick }: ProgressBarProps) {
  const [expanded, setExpanded] = useState(false);

  if (!progress) return null;

  const totalProgress = progress.products_total > 0
    ? (progress.products_searched / progress.products_total) * 100
    : 0;

  const costColorClass = {
    safe: "text-green-400",
    warning: "text-yellow-400",
    exceeded: "text-red-400",
  }[progress.cost_status];

  return (
    <div className="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
      {/* Progress bar */}
      <div className="h-2 bg-gray-800">
        <div
          className="h-full bg-blue-500 transition-all duration-300"
          style={{ width: `${totalProgress}%` }}
        />
      </div>

      {/* Quick info */}
      <div className="px-4 py-2 flex items-center justify-between text-sm">
        <div className="flex items-center gap-4 flex-wrap">
          {/* Cost */}
          <div className="flex items-center gap-1">
            <span className="text-gray-500">Cost:</span>
            <span className={costColorClass}>
              {formatCost(progress.actual_cost_cents)}
            </span>
            <span className="text-gray-600">/</span>
            <span className="text-gray-400">
              {formatCost(progress.budget_cap_cents)}
            </span>
          </div>

          <span className="text-gray-700">|</span>

          {/* Departments */}
          <div className="flex items-center gap-1">
            <span className="text-gray-500">Depts:</span>
            <span className="text-gray-300">
              {progress.departments_completed}/{progress.departments_total}
            </span>
          </div>

          <span className="text-gray-700">|</span>

          {/* Categories */}
          <div className="flex items-center gap-1">
            <span className="text-gray-500">Cats:</span>
            <span className="text-gray-300">
              {progress.categories_completed}/{progress.categories_total}
            </span>
          </div>

          <span className="text-gray-700">|</span>

          {/* Products */}
          <div className="flex items-center gap-1">
            <span className="text-gray-500">Products:</span>
            <span className="text-gray-300">
              {progress.products_searched}/{progress.products_total}
            </span>
          </div>

          <span className="text-gray-700">|</span>

          {/* New Sellers */}
          <div className="flex items-center gap-1">
            <span className="text-gray-500">+New Sellers:</span>
            <span className="text-green-400 font-medium">
              {progress.sellers_new}
            </span>
          </div>
        </div>

        {/* Details button */}
        <button
          onClick={() => {
            setExpanded(!expanded);
            onDetailsClick();
          }}
          className="flex items-center gap-1 text-gray-400 hover:text-gray-200 transition-colors"
        >
          <span>Details</span>
          {expanded ? (
            <ChevronUp className="h-4 w-4" />
          ) : (
            <ChevronDown className="h-4 w-4" />
          )}
        </button>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/components/admin/collection/progress-bar.tsx && echo "exists"`
- Component exports: `grep "export function ProgressBar" apps/web/src/components/admin/collection/progress-bar.tsx`
  </verify>
  <done>
ProgressBar created:
- Full-width blue progress bar
- Quick info: Cost (green/yellow/red), Depts, Cats, Products, +New Sellers
- Cost shows current/budget with status color
- Details button to expand/open detail modal
  </done>
</task>

<task type="auto">
  <name>Task 6: Create progress detail modal</name>
  <files>apps/web/src/components/admin/collection/progress-detail-modal.tsx</files>
  <action>
Create modal showing detailed per-worker status during active runs.

```tsx
"use client";

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";

interface WorkerStatus {
  worker_id: number;
  department: string;
  category: string;
  product: string | null;
  status: "idle" | "fetching" | "searching" | "complete";
}

interface ProgressDetailModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  progress: {
    departments_total: number;
    departments_completed: number;
    categories_total: number;
    categories_completed: number;
    products_total: number;
    products_searched: number;
    sellers_found: number;
    sellers_new: number;
    actual_cost_cents: number;
    budget_cap_cents: number;
    cost_status: "safe" | "warning" | "exceeded";
    worker_status: WorkerStatus[];
  } | null;
}

const statusColors = {
  idle: "bg-gray-500/20 text-gray-400",
  fetching: "bg-yellow-500/20 text-yellow-400",
  searching: "bg-blue-500/20 text-blue-400",
  complete: "bg-green-500/20 text-green-400",
};

function formatCost(cents: number): string {
  return `$${(cents / 100).toFixed(2)}`;
}

export function ProgressDetailModal({
  open,
  onOpenChange,
  progress,
}: ProgressDetailModalProps) {
  if (!progress) return null;

  const costColorClass = {
    safe: "text-green-400",
    warning: "text-yellow-400",
    exceeded: "text-red-400",
  }[progress.cost_status];

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="bg-gray-900 border-gray-800 max-w-2xl">
        <DialogHeader>
          <DialogTitle className="text-white">Collection Progress</DialogTitle>
        </DialogHeader>

        <div className="space-y-6">
          {/* Summary stats */}
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-gray-800 rounded p-3">
              <div className="text-gray-500 text-xs uppercase">Cost</div>
              <div className={cn("text-xl font-bold", costColorClass)}>
                {formatCost(progress.actual_cost_cents)}
              </div>
              <div className="text-gray-500 text-sm">
                of {formatCost(progress.budget_cap_cents)}
              </div>
            </div>

            <div className="bg-gray-800 rounded p-3">
              <div className="text-gray-500 text-xs uppercase">Progress</div>
              <div className="text-xl font-bold text-white">
                {progress.products_total > 0
                  ? Math.round((progress.products_searched / progress.products_total) * 100)
                  : 0}%
              </div>
              <div className="text-gray-500 text-sm">
                {progress.products_searched}/{progress.products_total} products
              </div>
            </div>

            <div className="bg-gray-800 rounded p-3">
              <div className="text-gray-500 text-xs uppercase">New Sellers</div>
              <div className="text-xl font-bold text-green-400">
                +{progress.sellers_new}
              </div>
              <div className="text-gray-500 text-sm">
                {progress.sellers_found} total found
              </div>
            </div>
          </div>

          {/* Hierarchical progress */}
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-gray-400">Departments</span>
              <span className="text-gray-300">
                {progress.departments_completed}/{progress.departments_total}
              </span>
            </div>
            <div className="h-2 bg-gray-800 rounded overflow-hidden">
              <div
                className="h-full bg-purple-500"
                style={{
                  width: `${(progress.departments_completed / Math.max(1, progress.departments_total)) * 100}%`,
                }}
              />
            </div>

            <div className="flex justify-between text-sm mt-3">
              <span className="text-gray-400">Categories</span>
              <span className="text-gray-300">
                {progress.categories_completed}/{progress.categories_total}
              </span>
            </div>
            <div className="h-2 bg-gray-800 rounded overflow-hidden">
              <div
                className="h-full bg-blue-500"
                style={{
                  width: `${(progress.categories_completed / Math.max(1, progress.categories_total)) * 100}%`,
                }}
              />
            </div>

            <div className="flex justify-between text-sm mt-3">
              <span className="text-gray-400">Products</span>
              <span className="text-gray-300">
                {progress.products_searched}/{progress.products_total}
              </span>
            </div>
            <div className="h-2 bg-gray-800 rounded overflow-hidden">
              <div
                className="h-full bg-cyan-500"
                style={{
                  width: `${(progress.products_searched / Math.max(1, progress.products_total)) * 100}%`,
                }}
              />
            </div>
          </div>

          {/* Worker status */}
          <div>
            <h4 className="text-sm font-medium text-gray-300 mb-2">
              Workers ({progress.worker_status.length} concurrent)
            </h4>
            <div className="space-y-2">
              {progress.worker_status.map((worker) => (
                <div
                  key={worker.worker_id}
                  className="bg-gray-800 rounded p-2 flex items-center gap-3"
                >
                  <Badge className={statusColors[worker.status]}>
                    #{worker.worker_id}
                  </Badge>
                  <div className="flex-1 min-w-0">
                    <div className="text-sm text-gray-300 truncate">
                      {worker.department}  {worker.category}
                    </div>
                    {worker.product && (
                      <div className="text-xs text-gray-500 truncate">
                        Searching: {worker.product}
                      </div>
                    )}
                  </div>
                  <Badge className={statusColors[worker.status]}>
                    {worker.status}
                  </Badge>
                </div>
              ))}
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/components/admin/collection/progress-detail-modal.tsx && echo "exists"`
- Component exports: `grep "export function ProgressDetailModal" apps/web/src/components/admin/collection/progress-detail-modal.tsx`
  </verify>
  <done>
ProgressDetailModal created:
- Summary cards: Cost, Progress %, New Sellers
- Hierarchical progress bars: Departments, Categories, Products
- Per-worker status: ID, department/category, current product, status badge
  </done>
</task>

<task type="auto">
  <name>Task 7: Create run config modal</name>
  <files>apps/web/src/components/admin/collection/run-config-modal.tsx</files>
  <action>
Create modal for configuring and starting collection runs with template support.

```tsx
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/lib/supabase/client";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Slider } from "@/components/ui/slider";
import { Loader2, Save, Trash2 } from "lucide-react";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface Template {
  id: string;
  name: string;
  description: string | null;
  department_ids: string[];
  concurrency: number;
  is_default: boolean;
}

interface CostEstimate {
  total_cents: number;
  within_budget: boolean;
  budget_cap_cents: number;
}

interface RunConfigModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onRunStarted: () => void;
}

// Placeholder departments until Phase 7
const PLACEHOLDER_DEPARTMENTS = [
  { id: "electronics", name: "Electronics" },
  { id: "home-kitchen", name: "Home & Kitchen" },
  { id: "toys-games", name: "Toys & Games" },
  { id: "clothing", name: "Clothing" },
  { id: "sports", name: "Sports & Outdoors" },
  { id: "beauty", name: "Beauty & Personal Care" },
];

export function RunConfigModal({
  open,
  onOpenChange,
  onRunStarted,
}: RunConfigModalProps) {
  const [templates, setTemplates] = useState<Template[]>([]);
  const [selectedTemplateId, setSelectedTemplateId] = useState<string>("");
  const [departments, setDepartments] = useState<string[]>([]);
  const [concurrency, setConcurrency] = useState(3);
  const [estimate, setEstimate] = useState<CostEstimate | null>(null);
  const [loading, setLoading] = useState(false);
  const [estimating, setEstimating] = useState(false);
  const [saveTemplateName, setSaveTemplateName] = useState("");
  const [showSaveTemplate, setShowSaveTemplate] = useState(false);

  const supabase = createClient();

  // Fetch templates
  useEffect(() => {
    if (!open) return;

    const fetchTemplates = async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const response = await fetch(`${API_BASE}/collection/templates`, {
          headers: { Authorization: `Bearer ${session.access_token}` },
        });

        if (response.ok) {
          const data = await response.json();
          setTemplates(data.templates || []);

          // Select default template
          const defaultTemplate = data.templates?.find((t: Template) => t.is_default);
          if (defaultTemplate) {
            setSelectedTemplateId(defaultTemplate.id);
            setDepartments(defaultTemplate.department_ids);
            setConcurrency(defaultTemplate.concurrency);
          }
        }
      } catch (e) {
        console.error("Failed to fetch templates:", e);
      }
    };

    fetchTemplates();
  }, [open]);

  // Fetch estimate when departments change
  useEffect(() => {
    if (departments.length === 0) {
      setEstimate(null);
      return;
    }

    const fetchEstimate = async () => {
      setEstimating(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const response = await fetch(`${API_BASE}/collection/estimate`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({ category_ids: departments }),
        });

        if (response.ok) {
          const data = await response.json();
          setEstimate(data);
        }
      } catch (e) {
        console.error("Failed to get estimate:", e);
      } finally {
        setEstimating(false);
      }
    };

    const timer = setTimeout(fetchEstimate, 300);
    return () => clearTimeout(timer);
  }, [departments]);

  // Apply template
  const handleTemplateChange = (templateId: string) => {
    setSelectedTemplateId(templateId);
    const template = templates.find((t) => t.id === templateId);
    if (template) {
      setDepartments(template.department_ids);
      setConcurrency(template.concurrency);
    }
  };

  // Toggle department
  const toggleDepartment = (deptId: string) => {
    setDepartments((prev) =>
      prev.includes(deptId)
        ? prev.filter((d) => d !== deptId)
        : [...prev, deptId]
    );
    setSelectedTemplateId(""); // Custom config
  };

  // Select all departments
  const selectAllDepartments = () => {
    setDepartments(PLACEHOLDER_DEPARTMENTS.map((d) => d.id));
    setSelectedTemplateId("");
  };

  // Save as template
  const saveAsTemplate = async () => {
    if (!saveTemplateName.trim()) return;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      await fetch(`${API_BASE}/collection/templates`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({
          name: saveTemplateName.trim(),
          department_ids: departments,
          concurrency,
        }),
      });

      setSaveTemplateName("");
      setShowSaveTemplate(false);

      // Refresh templates
      const response = await fetch(`${API_BASE}/collection/templates`, {
        headers: { Authorization: `Bearer ${session.access_token}` },
      });
      if (response.ok) {
        const data = await response.json();
        setTemplates(data.templates || []);
      }
    } catch (e) {
      console.error("Failed to save template:", e);
    }
  };

  // Start run
  const startRun = async () => {
    if (departments.length === 0) return;
    if (estimate && !estimate.within_budget) return;

    setLoading(true);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const response = await fetch(`${API_BASE}/collection/runs`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({
          category_ids: departments,
          // concurrency would be used by the actual run
        }),
      });

      if (response.ok) {
        const run = await response.json();
        // Start the run
        await fetch(`${API_BASE}/collection/runs/${run.id}/start`, {
          method: "POST",
          headers: { Authorization: `Bearer ${session.access_token}` },
        });

        onRunStarted();
        onOpenChange(false);
      }
    } catch (e) {
      console.error("Failed to start run:", e);
    } finally {
      setLoading(false);
    }
  };

  const formatCost = (cents: number) => `$${(cents / 100).toFixed(2)}`;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="bg-gray-900 border-gray-800 sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle className="text-white">Start Collection Run</DialogTitle>
          <DialogDescription className="text-gray-400">
            Configure which Amazon departments to search and start the collection.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Template selector */}
          <div className="space-y-2">
            <Label className="text-gray-300">Template</Label>
            <Select value={selectedTemplateId} onValueChange={handleTemplateChange}>
              <SelectTrigger className="bg-gray-800 border-gray-700">
                <SelectValue placeholder="Custom configuration" />
              </SelectTrigger>
              <SelectContent className="bg-gray-800 border-gray-700">
                {templates.map((t) => (
                  <SelectItem key={t.id} value={t.id}>
                    {t.name} {t.is_default && "(default)"}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* Departments */}
          <div className="space-y-2">
            <div className="flex justify-between items-center">
              <Label className="text-gray-300">Departments</Label>
              <Button
                variant="ghost"
                size="sm"
                onClick={selectAllDepartments}
                className="text-xs"
              >
                Select All
              </Button>
            </div>
            <div className="grid grid-cols-2 gap-2">
              {PLACEHOLDER_DEPARTMENTS.map((dept) => (
                <label
                  key={dept.id}
                  className={`flex items-center gap-2 p-2 rounded border cursor-pointer transition-colors ${
                    departments.includes(dept.id)
                      ? "bg-blue-900/30 border-blue-500"
                      : "bg-gray-800 border-gray-700 hover:border-gray-600"
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={departments.includes(dept.id)}
                    onChange={() => toggleDepartment(dept.id)}
                    className="rounded"
                  />
                  <span className="text-sm text-gray-200">{dept.name}</span>
                </label>
              ))}
            </div>
          </div>

          {/* Concurrency */}
          <div className="space-y-2">
            <div className="flex justify-between">
              <Label className="text-gray-300">Concurrency</Label>
              <span className="text-sm text-gray-400">{concurrency} workers</span>
            </div>
            <Slider
              value={[concurrency]}
              onValueChange={([v]) => setConcurrency(v)}
              min={1}
              max={10}
              step={1}
              className="w-full"
            />
          </div>

          {/* Cost estimate */}
          {departments.length > 0 && (
            <div
              className={`p-3 rounded border ${
                estimate && !estimate.within_budget
                  ? "bg-red-900/20 border-red-500/50"
                  : "bg-gray-800 border-gray-700"
              }`}
            >
              <div className="flex justify-between text-sm">
                <span className="text-gray-400">Estimated cost:</span>
                {estimating ? (
                  <Loader2 className="h-4 w-4 animate-spin text-gray-400" />
                ) : (
                  <span
                    className={
                      estimate && !estimate.within_budget
                        ? "text-red-400"
                        : "text-green-400"
                    }
                  >
                    {estimate ? formatCost(estimate.total_cents) : "-"}
                  </span>
                )}
              </div>
              {estimate && (
                <div className="flex justify-between text-sm text-gray-500 mt-1">
                  <span>Budget:</span>
                  <span>{formatCost(estimate.budget_cap_cents)}</span>
                </div>
              )}
              {estimate && !estimate.within_budget && (
                <div className="text-red-400 text-sm mt-2">
                  Exceeds budget - reduce departments or increase budget
                </div>
              )}
            </div>
          )}

          {/* Save as template */}
          {showSaveTemplate ? (
            <div className="flex gap-2">
              <Input
                value={saveTemplateName}
                onChange={(e) => setSaveTemplateName(e.target.value)}
                placeholder="Template name..."
                className="bg-gray-800 border-gray-700"
              />
              <Button size="sm" onClick={saveAsTemplate}>
                <Save className="h-4 w-4" />
              </Button>
              <Button
                size="sm"
                variant="ghost"
                onClick={() => setShowSaveTemplate(false)}
              >
                Cancel
              </Button>
            </div>
          ) : (
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setShowSaveTemplate(true)}
              className="text-gray-400"
            >
              <Save className="h-4 w-4 mr-1" />
              Save as template
            </Button>
          )}
        </div>

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            className="border-gray-700"
          >
            Cancel
          </Button>
          <Button
            onClick={startRun}
            disabled={
              loading ||
              departments.length === 0 ||
              estimating ||
              (estimate && !estimate.within_budget)
            }
            className="bg-blue-600 hover:bg-blue-700"
          >
            {loading ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Starting...
              </>
            ) : (
              "Start Collection"
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/components/admin/collection/run-config-modal.tsx && echo "exists"`
- Component exports: `grep "export function RunConfigModal" apps/web/src/components/admin/collection/run-config-modal.tsx`
  </verify>
  <done>
RunConfigModal created:
- Template selector dropdown
- Department checkboxes with Select All
- Concurrency slider (1-10 workers)
- Live cost estimate
- Save as template option
- Start button (disabled if over budget)
  </done>
</task>

<task type="auto">
  <name>Task 8: Create polling hook for real-time updates</name>
  <files>apps/web/src/hooks/use-collection-polling.ts</files>
  <action>
Create hook to poll for progress updates during active runs.

```typescript
import { useState, useEffect, useCallback } from "react";
import { createClient } from "@/lib/supabase/client";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";

interface EnhancedProgress {
  departments_total: number;
  departments_completed: number;
  categories_total: number;
  categories_completed: number;
  products_total: number;
  products_searched: number;
  sellers_found: number;
  sellers_new: number;
  actual_cost_cents: number;
  budget_cap_cents: number;
  cost_status: "safe" | "warning" | "exceeded";
  worker_status: Array<{
    worker_id: number;
    department: string;
    category: string;
    product: string | null;
    status: "idle" | "fetching" | "searching" | "complete";
  }>;
}

interface CollectionRun {
  id: string;
  status: "pending" | "running" | "paused" | "completed" | "failed" | "cancelled";
}

export function useCollectionPolling(pollingInterval = 2000) {
  const [activeRun, setActiveRun] = useState<CollectionRun | null>(null);
  const [progress, setProgress] = useState<EnhancedProgress | null>(null);
  const [newSellerIds, setNewSellerIds] = useState<Set<string>>(new Set());
  const supabase = createClient();

  // Check for active run
  const checkActiveRun = useCallback(async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return null;

      const response = await fetch(`${API_BASE}/collection/runs?limit=1`, {
        headers: { Authorization: `Bearer ${session.access_token}` },
      });

      if (response.ok) {
        const data = await response.json();
        const runs = data.runs || [];
        const active = runs.find(
          (r: CollectionRun) => r.status === "running" || r.status === "paused"
        );
        setActiveRun(active || null);
        return active || null;
      }
    } catch (e) {
      console.error("Failed to check active run:", e);
    }
    return null;
  }, []);

  // Fetch progress for active run
  const fetchProgress = useCallback(async (runId: string) => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const response = await fetch(
        `${API_BASE}/collection/runs/${runId}/progress`,
        { headers: { Authorization: `Bearer ${session.access_token}` } }
      );

      if (response.ok) {
        const data = await response.json();
        setProgress(data);
      }
    } catch (e) {
      console.error("Failed to fetch progress:", e);
    }
  }, []);

  // Polling effect
  useEffect(() => {
    let mounted = true;

    const poll = async () => {
      if (!mounted) return;

      const run = await checkActiveRun();
      if (run && run.status === "running") {
        await fetchProgress(run.id);
      } else {
        setProgress(null);
      }
    };

    // Initial check
    poll();

    // Set up polling interval
    const interval = setInterval(poll, pollingInterval);

    return () => {
      mounted = false;
      clearInterval(interval);
    };
  }, [checkActiveRun, fetchProgress, pollingInterval]);

  // Track new sellers added during this session
  const addNewSellerId = useCallback((id: string) => {
    setNewSellerIds((prev) => new Set([...prev, id]));
  }, []);

  const clearNewSellerIds = useCallback(() => {
    setNewSellerIds(new Set());
  }, []);

  return {
    activeRun,
    progress,
    newSellerIds,
    addNewSellerId,
    clearNewSellerIds,
    refresh: checkActiveRun,
  };
}
```
  </action>
  <verify>
- File exists: `test -f apps/web/src/hooks/use-collection-polling.ts && echo "exists"`
- Hook exports: `grep "export function useCollectionPolling" apps/web/src/hooks/use-collection-polling.ts`
  </verify>
  <done>
useCollectionPolling hook created:
- Polls for active run status
- Fetches enhanced progress during active runs
- Tracks new seller IDs for highlighting
- Configurable polling interval (default 2s)
  </done>
</task>

<task type="auto">
  <name>Task 9: Add Collections tab to automation page</name>
  <files>apps/web/src/app/admin/automation/page.tsx</files>
  <action>
Update automation page to add Collections tab with all widgets wired together.

**Key updates:**
1. Add Collections to Tab type and tabs array
2. Import all collection components
3. Import and use useCollectionPolling hook
4. Add state for modals (logDetail, diff, progressDetail, runConfig)
5. Render layout: progress bar (top), grid (left), sidebar (right)
6. Wire up all modal open/close handlers
  </action>
  <verify>
- Collections tab: `grep "collections" apps/web/src/app/admin/automation/page.tsx`
- SellersGrid imported: `grep "SellersGrid" apps/web/src/app/admin/automation/page.tsx`
- useCollectionPolling: `grep "useCollectionPolling" apps/web/src/app/admin/automation/page.tsx`
  </verify>
  <done>
Automation page updated with Collections tab:
- Progress bar at top (hidden when no active run)
- Sellers grid on left (dominant)
- Recent logs sidebar on right
- All modals wired up: LogDetail, Diff, ProgressDetail, RunConfig
- Polling hook for real-time updates
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Collections UI integrated into admin/automation page:
- Sellers grid (resizable, editable, export)
- Recent logs sidebar (click to see history)
- Log detail modal (seller list + full history + compare)
- Diff modal (side-by-side with added/removed highlighting)
- Progress bar with quick info (cost/depts/cats/products/sellers)
- Progress detail modal (per-worker status)
- Run config modal (templates, departments, concurrency)
  </what-built>
  <how-to-verify>
1. Run migrations 038, 039, 040 in Supabase SQL editor
2. Run the API: `cd apps/api && uvicorn app.main:app --reload --app-dir src`
3. Run the web app: `cd apps/web && npm run dev`
4. Navigate to Admin > Extension Hub > Collections tab

**Verify:**
- [ ] Collections tab is visible
- [ ] Sellers grid shows (empty initially)
- [ ] Can add a seller via input box
- [ ] Can edit seller name by clicking
- [ ] Can delete seller via hover X
- [ ] Can resize grid width (snaps to columns)
- [ ] Export buttons work (CSV, JSON, Copy)
- [ ] Recent logs sidebar shows activity
- [ ] Click log opens detail modal
- [ ] Compare button in detail modal works
- [ ] Diff modal shows side-by-side with colors
- [ ] Start Collection button opens config modal
- [ ] Can select departments and see cost estimate
- [ ] Can save as template
- [ ] Progress bar hidden when no run active
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] SellersGrid component with resize, edit, delete, export
- [ ] RecentLogsSidebar component
- [ ] LogDetailModal component
- [ ] DiffModal component with side-by-side view
- [ ] ProgressBar component with quick info
- [ ] ProgressDetailModal component
- [ ] RunConfigModal component with templates
- [ ] useCollectionPolling hook
- [ ] Collections tab in automation page
- [ ] All components wired together
</verification>

<success_criteria>
Admin can manage sellers from Collections tab:
- View/edit/add/remove sellers in resizable grid
- Export sellers (CSV, JSON, clipboard)
- View edit history and compare snapshots
- See real-time progress during collection runs
- Configure and start runs with templates
</success_criteria>

<output>
After completion, create `.planning/phases/06-collection-infrastructure/06-04-SUMMARY.md`
</output>
