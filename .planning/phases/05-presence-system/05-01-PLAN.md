---
phase: 05-presence-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/migrations/036_presence_system.sql
  - apps/api/src/app/services/presence.py
  - apps/api/src/app/services/__init__.py
  - apps/api/src/app/routers/access_codes.py
  - apps/api/src/app/routers/presence.py
  - apps/api/src/app/routers/__init__.py
  - apps/api/src/app/main.py
autonomous: true

must_haves:
  truths:
    - "Presence table records which VA is on which account"
    - "Clock-in records presence for the VA's assigned account"
    - "Clock-out clears presence from the account"
    - "Only one VA can be present on an account at a time"
    - "A VA can only be present on one account at a time"
    - "Admin can force-clear orphaned presence entries"
  artifacts:
    - path: "apps/api/migrations/036_presence_system.sql"
      provides: "account_presence table with unique constraints and RLS"
      contains: "CREATE TABLE.*account_presence"
    - path: "apps/api/src/app/services/presence.py"
      provides: "Presence record/clear logic"
      exports: ["record_presence", "clear_presence"]
    - path: "apps/api/src/app/routers/presence.py"
      provides: "Admin force-clear endpoint"
      exports: ["router"]
  key_links:
    - from: "apps/api/src/app/routers/access_codes.py"
      to: "apps/api/src/app/services/presence.py"
      via: "record_presence called after successful validation"
      pattern: "record_presence"
    - from: "apps/api/src/app/routers/presence.py"
      to: "apps/api/src/app/services/presence.py"
      via: "clear_presence called by admin endpoint"
      pattern: "clear_presence"
---

<objective>
Create the backend presence infrastructure: database schema, service layer, and integration with clock-in/out flow.

Purpose: Enable tracking of which VA is working on which account, with atomic one-account-per-VA constraint.

Output:
- Migration file for account_presence table with Realtime enabled
- Presence service with record/clear functions
- Integration into access code validation (clock-in)
- Admin endpoint to force-clear orphaned presence
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-presence-system/05-CONTEXT.md
@.planning/phases/05-presence-system/05-RESEARCH.md

# Relevant prior phase work
@.planning/phases/01-access-code-foundation/01-02-SUMMARY.md
@.planning/phases/03-extension-auth-flow/03-01-SUMMARY.md

# Key existing files
@apps/api/src/app/services/access_code.py
@apps/api/src/app/routers/access_codes.py
@apps/api/migrations/035_access_codes.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create presence database schema</name>
  <files>apps/api/migrations/036_presence_system.sql</files>
  <action>
Create migration file with:

1. **account_presence table:**
```sql
CREATE TABLE IF NOT EXISTS public.account_presence (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  membership_id UUID NOT NULL REFERENCES memberships(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES orgs(id) ON DELETE CASCADE,
  clocked_in_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- One VA per account constraint
  CONSTRAINT account_presence_account_unique UNIQUE (account_id),
  -- One account per VA per org constraint
  CONSTRAINT account_presence_user_org_unique UNIQUE (user_id, org_id)
);
```

2. **Enable Realtime:**
```sql
ALTER PUBLICATION supabase_realtime ADD TABLE account_presence;
```

3. **RLS policies:**
- Service role: full access for backend operations
- Authenticated users: SELECT only for their org (both admins and VAs can see presence)

4. **Index for org-based queries:**
```sql
CREATE INDEX idx_account_presence_org ON account_presence(org_id);
```

5. **NOTIFY pgrst to reload schema**

Note: RLS controls row access. Column filtering (admin sees name, VA sees "Occupied") happens in application layer.
  </action>
  <verify>
File exists at apps/api/migrations/036_presence_system.sql with:
- CREATE TABLE account_presence
- UNIQUE constraints for both account_id and (user_id, org_id)
- ALTER PUBLICATION for realtime
- RLS enabled with at least one policy
  </verify>
  <done>
Migration file ready for Supabase SQL editor execution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create presence service module</name>
  <files>apps/api/src/app/services/presence.py, apps/api/src/app/services/__init__.py</files>
  <action>
Create `apps/api/src/app/services/presence.py`:

```python
"""Presence tracking service for account occupancy.

Records and clears presence when VAs clock in/out of accounts.
Uses UPSERT to atomically replace previous presence on clock-in.
"""

import logging
from datetime import datetime, timezone

from postgrest.exceptions import APIError

logger = logging.getLogger(__name__)


async def record_presence(
    supabase,
    account_id: str,
    user_id: str,
    membership_id: str,
    org_id: str,
) -> bool:
    """Record presence when VA clocks into an account.

    Uses upsert with (user_id, org_id) constraint to:
    1. Clear any existing presence for this user in this org
    2. Set new presence on the target account

    Returns True on success, False on failure.
    """
    try:
        result = supabase.table("account_presence").upsert(
            {
                "account_id": account_id,
                "user_id": user_id,
                "membership_id": membership_id,
                "org_id": org_id,
                "clocked_in_at": datetime.now(timezone.utc).isoformat(),
            },
            on_conflict="user_id,org_id",
        ).execute()

        logger.info(f"Recorded presence: user={user_id} on account={account_id}")
        return True
    except APIError as e:
        logger.error(f"Failed to record presence: {e}")
        return False


async def clear_presence(supabase, user_id: str, org_id: str) -> bool:
    """Clear presence when VA clocks out or session times out.

    Returns True on success (including if no presence existed), False on error.
    """
    try:
        supabase.table("account_presence").delete().match({
            "user_id": user_id,
            "org_id": org_id,
        }).execute()

        logger.info(f"Cleared presence: user={user_id} in org={org_id}")
        return True
    except APIError as e:
        logger.error(f"Failed to clear presence: {e}")
        return False


async def clear_presence_by_account(supabase, account_id: str, org_id: str) -> bool:
    """Force-clear presence from an account (admin action).

    Used to clear orphaned presence entries.
    Returns True on success, False on error.
    """
    try:
        supabase.table("account_presence").delete().match({
            "account_id": account_id,
            "org_id": org_id,
        }).execute()

        logger.info(f"Admin cleared presence from account={account_id}")
        return True
    except APIError as e:
        logger.error(f"Failed to clear presence by account: {e}")
        return False
```

Update `apps/api/src/app/services/__init__.py` to export the new functions:
```python
from .presence import clear_presence, clear_presence_by_account, record_presence
```

Add to existing exports (don't remove access_code exports).
  </action>
  <verify>
- File apps/api/src/app/services/presence.py exists with record_presence, clear_presence, clear_presence_by_account functions
- apps/api/src/app/services/__init__.py includes presence exports
- Run: `cd /mnt/c/Users/User/Downloads/GitRepos/DS-ProSolution/apps/api && python -c "from app.services import record_presence, clear_presence, clear_presence_by_account; print('OK')"`
  </verify>
  <done>
Presence service module created with record/clear functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate presence into clock-in/out and add admin endpoint</name>
  <files>apps/api/src/app/routers/access_codes.py, apps/api/src/app/routers/presence.py, apps/api/src/app/routers/__init__.py, apps/api/src/app/main.py</files>
  <action>
**Part A: Update access_codes.py validate endpoint**

Modify the `/access-codes/validate` endpoint to:
1. Accept optional `account_id` in request body
2. After successful validation, if account_id provided, record presence

Update `AccessCodeValidateRequest` model in `apps/api/src/app/models.py` to include:
```python
account_id: str | None = None  # Optional account to clock into
```

In the validate endpoint (after JWT generation, before return):
```python
# Record presence if account_id provided
if body.account_id:
    from app.services.presence import record_presence
    await record_presence(
        supabase,
        account_id=body.account_id,
        user_id=user_id,
        membership_id=membership["id"],
        org_id=org_id,
    )
```

**Part B: Create presence router**

Create `apps/api/src/app/routers/presence.py`:
```python
"""Presence management endpoints.

Admin endpoints:
- GET /presence: List all presence entries for org
- DELETE /presence/{account_id}: Force-clear presence from account
"""

import logging

from fastapi import APIRouter, Depends, HTTPException

from app.auth import get_current_user_with_membership
from app.database import get_supabase
from app.services.presence import clear_presence_by_account

router = APIRouter(prefix="/presence", tags=["presence"])
logger = logging.getLogger(__name__)


@router.delete("/{account_id}")
async def admin_clear_presence(
    account_id: str,
    user: dict = Depends(get_current_user_with_membership),
):
    """Force-clear presence from an account (admin only).

    Used to remove orphaned presence entries.
    """
    membership = user["membership"]
    if membership.get("role") != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")

    supabase = get_supabase()
    org_id = membership["org_id"]

    success = await clear_presence_by_account(supabase, account_id, org_id)
    if not success:
        raise HTTPException(status_code=500, detail="Failed to clear presence")

    return {"status": "cleared"}
```

**Part C: Register the router**

Update `apps/api/src/app/routers/__init__.py`:
```python
from .presence import router as presence_router
```

Update `apps/api/src/app/main.py` to include:
```python
from app.routers import presence_router
app.include_router(presence_router)
```

**Part D: Add clock-out presence clearing**

The extension calls `/access-codes/me` endpoint for permission re-check. When users log out from extension, we need to clear presence.

Add a new endpoint to access_codes.py:
```python
@router.post("/logout")
async def logout_access_code(
    user: dict = Depends(get_current_user_with_membership),
):
    """Clear presence when user logs out from extension."""
    from app.services.presence import clear_presence

    supabase = get_supabase()
    user_id = user["user_id"]
    org_id = user["membership"]["org_id"]

    await clear_presence(supabase, user_id, org_id)
    return {"status": "logged_out"}
```

This endpoint requires authentication (access code JWT) and clears the user's presence.
  </action>
  <verify>
- AccessCodeValidateRequest model in models.py includes account_id field
- /access-codes/validate endpoint calls record_presence when account_id provided
- /presence/{account_id} DELETE endpoint exists for admin force-clear
- /access-codes/logout POST endpoint exists for clearing presence
- Run API and check /docs shows new endpoints
  </verify>
  <done>
- Clock-in records presence (when account_id provided)
- Admin can force-clear presence
- Logout endpoint clears presence
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Migration file exists and contains proper schema
2. `python -c "from app.services import record_presence, clear_presence"` succeeds
3. API starts without errors: `cd apps/api && uvicorn app.main:app --reload --app-dir src`
4. /docs shows:
   - POST /access-codes/validate (with optional account_id)
   - POST /access-codes/logout
   - DELETE /presence/{account_id}
</verification>

<success_criteria>
- [ ] Migration 036 ready for Supabase
- [ ] Presence service with record/clear functions
- [ ] Validate endpoint accepts account_id for presence recording
- [ ] Logout endpoint clears presence
- [ ] Admin force-clear endpoint works
- [ ] API starts and all endpoints visible in /docs
</success_criteria>

<output>
After completion, create `.planning/phases/05-presence-system/05-01-SUMMARY.md`
</output>
